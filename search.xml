<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>原生js实现ajax请求</title>
    <url>/8a9d69d0-e38d-11ee-8d05-110f62540784/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1-XMLHttpRequest-对象"><a href="#1-XMLHttpRequest-对象" class="headerlink" title="1 XMLHttpRequest 对象"></a>1 XMLHttpRequest 对象</h2><p>XMLHttpRequest 对象是 ajax 的基础,XMLHttpRequest 用于在后台与服务器交换数据。这意味着可以在不重新加载整个网页的情况下，对网页的某部分进行更新。目前所有浏览器都支持 XMLHttpRequest</p>
<table>
<thead>
<tr>
<th align="center">方 法</th>
<th align="center">描 述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">abort()</td>
<td align="center">停止当前请求</td>
</tr>
<tr>
<td align="center">getAllResponseHeaders()</td>
<td align="center">把 HTTP 请求的所有响应首部作为键&#x2F;值对返回</td>
</tr>
<tr>
<td align="center">getResponseHeader(“header”)</td>
<td align="center">返回指定首部的串值</td>
</tr>
<tr>
<td align="center">open(“method”,”URL”,[asyncFlag],[“userName”],[“password”])</td>
<td align="center">建立对服务器的调用。method 参数可以是 GET、POST 或 PUT。url 参数可以是相对 URL 或绝对 URL。这个方法还包括 3 个可选的参数，是否异步，用户名，密码</td>
</tr>
<tr>
<td align="center">send(content)</td>
<td align="center">向服务器发送请求</td>
</tr>
<tr>
<td align="center">setRequestHeader(“header”, “value”)</td>
<td align="center">把指定首部设置为所提供的值。在设置任何首部之前必须先调用 open()。设置 header 并和请求一起发送 (‘post’方法一定要 )</td>
</tr>
</tbody></table>
<h2 id="2-案例"><a href="#2-案例" class="headerlink" title="2 案例"></a>2 案例</h2><p>1）get 请求：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建异步对象</span></span><br><span class="line"><span class="keyword">var</span> ajax = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line"><span class="comment">// 设置请求的url参数，参数一是请求的类型，参数二是请求的url，可带参数传递到服务端</span></span><br><span class="line">ajax.<span class="title function_">open</span>(<span class="string">&quot;get&quot;</span>, <span class="string">&quot;getStar.php?starName=&quot;</span> + name);</span><br><span class="line"><span class="comment">// 发送请求</span></span><br><span class="line">ajax.<span class="title function_">send</span>();</span><br><span class="line"><span class="comment">// 注册事件 onreadystatechange</span></span><br><span class="line">ajax.<span class="property">onreadystatechange</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (ajax.<span class="property">readyState</span> == <span class="number">4</span> &amp;&amp; ajax.<span class="property">status</span> == <span class="number">200</span>) &#123;</span><br><span class="line">    <span class="comment">// 正常响应，输出</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ajax.<span class="property">responseText</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>2）post 请求：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建异步对象</span></span><br><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line"><span class="comment">// 设置请求的类型及url，post请求一定要添加请求头</span></span><br><span class="line">xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&quot;Content-type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span><br><span class="line">xhr.<span class="title function_">open</span>(<span class="string">&quot;post&quot;</span>, <span class="string">&quot;02.post.php&quot;</span>);</span><br><span class="line"><span class="comment">// 发送请求</span></span><br><span class="line">xhr.<span class="title function_">send</span>(<span class="string">&quot;name=fox&amp;age=18&quot;</span>);</span><br><span class="line">xhr.<span class="property">onreadystatechange</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 正常响应，输出</span></span><br><span class="line">  <span class="keyword">if</span> (xhr.<span class="property">readyState</span> == <span class="number">4</span> &amp;&amp; xhr.<span class="property">status</span> == <span class="number">200</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(xhr.<span class="property">responseText</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>未分类</category>
      </categories>
      <tags>
        <tag>未标记</tag>
      </tags>
  </entry>
  <entry>
    <title>3-things-every-java-developer-should-stop-doing</title>
    <url>/5886d182-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h1 id="3-Things-Every-Java-Developer-Should-Stop-Doing"><a href="#3-Things-Every-Java-Developer-Should-Stop-Doing" class="headerlink" title="3 Things Every Java Developer Should Stop Doing"></a>3 Things Every Java Developer Should Stop Doing</h1><p><strong>每个 Java 开发者都应该停止的三件事</strong></p>
<blockquote>
<p>转译自：<a href="https://dzone.com/articles/3-things-every-java-developer-should-stop-doing">https://dzone.com/articles/3-things-every-java-developer-should-stop-doing</a></p>
</blockquote>
<blockquote>
<p>Looking for a few bad habits to drop? Let’s take a look at null, functional programming, and getters and setters to see how you can improve your coding.</p>
</blockquote>
<p>前言：想改掉一些坏习惯吗？让我们从 null、函数式编程以及 getter 和 setter 着手，看看如何改善代码。</p>
<p>From returning null values to overusing getters and setters, there are idioms that we as Java developers are accustom to making, even when unwarranted. While they may be appropriate in some occasions, they are usually forces of habit or fallbacks that we make to get the system working. In this article, we will go through three things that are common among Java developers, both novice and advanced, and explore how they can get us into trouble. It should be noted that these are not hard-and-fast rules that should always be adhered to, regardless of the circumstances. At times, there may be a good reason to use these patterns to solve a problem, but on the whole, they should be used a lot less than they are now. To start us off, we will begin with one of the most prolific, but double-edged keywords in Java: Null.</p>
<p>作为 Java 开发人员，我们会使用一些习惯用法，典型的例子，如：返回 null 值、滥用 getter 和 setter，即使在没有依据的情况下也是如此。虽然在某些情况下，使用它们可能是适当的，但通常是我们为使系统正常工作而形成的习惯或权宜之计。在本文中，我们将介绍 Java 开发（包括新手和高级开发人员）中常见的三种情况，并探究它们是如何给我们带来麻烦的。应该指出的是，文中总结的规则并不是无论何时都应该始终遵守的硬性要求。有时候，可能有一个很好的理由来使用这些模式解决问题，但是总的来说，还是应该减少这些用法。首先，我们将从 Null 这个关键字开始，它也是 Java 中使用最频繁、但也是最具两面性特性的关键字之一。</p>
<h2 id="1-Returning-Null"><a href="#1-Returning-Null" class="headerlink" title="1. Returning Null"></a>1. Returning Null</h2><p><strong>返回 Null</strong></p>
<p>Null has been the best friend and worst enemy of developers for decades and null in Java is no different. In high-performance applications, null can be a solid means of reducing the number of objects and signaling that a method does not have a value to return. In contrast to throwing an exception, which has to capture the entire stack trace when it is created, null serves as a quick and low-overhead way to signal clients that no value can be obtained.</p>
<p>null 一直是开发者最好的朋友，也是最大的敌人，这在 Java 中也不例外。在高性能应用中，使用 null 是一种减少对象数量的可靠方法，它表明方法没有要返回的值。与抛出异常（创建异常时必须捕获整个堆栈跟踪）不同，使用 null 是一种快速且低开销的方法，用于通知客户机不能获取任何值。</p>
<p>Outside the context of high-performance systems, null can wreak havoc in an application by creating more tedious checks for null return values and causing NullPointerExceptions when dereferencing a null object. In most applications, nulls are returned for three primary reasons: (1) to denote no elements could be found for a list, (2) to signal that no valid value could be found, even if an error did not occur, or (3) to denote a special case return value.</p>
<p>在高性能系统的环境之外，null 可以通过创建更繁琐的 null 返回值检查来破坏应用程序，并在非关联化 null 对象时导致 NullPointerExceptions 异常。在大多数应用程序中，返回 null 有三个主要原因：（1）表示列表中找不到元素；（2）表示即使没有发生错误，也找不到有效值;（3）表示特殊情况下的返回值。</p>
<p>Barring any performance reasons, each of these cases has a much better solution which does not use null and force developers to handle null cases. Whatsmore, clients of these methods are not left scratching their heads wondering if the method will return a null in some edge case. In each case, we will devise a cleaner approach that does not involve returning a null value.</p>
<p>除非有任何性能方面的原因，否则以上每一种情况都有更好的解决方案，它们不使用 null，并且强制开发人员处理出现 null 的情况。更重要的是，这些方法的客户端不会为该方法是否会在某些边缘情况下返回 null 而伤脑筋。在每种情况下，我们将设计一种不返回 null 值的简洁方法。</p>
<h2 id="No-Elements"><a href="#No-Elements" class="headerlink" title="No Elements"></a>No Elements</h2><p><strong>集合中没有元素的情况</strong></p>
<p>When returning lists or other collections, it can be common to see a null collection returned in order to signal that elements for that collection could not be found. For example, we could create a service that manages users in a database that resembles the following (some method and class definitions have been left out for brevity):</p>
<p>在返回列表或其他集合时，通常会看到返回空集合，以表明无法找到该集合的元素。例如，我们可以创建一个服务来管理数据库中的用户，该服务类似于以下内容（为了简洁起见，省略了一些方法和类定义）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        User[] usersFromDb = getUsersFromDatabase();</span><br><span class="line">        <span class="keyword">if</span> (usersFromDb == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No users found in database</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Arrays.asList(usersFromDb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">UserServer</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br><span class="line">List&lt;Users&gt; users = service.getUsers();</span><br><span class="line"><span class="keyword">if</span> (users != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (User user: users) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;User found: &quot;</span> + user.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Since we have elected to return a null value in the case of no users, we are forcing our client to handle this case before iterating over the list of users. If instead, we returned an empty list to denote no users were found, the client can remove the null check entirely and loop through the users as normal. If there are no users, the loop will be skipped implicitly without having to manually handle that case; in essence, looping through the list of users functions as we intend for both an empty and populated list without having to manually handle one case or the other:</p>
<p>因为我们选择在没有用户的情况下返回 null 值，所以我们在遍历用户列表之前强制客户端处理这种情况。如果我们返回一个空列表来表示没有找到用户，那么客户端可以完全删除空检查并像往常一样遍历用户。如果没有用户，则隐式跳过循环，而不必手动处理这种情况；从本质上说，循环遍历用户列表的功能就像我们为空列表和填充列表所做的那样，而不需要手动处理任何一种情况：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        User[] usersFromDb = getUsersFromDatabase();</span><br><span class="line">        <span class="keyword">if</span> (usersFromDb == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No users found in database</span></span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Arrays.asList(usersFromDb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">UserServer</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br><span class="line">List&lt;Users&gt; users = service.getUsers();</span><br><span class="line"><span class="keyword">for</span> (User user: users) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;User found: &quot;</span> + user.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In the case above, we have elected to return an immutable, empty list. This is an acceptable solution, so long as we document that the list is immutable and should not be modified (doing so may throw an exception). If the list must be mutable, we can return an empty, mutable list, as in the following example:</p>
<p>在上面的例子中，我们返回的是一个不可变的空列表。这是一个可接受的解决方案，只要我们记录该列表是不可变的并且不应该被修改（这样做可能会抛出异常）。如果列表必须是可变的，我们可以返回一个空的可变列表，如下例所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUsers</span><span class="params">()</span> &#123;</span><br><span class="line">    User[] usersFromDb = getUsersFromDatabase();</span><br><span class="line">    <span class="keyword">if</span> (usersFromDb == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// No users found in database</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();    <span class="comment">// A mutable list</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(usersFromDb);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In general, the following rule should be adhered to when signaling that no elements could be found:</p>
<p>一般来说，在发出找不到元素的信号时，应遵守以下规则：</p>
<p><strong>Return an empty collection (or list, set, queue, etc.) to denote that no elements can be found</strong></p>
<p>返回一个空集合（或 list、set、queue 等等）表明找不到元素。</p>
<p>Doing so not only reduces the special-case handling that clients must perform, but it also reduces the inconsistencies in our interface (i.e. we return a list object sometimes and not others).</p>
<p>这样做不仅减少了客户端必须执行的特殊情况处理，而且还减少了接口中的不一致性（例如，我们有时返回一个 list 对象，而不是其他对象）。</p>
<h2 id="Optional-Value"><a href="#Optional-Value" class="headerlink" title="Optional Value"></a>Optional Value</h2><p><strong>可选值</strong></p>
<p>Many times, null values are returned when we wish to inform a client that an optional value is not present, but no error has occurred. For example, getting a parameter from a web address. In some cases, the parameter may be present, but in other cases, it may not. The lack of this parameter does not necessarily denote an error, but rather, it denotes that the user did not want the functionality that is included when the parameter is provided (such as sorting). We can handle this by returning null if no parameter is present or the value of the parameter if one is supplied (some methods have been removed for brevity):</p>
<p>很多时候，我们希望在没有发生错误时通知客户端不存在可选值，此时返回 null。例如，从 web 地址获取参数。在某些情况下，参数可能存在，但在其他情况下，它可能不存在。缺少此参数并不一定表示错误，而是表示用户不希望提供该参数时包含的功能（例如排序）。如果没有参数，则返回 null；如果提供了参数，则返回参数值（为了简洁起见，删除了一些方法）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserListUrl</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String url;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserListUrl</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSortingValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (urlContainsSortParameter(url)) &#123;</span><br><span class="line">            <span class="keyword">return</span> extractSortParameter(url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br><span class="line"><span class="type">UserListUrl</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserListUrl</span>(<span class="string">&quot;http://localhost/api/v2/users&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">sortingParam</span> <span class="operator">=</span> url.getSortingValue();</span><br><span class="line"><span class="keyword">if</span> (sortingParam != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">UserSorter</span> <span class="variable">sorter</span> <span class="operator">=</span> UserSorter.fromParameter(sortingParam);</span><br><span class="line">    <span class="keyword">return</span> userService.getUsers(sorter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userService.getUsers();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When no parameter is supplied, a null is returned and a client must handle this case, but nowhere in the signature of the getSortingValue method does it state that the sorting value is optional. For us to know that this method is optional and may return a null if no parameter is present, we would have to read the documentation associated with the method (if any were provided).</p>
<p>当没有提供参数时，返回 null，客户端必须处理这种情况，但是在 getSortingValue 方法的签名中，没有任何地方声明排序值是可选的。如果要知道这个方法是可选的，如果没有参数，可能返回null，我们必须阅读与该方法相关的文档（如果提供了文档）。</p>
<p>Instead, we can make the optionality explicit returning an Optional object. As we will see, the client still has to handle the case when no parameter is present, but now that requirement is made explicit. Whatsmore, the Optional class provides more mechanisms to handle a missing parameter than a simple null check. For example, we can simply check for the presence of the parameter using the query method (a state-testing method) provided by Optional:</p>
<p>相反，我们可以使可选性显式地返回一个 Optional 对象。正如我们将看到的，当没有参数存在时，客户端仍然需要处理这种情况，但是现在这个需求已经明确了。更重要的是，Optional 类提供了比简单的 null 检查更多的机制来处理丢失的参数。例如，我们可以使用 Optional 类提供的查询方法（一种状态测试方法）简单地检查参数是否存在:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserListUrl</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String url;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserListUrl</span><span class="params">(String url)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Optional&lt;String&gt; <span class="title function_">getSortingValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (urlContainsSortParameter(url)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Optional.of(extractSortParameter(url));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Optional.empty();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br><span class="line"><span class="type">UserListUrl</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserListUrl</span>(<span class="string">&quot;http://localhost/api/v2/users&quot;</span>);</span><br><span class="line">Optional&lt;String&gt; sortingParam = url.getSortingValue();</span><br><span class="line"><span class="keyword">if</span> (sortingParam.isPresent()) &#123;</span><br><span class="line">    <span class="type">UserSorter</span> <span class="variable">sorter</span> <span class="operator">=</span> UserSorter.fromParameter(sortingParam.get());</span><br><span class="line">    <span class="keyword">return</span> userService.getUsers(sorter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userService.getUsers();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is nearly identical to that of the null-check case, but we have made the optionality of the parameter explicit (i.e. the client cannot access the parameter without calling get(), which will throw a NoSuchElementException if the optional is empty). If we were not interested in returning the list of users based on the optional parameter in the web address, but rather, consuming the parameter in some manner, we could use the ifPresentOrElse method to do so:</p>
<p>这与「空检查」的情况几乎相同，但是我们已经明确了参数的可选性（即客户机在不调用 <code>get()</code> 的情况下无法访问参数，如果可选参数为空，则会抛出NoSuchElementException）。如果我们不希望根据 web 地址中的可选参数返回用户列表，而是以某种方式使用该参数，我们可以使用 ifPresentOrElse 方法来这样做：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">sortingParam.ifPresentOrElse(</span><br><span class="line">    param -&gt; System.out.println(<span class="string">&quot;Parameter is :&quot;</span> + param),</span><br><span class="line">    () -&gt; System.out.println(<span class="string">&quot;No parameter supplied.&quot;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>This greatly reduces the noise required for null checking. If we wished to disregard the parameter if no parameter is supplied, we could do so using the ifPresent method:</p>
<p>这极大降低了「空检查」的影响。如果我们希望在没有提供参数时忽略参数，可以使用 ifPresent 方法:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">sortingParam.ifPresent(param -&gt; System.out.println(<span class="string">&quot;Parameter is :&quot;</span> + param));</span><br></pre></td></tr></table></figure>

<p>In either case, using an Optional object, rather than returning null, explicitly forces clients to handle the case that a return value may not be present and provides many more avenues for handling this optional value. Taking this into account, we can devise the following rule:</p>
<p>在这两种情况下，使用 Optional 对象要优于返回 null 以及显式地强制客户端处理返回值可能不存在的情况，为处理这个可选值提供了更多的途径。考虑到这一点，我们可以制定以下规则：</p>
<p><strong>If a return value is optional, ensure clients handle this case by returning an Optional that contains a value if one is found and is empty if no value can be found</strong></p>
<p>如果返回值是可选的，则通过返回一个 Optional 来确保客户端处理这种情况，该可选的值在找到值时包含一个值，在找不到值时为空</p>
<h2 id="Special-Case-Value"><a href="#Special-Case-Value" class="headerlink" title="Special-Case Value"></a>Special-Case Value</h2><p><strong>特殊情况值</strong></p>
<p>The last common use case is that of a special case, where a normal value cannot be obtained and a client should handle a corner case different than the others. For example, suppose we have a command factory from which clients periodically request commands to complete. If no command is ready to be completed, the client should wait 1 second before asking again. We can accomplish this by returning a null command, which clients must handle, as illustrated in the example below (some methods are not shown for brevity):</p>
<p>最后一个常见用例是特殊用例，在这种情况下无法获得正常值，客户端应该处理与其他用例不同的极端情况。例如，假设我们有一个命令工厂，客户端定期从命令工厂请求命令。如果没有命令可以获得，客户端应该等待 1 秒钟再请求。我们可以通过返回一个空命令来实现这一点，客户端必须处理这个空命令，如下面的例子所示（为了简洁起见，没有显示一些方法）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Command</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadCommand</span> <span class="keyword">implements</span> <span class="title class_">Command</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Read&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WriteCommand</span> <span class="keyword">implements</span> <span class="title class_">Command</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Write&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommandFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Command <span class="title function_">getCommand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (shouldRead()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReadCommand</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (shouldWrite()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WriteCommand</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">CommandFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommandFactory</span>();</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="type">Command</span> <span class="variable">command</span> <span class="operator">=</span> factory.getCommand();</span><br><span class="line">    <span class="keyword">if</span> (command != <span class="literal">null</span>) &#123;</span><br><span class="line">        command.execute();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Since the CommandFactory can return null commands, clients are obligated to check if the command received is null and if it is, sleep for 1 second. This creates a set of conditional logic that clients must handle on their own. We can reduce this overhead by creating a null-object (sometimes called a special-case object). A null-object encapsulates the logic that would have been executed in the null scenario (namely, sleeping for 1 second) into an object that is returned in the null case. For our command example, this means creating a SleepCommand that sleeps when executed:</p>
<p>由于 CommandFactory 可以返回空命令，客户端有义务检查接收到的命令是否为空，如果为空，则休眠1秒。这将创建一组必须由客户端自行处理的条件逻辑。我们可以通过创建一个「空对象」（有时称为特殊情况对象）来减少这种开销。「空对象」将在 null 场景中执行的逻辑（休眠 1 秒）封装到 null 情况下返回的对象中。对于我们的命令示例，这意味着创建一个在执行时休眠的 SleepCommand：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SleepCommand</span> <span class="keyword">implements</span> <span class="title class_">Command</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommandFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Command <span class="title function_">getCommand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (shouldRead()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReadCommand</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (shouldWrite()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WriteCommand</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SleepCommand</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">CommandFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CommandFactory</span>();</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="type">Command</span> <span class="variable">command</span> <span class="operator">=</span> factory.getCommand();</span><br><span class="line">    command.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As with the case of returning empty collections, creating a null-object allows clients to implicitly handle special cases as if they were the normal case. This is not always possible, though; there may be instances where the decision for dealing with a special case must be made by the client. This can be handled by allowing the client to supply a default value, as is done with the Optional class. In the case of Optional, clients can obtain the contained value or a default using the orElse method:</p>
<p>与返回空集合的情况一样，创建「空对象」允许客户端隐式处理特殊情况，就像它们是正常情况一样。但这并不总是可行的；在某些情况下，处理特殊情况的决定必须由客户做出。这可以通过允许客户端提供默认值来处理，就像使用 Optional 类一样。在 Optional 的情况下，客户端可以使用 orElse 方法获取包含的值或默认值：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">UserListUrl</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserListUrl</span>(<span class="string">&quot;http://localhost/api/v2/users&quot;</span>);</span><br><span class="line">Optional&lt;String&gt; sortingParam = url.getSortingValue();</span><br><span class="line"><span class="type">String</span> <span class="variable">sort</span> <span class="operator">=</span> sortingParam.orElse(<span class="string">&quot;ASC&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>If there is a supplied sorting parameter (i.e. if the Optional contains a value), this value will be returned. If no value exists, “ASC” will be returned by default. The Optional class also allows a client to create a default value when needed, in case the default creation process is expensive (i.e. the default will be created only when needed):</p>
<p>如果有一个提供的排序参数（例如，如果 Optional 包含一个值），这个值将被返回。如果不存在值，默认情况下将返回「ASC」。Optional 类还允许客户端在需要时创建默认值，以防默认创建过程开销较大（即只在需要时创建默认值）:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">UserListUrl</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserListUrl</span>(<span class="string">&quot;http://localhost/api/v2/users&quot;</span>);</span><br><span class="line">Optional&lt;String&gt; sortingParam = url.getSortingValue();</span><br><span class="line"><span class="type">String</span> <span class="variable">sort</span> <span class="operator">=</span> sortingParam.orElseGet(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// Expensive computation</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Using a combination of null-objects and default values, we can devise the following rule:</p>
<p>结合「空对象」和默认值的用法，我们可以设计以下规则：</p>
<p><strong>When possible, handle null cases with a null-object or allow clients to supply a default value</strong></p>
<p>如果可能，使用「空对象」处理使用 null 关键字的情况，或者允许客户端提供默认值</p>
<h2 id="2-Defaulting-to-Functional-Programming"><a href="#2-Defaulting-to-Functional-Programming" class="headerlink" title="2. Defaulting to Functional Programming"></a>2. Defaulting to Functional Programming</h2><p><strong>默认使用函数式编程</strong></p>
<p>Since streams and lambdas were introduced in Java Development Kit (JDK) 8, there has been a push to migrate towards functional programming, and rightly so. Before lambdas and streams, performing simple functional tasks were cumbersome and resulted in severely unreadable code. For example, filtering a collection in the traditional style resulted in code that resembled the following:</p>
<p>自从在 JDK 8 中引入了 stream 和 lambda 表达式之后，就出现了向函数式编程迁移的趋势，这理当如此。在 lambda 表达式和 stream 出现之前，执行简单的功能任务是非常麻烦的，并且会导致代码可读性的严重下降。例如，以下代码用传统方式过滤一个集合：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Foo</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Iterator&lt;Foo&gt; iterator = foos.iterator();</span><br><span class="line"><span class="keyword">while</span>(iterator.hasNext()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (iterator.next().getValue() &gt; <span class="number">10</span>) &#123;</span><br><span class="line">        iterator.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>While this code is compact, it does not tell us in an obvious way that we are trying to remove elements of a collection if some criterion is satisfied. Instead, it tells us that we are iterating over a collection while there are more elements in the collection and removing each element if its value is greater than 10 (we can surmise that filtering is occurring, but it obscured in the verbosity of the code). We can shrink this logic down to one statement using functional programming:</p>
<p>虽然这段代码很紧凑，但它并没有以一种明显的方式告诉我们，当满足某个条件时，我们将尝试删除集合的元素。相反，它告诉我们，当集合中有更多的元素时将遍历集合，并将删除值大于 10 的元素（我们可以假设正在进行筛选，但是删除元素的部分被代码的冗长所掩盖）。我们可以使用函数式编程将这个逻辑压缩为一条语句：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">foos.removeIf(foo -&gt; foo.getValue() &gt; <span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p>Not only is this statement much more concise than its iterative alternative, it also tells us exactly what it is trying to do. We can even make it more readable if we name the predicate and pass it to the removeIf method:</p>
<p>这个语句不仅比迭代方式更简洁，而且准确的告诉我们它的行为。如果我们为 predicate 命名并将其传递给 removeIf 方法，甚至可以使其更具可读性：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Predicate&lt;Foo&gt; valueGreaterThan10 = foo -&gt; foo.getValue() &gt; <span class="number">10</span>;</span><br><span class="line">foos.removeIf(valueGreaterThan10);</span><br></pre></td></tr></table></figure>

<p>The final line of this snippet reads like a sentence in English, informing us exactly of what the statement is doing. With code that looks so compact and readable, it is tempting to try and use functional programming in every situation where iteration is required, but this is a naive philosophy. Not every situation lends itself to functional programming. For example, if we tried to print the cross product of the set of suits and ranks in a deck of cards (every combination of suits and ranks), we could create the following (see Effective Java, 3rd Edition for a more detailed listing of this example):</p>
<p>这段代码的最后一行读起来像一个英语句子，准确地告诉我们语句在做什么。对于看起来如此紧凑和极具可读性的代码，在任何需要迭代的情况下尝试使用函数式编程是很让人向往的，但这是一种天真的想法。并不是每种情况都适合函数式编程。例如，如果我们尝试在一副牌中打印一组花色和等级的排列组合（花色和等级的每一种组合），我们可以创建以下内容（参见 Effective Java，第三版，获得这个示例的详细内容）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">Suit</span> &#123;</span><br><span class="line">    CLUB, DIAMOND, HEART, SPADE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">Rank</span> &#123;</span><br><span class="line">    ONE, TWO, THREE, FOUR, FIVE, SIX, SEVEN, EIGHT, NINE, TEN, JACK, QUEEN, KING;</span><br><span class="line">&#125;</span><br><span class="line">Collection&lt;Suit&gt; suits = EnumSet.allOf(Suit.class);</span><br><span class="line">Collection&lt;Rank&gt; ranks = EnumSet.allOf(Rank.class);</span><br><span class="line">suits.stream()</span><br><span class="line">    .forEach(suit -&gt; &#123;</span><br><span class="line">        ranks.stream().forEach(rank -&gt; System.out.println(<span class="string">&quot;Suit: &quot;</span> + suit + <span class="string">&quot;, rank: &quot;</span> + rank));</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>While this is not over-complicated to read, it is not the most straightforward implementation we could devise. It is pretty clear that we are trying to force streams into a realm where traditional iteration is much more favorable. If we used traditional iteration, we could have simplified the cross product of suits and ranks to the following:</p>
<p>虽然读起来并不复杂，但这种实现并不是最简单的。很明显，我们正试图强行使用 stream，而此时使用传统迭代明显更有利。如果我们使用传统的迭代方法，我们可以将 花色和等级的排列组合简化为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (Suit suit: suits) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Rank rank: ranks) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Suit: &quot;</span> + suit + <span class="string">&quot;, rank: &quot;</span> + rank);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This style, although much less flashy, is much more straightforward. We can quickly see that we are attempting to iterate over each suit and rank and pair each rank with each suit. The tediousness of functional programming becomes much more acute the larger the stream expression becomes. Take for example the following code snippet created by Joshua Bloch in Effective Java, 3rd Edition (pp. 205, Item 45) to find all the anagrams over a specified length contained in a dictionary at the path supplied by the user:</p>
<p>这种风格虽然不那么浮华，但却直截了当得多。我们可以很快地理解，我们试图遍历每个花色和等级，并将每个等级与每个花色配对。流表达式越大，函数式编程的乏味性就越明显。以 Joshua Bloch 在《Effective Java, 3rd Edition》第 205 页，第 45 项中创建的以下代码片段为例，在用户提供的路径上查找字典中包含的指定长度内的所有词组：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Anagrams</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Path</span> <span class="variable">dictionary</span> <span class="operator">=</span> Paths.get(args[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">int</span> <span class="variable">minGroupSize</span> <span class="operator">=</span> Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">try</span> (Stream&lt;String&gt; words = Files.lines(dictionary)) &#123;</span><br><span class="line">            words.collect(</span><br><span class="line">                groupingBy(word -&gt; word.chars().sorted()</span><br><span class="line">                           .collect(StringBuilder::<span class="keyword">new</span>,</span><br><span class="line">                               (sb, c) -&gt; sb.append((<span class="type">char</span>) c),</span><br><span class="line">                               StringBuilder::append).toString()))</span><br><span class="line">                .values().stream()</span><br><span class="line">                    .filter(group -&gt; group.size() &gt;= minGroupSize)</span><br><span class="line">                    .map(group -&gt; group.size() + <span class="string">&quot;: &quot;</span> + group)</span><br><span class="line">                    .forEach(System.out::println);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Even the most seasoned stream adherents would probably balk at this implementation. It is unclear as to the intention of the code and would take a decent amount of thinking to uncover what the above stream manipulations are trying to accomplish. This does not mean that streams are complicated or that they are too wordy, but they are not always the best choice. As we saw above, using the removeIf reduced a complicated group of statements into a single, easily-comprehensible statement. Therefore, we should not try to replace every instance of traditional iteration with streams or even lambdas. Instead, we should abide by the following rule when deciding whether to functional programming or use the traditional route:</p>
<p>即使是经验最丰富的 stream 使用者也可能会对这个实现感到迷茫。短时间内很难理解代码的意图，需要大量的思考才能发现上面的 stream 操作试图实现什么。这并不意味着 stream 一定很复杂或太冗长，只是因为它们不总是最好的选择。正如我们在上面看到的，使用 removeIf 可以将一组复杂的语句简化为一个易于理解的语句。因此，我们不应该试图用 stream 甚至 lambda 表达式替换传统迭代的每个使用场景。相反，在决定是使用函数式编程还是使用传统路线时，我们应该遵循以下规则：</p>
<p><strong>Functional programming and traditional iteration both have their benefits and disadvantages: Use whichever results in the simplest and most readable code</strong></p>
<p>函数式编程和传统的迭代都有其优点和缺点：应该以简易性和可读性为准来选择</p>
<p>Although it may be tempting to use the flashiest, most up-to-date features of Java in every possible scenario, this is not always the best route. Sometimes, the old-school features work best.</p>
<p>尽管在每个可能的场景中使用 Java 最炫、最新的特性可能很让人向往，但这并不总是最好的方法。有时候，老式的功能效果反而最好。</p>
<h2 id="3-Creating-Indiscriminate-Getters-and-Setters"><a href="#3-Creating-Indiscriminate-Getters-and-Setters" class="headerlink" title="3. Creating Indiscriminate Getters and Setters"></a>3. Creating Indiscriminate Getters and Setters</h2><p><strong>滥用 getter 和 setter</strong></p>
<p>One of the first things that novice programmers are taught is to encapsulate the data associated with a class in private fields and expose them through public methods. In practice, this results in creating getters to access the private data of a class and setters to modify the private data of a class:</p>
<p>新手程序员学到的第一件事是将与类相关的数据封装在私有字段中，并通过公共方法公开它们。在实际使用时，通过创建 getter 来访问类的私有数据，创建 setter 来修改类的私有数据：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> value;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>While this is a great practice for newer programmers to learn, it is not a practice that should go unrefined into intermediate or advanced programming. What normally occurs in practice is that every private field is given a pair of getters and setters, exposing the internals of the class to external entities. This can cause some serious issues, especially if the private fields are mutable. This is not only a problem with setters but even when only a getter is present. Take for example the following class, which exposes its only field using a getter:</p>
<p>虽然这对于新程序员来说是一个很好的学习实践，但这种做法不能未经思索就应用在中级或高级编程。在实际中通常发生的情况是，每个私有字段都有一对 getter 和 setter 将类的内部内容公开给外部实体。这会导致一些严重的问题，特别是在私有字段是可变的情况下。这不仅是 setter 的问题，甚至在只有 getter 时也是如此。以下面的类为例，该类使用 getter 公开其唯一的字段：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bar</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Foo foo;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Bar</span><span class="params">(Foo foo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.foo = foo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Foo <span class="title function_">getFoo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> foo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This exposure may seem innocuous since we have wisely restricted removed a setter method, but it is far from it. Suppose that another class accesses an object of type Bar and changes the underlying value of Foo without the Bar object knowing:</p>
<p>由于我们删除了 setter 方法，这么做可能看起来明智且无害，但并非如此。假设另一个类访问 Bar 类型的对象，并在 Bar 对象不知道的情况下更改 Foo 的底层值：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Foo</span> <span class="variable">foo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Foo</span>();</span><br><span class="line"><span class="type">Bar</span> <span class="variable">bar</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bar</span>(foo);</span><br><span class="line"><span class="comment">// Another place in the code</span></span><br><span class="line">bar.getFoo().setValue(-<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>In this case, we have changed the underlying value of the Foo object without informing the Bar object. This can cause some serious problems if the value that we provided the Foo object breaks an invariant of the Bar object. For example, if we had an invariant that stated the value of Foo could not be negative, then the above snippet silently breaks this invariant without notifying the Bar object. When the Bar object goes to use the value of its Foo object, things may go south very quickly, especially if the Bar object assumed that the invariant held since it did not expose a setter to directly reassign the Foo object it held. This can even cause failure to a system if data is severely altered, as in the following example of an array being inadvertently exposed:</p>
<p>在本例中，我们更改了 Foo 对象的基础值，而没有通知 Bar 对象。如果我们提供的 Foo 对象的值破坏了 Bar 对象的一个不变量，这可能会导致一些严重的问题。举个例子，如果我们有一个不变量，它表示 Foo 的值不可能是负的，那么上面的代码片段将在不通知 Bar 对象的情况下静默修改这个不变量。当 Bar 对象使用它的 Foo 对象值时，事情可能会迅速向不好的方向发展，尤其是如果 Bar 对象假设这是不变的，因为它没有暴露 setter 直接重新分配它所保存的 Foo 对象。如果数据被严重更改，这甚至会导致系统失败，如下面例子所示，数组的底层数据在无意中暴露：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArrayReader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String[] array;</span><br><span class="line">    <span class="keyword">public</span> String[] getArray() &#123;</span><br><span class="line">        <span class="keyword">return</span> array;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setArray</span><span class="params">(String[] array)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.array = array;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (String e: array) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Reader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ArrayReader arrayReader;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Reader</span><span class="params">(ArrayReader arrayReader)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.arrayReader = arrayReader;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> ArrayReader <span class="title function_">getArrayReader</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> arrayReader;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">        arrayReader.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ArrayReader</span> <span class="variable">arrayReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayReader</span>();</span><br><span class="line">arrayReader.setArray(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>&#125;);</span><br><span class="line"><span class="type">Reader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reader</span>(arrayReader);</span><br><span class="line">reader.getArrayReader().setArray(<span class="literal">null</span>);</span><br><span class="line">reader.read();</span><br></pre></td></tr></table></figure>

<p>Executing this code would cause a NullPointerException because the array associated with the ArrayReader object is null when it tries to iterate over the array. What is disturbing about this NullPointerException is that it can occur long after the change to the ArrayReader was made and maybe even in an entirely different context (such as in a different part of the code or maybe even in a different thread), making the task of tracking down the problem very difficult.</p>
<p>执行此代码将导致 NullPointerException 异常，因为当 ArrayReader 的实例对象试图遍历数组时，与该对象关联的数组为 null。这个 NullPointerException 异常的令人不安之处在于，它可能在对 ArrayReader 进行更改很久之后才发生，甚至可能发生在完全不同的上下文中（例如在代码的不同部分中，甚至在不同的线程中），这使得调试变得非常困难。</p>
<p>The astute reader may also notice that we could have made the private ArrayReader field final since we did not expose a way to reassign it after it has been set through the constructor. Although it might seem that this would make the ArrayReader constant, ensuring that the ArrayReader object we return cannot be changed, this is not the case. Instead, adding final to a field only ensures that the field itself is not reassigned (i.e. we cannot create a setter for that field). It does not stop the state of the object itself from being changed. If we tried to add final to the getter method, this is futile as well, since final modifier on a method only means that the method cannot be overridden by subclasses.</p>
<p>读者如果仔细考虑，可能还会注意到，我们可以将私有的 ArrayReader 字段设置为 final，因为我们在通过构造函数赋值之后，没有对它重新赋值的方法。虽然这看起来会使 ArrayReader 成为常量，确保我们返回的 ArrayReader 对象不会被更改，但事实并非如此。如果将 final 添加到字段中只能确保字段本身没有重新赋值（即，不能为该字段创建 setter）而不会阻止对象本身的状态被更改。或者我们试图将 final 添加到 getter 方法中，这也是徒劳的，因为方法上的 final 修饰符只意味着该方法不能被子类重写。</p>
<p>We can even go one step further and defensively copy the ArrayReader object in the constructor of Reader, ensuring that the object that was passed into the object cannot be tampered with after it has been supplied to the Reader object. For example, the following cannot happen:</p>
<p>我们甚至可以更进一步考虑，在 Reader 的构造函数中防御性地复制 ArrayReader 对象，确保在将对象提供给 Reader 对象之后，传入该对象的对象不会被篡改。例如，应避免以下情况发生：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ArrayReader</span> <span class="variable">arrayReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayReader</span>();</span><br><span class="line">arrayReader.setArray(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>&#125;);</span><br><span class="line"><span class="type">Reader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reader</span>(arrayReader);</span><br><span class="line">arrayReader.setArray(<span class="literal">null</span>);    <span class="comment">// Change arrayReader after supplying it to Reader</span></span><br><span class="line">reader.read();    <span class="comment">// NullPointerException thrown</span></span><br></pre></td></tr></table></figure>

<p>Even with these three changes (the final modifier on the field, the final modifier on the getter, and the defensive copy of the ArrayReader supplied to the constructor), we still have not solved the problem. The problem is not found in how we are exposing the underlying data of our class, but in the fact that we are doing it in the first place. For us to solve this issue, we have to stop exposing the internal data of our class and instead provide a method to change the underlying data, while still adhering to the class invariants. The following code solves this problem, while at the same time introducing a defensive copy of the supplied ArrayReader and marking the ArrayReader field final, as should be the case since there is no setter:</p>
<p>即使有了这三个更改（字段上增加 final 修饰符、getter 上增加 final 修饰符以及提供给构造函数的 ArrayReader 的防御性副本），我们仍然没有解决问题。问题不在于我们公开底层数据的方式，而是因为我们是在一开始就是错的。要解决这个问题，我们必须停止公开类的内部数据，而是提供一种方法来更改底层数据，同时仍然遵循类不变量。下面的代码解决了这个问题，同时引入了提供的 ArrayReader 的防御性副本，并将 ArrayReader 字段标记为 final，因为没有 setter，所以应该是这样：</p>
<p><strong>译注：原文的如下代码有一处错误，Reader 类中的 setArrayReaderArray 方法返回值类型应为 void，该方法是为了取代 setter，不应产生返回值。</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArrayReader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ArrayReader <span class="title function_">copy</span><span class="params">(ArrayReader other)</span> &#123;</span><br><span class="line">        <span class="type">ArrayReader</span> <span class="variable">copy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayReader</span>();</span><br><span class="line">        String[] originalArray = other.getArray();</span><br><span class="line">        copy.setArray(Arrays.copyOf(originalArray, originalArray.length));</span><br><span class="line">        <span class="keyword">return</span> copy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... Existing class ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Reader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayReader arrayReader;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Reader</span><span class="params">(ArrayReader arrayReader)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.arrayReader = ArrayReader.copy(arrayReader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> ArrayReader <span class="title function_">setArrayReaderArray</span><span class="params">(String[] array)</span> &#123;</span><br><span class="line">        arrayReader.setArray(Objects.requireNonNull(array));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">        arrayReader.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ArrayReader</span> <span class="variable">arrayReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayReader</span>();</span><br><span class="line">arrayReader.setArray(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>&#125;);</span><br><span class="line"><span class="type">Reader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reader</span>(arrayReader);</span><br><span class="line">reader.read();</span><br><span class="line"><span class="type">Reader</span> <span class="variable">flawedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reader</span>(arrayReader);</span><br><span class="line">flawedReader.setArrayReaderArray(<span class="literal">null</span>);    <span class="comment">// NullPointerException thrown</span></span><br></pre></td></tr></table></figure>

<p>If we look at the flawed reader, a NullPointerException is still thrown, but it is thrown immediately when the invariant (that a non-null array is used when reading) is broken, not at some later time. This ensures that the invariant fails-fast, which makes debugging and finding the root of the problem much easier.</p>
<p>如果我们查看这个有缺陷的读取器，它仍然会抛出 NullPointerException 异常，但在不变量（读取时使用非空数组）被破坏时，会立即抛出该异常，而不是在稍后的某个时间。这确保了不变式失败的速度很快，这使得调试和找到问题的根源变得容易得多。</p>
<p>We can take this principle one step further and state that it is a good idea to make the fields of a class completely inaccessible if there is no pressing need to allow for the state of a class to be changed. For example, we could make the Reader class fully encapsulated by removing any methods that modify its state after creation:</p>
<p>我们可以进一步利用这一原则。如果不迫切需要更改类的状态，那么让类的字段完全不可访问是一个好主意。例如，我们可以通过删除所有能够修改 Reader 类实例对象状态的方法，实现 Reader 类的完全封装：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Reader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayReader arrayReader;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Reader</span><span class="params">(ArrayReader arrayReader)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.arrayReader = ArrayReader.copy(arrayReader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">        arrayReader.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ArrayReader</span> <span class="variable">arrayReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayReader</span>();</span><br><span class="line">arrayReader.setArray(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>&#125;);</span><br><span class="line"><span class="type">Reader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reader</span>(arrayReader);</span><br><span class="line"><span class="comment">// No changes can be made to the Reader after instantiation</span></span><br><span class="line">reader.read();</span><br></pre></td></tr></table></figure>

<p>Taking this concept to its logical conclusion, it is a good idea to make a class immutable if it is possible. Thus, the state of the object never changes after the object has been instantiated. For example, we can create an immutable Car object as follows:</p>
<p>从逻辑上总结这个概念，如果可能的话，让类不可变是一个好主意。因此，在实例化对象之后，对象的状态永远不会改变。例如，我们可以创建一个不可变的 Car 对象如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String make;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String model;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Car</span><span class="params">(String make, String model)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.make = make;</span><br><span class="line">        <span class="built_in">this</span>.model = model;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMake</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> make;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getModel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> model;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It is important to note that if the fields of the class are non-primitive, a client can modify the underlying object as we saw above. Thus, immutable objects should return defensive copies of these objects, disallowing clients to modify the internal state of the immutable object. Note, though, that defensive copying can reduce performance since a new object is created each time the getter is called. This issue should not be prematurely optimized (disregarding immutability for the promise of possible performance increases), but it should be noted. The following snippet provides an example of defensive copying for method return values:</p>
<p>需要注意的是，如果类的字段不是基本数据类型，客户端可以如前所述那样修改底层对象。因此，不可变对象应该返回这些对象的防御性副本，不允许客户端修改不可变对象的内部状态。但是请注意，防御性复制会降低性能，因为每次调用 getter 时都会创建一个新对象。对于这个缺陷，不应该过早地进行优化（忽视不可变性，以保证可能的性能提高），但是应该注意到这一点。下面的代码片段提供了一个方法返回值的防御性复制示例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Transmission</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Transmission <span class="title function_">copy</span><span class="params">(Transmission other)</span> &#123;</span><br><span class="line">        <span class="type">Transmission</span> <span class="variable">copy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Transmission</span>();</span><br><span class="line">        copy.setType(other.getType);</span><br><span class="line">        <span class="keyword">return</span> copy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">setType</span><span class="params">(String type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String make;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String model;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Transmission transmission;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Car</span><span class="params">(String make, String model, Transmission transmission)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.make = make;</span><br><span class="line">        <span class="built_in">this</span>.model = model;</span><br><span class="line">        <span class="built_in">this</span>.transmission = Transmission.copy(transmission);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMake</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> make;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getModel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> model;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Transmission <span class="title function_">getTransmission</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Transmission.copy(transmission);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This leaves us with the following principle:</p>
<p>这给我们提示了以下原则：</p>
<p><strong>Make classes immutable, unless there is a pressing need to change the state of a class. All fields of an immutable class should be marked as private and final to ensure that no reassignments are performed on the fields and no indirect access should be provided to the internal state of the fields</strong></p>
<p>使类不可变，除非迫切需要更改类的状态。不可变类的所有字段都应该标记为 private 和 final，以确保不会对字段执行重新赋值，也不会对字段的内部状态提供间接访问</p>
<p>Immutability also brings with it some very important advantages, such as the ability of the class to be easily used in a multi-threaded context (i.e. two threads can share the object without fear that one thread will alter the state of the object while the other thread is accessing that state). In general, there are many more instances that we can create immutable classes than we realize at first: Many times, we add getters or setters out of habit.</p>
<p>不变性还带来了一些非常重要的优点，例如类能够在多线程上下文中轻松使用（即两个线程可以共享对象，而不用担心一个线程会在另一个线程访问该状态时更改该对象的状态）。总的来说，在很多实际情况下我们可以创建不可变的类，要比我们意识到的要多很多，只是我们习惯了添加了 getter 或 setter。</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p><strong>结论</strong></p>
<p>Many of the applications we create end up working, but in a large number of them, we introduce sneaky problems that tend to creep up at the worst possible times. In some of those cases, we do things out of convenience, or even out of habit, and pay little mind to whether these idioms are practical (or safe) in the context we use them. In this article, we delved into three of the most common of these practices, such null return values, affinity for functional programming, and careless getters and setters, along with some pragmatic alternatives. While the rules in this article should not be taken as absolute, they do provide some insight into the uncommon dangers of common practices and may help in fending off laborious errors in the future.</p>
<p>我们创建的许多应用程序最终都能正常工作，但是在大量应用程序中，我们无意引入的一些问题可能只会在最极端的情况下出现。在某些情况下，我们做事情是出于方便，甚至是出于习惯，而很少注意这些习惯在我们使用的上下文中是否实用（或安全）。在本文中，我们深入研究了在实际应用中最常见的三种问题，如：空返回值、函数式编程的魅力、粗心的 getter 和 setter，以及一些实用的替代方法。虽然本文中的规则不是绝对的，但是它们确实为一些在实际应用中遇到的罕见问题提供了见解，并且在将来可能会有助于避免产生一些需要费力解决的错误。</p>
]]></content>
      <categories>
        <category>文献翻译</category>
        <category>java</category>
      </categories>
      <tags>
        <tag>未标记</tag>
      </tags>
  </entry>
  <entry>
    <title>9-differences-between-Array-and-ArrayList-in-Java</title>
    <url>/46868f90-2bb6-11ee-879b-0b2c36f14b2e/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h1 id="9-differences-between-Array-and-ArrayList-in-Java"><a href="#9-differences-between-Array-and-ArrayList-in-Java" class="headerlink" title="9 differences between Array and ArrayList in Java"></a>9 differences between Array and ArrayList in Java</h1><p><strong>Java 中数组和 ArrayList 的 9 个区别</strong></p>
<blockquote>
<p>转译自：<a href="https://www.javacodegeeks.com/2016/01/9-differences-between-array-and-arraylist-in-java.html">https://www.javacodegeeks.com/2016/01/9-differences-between-array-and-arraylist-in-java.html</a></p>
</blockquote>
<p>Both array and ArrayList are two important data structures in Java and are frequentl used in Java programs. Even though ArrayList is internally backed by an array, knowing the difference between an array and an ArrayList in Java is critical for becoming a good Java developer. If you know the similarity and differences, you can judiciously decide when to use an array over an AraryList or vice-versa.</p>
<p>数组和 ArrayList 都是 Java 中非常重要的数据结构，在 Java 程序中经常使用。虽然 ArrayList 是由数组内部支持的，了解 Java 中数组和 ArrayList 之间的区别对于成为一名优秀的 Java 开发人员至关重要。如果你知道相似性和差异性，你就可以明智地决定何时以 AraryList（取代）数组，反之亦然。</p>
<p>In this article, I’ll help you understand the difference. If you are coming from C or C++ background then you already know that array is one of the most useful data structure in the programming world. It offers O(1) performance for index-based search and one of the fundamental way to store data.</p>
<p>在本文中，我将帮助你理解其中的区别。如果你有 C 或 C++ 背景，那么肯定知道数组是编程世界中最有用的数据结构之一。它为基于索引的搜索提供了 O(1) 性能，是存储数据的基本方式之一。</p>
<p>The ArrayList one the other hand is a class in Java Collection framework which was introduced as a dynamic array. Since an array is static in nature i.e. you cannot change the size of an array once created, So, if you need an array which can resize itself then you should use the ArrayList. This is the fundamental difference between an array and an ArrayList.</p>
<p>ArrayList 是 Java 集合框架中的一个类，作为动态数组引入。由于数组本质上是静态的，也就是说，一旦创建了数组，你就不能更改数组的大小，因此，如果你需要一个能够调整自身大小的数组，那么你应该使用 ArrayList。这是数组和 ArrayList 的基本区别。</p>
<h2 id="Array-vs-ArrayList-in-Java"><a href="#Array-vs-ArrayList-in-Java" class="headerlink" title="Array vs ArrayList in Java"></a>Array vs ArrayList in Java</h2><p><strong>Java 中的数组与 ArrayList</strong></p>
<p>It’s best to compare two things on some points, this will make the differences easy to understand. So let’s see what are the points on which you can compare an array with the ArrayList in Java</p>
<p>最好在某些技术点上比较两件事情，这将使两者的区别容易理解。那么，让我们看看在哪些技术点上可以将数组与 Java 中的 ArrayList 进行比较。</p>
<h2 id="1、Implementation"><a href="#1、Implementation" class="headerlink" title="1、Implementation"></a>1、Implementation</h2><p><strong>实现</strong></p>
<p>The array is a native programming component or data structure but ArrayList is a class from Java Collections framework, an API. In fact, ArrayList is internally implemented using an array. Since ArrayList is a class, it holds all properties of a class e.g. you can create objects and call methods but even though the array is an object in Java it doesn’t provide any method. It just exposes a length attribute to give you the length of the array, which is constant.</p>
<p>数组是原生编程组件或数据结构，而 ArrayList 是 Java 集合框架中的一个类，是一个 API。实际上，ArrayList 内部是使用数组实现的。因为 ArrayList 是一个类，它包含一个类的所有属性，例如，你可以创建对象和调用方法，但即使数组是 Java 中的一个对象，它也不提供任何方法。它只是公开了一个 length 属性来给你数组的长度，这是常量。</p>
<h2 id="2、Performance"><a href="#2、Performance" class="headerlink" title="2、Performance"></a>2、Performance</h2><p><strong>性能</strong></p>
<p>Since ArrayList is based upon array, you would assume that it provides the same performance as an array. This is true at some extent but because of extra functionality ArrayList provides there is some difference in performance between ArrayList and array, mainly in terms of memory usage and CPU time.</p>
<p>由于 ArrayList 是基于数组的，因此可以假设它提供了与数组相同的性能。这在某种程度上是正确的，但是由于 ArrayList 提供了额外的功能，所以 ArrayList 和数组之间的性能有一些不同，主要是在内存使用和 CPU 时间方面。</p>
<p>For index-based access, both ArrayList and array provides <strong>O(1)</strong> performance but add can be <strong>O(logN)</strong> in ArrayList if adding a new element triggers resize, as it involves creating a new array in background and copying elements from the old array to new array. The memory requirement for ArrayList is also more than an array for storing the same number of objects e.g. an int[] will take less memory to store 20 int variables than an ArrayList because of object metadata overhead on both ArrayList and wrapper class.</p>
<p>对于基于索引的访问，ArrayList 和数组都提供了 O(1) 性能，但是如果在 ArrayList 中添加一个新元素会触发调整大小，那么 add 可以是 O(logN)，因为它涉及在后台创建一个新数组，并将元素从旧数组复制到新数组。ArrayList 的内存需求也不仅仅是存储相同数量对象的数组，例如 int[] 比 ArrayList 存储 20 个 int 变量所需内存更少，因为 ArrayList 和包装类上都有对象元数据开销。</p>
<h2 id="3、Type-Safety"><a href="#3、Type-Safety" class="headerlink" title="3、Type Safety"></a>3、Type Safety</h2><p><strong>类型安全</strong></p>
<p>ArrayList is type safe because it supports generics which allows the compiler to check if all objects stored in ArrayList are of the correct type. On the other hand, the array doesn’t support Generics. Which means compile time checking is not possible but array provides runtime type checking by throwing ArrayStoreException if you try to store an incorrect object into array e.g. storing a String into an int array.</p>
<p>ArrayList 是类型安全的，因为它支持泛型，允许编译器检查存储在 ArrayList 中的所有对象是否都是正确的类型。另一方面，数组不支持泛型。这意味着编译时检查是不可能的，但是如果你试图将一个不正确的对象存储到数组中，例如将一个字符串存储到 int 数组中，数组通过抛出 ArrayStoreException（体现）提供了运行时类型检查。</p>
<h2 id="4、Flexibility"><a href="#4、Flexibility" class="headerlink" title="4、Flexibility"></a>4、Flexibility</h2><p><strong>灵活性</strong></p>
<p>Flexibility is the single most important thing that separates array and ArrayList. In short, ArrayList is more flexible than a plain native array because it’s dynamic. It can grow itself when needed, which is not possible with the native array. ArrayList also allows you to remove elements which are not possible with native arrays. By remove, we mean not just assigning null to the corresponding index but also copying rest of elements one index down, which ArrayList automatically does for you. You can learn more about removing objects from ArayList in my article <strong><em>difference between clear() and removeAll()</em></strong>.</p>
<p>灵活性是区分数组和数组列表最重要的一点。简而言之，ArrayList 比普通的原生数组更灵活，因为它是动态的。它可以在需要时自行增长，这在原生数组中是不可能的。ArrayList 还允许删除原生数组无法删除的元素。所谓删除，我们的意思不仅仅是给相应的索引分配 null，还包括将其他元素的一个索引复制下来，ArrayList 会自动为你这样做。在我的文章《clear() 和 removeAll() 的区别》中，你可以了解关于从 ArayList 中删除对象的更多信息。</p>
<h2 id="5、Primitives"><a href="#5、Primitives" class="headerlink" title="5、Primitives"></a>5、Primitives</h2><p><strong>基本数据类型</strong></p>
<p>If you first start using ArrayList then you will realize that you cannot store primitives on ArrayList. This is a key difference between array and ArrayList because array allows storing both primitives and object. For example int[] numbers are valid but ArrayList of int is not valid. how do you deal with this problem?</p>
<p>如果你第一次开始使用 ArrayList，那么你将意识到不能在 ArrayList 上存储基本数据类型。这是数组和 ArrayList 之间的一个关键区别，因为数组允许存储基本数据类型和对象。例如 int[] 数字是有效的，但是 ArrayList 是无效的。你如何处理这个问题？</p>
<p>Suppose you want to store int primitives into ArrayList than how do you that? Well, you can use the wrapper class. This is one of the reasons why wrapper class was introduced in Java. So if you want to store int 2 into ArrayList just put it, autoboxing will do the rest. Btw, this difference is not so obvious from Java 5 onwards because of auto-boxing as you will see that ArrayList.add(21) is perfectly valid and works.</p>
<p>假设你想把 int 类型存储到 ArrayList 中，你会怎么做？你可以使用包装器类。这是 Java 中引入包装类的原因之一。如果你想把 int 2 存储到 ArrayList 中，只要把它放进去，自动装箱就能完成剩下的。顺便说一下，从 Java 5 开始，由于自动装箱的原因，这种差异就不那么明显了，因为你将看到 ArrayList.add(21) 是完全有效的，并且可以工作。</p>
<h2 id="6、Generics"><a href="#6、Generics" class="headerlink" title="6、Generics"></a>6、Generics</h2><p><strong>泛型</strong></p>
<p>One more significant（重要的） difference between an ArrayList and an array is that the former supports Generic but the latter doesn’t. Since an array is of covariant type, you can use Generics with them. This means it’s not possible for a compiler to check the type-safety of an array at compile time but they can verify type-safety of Array. So how do you deal with this problem while writing a type-safe class in Java? Well, you can use the technique shown in Effective Java, where you can declare an array like E[] and later use type casting.</p>
<p>ArrayList 和数组的另一个重要区别是前者支持泛型，而后者不支持泛型。由于数组是协变类型的，所以可以使用泛型。这意味着编译器不可能在编译时检查数组的类型安全性，但它们可以验证数组的类型安全性。那么，在用 Java 编写类型安全类时，如何处理这个问题呢？你可以使用 Effective Java 中所示的技术，可以声明一个像 E[] 这样的数组，然后使用类型转换。</p>
<h2 id="7、Iteration"><a href="#7、Iteration" class="headerlink" title="7、Iteration"></a>7、Iteration</h2><p><strong>迭代</strong></p>
<p>ArrayList provides more ways for iteration i.e. accessing all elements one by one than an array. You can only use loop e.g. for, while, enhanced for loop and do-while to iterate over an array but you can also use Iterator and ListIterator class to iterate over ArrayList. See here to learn different ways to iterate over ArrayList in Java.</p>
<p>ArrayList 相比数组而言为迭代，即逐个访问所有元素，提供了更多的方法。你只能使用 for 循环、 while 循环、增强 for 循环和 do-while 来迭代数组，但你也可以使用 Iterator 和 ListIterator 类来迭代 ArrayList。请参阅此处以了解在 Java 中迭代 ArrayList 的不同方法。</p>
<h2 id="8、Supported-Operations"><a href="#8、Supported-Operations" class="headerlink" title="8、Supported Operations"></a>8、Supported Operations</h2><p><strong>运算符支持</strong></p>
<p>Since ArrayList is backed by an array internally, it exposes（揭露） the operation which is possible with an array but given its dynamic nature it also added operation which is not possible with native array e.g. you can store elements in both array and ArrayList, but only ArrayList allows you to remove an element. Though you can simulate that with an array by assigning null to respective index, it won’t be like remove unless you also move all element above that index in the array to one level down.</p>
<p>因为 ArrayList 是由数组在内部支持的，所以它公开了使用数组可以实现的操作，但考虑到它的动态特性，它还添加了使用原生数组不可能实现的操作，例如，你可以在数组和 ArrayList 中存储元素，但只有 ArrayList 允许你删除元素。虽然你可以通过将 null 赋值给相应的索引来模拟这个过程，但是它不会像 remove （方法）那样，除非你还将数组中位于该索引之上的所有元素向下移动一层。</p>
<p>Both ArrayList and array provide ways to retrieve an element e.g. get() method of ArrayList uses an index to get an element from array e.g. version[0] will return the first element.</p>
<p>ArrayList 和数组都提供了检索元素的方法，例如 ArrayList 的 get() 方法使用索引从数组中获取元素，例如 version[0] 将返回第一个元素。</p>
<p>ArrayList also provides an operation to clear and reuse（重 chong 用） e.g. clear() and removeAll(), the array doesn’t provide that but you can loop over Array and assign each index null to simulate that.</p>
<p>ArrayList 还提供了一个清除和重用的操作，例如 clear() 和 removeAll()，数组没有提供这个功能，但是你可以用循环数组，为每个索引分配 null 的方式来模拟它。</p>
<h2 id="9、Size-vs-length"><a href="#9、Size-vs-length" class="headerlink" title="9、Size() vs length"></a>9、Size() vs length</h2><p><strong>Size() 方法与 length 属性</strong></p>
<p>Array only provides a length attribute which tells you the number of slots in the array i.e. how many elements it can store, it doesn’t provide you any method to find out how many are filled and how many slots are empty i.e. the current number of elements. While ArrayList does provides a size() method which tells a number of objects stored in ArrayList at a given point of time. The size() is always different than length, which is also the capacity of ArrayList. If you want to know more, I suggest you read the difference between size() and length in ArrayList article.</p>
<p>数组只提供一个 length 属性，它告诉你数组中的槽数，也就是它可以存储多少个元素，它不提供任何方法来找出有多少个被填充，有多少个槽是空的，也就是当前元素的数量。虽然 ArrayList 提供了一个 size() 方法，它告诉在给定时间点存储在 ArrayList 中的许多对象。size() 总是与 length 不同，length 也是 ArrayList 的容量。如果你想了解更多，我建议你阅读 ArrayList 文章中的 size() 和 length 之间的区别。</p>
<h2 id="10、Dimension"><a href="#10、Dimension" class="headerlink" title="10、Dimension"></a>10、Dimension</h2><p><strong>维度</strong></p>
<p>Another significant（重要的） difference between an array and an ArrayList is that array can be multi-dimensional e.g. you can have a two-dimensional array or a three-dimensional array, which makes it a really special data structure to represent matrices and 2D terrains. On the other hand, ArrayList doesn’t allow you to specify dimension. See this tutorial learn more about how to use a multi-dimensional array in Java.</p>
<p>数组和 ArrayList 的另一个重要区别是，数组可以是多维的，例如，你可以有一个二维数组或三维数组，这使得它可以成为一种非常特殊的数据结构来表示矩阵和二维地形。另一方面，ArrayList 不允许指定维度。请参阅本教程，了解如何在 Java 中使用多维数组。</p>
<p>Here is the nice slide highlighting all important difference between Array and ArrayList in Java:</p>
<p>下面这张幻灯片（<strong>注：已将图片内容转为文字</strong>）突出了 Java 中数组和 ArrayList 的所有重要区别：</p>
<h2 id="Difference-between-array-vs-ArrayList-in-Java"><a href="#Difference-between-array-vs-ArrayList-in-Java" class="headerlink" title="Difference between array vs ArrayList in Java"></a>Difference between array vs ArrayList in Java</h2><p><strong>Java 中数组与 ArrayList 的区别</strong></p>
<p>1、An array is static, you cannot change it’s length once created, but ArrayList is dynamic, it can grow to accommodate more elements.</p>
<p>数组是静态的，一旦创建就不能改变它的长度，但是 ArrayList 是动态的，它可以增长以适应更多的元素。</p>
<p>2、The array doesn’t support generics, hence they are not type-safe but ArrayList support Generics, hence they provide compile time type-safety.</p>
<p>数组不支持泛型，因此它们不是类型安全的，但是 ArrayList 支持泛型，因此它们提供编译时类型安全。</p>
<p>3、Array takes less memory than Arrayist for storing same number of elements or objects.</p>
<p>在存储相同数量的元素或对象时，数组比 Arrayist 占用更少的内存。</p>
<p>4、ArrayList allows you to remove element, but array doesn’t provide such methods.</p>
<p>ArrayList 允许删除元素，但数组不提供这样的方法。</p>
<p>5、Array can accommodate both primitive and objects, but Arraylist can only accommodate objects.</p>
<p>数组可以同时容纳基础数据类型和对象，但 Arraylist 只能容纳对象。</p>
<p>译注：本文第 5 点提到了，从 Java 5 开始 Arraylist 也能容纳基础数据类型</p>
<p>6、Array can be multi-dimensional but ArrayList is always one dimensional.</p>
<p>数组可以是多维的，但 ArrayList 总是一维的。</p>
<p>译注：应该说 ArrayList 默认是一维的，如果每个元素也是一个 ArrayList，可以间接实现多维</p>
<p>7、Array provides length attribute and ArrayList provides size() but both are different, length is capacity, while size() return number of elements.</p>
<p>数组提供 length 属性，ArrayList 提供 size()，但两者不同，length 是容量，size() 返回元素数量。</p>
<h2 id="Similarities-between-Array-and-ArrayList"><a href="#Similarities-between-Array-and-ArrayList" class="headerlink" title="Similarities between Array and ArrayList"></a>Similarities between Array and ArrayList</h2><p><strong>数组和数组列表的相似性</strong></p>
<p>So far you have seen the difference between an ArrayList and an array, now let’s concentrate（关注） on some of the similarities. Since ArrayList internally uses array, it’s bound to have lot of similarities as seen below:</p>
<p>到目前为止，你已经看到了 ArrayList 和数组之间的区别，现在让我们关注一些相似之处。由于 ArrayList 内部使用数组，两者肯定有很多相似之处，如下所示：</p>
<h2 id="1、Data-Structure"><a href="#1、Data-Structure" class="headerlink" title="1、Data Structure"></a>1、Data Structure</h2><p><strong>数据结构</strong></p>
<p>Both allow you to store objects in Java and both are an index-based data structure which provides O(1) performance to retrieve an element, but search without an index is still log(N) if your array is sorted and you use binary search algorithm.</p>
<p>这两种方法都允许在 Java 中存储对象，并且都是基于索引的数据结构，它提供了 O(1) 性能来检索元素，但是如果数组是有序的，并且使用二进制搜索算法，那么没有索引的搜索仍然是 log(N)。</p>
<h2 id="2、Order"><a href="#2、Order" class="headerlink" title="2、Order"></a>2、Order</h2><p><strong>有序性</strong></p>
<p>Both array and ArrayList maintain order on which elements are added into them.</p>
<p>数组和 ArrayList 的元素顺序就是添加时的顺序。</p>
<h2 id="3、Search"><a href="#3、Search" class="headerlink" title="3、Search"></a>3、Search</h2><p><strong>搜索</strong></p>
<p>You can search for an element using an index, that’s O(1) otherwise you can use linear search if your array is not sorted, which takes around O(n) time or you can use binary search after sorting an array in Java, this is sorting + O(logN).</p>
<p>你可以用索引来搜索一个元素，它是 O(1) 的，如果你的数组没有排序，你可以用线性搜索，这需要大约 O(n) 的时间，或者你可以用二分法检索，在 Java 中对一个数组排序后，这种排序的时间复杂度为 O(logN)。</p>
<h2 id="4、Null-values"><a href="#4、Null-values" class="headerlink" title="4、Null values"></a>4、Null values</h2><p><strong>Null 值</strong></p>
<p>Both array and ArrayList allow null values but remember only object array allows null primitive array doesn’t they store the default value of primitive type e.g. zero for int and false for boolean.</p>
<p>数组和 ArrayList 都允许 null 值，但记住只有对象数组允许 null 基本数据类型数组，它们不存储基本数据类型类型的默认值，例如，0 表示 int, false 表示 boolean。</p>
<h2 id="5、Duplicates"><a href="#5、Duplicates" class="headerlink" title="5、Duplicates"></a>5、Duplicates</h2><p><strong>重复</strong></p>
<p>Both array and ArrayList allow duplicates. It’s also one of the common array based coding questions to write a program to find out duplicates from an array in place.</p>
<p>数组和 ArrayList 都允许（元素）重复。它也是一个常见的基于数组的编码问题，即编写一个程序从一个数组中找出（元素）副本。</p>
<h2 id="6、Performance"><a href="#6、Performance" class="headerlink" title="6、Performance"></a>6、Performance</h2><p><strong>性能</strong></p>
<p>ArrayList mimic array’s performance e.g. O(1) access if you know the index but it has additional memory overhead because it’s an object and also holds additional data to automatic resize the ArrayList.</p>
<p>ArrayList 模拟数组的性能，如 O(1) 访问，如果你知道索引，但是它有额外的内存开销，因为它是一个对象，而且还包含额外的数据来自动调整 ArrayList 的大小。</p>
<h2 id="7、Zero-based-Index"><a href="#7、Zero-based-Index" class="headerlink" title="7、Zero-based Index"></a>7、Zero-based Index</h2><p><strong>从零开始的索引</strong></p>
<p>Both array and ArrayList have zero-based index i.e. first element starts at zeroth index.</p>
<p>数组和 ArrayList 都有从零开始的索引，即第一个元素从第 0 个索引开始。</p>
<p>The most important difference you should remember is that array is static in nature i.e. you cannot change their size once created but ArrayList is a dynamic array, which can resize itself if a number of elements in the ArrayList are more than the resize threshold. Based upon this difference, you should use an array as a data structure to store objects if you know the size in advance and sure it’s not going to change, if you are unsure then just use the ArrayList.</p>
<p>你应该记住的最重要的区别是数组本质上是静态的，也就是说你不能改变它们的大小，但是 ArrayList 是一个动态数组，如果 ArrayList 中的一些元素超过了阈值，它可以调整自己的大小。基于这种差异，如果你事先知道对象的大小并且确定不会改变对象的大小，那么你应该使用数组作为数据结构来存储对象，如果你不确定，那么就使用 ArrayList。</p>
]]></content>
      <categories>
        <category>文献翻译</category>
        <category>java</category>
      </categories>
      <tags>
        <tag>未标记</tag>
      </tags>
  </entry>
  <entry>
    <title>Enabling-Cross-Origin-Requests-for-a-RESTful-Web-Service</title>
    <url>/4686b6a0-2bb6-11ee-879b-0b2c36f14b2e/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h1 id="Enabling-Cross-Origin-Requests-for-a-RESTful-Web-Service"><a href="#Enabling-Cross-Origin-Requests-for-a-RESTful-Web-Service" class="headerlink" title="Enabling Cross Origin Requests for a RESTful Web Service"></a>Enabling Cross Origin Requests for a RESTful Web Service</h1><p><strong>为 RESTful Web 服务启用跨域请求</strong></p>
<blockquote>
<p>转译自：<a href="https://spring.io/guides/gs/rest-service-cors/">https://spring.io/guides/gs/rest-service-cors/</a></p>
</blockquote>
<p>This guide walks you through the process of creating a “Hello, World” RESTful web service with Spring that includes headers for Cross-Origin Resource Sharing (CORS) in the response. You can find more information about Spring CORS support in this blog post.</p>
<p>本指南指导你使用 Spring 创建「Hello, World」RESTful Web 服务，包括响应跨域资源共享（CORS）头。你可以在这篇博客文章中找到更多关于 Spring 支持 CORS 的信息。</p>
<h2 id="What-You-Will-Build"><a href="#What-You-Will-Build" class="headerlink" title="What You Will Build"></a>What You Will Build</h2><p><strong>你将创建什么项目</strong></p>
<p>You will build a service that accepts HTTP GET requests at <a href="http://localhost:8080/greeting">http://localhost:8080/greeting</a> and responds with a JSON representation of a greeting, as the following listing shows:</p>
<p>你将建立一个服务器端，它能够接受一个 HTTP GET 请求 <a href="http://localhost:8080/greeting%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%93%8D%E5%BA%94%E4%B8%80%E4%B8%AA">http://localhost:8080/greeting，并且响应一个</a> JSON 格式的数据，如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;id&quot;</span>:<span class="number">1</span>,<span class="string">&quot;content&quot;</span>:<span class="string">&quot;Hello, World!&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>You can customize the greeting with an optional name parameter in the query string, as the following listing shows:</p>
<p>你可以在这个查询中为这个问候语定义一个可选的 name 参数，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://localhost:8080/greeting?name=User</span><br></pre></td></tr></table></figure>

<p>The name parameter value overrides the default value of World and is reflected in the response, as the following listing shows:</p>
<p>name 参数值将覆盖默认值「World」并体现在响应中，如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;id&quot;</span>:<span class="number">1</span>,<span class="string">&quot;content&quot;</span>:<span class="string">&quot;Hello, User!&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>This service differs slightly from the one described in Building a RESTful Web Service, in that it uses Spring Framework CORS support to add the relevant CORS response headers.</p>
<p>这个服务与其他构建 RESTful Web Service 中描述的服务略有不同，因为它使用 Spring Framework CORS 支持来添加相关的 CORS 响应头。</p>
<h2 id="What-You-Need"><a href="#What-You-Need" class="headerlink" title="What You Need"></a>What You Need</h2><p><strong>需要如下环境</strong></p>
<ul>
<li>About 15 minutes</li>
<li>A favorite text editor or IDE</li>
<li>JDK 1.8 or later</li>
<li>Gradle 4+ or Maven 3.2+</li>
<li>You can also import the code straight into your IDE:<ul>
<li>Spring Tool Suite (STS)</li>
<li>IntelliJ IDEA</li>
</ul>
</li>
</ul>
<h2 id="How-to-complete-this-guide"><a href="#How-to-complete-this-guide" class="headerlink" title="How to complete this guide"></a>How to complete this guide</h2><p><strong>如何完成这个指南</strong></p>
<p>Like most Spring Getting Started guides, you can start from scratch and complete each step or you can bypass basic setup steps that are already familiar to you. Either way, you end up with working code.</p>
<p>就像大多数 Spring 入门指南一样，你可以从头开始并完成每个步骤，也可以跳过已经熟悉的基本设置步骤。无论哪种方式，最终得到的都是能够工作的代码。</p>
<p>To <strong>start from scratch</strong>, move on to Starting with Spring Initializr.</p>
<p>要从头开始，请继续从 Spring Initializr 开始。</p>
<p>To <strong>skip the basics</strong>, do the following:</p>
<p>要跳过这些基本步骤，请执行以下步骤:</p>
<ul>
<li>Download and unzip the source repository for this guide, or clone it using Git: <code>git clone https://github.com/spring-guides/gs-rest-service-cors.git</code></li>
</ul>
<p>下载并解压本指南的源码存储库，或者使用 Git 克隆它：<code>git clone https://github.com/spring-guides/gs-rest-service-cors.git</code></p>
<ul>
<li>cd into gs-rest-service-cors&#x2F;initial</li>
</ul>
<p>进入 <code>gs-rest-service-cors/initial</code> 目录</p>
<ul>
<li>Jump ahead to Create a Resource Representation Class.</li>
</ul>
<p>跳到 Create a Resource Representation Class 前面。</p>
<p><strong>When you finish</strong>, you can check your results against the code in <code>gs-rest-service-cors/complete</code>.</p>
<p>完成后，可以根据 <code>gs-rest-service-cors/complete</code> 目录中的代码检查结果。</p>
<h2 id="Starting-with-Spring-Initializr"><a href="#Starting-with-Spring-Initializr" class="headerlink" title="Starting with Spring Initializr"></a>Starting with Spring Initializr</h2><p><strong>从 Spring Initializr 开始</strong></p>
<p>For all Spring applications, you should start with the Spring Initializr. The Initializr offers a fast way to pull in all the dependencies you need for an application and does a lot of the setup for you. This example needs only the Spring Web dependency. The following image shows the Initializr set up for this sample project:</p>
<p>对于所有 Spring 应用程序，应该从 Spring Initializr 开始。Initializr 提供了一种快捷方法来获取应用程序所需的所有依赖项，并做了大量的设置工作。这个例子只需要 Spring Web 依赖项。下图显示了为这个示例项目设置的 Initializr：</p>
<p>（原文该处为 Spring Initializr 页面图片，略）</p>
<blockquote>
<p>The preceding image shows the Initializr with Maven chosen as the build tool. You can also use Gradle. It also shows values of com.example and rest-service-cors as the Group and Artifact, respectively. You will use those values throughout the rest of this sample.</p>
</blockquote>
<p>前面的图片显示了项目以 Maven 作为 Initializr 的构建工具。你也可以使用 Gradle。它还显示了 com.example 的值。将 rest-service-cors 分别作为 Group 和 Artifact 的值。在本示例的其余部分中会使用这些值。</p>
<p>The following listing shows the pom.xml file that is created when you choose Maven:</p>
<p>当选择 Maven 作为构建工具时，生成的 pom.xml 文件如下所示：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rest-service-cors<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>rest-service-cors<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>The following listing shows the build.gradle file that is created when you choose Gradle:</p>
<p>当选择 Gradle 作为构建工具时，生成的 build.gradle 文件如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">	id <span class="string">&#x27;org.springframework.boot&#x27;</span> version <span class="string">&#x27;2.2.0.RELEASE&#x27;</span></span><br><span class="line">	id <span class="string">&#x27;io.spring.dependency-management&#x27;</span> version <span class="string">&#x27;1.0.8.RELEASE&#x27;</span></span><br><span class="line">	id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group = <span class="string">&#x27;com.example&#x27;</span></span><br><span class="line">version = <span class="string">&#x27;0.0.1-SNAPSHOT&#x27;</span></span><br><span class="line">sourceCompatibility = <span class="string">&#x27;1.8&#x27;</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">	mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">	implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-web&#x27;</span></span><br><span class="line">	testImplementation(<span class="string">&#x27;org.springframework.boot:spring-boot-starter-test&#x27;</span>) &#123;</span><br><span class="line">		exclude <span class="attr">group:</span> <span class="string">&#x27;org.junit.vintage&#x27;</span>, <span class="attr">module:</span> <span class="string">&#x27;junit-vintage-engine&#x27;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test &#123;</span><br><span class="line">	useJUnitPlatform()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Adding-the-httpclient-Dependency"><a href="#Adding-the-httpclient-Dependency" class="headerlink" title="Adding the httpclient Dependency"></a>Adding the httpclient Dependency</h2><p><strong>增加 httpclient 依赖</strong></p>
<p>The tests (in complete&#x2F;src&#x2F;test&#x2F;java&#x2F;com&#x2F;example&#x2F;restservicecors&#x2F;GreetingIntegrationTests.java) require the Apache httpclient library.</p>
<p>单元测试（路径为 <code>complete/src/test/java/com/example/restservicecors/GreetingIntegrationTests.java</code>）需要 Apache httpclient 库。</p>
<p>To add the Apache httpclient library to Maven, add the following dependency:</p>
<p>在 Maven 增加 Apache httpclient 库的依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>The following listing shows the finished pom.xml file:</p>
<p>最终的 pom.xml 文件如下所示：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rest-service-cors<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>rest-service-cors<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>To add the Apache httpclient library to Gradle, add the following dependency:</p>
<p>在 Gradle 增加 Apache httpclient 库的依赖：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">testImplementation <span class="string">&#x27;org.apache.httpcomponents:httpclient&#x27;</span></span><br></pre></td></tr></table></figure>

<p>The following listing shows the finished build.gradle file:</p>
<p>最终的 build.gradle 文件如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">	id <span class="string">&#x27;org.springframework.boot&#x27;</span> version <span class="string">&#x27;2.2.0.RELEASE&#x27;</span></span><br><span class="line">	id <span class="string">&#x27;io.spring.dependency-management&#x27;</span> version <span class="string">&#x27;1.0.8.RELEASE&#x27;</span></span><br><span class="line">	id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group = <span class="string">&#x27;com.example&#x27;</span></span><br><span class="line">version = <span class="string">&#x27;0.0.1-SNAPSHOT&#x27;</span></span><br><span class="line">sourceCompatibility = <span class="string">&#x27;1.8&#x27;</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">	mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">	implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-web&#x27;</span></span><br><span class="line">	testImplementation <span class="string">&#x27;org.apache.httpcomponents:httpclient&#x27;</span></span><br><span class="line">	testImplementation(<span class="string">&#x27;org.springframework.boot:spring-boot-starter-test&#x27;</span>) &#123;</span><br><span class="line">		exclude <span class="attr">group:</span> <span class="string">&#x27;org.junit.vintage&#x27;</span>, <span class="attr">module:</span> <span class="string">&#x27;junit-vintage-engine&#x27;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test &#123;</span><br><span class="line">	useJUnitPlatform()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Create-a-Resource-Representation-Class"><a href="#Create-a-Resource-Representation-Class" class="headerlink" title="Create a Resource Representation Class"></a>Create a Resource Representation Class</h2><p><strong>创建资源表示类</strong></p>
<p>Now that you have set up the project and build system, you can create your web service.</p>
<p>现在已经建立了项目和构建系统，可以创建 web 服务了。</p>
<p>Begin the process by thinking about service interactions.</p>
<p>在这个过程中考虑服务交互。</p>
<p>The service will handle GET requests to &#x2F;greeting, optionally with a name parameter in the query string. The GET request should return a 200 OK response with JSON in the body to represent a greeting. It should resemble the following listing:</p>
<p>该服务将处理 <code>/greeting</code> 的 GET 请求，也可以在查询字符串中使用 name 参数。GET 请求应该返回一个包含 JSON 的 <code>200 OK</code> 响应来表示问候语。它应该与如下所示类似：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello, World!&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>The id field is a unique identifier for the greeting, and content is the textual representation of the greeting.</p>
<p>id 字段是问候语的唯一标识符，而内容是问候语的文本表示。</p>
<p>To model the greeting representation, create a resource representation class. Provide a plain old Java object with fields, constructors, and accessors for the id and content data, as the following listing (from <code>src/main/java/com/example/restservicecors/Greeting.java</code>) shows:</p>
<p>要对问候语表示进行建模，请创建一个资源表示类。为 id 和内容数据提供一个普通的旧 Java 对象，包含字段、构造函数和访问器，如下所示（来自 <code>src/main/ Java /com/example/restservicecors/Greeting.java</code>）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.restservicecors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Greeting</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> id;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String content;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Greeting</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.id = -<span class="number">1</span>;</span><br><span class="line">		<span class="built_in">this</span>.content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">Greeting</span><span class="params">(<span class="type">long</span> id, String content)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.id = id;</span><br><span class="line">		<span class="built_in">this</span>.content = content;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getContent</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> content;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Spring uses the Jackson JSON library to automatically marshal instances of type Greeting into JSON.</p>
</blockquote>
<p>Spring 使用 Jackson JSON 库自动将 Greeting 类型的实例封装到 JSON 中。</p>
<h2 id="Create-a-Resource-Controller"><a href="#Create-a-Resource-Controller" class="headerlink" title="Create a Resource Controller"></a>Create a Resource Controller</h2><p><strong>创建资源控制器</strong></p>
<p>In Spring’s approach to building RESTful web services, HTTP requests are handled by a controller. These components are easily identified by the @Controller annotation, and the GreetingController shown in the following listing (from <code>src/main/java/com/example/restservicecors/GreetingController.java</code>) handles GET requests for &#x2F;greeting by returning a new instance of the Greeting class:</p>
<p>在 Spring 构建 RESTful web 服务的方式中，HTTP 请求由控制器处理。这些组件很容易通过 <code>@Controller</code> 注解定义，下面清单中显示的 GreetingController（来自 <code>src/main/java/com/example/restservicecors/GreetingController.java</code>）通过返回 Greeting 类的一个新实例来处理 GET 请求 <code>/greeting</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.restservicecors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.CrossOrigin;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GreetingController</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">template</span> <span class="operator">=</span> <span class="string">&quot;Hello, %s!&quot;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/greeting&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Greeting <span class="title function_">greeting</span><span class="params">(<span class="meta">@RequestParam(required=false, defaultValue=&quot;World&quot;)</span> String name)</span> &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;==== in greeting ====&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Greeting</span>(counter.incrementAndGet(), String.format(template, name));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This controller is concise and simple, but there is plenty going on under the hood. We break it down step by step.</p>
<p>这个控制器简洁而简单，但在引擎盖下有很多东西。我们一步一步地分析它。</p>
<p>The @RequestMapping annotation ensures that HTTP requests to &#x2F;greeting are mapped to the greeting() method.</p>
<p><code>@RequestMapping</code> 注解确保对 <code>/greeting</code> 的 HTTP 请求映射到 <code>greeting()</code> 方法。</p>
<blockquote>
<p>The preceding example uses the @GetMapping annotation, which acts as a shortcut for <code>@RequestMapping(method = RequestMethod.GET)</code>.</p>
</blockquote>
<p>注意：前面的示例使用的 <code>@GetMapping</code> 注解是 <code>@RequestMapping(method = RequestMethod.GET)</code> 的简写。</p>
<p><code>@RequestParam</code> binds the value of the name query string parameter into the name parameter of the greeting() method. This query string parameter is not required. If it is absent in the request, the defaultValue of World is used.</p>
<p><code>@RequestParam</code> 将包含 name 参数的查询字符串值绑定到 <code>greeting()</code> 方法的名称参数中。此查询字符串参数不是必需的。如果它在请求中不存在，则使用「World」默认值。</p>
<p>The implementation of the method body creates and returns a new Greeting object, with the value of the id attribute based on the next value from the counter and the value of the content based on the query parameter or the default value. It also formats the given name by using the greeting template.</p>
<p>方法实现创建并返回一个新的 Greeting 对象，其中 id 属性的值基于计数器的下一个值，内容的值基于查询参数或默认值。它还通过使用问候语模板来格式化给定的 name。</p>
<p>A key difference between a traditional MVC controller and the RESTful web service controller shown earlier is the way that the HTTP response body is created. Rather than relying on a view technology to perform server-side rendering of the greeting data to HTML, this RESTful web service controller populates and returns a Greeting object. The object data is written directly to the HTTP response as JSON.</p>
<p>传统 MVC 控制器和 RESTful web 服务控制器之间的一个关键区别是 HTTP 响应体的创建方式。与依赖视图技术将问候语数据执行服务器端呈现为 HTML 不同，这个 RESTful web 服务控制器填充并返回一个 Greeting 对象。对象数据直接以 JSON 的形式写入 HTTP 响应。</p>
<p>To accomplish this, the <code>@ResponseBody</code> annotation on the greeting() method tells Spring MVC that it does not need to render the greeting object through a server-side view layer. Instead, the returned greeting object is the response body and should be written out directly.</p>
<p>为此，greeting() 方法上的 <code>@ResponseBody</code> 注解告诉 Spring MVC，它不需要通过服务器端视图层呈现 greeting 对象。相反，返回的 greeting 对象是响应体，应该直接写出来。</p>
<p>The Greeting object must be converted to JSON. Thanks to Spring’s HTTP message converter support, you need not do this conversion manually. Because Jackson is on the classpath, Spring’s MappingJackson2HttpMessageConverter is automatically chosen to convert the Greeting instance to JSON.</p>
<p>Greeting 对象必须转换为 JSON。由于 Spring 的 HTTP 消息转换器支持，不需要手动执行此转换。因为 J ackson 位于类路径中，所以会自动调用 Spring 的 MappingJackson2HttpMessageConverter 将 Greeting 实例转换为 JSON。</p>
<h2 id="Enabling-CORS"><a href="#Enabling-CORS" class="headerlink" title="Enabling CORS"></a>Enabling CORS</h2><p><strong>启用跨域资源共享（CORS）</strong></p>
<p>You can enable cross-origin resource sharing (CORS) from either in individual controllers or globally. The following topics describe how to do so:</p>
<p>你可以在单个控制器或全局控制器中启用跨源资源共享（CORS）。以下主题描述了如何做到这一点：</p>
<ul>
<li>Controller Method CORS Configuration</li>
</ul>
<p>控制器方法的 CORS 配置</p>
<ul>
<li>Global CORS configuration</li>
</ul>
<p>全局 CORS 配置</p>
<h2 id="Controller-Method-CORS-Configuration"><a href="#Controller-Method-CORS-Configuration" class="headerlink" title="Controller Method CORS Configuration"></a>Controller Method CORS Configuration</h2><p><strong>控制器方法的 CORS 配置</strong></p>
<p>So that the RESTful web service will include CORS access control headers in its response, you have to add a @CrossOrigin annotation to the handler method, as the following listing (from <code>src/main/java/com/example/restservicecors/GreetingController.java</code>) shows:</p>
<p>为了使 RESTful web 服务在其响应中包含 CORS 访问控制头，必须向处理程序方法添加一个 <code>@CrossOrigin</code> 注释，如下所示（来自 <code>src/main/java/com/example/restservicecors/GreetingController.java</code>）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@CrossOrigin(origins = &quot;http://localhost:9000&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/greeting&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Greeting <span class="title function_">greeting</span><span class="params">(<span class="meta">@RequestParam(required=false, defaultValue=&quot;World&quot;)</span> String name)</span> &#123;</span><br><span class="line">	System.out.println(<span class="string">&quot;==== in greeting ====&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Greeting</span>(counter.incrementAndGet(), String.format(template, name));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This @CrossOrigin annotation enables cross-origin resource sharing only for this specific method. By default, its allows all origins, all headers, and the HTTP methods specified in the @RequestMapping annotation. Also, a maxAge of 30 minutes is used. You can customize this behavior by specifying the value of one of the following annotation attributes:</p>
<p><code>@CrossOrigin</code> 注解只支持这个特定方法的跨源资源共享。默认情况下，它允许所有的源、所有的头和在 @RequestMapping 注解中指定的 HTTP 方法。此外，最大使用 30 分钟。可以通过指定下列注解属性之一的值来自定义此行为：</p>
<ul>
<li>origins</li>
<li>methods</li>
<li>allowedHeaders</li>
<li>exposedHeaders</li>
<li>allowCredentials</li>
<li>maxAge.</li>
</ul>
<p>In this example, we allow only <a href="http://localhost:9000/">http://localhost:9000</a> to send cross-origin requests.</p>
<p>在这里例子中，我们只允许 <a href="http://localhost:9000/">http://localhost:9000</a> 发送跨域请求。</p>
<blockquote>
<p>You can also add the @CrossOrigin annotation at the controller class level as well, to enable CORS on all handler methods of this class.</p>
</blockquote>
<p>你同样可以将 @CrossOrigin 注解应用在类级别，以便让其中所有方法开启 CORS</p>
<h2 id="Global-CORS-configuration"><a href="#Global-CORS-configuration" class="headerlink" title="Global CORS configuration"></a>Global CORS configuration</h2><p><strong>全局 CORS 配置</strong></p>
<p>In addition (or as an alternative) to fine-grained annotation-based configuration, you can define some global CORS configuration as well. This is similar to using a Filter but can be declared within Spring MVC and combined with fine-grained @CrossOrigin configuration. By default, all origins and GET, HEAD, and POST methods are allowed.</p>
<p>此外(或作为基于细粒度注释的配置的替代方法)，还可以定义一些全局 CORS 配置。这类似于使用过滤器，但可以在 Spring MVC 中声明，并与细粒度的 <code>@CrossOrigin</code> 配置相结合。默认情况下，允许使用所有域、GET、HEAD 和 POST 方法。</p>
<p>The following listing (from <code>src/main/java/com/example/restservicecors/GreetingController.java)</code> shows the greetingWithJavaconfig method in the GreetingController class:</p>
<p>如下所示（源码参考 <code>src/main/java/com/example/restservicecors/GreetingController.java)</code>）：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/greeting-javaconfig&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Greeting <span class="title function_">greetingWithJavaconfig</span><span class="params">(<span class="meta">@RequestParam(required=false, defaultValue=&quot;World&quot;)</span> String name)</span> &#123;</span><br><span class="line">	System.out.println(<span class="string">&quot;==== in greeting ====&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Greeting</span>(counter.incrementAndGet(), String.format(template, name));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The difference between the greetingWithJavaconfig method and the greeting method (used in the controller-level CORS configuration) is the route (&#x2F;greeting-javaconfig rather than &#x2F;greeting) and the presence of the @CrossOrigin origin.</p>
</blockquote>
<p>greetingWithJavaconfig 方法和 greeting 方法（在控制器级 CORS 配置中使用）之间的区别是路由(&#x2F;greeting-javaconfig 而不是 &#x2F;greeting)和 <code>@CrossOrigin</code> 来源的存在。</p>
<p>The following listing (from src&#x2F;main&#x2F;java&#x2F;com&#x2F;example&#x2F;restservicecors&#x2F;RestServiceCorsApplication.java) shows how to add CORS mapping in the application class:</p>
<p>下面的清单(源码路径 <code>src/main/java/com/example/restservicecors/RestServiceCorsApplication.java</code>）展示了如何在应用程序类中添加 CORS 映射：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> WebMvcConfigurer <span class="title function_">corsConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcConfigurer</span>() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> &#123;</span><br><span class="line">			registry.addMapping(<span class="string">&quot;/greeting-javaconfig&quot;</span>).allowedOrigins(<span class="string">&quot;http://localhost:9000&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can easily change any properties (such as allowedOrigins in the example), as well as apply this CORS configuration to a specific path pattern.</p>
<p>你可以轻松地更改任何属性（例如本例中的 allowedOrigins），也可以将这种 CORS 配置应用于特定的路径模式。</p>
<blockquote>
<p>You can combine global- and controller-level CORS configuration.</p>
</blockquote>
<p>你可以结合全局和控制器两种级别的 CORS 配置</p>
<h2 id="Creating-the-Application-Class"><a href="#Creating-the-Application-Class" class="headerlink" title="Creating the Application Class"></a>Creating the Application Class</h2><p><strong>生成 Application 类</strong></p>
<p>The Spring Initializr creates a bare-bones application class for you. The following listing (from initial&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;example&#x2F;restservicecors&#x2F;RestServiceCorsApplication.java) shows that initial class:</p>
<p>Spring Initializr 创建了一个基本的应用程序类。下面的清单（来自 <code>initial/src/main/java/com/example/restservicecors/RestServiceCorsApplication.java</code>）显示了这个类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.restservicecors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestServiceCorsApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(RestServiceCorsApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You need to add a method to configure how to handle cross-origin resource sharing. The following listing (from complete&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;example&#x2F;restservicecors&#x2F;RestServiceCorsApplication.java) shows how to do so:</p>
<p>你需要添加一个方法来配置如何处理跨源资源共享。下面的清单（来自 <code>complete/src/main/java/com/example/restservicecors/RestServiceCorsApplication.java</code>）展示了如何做到这一点：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> WebMvcConfigurer <span class="title function_">corsConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcConfigurer</span>() &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> &#123;</span><br><span class="line">			registry.addMapping(<span class="string">&quot;/greeting-javaconfig&quot;</span>).allowedOrigins(<span class="string">&quot;http://localhost:9000&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The following listing shows the completed application class:</p>
<p>完整的应用类如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.restservicecors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.CorsRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestServiceCorsApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(RestServiceCorsApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="keyword">public</span> WebMvcConfigurer <span class="title function_">corsConfigurer</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcConfigurer</span>() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> &#123;</span><br><span class="line">				registry.addMapping(<span class="string">&quot;/greeting-javaconfig&quot;</span>).allowedOrigins(<span class="string">&quot;http://localhost:9000&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@SpringBootApplication is a convenience annotation that adds all of the following:</p>
<p><code>@SpringBootApplication</code> 是一个方便的注解，它添加了以下所有内容：</p>
<ul>
<li><code>@Configuration</code>: Tags the class as a source of bean definitions for the application context.</li>
</ul>
<p>将该类标记为应用程序上下文的 bean 定义源。</p>
<ul>
<li><code>@EnableAutoConfiguration</code>: Tells Spring Boot to start adding beans based on classpath settings, other beans, and various property settings. For example, if spring-webmvc is on the classpath, this annotation flags the application as a web application and activates key behaviors, such as setting up a DispatcherServlet.</li>
</ul>
<p>告诉 Spring Boot 根据类路径设置、其他 bean 和各种属性设置开始添加 bean。例如，如果 spring-webmvc 位于 classpath，则该注解将应用程序标记为 web 应用程序并激活关键行为，例如设置 DispatcherServlet。</p>
<ul>
<li><code>@ComponentScan</code>: Tells Spring to look for other components, configurations, and services in the com&#x2F;example package, letting it find the controllers.</li>
</ul>
<p>告诉 Spring 在 com&#x2F;example 包中查找其他组件、配置和服务，让它查找控制器。</p>
<p>The main() method uses Spring Boot’s SpringApplication.run() method to launch an application. Did you notice that there was not a single line of XML? There is no web.xml file, either. This web application is 100% pure Java and you did not have to deal with configuring any plumbing or infrastructure.</p>
<p>main() 方法使用 Spring Boot 的 SpringApplication.run() 方法来启动应用程序。你注意到没有一行 XML 吗？也没有 web.xml 文件。这个 web 应用程序是 100% 纯 Java 的，不需要配置任何管道或基础设施。</p>
<p><strong>译注：以下部分过于简单，且不涉及 CORS，不译。</strong></p>
<h2 id="Build-an-executable-JAR"><a href="#Build-an-executable-JAR" class="headerlink" title="Build an executable JAR"></a>Build an executable JAR</h2><p>You can run the application from the command line with Gradle or Maven. You can also build a single executable JAR file that contains all the necessary dependencies, classes, and resources and run that. Building an executable jar so makes it easy to ship, version, and deploy the service as an application throughout the development lifecycle, across different environments, and so forth.</p>
<p>If you use Gradle, you can run the application by using .&#x2F;gradlew bootRun. Alternatively, you can build the JAR file by using .&#x2F;gradlew build and then run the JAR file, as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -jar build/libs/gs-rest-service-cors-0.1.0.jar</span><br></pre></td></tr></table></figure>

<p>If you use Maven, you can run the application by using .&#x2F;mvnw spring-boot:run. Alternatively, you can build the JAR file with .&#x2F;mvnw clean package and then run the JAR file, as follows:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -jar target/gs-rest-service-cors-0.1.0.jar</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The steps described here create a runnable JAR. You can also build a classic WAR file.</p>
</blockquote>
<p>Logging output is displayed. The service should be up and running within a few seconds.</p>
<h2 id="Test-the-service"><a href="#Test-the-service" class="headerlink" title="Test the service"></a>Test the service</h2><p>Now that the service is up, visit <a href="http://localhost:8080/greeting">http://localhost:8080/greeting</a>, where you should see:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;id&quot;:1,&quot;content&quot;:&quot;Hello, World!&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>Provide a name query string parameter by visiting <a href="http://localhost:8080/greeting?name=User">http://localhost:8080/greeting?name=User</a>. The value of the content attribute changes from Hello, World! to Hello User!, as the following listing shows:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;id&quot;:2,&quot;content&quot;:&quot;Hello, User!&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>This change demonstrates that the @RequestParam arrangement in GreetingController works as expected. The name parameter has been given a default value of World but can always be explicitly overridden through the query string.</p>
<p>Also, the id attribute has changed from 1 to 2. This proves that you are working against the same GreetingController instance across multiple requests and that its counter field is being incremented on each call, as expected.</p>
<p>Now you can test that the CORS headers are in place and allow a Javascript client from another origin to access the service. To do so, you need to create a Javascript client to consume the service. The following listing shows such a client:</p>
<p>First, create a simple Javascript file named hello.js (from complete&#x2F;public&#x2F;hello.js) with the following content:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;http://localhost:8080/greeting&quot;</span>,</span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">data, status, jqxhr</span>) &#123;</span><br><span class="line">    $(<span class="string">&quot;.greeting-id&quot;</span>).<span class="title function_">append</span>(data.<span class="property">id</span>);</span><br><span class="line">    $(<span class="string">&quot;.greeting-content&quot;</span>).<span class="title function_">append</span>(data.<span class="property">content</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(jqxhr);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>This script uses jQuery to consume the REST service at <a href="http://localhost:8080/greeting">http://localhost:8080/greeting</a>. It is loaded by index.html, as the following listing (from complete&#x2F;public&#x2F;index.html) shows:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello CORS<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;hello.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;greeting-id&quot;</span>&gt;</span>The ID is <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;greeting-content&quot;</span>&gt;</span>The content is <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>This is essentially the REST client created in Consuming a RESTful Web Service with jQuery, modified slightly to consume the service when it runs on localhost at port 8080. See that guide for more details on how this client was developed.</p>
</blockquote>
<p>Because the REST service is already running on localhost at port 8080, you need to be sure to start the client from another server or port. Doing so not only avoids a collision between the two applications but also ensures that the client code is served from a different origin than the service. To start the client running on localhost at port 9000, run the following Maven command:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./mvnw spring-boot:run -Dserver.port=9000</span><br></pre></td></tr></table></figure>

<p>Once the client starts, open <a href="http://localhost:9000/">http://localhost:9000</a> in your browser, where you should see the following:</p>
<p>（原文有图，略）</p>
<p>If the service response includes the CORS headers, then the ID and content are rendered into the page. But if the CORS headers are missing (or insufficiently defined for the client), the browser fails the request and the values are not rendered into the DOM. In that case, you should see the following:</p>
<p>（原文有图，略）</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>Congratulations! You have just developed a RESTful web service that includes Cross-Origin Resource Sharing with Spring.</p>
<h2 id="See-Also"><a href="#See-Also" class="headerlink" title="See Also"></a>See Also</h2><p>The following guides may also be helpful:</p>
<ul>
<li><p>Building a RESTful Web Service</p>
</li>
<li><p>Building a Hypermedia-Driven RESTful Web Service</p>
</li>
<li><p>Creating API Documentation with Restdocs</p>
</li>
<li><p>Accessing GemFire Data with REST</p>
</li>
<li><p>Accessing MongoDB Data with REST</p>
</li>
<li><p>Accessing data with MySQL</p>
</li>
<li><p>Accessing JPA Data with REST</p>
</li>
<li><p>Accessing Neo4j Data with REST</p>
</li>
<li><p>Consuming a RESTful Web Service</p>
</li>
<li><p>Consuming a RESTful Web Service with AngularJS</p>
</li>
<li><p>Consuming a RESTful Web Service with jQuery</p>
</li>
<li><p>Consuming a RESTful Web Service with rest.js</p>
</li>
<li><p>Securing a Web Application</p>
</li>
<li><p>Building REST services with Spring</p>
</li>
<li><p>React.js and Spring Data REST</p>
</li>
<li><p>Building an Application with Spring Boot</p>
</li>
</ul>
<p>Want to write a new guide or contribute to an existing one? Check out our contribution guidelines.</p>
<blockquote>
<p>All guides are released with an ASLv2 license for the code, and an Attribution, NoDerivatives creative commons license for the writing.</p>
</blockquote>
]]></content>
      <categories>
        <category>文献翻译</category>
        <category>java</category>
      </categories>
      <tags>
        <tag>未标记</tag>
      </tags>
  </entry>
  <entry>
    <title>Guide to ApplicationContextRunner in Spring Boot</title>
    <url>/3c6a9ce0-e213-11ee-8578-cb8bdeddad57/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<blockquote>
<p>转译自：<a href="https://www.baeldung.com/spring-boot-context-runner">https://www.baeldung.com/spring-boot-context-runner</a></p>
</blockquote>
<h2 id="1-Overview"><a href="#1-Overview" class="headerlink" title="1 Overview"></a>1 Overview</h2><p>It’s well known that auto-configuration is one of the key features in Spring Boot, but testing auto-configuration scenarios can be tricky.</p>
<p>In the following sections, we’ll show how ApplicationContextRunner simplifies auto-configuration testing.</p>
<h2 id="2-Test-Auto-Configuration-Scenarios"><a href="#2-Test-Auto-Configuration-Scenarios" class="headerlink" title="2 Test Auto-Configuration Scenarios"></a>2 Test Auto-Configuration Scenarios</h2><p>ApplicationContextRunner is a utility class which runs the ApplicationContext and provides AssertJ style assertions. It’s best used as a field in test class for shared configuration and we make customizations in each test afterward:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ApplicationContextRunner</span> <span class="variable">contextRunner</span></span><br><span class="line">    <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextRunner</span>();</span><br></pre></td></tr></table></figure>

<p>Let’s move on to show its magic by testing a few cases.</p>
<h2 id="2-1-Test-Class-Condition"><a href="#2-1-Test-Class-Condition" class="headerlink" title="2.1 Test Class Condition"></a>2.1 Test Class Condition</h2><p>In this section, we’re going to test some auto-configuration classes which use @ConditionalOnClass and @ConditionalOnMissingClass annotations:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(ConditionalOnClassIntegrationTest.class)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConditionalOnClassConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">created</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;This is created when ConditionalOnClassIntegrationTest &quot;</span></span><br><span class="line">               + <span class="string">&quot;is present on the classpath&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingClass(</span></span><br><span class="line"><span class="meta">    &quot;com.baeldung.autoconfiguration.ConditionalOnClassIntegrationTest&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConditionalOnMissingClassConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">missed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;This is missed when ConditionalOnClassIntegrationTest &quot;</span></span><br><span class="line">               + <span class="string">&quot;is present on the classpath&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We’d like to test whether the auto-configuration properly instantiates or skips the created and missed beans given expected conditions.</p>
<p>ApplicationContextRunner gives us the withUserConfiguration method where we can provide an auto-configuration on demand to customize the ApplicationContext for each test.</p>
<p>The run method takes a ContextConsumer as a parameter which applies the assertions to the context. The ApplicationContext will be closed automatically when the test exits:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">whenDependentClassIsPresent_thenBeanCreated</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.contextRunner.withUserConfiguration(ConditionalOnClassConfiguration.class)</span><br><span class="line">        .run(context -&gt; &#123;</span><br><span class="line">            assertThat(context).hasBean(<span class="string">&quot;created&quot;</span>);</span><br><span class="line">            assertThat(context.getBean(<span class="string">&quot;created&quot;</span>))</span><br><span class="line">              .isEqualTo(<span class="string">&quot;This is created when ConditionalOnClassIntegrationTest &quot;</span></span><br><span class="line">                         + <span class="string">&quot;is present on the classpath&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">whenDependentClassIsPresent_thenBeanMissing</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.contextRunner.withUserConfiguration(ConditionalOnMissingClassConfiguration.class)</span><br><span class="line">        .run(context -&gt; &#123;</span><br><span class="line">            assertThat(context).doesNotHaveBean(<span class="string">&quot;missed&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Through the preceding example, we see the simpleness of testing the scenarios in which a certain class is present on the classpath. But how are we going to test the converse, when the class is absent on the classpath?</p>
<p>This is where FilteredClassLoader kicks in. It’s used to filter specified classes on the classpath at runtime:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">whenDependentClassIsNotPresent_thenBeanMissing</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.contextRunner.withUserConfiguration(ConditionalOnClassConfiguration.class)</span><br><span class="line">        .withClassLoader(<span class="keyword">new</span> <span class="title class_">FilteredClassLoader</span>(ConditionalOnClassIntegrationTest.class))</span><br><span class="line">        .run((context) -&gt; &#123;</span><br><span class="line">            assertThat(context).doesNotHaveBean(<span class="string">&quot;created&quot;</span>);</span><br><span class="line">            assertThat(context).doesNotHaveBean(ConditionalOnClassIntegrationTest.class);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">whenDependentClassIsNotPresent_thenBeanCreated</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.contextRunner.withUserConfiguration(ConditionalOnMissingClassConfiguration.class)</span><br><span class="line">        .withClassLoader(<span class="keyword">new</span> <span class="title class_">FilteredClassLoader</span>(ConditionalOnClassIntegrationTest.class))</span><br><span class="line">        .run((context) -&gt; &#123;</span><br><span class="line">            assertThat(context).hasBean(<span class="string">&quot;missed&quot;</span>);</span><br><span class="line">            assertThat(context).getBean(<span class="string">&quot;missed&quot;</span>)</span><br><span class="line">              .isEqualTo(<span class="string">&quot;This is missed when ConditionalOnClassIntegrationTest &quot;</span></span><br><span class="line">                         + <span class="string">&quot;is present on the classpath&quot;</span>);</span><br><span class="line">            assertThat(context).doesNotHaveBean(ConditionalOnClassIntegrationTest.class);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-Test-Bean-Condition"><a href="#2-2-Test-Bean-Condition" class="headerlink" title="2.2 Test Bean Condition"></a>2.2 Test Bean Condition</h2><p>We’ve just looked at testing @ConditionalOnClass and @ConditionalOnMissingClass annotations, now let’s see what things look like when we are using @ConditionalOnBean and @ConditionalOnMissingBean annotations.</p>
<p>To make a start, we similarly need a few auto-configuration classes:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">BasicConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">created</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;This is always created&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(name = &quot;created&quot;)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConditionalOnBeanConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createOnBean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;This is created when bean (name=created) is present&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(name = &quot;created&quot;)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConditionalOnMissingBeanConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createOnMissingBean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;This is created when bean (name=created) is missing&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then, we’d call the withUserConfiguration method like the preceding section and send in our custom configuration class to test if the auto-configuration appropriately instantiates or skips createOnBean or createOnMissingBean beans in different conditions:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">whenDependentBeanIsPresent_thenConditionalBeanCreated</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.contextRunner.withUserConfiguration(</span><br><span class="line">        BasicConfiguration.class,</span><br><span class="line">        ConditionalOnBeanConfiguration.class</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// ommitted for brevity</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">whenDependentBeanIsNotPresent_thenConditionalMissingBeanCreated</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.contextRunner.withUserConfiguration(ConditionalOnMissingBeanConfiguration.class)</span><br><span class="line">    <span class="comment">// ommitted for brevity</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-Test-Property-Condition"><a href="#2-3-Test-Property-Condition" class="headerlink" title="2.3 Test Property Condition"></a>2.3 Test Property Condition</h2><p>In this section, let’s test the auto-configuration classes which use @ConditionalOnProperty annotations.</p>
<p>First, we need a property for this test:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">com.baeldung.service=custom</span><br></pre></td></tr></table></figure>

<p>After that, we write nested auto-configuration classes to create beans based on the preceding property:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@TestPropertySource(&quot;classpath:ConditionalOnPropertyTest.properties&quot;)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SimpleServiceConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(name = &quot;com.baeldung.service&quot;, havingValue = &quot;default&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> DefaultService <span class="title function_">defaultService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultService</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(name = &quot;com.baeldung.service&quot;, havingValue = &quot;custom&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> CustomService <span class="title function_">customService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomService</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now, we’re calling the withPropertyValues method to override the property value in each test:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">whenGivenCustomPropertyValue_thenCustomServiceCreated</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.contextRunner.withPropertyValues(<span class="string">&quot;com.baeldung.service=custom&quot;</span>)</span><br><span class="line">        .withUserConfiguration(SimpleServiceConfiguration.class)</span><br><span class="line">        .run(context -&gt; &#123;</span><br><span class="line">            assertThat(context).hasBean(<span class="string">&quot;customService&quot;</span>);</span><br><span class="line">            <span class="type">SimpleService</span> <span class="variable">simpleService</span> <span class="operator">=</span> context.getBean(CustomService.class);</span><br><span class="line">            assertThat(simpleService.serve()).isEqualTo(<span class="string">&quot;Custom Service&quot;</span>);</span><br><span class="line">            assertThat(context).doesNotHaveBean(<span class="string">&quot;defaultService&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">whenGivenDefaultPropertyValue_thenDefaultServiceCreated</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.contextRunner.withPropertyValues(<span class="string">&quot;com.baeldung.service=default&quot;</span>)</span><br><span class="line">        .withUserConfiguration(SimpleServiceConfiguration.class)</span><br><span class="line">        .run(context -&gt; &#123;</span><br><span class="line">            assertThat(context).hasBean(<span class="string">&quot;defaultService&quot;</span>);</span><br><span class="line">            <span class="type">SimpleService</span> <span class="variable">simpleService</span> <span class="operator">=</span> context.getBean(DefaultService.class);</span><br><span class="line">            assertThat(simpleService.serve()).isEqualTo(<span class="string">&quot;Default Service&quot;</span>);</span><br><span class="line">            assertThat(context).doesNotHaveBean(<span class="string">&quot;customService&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-Conclusion"><a href="#3-Conclusion" class="headerlink" title="3 Conclusion"></a>3 Conclusion</h2><p>To sum up, this tutorial just showed how to use ApplicationContextRunner to run the ApplicationContext with customizations and apply assertions.</p>
<p>We covered the most frequently used scenarios in here instead of an exhaustive list of how to customize the ApplicationContext.</p>
<p>In the meantime, please bear in mind that the ApplicationConetxtRunner is for non-web applications, so consider WebApplicationContextRunner for servlet-based web applications and ReactiveWebApplicationContextRunner for reactive web applications.</p>
<p>The source code for this tutorial can be found over on <a href="https://github.com/eugenp/tutorials/tree/master/spring-boot-modules/spring-boot-autoconfiguration">GitHub</a>.</p>
]]></content>
      <categories>
        <category>文献翻译</category>
        <category>java</category>
      </categories>
      <tags>
        <tag>springboot</tag>
      </tags>
  </entry>
  <entry>
    <title>How-to-design-Classes-and-Interfaces</title>
    <url>/4686ddb1-2bb6-11ee-879b-0b2c36f14b2e/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h1 id="How-to-design-Classes-and-Interfaces（如何设计类和接口）"><a href="#How-to-design-Classes-and-Interfaces（如何设计类和接口）" class="headerlink" title="How to design Classes and Interfaces（如何设计类和接口）"></a>How to design Classes and Interfaces（如何设计类和接口）</h1><blockquote>
<p>转译自：<a href="https://examples.javacodegeeks.com/">https://examples.javacodegeeks.com</a></p>
</blockquote>
<h2 id="1、Introduction"><a href="#1、Introduction" class="headerlink" title="1、Introduction"></a>1、Introduction</h2><p><strong>介绍</strong></p>
<p>Whatever programming language you are using (and Java is not an exception here), following good design principles is a key factor to write clean, understandable, testable code and deliver（交付） long-living, easy to maintain solutions. In this part of the tutorial we are going to discuss the foundational building blocks which the Java language provides and introduce a couple of design principles, aiming to help you to make better design decisions.</p>
<p>无论你使用什么编程语言（Java 也不例外），遵循良好设计原则是编写干净的、可理解的、可测试的并且交付后能长期使用的代码，以及易于维护的解决方案的关键因素。</p>
<p>More precisely, we are going to discuss interfaces and interfaces with default methods (new feature of Java 8), abstract and final classes, immutable classes, inheritance, composition and revisit a bit the visibility (or accessibility) rules we have briefly touched in part 1 of the tutorial, How to create and destroy objects.</p>
<p>更准确的说，我们准备讨论接口和带有默认方法的接口（Java 8 的新特性），抽象类和终态类，不可变类、继承、组合，并且重新讨论一下本教程第 1 部分中简要介绍的可见性（或可访问性）规则，即如何创建和销毁对象。</p>
<h2 id="2、Interfaces"><a href="#2、Interfaces" class="headerlink" title="2、Interfaces"></a>2、Interfaces</h2><p><strong>接口</strong></p>
<p>In object-oriented programming, the concept（概念） of interfaces forms the basics of contract-driven (or contract-based) development. In a nutshell（简而言之）, interfaces define the set of methods (contract) and every class which claims to support this particular interface must provide the implementation of those methods: a pretty simple, but powerful idea.</p>
<p>在面向对象编程中，接口的概念形成了契约驱动（或基于契约的）开发的基础。简而言之，接口定义了一组方法（契约），并且每个声称支持该特定接口的类都必须提供这些方法的实现：这是一个非常简单但功能强大的想法。</p>
<p>Many programming languages do have interfaces in one form or another, but Java particularly provides language support for that. Let take a look on a simple interface definition in Java.</p>
<p>许多编程语言都有这样或那样的接口，但是 Java 特别提供了语言支持。让我们看一下 Java 中一个简单接口的定义。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">public interface SimpleInterface &#123;</span><br><span class="line">    void performAction();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In the code snippet（片段） above, the interface which we named SimpleInterface declares just one method with name performAction. The principal（主要的） differences of interfaces <strong>in respect to</strong>（关于） classes is that interfaces outline what the contact is (declare methods), but do not provide their implementations.</p>
<p>在上面的代码片段中，我们命名为 SimpleInterface 的接口仅仅声明了一个名为 performAction 的方法。接口与类的主要区别在于接口概括了两者的联系是什么（声明方法），但没有提供它们的实现。</p>
<p>However, interfaces in Java can be more complicated（复杂的） than that: they can include nested interfaces, classes, enumerations, annotations (enumerations and annotations will be covered in details in part 5 of the tutorial, How and when to use Enums and Annotations) and constants. For example:</p>
<p>然而，Java 中的接口可能比这更复杂：它们可以包括嵌套的接口、类、枚举、注解（枚举和注解将在本教程的第 5 部分中详细介绍，如何以及何时使用枚举和注解）和常量。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">public interface InterfaceWithDefinitions &#123;</span><br><span class="line">    String CONSTANT = &quot;CONSTANT&quot;;</span><br><span class="line"></span><br><span class="line">    enum InnerEnum &#123;</span><br><span class="line">        E1, E2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class InnerClass &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    interface InnerInterface &#123;</span><br><span class="line">        void performInnerAction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void performAction();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>With this more complicated example, there are a couple of constraints which interfaces implicitly impose with respect to the nested constructs and method declarations, and Java compiler enforces（强制执行） that. First and foremost, even if it is not being said explicitly, every declaration in the interface is public (and can be only public, for more details about visibility and accessibility rules, please refer to section Visibility). As such, the following method declarations are equivalent:</p>
<p>对于这个更复杂的示例，有两个约束，接口隐式地对嵌套构造和方法声明施加约束，Java 编译器强制执行这些约束。首先，也是最重要的，即使没有明确说明，接口中的每个声明都是 public 的（并且只能是 public 的，关于可见性和可访问性规则的更多细节，请参阅可见性部分）。因此，以下方法声明是等价的：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public void performAction();</span><br><span class="line">void performAction();</span><br></pre></td></tr></table></figure>

<p>Worth to mention that every single method in the interface is implicitly declared as abstract and even these method declarations are equivalent:</p>
<p>值得一提的是，接口中的每个方法都被隐式地声明为抽象的，甚至这些方法声明也是等价的：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public abstract void performAction();</span><br><span class="line">public void performAction();</span><br><span class="line">void performAction();</span><br></pre></td></tr></table></figure>

<p>As for the constant field declarations, additionally to being public, they are implicitly static and final so the following declarations are also equivalent:</p>
<p>对于常量字段声明，除了标记为 public 外，它们是隐式的静态的和最终态的，所以下面的声明也是等价的：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">String CONSTANT = &quot;CONSTANT&quot;;</span><br><span class="line">public static final String CONSTANT = &quot;CONSTANT&quot;;</span><br></pre></td></tr></table></figure>

<p>And finally, the nested classes, interfaces or enumerations, additionally to being public, are implicitly declared as static. For example, those class declarations are equivalent as well:</p>
<p>最后，嵌套的类、接口或枚举，除了标记为 public 之外，还被隐式地声明为静态的。例如，这些类声明也是等价的：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class InnerClass &#123;</span><br><span class="line">&#125;</span><br><span class="line">static class InnerClass &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Which style you are going to choose is a personal preference, however knowledge of those simple qualities of interfaces could save you from unnecessary typing.</p>
<p>选择哪种风格是个人的喜好，但是了解这些简单的接口特性可以避免不必要的输入。</p>
<h2 id="3、Marker-Interfaces"><a href="#3、Marker-Interfaces" class="headerlink" title="3、Marker Interfaces"></a>3、Marker Interfaces</h2><p><strong>标记接口</strong></p>
<p>Marker interfaces are a special kind of interfaces which have no methods or other nested constructs defined. We have already seen one example of the marker interface in part 2 of the tutorial Using methods common to all objects, the interface Cloneable. Here is how it is defined in the Java library:</p>
<p>标记接口是一种特殊的接口，它没有定义任何方法或其他嵌套构造。在本教程的第 2 部分中，我们已经看到了一个标记接口的示例，它使用了所有对象都通用的方法，即接口 Cloneable。下面是它在 Java 库中的定义：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public interface Cloneable &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Marker interfaces are not contracts per se but somewhat useful technique to “attach” or “tie” some particular trait to the class. For example, with respect to Cloneable, the class is marked as being available for cloning however the way it should or could be done is not a part of the interface. Another very well-known and widely used example of marker interface is Serializable:</p>
<p>标记接口本身不是契约，而是某种有用的技术，可以“附加”或“绑定”类的某些特定特性。例如，对于 Cloneable，类被标记为可用于克隆，但是它应该或可能的方式不是接口的一部分。另一个非常著名和广泛使用的标记接口示例是 Serializable:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public interface Serializable &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This interface marks the class as being available for serialization and deserialization, and again, it does not specify the way it could or should be done.</p>
<p>该接口将类标记为可用于序列化和反序列化，并且它没有指定它可以或应该执行的方式。</p>
<p>The marker interfaces have their place in object-oriented design, although they do not satisfy the main purpose of interface to be a contract.</p>
<p>标记接口在面向对象设计中有自己的位置，尽管它们不满足接口作为契约的主要目的。</p>
<h2 id="4、Functional-interfaces-default-and-static-methods"><a href="#4、Functional-interfaces-default-and-static-methods" class="headerlink" title="4、Functional interfaces, default and static methods"></a>4、Functional interfaces, default and static methods</h2><p><strong>功能接口，默认和静态方法</strong></p>
<p>With the release of Java 8, interfaces have obtained new very interesting capabilities: static methods, default methods and automatic conversion from lambdas (functional interfaces).</p>
<p>随着 Java 8 的发布，接口获得了非常有趣的新功能:静态方法、默认方法和 lambdas（函数接口）的自动转换。</p>
<p>In section Interfaces we have emphasized（强调） on the fact that interfaces in Java can only declare methods but are not allowed to provide their implementations. With default methods it is not true anymore: an interface can mark a method with the default keyword and provide the implementation for it. For example:</p>
<p>在部分接口中，我们强调了一个事实，即 Java 中的接口只能声明方法，但不能提供它们的实现。对于默认方法就不再适用：接口可以用 default 关键字标记方法并为其提供实现。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line">public interface InterfaceWithDefaultMethods &#123;</span><br><span class="line">    void performAction();</span><br><span class="line"></span><br><span class="line">    default void performDefaulAction() &#123;</span><br><span class="line">        // Implementation here</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Being an instance（实例） level, defaults methods could be overridden by each interface implementer, but from now, interfaces may also include static methods, for example:</p>
<p>作为一个实例，默认方法可以被每个接口实现者覆盖，但是从现在开始，接口也可以包括静态方法，例如:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">public interface InterfaceWithDefaultMethods &#123;</span><br><span class="line">    static void createAction() &#123;</span><br><span class="line">        // Implementation here</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>One may say that providing an implementation in the interface defeats the whole purpose of contract-based development, but there are many reasons why these features were introduced into the Java language and no matter how useful or confusing they are, they are there for you to use.</p>
<p>有人可能会说，在接口中提供一个实现违背了基于契约开发的全部目的，但是这些特性被引入 Java 语言有很多原因，而且无论它们多么有用或令人困惑，它们都是可供使用的工具。</p>
<p>The functional interfaces are a different story and they are proven to be very helpful add-on to the language. Basically, the functional interface is the interface with just a single abstract method declared in it. The Runnable interface from Java standard library is a good example of this concept:</p>
<p>函数式接口是一个不同的故事，它们被证明是对语言非常有用的附加组件。基本上，函数式接口就是在接口中仅声明一个抽象方法。Java 标准库中的 Runnable 接口就是这个概念很好的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@FunctionalInterface</span><br><span class="line">public interface Runnable &#123;</span><br><span class="line">    void run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The Java compiler treats functional interfaces differently and is able to convert the lambda function into the functional interface implementation where it makes sense. Let us take a look on following function definition:</p>
<p>Java 编译器以不同的方式对待函数式接口，并能够将 lambda 函数转换为有意义的函数式接口实现。让我们来看看下面的函数定义：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public void runMe( final Runnable r ) &#123;</span><br><span class="line">    r.run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To invoke this function in Java 7 and below, the implementation of the Runnable interface should be provided (for example using Anonymous classes), but in Java 8 it is enough to pass run() method implementation using lambda syntax:</p>
<p>要在 Java 7 和以下版本中调用此方法，应该提供 Runnable 接口的实现（如使用匿名类），但在 Java 8 中，使用 lambda 语法传递 run()方法就足够了:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">runMe( () -&gt; System.out.println( &quot;Run!&quot; ) );</span><br></pre></td></tr></table></figure>

<p>Additionally, the @FunctionalInterface annotation (annotations will be covered in details in part 5 of the tutorial, How and when to use Enums and Annotations) hints（暗示，提示） the compiler to verify that the interface contains only one abstract method so any changes introduced to the interface in the future will not break this assumption（假设）.</p>
<p>此外，@FunctionalInterface 注解（注解将在本教程的第 5 部分中详细介绍，如何以及何时使用枚举和注解）提示编译器验证该接口只包含一个抽象方法，将来接口引入的任何更改都不能打破这个假设。</p>
<h2 id="5、Abstract-classes"><a href="#5、Abstract-classes" class="headerlink" title="5、Abstract classes"></a>5、Abstract classes</h2><p><strong>抽象类</strong></p>
<p>Another interesting concept（概念） supported by Java language is the notion（概念） of abstract classes. Abstract classes are somewhat（有些，稍微） similar to the interfaces in Java 7 and very close to interfaces with default methods in Java 8. By contrast to regular（常规的） classes, abstract classes cannot be instantiated but could be subclassed (please refer to the section Inheritance for more details). More importantly, abstract classes may contain abstract methods: the special kind of methods without implementations, much like interfaces do. For example:</p>
<p>Java 语言支持的另一个有趣的概念是抽象类的概念。抽象类有点类似于 Java 7 中的接口，与 Java 8 中具有默认方法的接口非常接近。与常规类不同的是，抽象类不能被实例化，但可以被子类化（有关更多细节，请参阅继承部分）。更重要的是，抽象类可能包含抽象方法：没有实现的特殊类型的方法，就像接口一样。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">public abstract class SimpleAbstractClass &#123;</span><br><span class="line">    public void performAction() &#123;</span><br><span class="line">        // Implementation here</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public abstract void performAnotherAction();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this example, the class SimpleAbstractClass is declared as abstract and has one abstract method declaration as well. Abstract classes are very useful when most or even some part of implementation details could be shared by many subclasses. However, they still leave the door open and allow customizing（定制） the intrinsic（内在） behavior of each subclass by means of abstract methods.</p>
<p>在本例中，SimpleAbstractClass 类被声明为抽象类，并且有一个抽象方法声明。抽象类非常有用，因为少部分、甚至大部分实现细节都可以由多个子类共享。然而，它们仍然开放，允许通过抽象方法定制每个子类的内在行为。</p>
<p>One thing to mention, in contrast（对比） to interfaces which can contain only public declarations, abstract classes may use the full power of accessibility rules to control abstract methods visibility (please refer to the sections Visibility and Inheritance for more details).</p>
<p>值得一提的是，与只能包含 public 声明的接口不同，抽象类可以使用可访问性规则的全部功能来控制抽象方法的可见性（有关详细信息，请参阅可见性和继承部分）。</p>
<h2 id="6、Immutable-classes"><a href="#6、Immutable-classes" class="headerlink" title="6、Immutable classes"></a>6、Immutable classes</h2><p><strong>不可变类</strong></p>
<p>Immutability is becoming more and more important in the software development nowadays. The rise of multi-core systems has raised a lot of concerns related to data sharing and concurrency (in the part 9, Concurrency（并发性） best practices, we are going to discuss in details those topics). But the one thing definitely emerged: less (or even absence of) mutable state leads to better scalability（可伸缩性） and simpler reasoning（推理） about the systems.</p>
<p>不可变性在当今软件开发中变得越来越重要。多核系统的兴起引起了许多与数据共享和并发相关的关注（在第 9 部分，并发的最佳实践中，我们将详细讨论这些主题）。但有一件事是肯定的：较少（甚至没有）的可变状态会带来更好的可伸缩性和更简单的系统演绎。</p>
<p>Unfortunately, the Java language does not provide strong support for class immutability. However using a combination（结合） of techniques it is possible to design classes which are immutable. First and foremost, all fields of the class should be final. It is a good start but does not guarantee immutability alone.</p>
<p>不幸的是，Java 语言没有提供对类不变性的强大支持。然而，结合一系列技术就可以设计出不可变类。首先，类的所有字段都应该是 final。这是一个良好的开端，但并不能保证一成不变。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">import java.util.Collection;</span><br><span class="line"></span><br><span class="line">public class ImmutableClass &#123;</span><br><span class="line">    private final long id;</span><br><span class="line">    private final String[] arrayOfStrings;</span><br><span class="line">    private final Collection&lt; String &gt; collectionOfString;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Secondly, follow the proper initialization: if the field is the reference to a collection or an array, do not assign those fields directly from constructor arguments, make the copies instead. It will guarantee that state of the collection or array will not be changed from outside.</p>
<p>其次，遵循适当的初始化原则：如果字段是对集合或数组的引用，不要直接从构造函数参数中对这些字段赋值，而是生成副本。它将确保集合或数组的状态不会被外部更改。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public ImmutableClass( final long id, final String[] arrayOfStrings,</span><br><span class="line">        final Collection&lt; String &gt; collectionOfString) &#123;</span><br><span class="line">    this.id = id;</span><br><span class="line">    this.arrayOfStrings = Arrays.copyOf( arrayOfStrings, arrayOfStrings.length );</span><br><span class="line">    this.collectionOfString = new ArrayList&lt;&gt;( collectionOfString );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And lastly, provide the proper accessors (getters). For the collection, the immutable view should be exposed（暴露） using Collections.unmodifiableXxx wrappers.</p>
<p>最后，提供适当的访问器（getter）。对于集合，不可变视图应该使用 Collections.unmodifiableXxx 之类的包装器公开。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public Collection&lt;String&gt; getCollectionOfString() &#123;</span><br><span class="line">    return Collections.unmodifiableCollection( collectionOfString );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>With arrays, the only way to ensure true immutability is to provide a copy instead of returning reference to the array. That might not be acceptable from a practical standpoint as it hugely depends on array size and may put a lot of pressure on garbage collector.</p>
<p>对于数组，确保真正的不变性的唯一方法是提供一个副本，而不是返回对数组的引用。从实践的角度来看，这可能是不可接受的，因为它很大程度上依赖于数组大小，可能会给垃圾收集器带来很大压力。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public String[] getArrayOfStrings() &#123;</span><br><span class="line">    return Arrays.copyOf( arrayOfStrings, arrayOfStrings.length );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Even this small example gives a good idea that immutability is not a first class citizen in Java yet. Things can get really complicated if an immutable class has fields referencing another class instances. Those classes should also be immutable however there is no simple way to enforce that.</p>
<p>即使是这个小示例也给出了一个好主意：在 Java 中，不可变性还不是一等的公民。如果一个不可变的类有引用另一个类实例的字段，那么事情就会变得非常复杂。这些类也应该是不可变的，但是没有简单的方法来实现它。</p>
<p>There are a couple of great Java source code analyzers like FindBugs) and PMD) which may help a lot by inspecting your code and pointing to the common Java programming flaws. Those tools are great friends of any Java developer.</p>
<p>有一些很棒的 Java 源代码分析程序，比如 FindBugs 和 PMD，它们可以通过检查代码并指出常见的 Java 编程缺陷来帮助你。这些工具是任何 Java 开发人员的好朋友。</p>
<h2 id="7、Anonymous-classes"><a href="#7、Anonymous-classes" class="headerlink" title="7、Anonymous classes"></a>7、Anonymous classes</h2><p><strong>匿名类</strong></p>
<p>In the pre-Java 8 era, anonymous classes were the only way to provide in-place class definitions and immediate instantiations. The purpose of the anonymous classes was to reduce boilerplate（样板） and provide a concise and easy way to represent classes as expressions. Let us take a look on the typical old-fashioned way to spawn（大量生产） new thread in Java:</p>
<p>java 8 之前的时代，匿名类是提供 in-place class 定义和立即实例化的唯一方法。匿名类的目的是减少样板文件，并提供一种简洁而简单的方法来将类表示为表达式。让我们看看在 Java 中产生新线程的典型旧式方法：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">public class AnonymousClass &#123;</span><br><span class="line">    public static void main( String[] args ) &#123;</span><br><span class="line">        new Thread(</span><br><span class="line">            // Example of creating anonymous class which implements</span><br><span class="line">            // Runnable interface</span><br><span class="line">            new Runnable() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    // Implementation here</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this example, the implementation of the Runnable interface is provided in place as anonymous class. Although there are some limitations associated（相关的） with anonymous classes, the fundamental（基本的） disadvantages（缺点） of their usage are a quite verbose（详细的） syntax constructs which Java imposes（强加） as a language. Even the simplest anonymous class which does nothing requires at least 5 lines of code to be written every time.</p>
<p>在本例中，以匿名类的形式提供了 Runnable 接口的实现。虽然匿名类有一些限制，但是它们的使用的基本缺点是 Java 作为一种语言强加了相当详细的语法结构。即使最简单的匿名类什么也不做，每次至少需要编写 5 行代码。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">new Runnable() &#123;</span><br><span class="line">   @Override</span><br><span class="line">   public void run() &#123;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Luckily, with Java 8, lambdas and functional interfaces all this boilerplate is about to gone away, finally making the Java code to look truly concise.</p>
<p>幸运的是，因为有了 Java 8 的 lambdas 表达式和函数式接口，所有这些样板文件都将消失，最终使 Java 代码看起来非常简洁。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">public class AnonymousClass &#123;</span><br><span class="line">    public static void main( String[] args ) &#123;</span><br><span class="line">        new Thread( () -&gt; &#123; /* Implementation here */ &#125; ).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8、Visibility"><a href="#8、Visibility" class="headerlink" title="8、Visibility"></a>8、Visibility</h2><p><strong>可见性</strong></p>
<p>We have already talked a bit about Java visibility and accessibility rules in part 1 of the tutorial（教程）, How to design Classes and Interfaces. In this part we are going to get back to this subject again but in the context of subclassing</p>
<p>我们已经在本教程的第 1 部分讨论了 Java 可见性和可访问性规则，以及如何设计类和接口。在这一部分中，我们将在子类化的背景下再次回到这个主题。</p>
<table>
<thead>
<tr>
<th><strong>Modifier</strong></th>
<th><strong>Package</strong></th>
<th><strong>Subclass</strong></th>
<th><strong>Everyone Else</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>public</strong></td>
<td>accessible</td>
<td>accessible</td>
<td>accessible</td>
</tr>
<tr>
<td><strong>protected</strong></td>
<td>accessible</td>
<td>accessible</td>
<td>not accessible</td>
</tr>
<tr>
<td><strong>&lt;no modifier&gt;</strong></td>
<td>accessible</td>
<td>not accessible</td>
<td>not accessible</td>
</tr>
<tr>
<td><strong>private</strong></td>
<td>not accessible</td>
<td>not accessible</td>
<td>not accessible</td>
</tr>
</tbody></table>
<p>Different visibility levels allow or disallow the classes to see other classes or interfaces (for example, if they are in different packages or nested in one another) or subclasses to see and access methods, constructors and fields of their parents.</p>
<p>不同的可见性级别允许或不允许类查看其他类或接口（例如，如果它们位于不同的包中或嵌套在另一个包中）或子类，以查看和访问父类的方法、构造函数和字段。</p>
<p>In next section, Inheritance, we are going to see that in action.</p>
<p>在下一节“继承”中，我们将看到它的实际应用。</p>
<h2 id="9、Inheritance"><a href="#9、Inheritance" class="headerlink" title="9、Inheritance"></a>9、Inheritance</h2><p><strong>继承</strong></p>
<p>Inheritance is one of the key concepts of object-oriented programming, serving as a basis of building class relationships. Combined together with visibility and accessibility rules, inheritance allows designing extensible and maintainable class hierarchies.</p>
<p>继承是面向对象编程的关键概念之一，是构建类关系的基础。结合可见性和可访问性规则，继承允许设计可扩展和可维护的类层次结构。</p>
<p>Conceptually, inheritance in Java is implemented using subclassing and the extends keyword, followed by the parent class. The subclass inherits all of the public and protected members of its parent class. Additionally, a subclass inherits the package-private members of the parent class if both reside in the same package. Having said that, it is very important no matter what you are trying to design, to keep the minimal set of the methods which class exposes publicly or to its subclasses. For example, let us take a look on a class Parent and its subclass Child to demonstrate different visibility levels and their effect:</p>
<p>从概念上讲，Java 中的继承是使用子类，即 extends 关键字后加父类实现的。子类继承其父类的所有公共和受保护的成员。此外，如果两个类都驻留在同一个包中，则子类继承父类的包私有成员。尽管如此，无论你试图设计什么，保持类公开或公开其子类的方法的最小集合都是非常重要的。例如，让我们看看一个类父类及其子类，以演示不同的可见性级别及其效果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">public class Parent &#123;</span><br><span class="line">    // Everyone can see it</span><br><span class="line">    public static final String CONSTANT = &quot;Constant&quot;;</span><br><span class="line"></span><br><span class="line">    // No one can access it</span><br><span class="line">    private String privateField;</span><br><span class="line">    // Only subclasses can access it</span><br><span class="line">    protected String protectedField;</span><br><span class="line"></span><br><span class="line">    // No one can see it</span><br><span class="line">    private class PrivateClass &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Only visible to subclasses</span><br><span class="line">    protected interface ProtectedInterface &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Everyone can call it</span><br><span class="line">    public void publicAction() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Only subclass can call it</span><br><span class="line">    protected void protectedAction() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // No one can call it</span><br><span class="line">    private void privateAction() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Only subclasses in the same package can call it</span><br><span class="line">    void packageAction() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">// Resides in the same package as parent class</span><br><span class="line">public class Child extends Parent implements Parent.ProtectedInterface &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void protectedAction() &#123;</span><br><span class="line">        // Calls parent&#x27;s method implementation</span><br><span class="line">        super.protectedAction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    void packageAction() &#123;</span><br><span class="line">        // Do nothing, no call to parent&#x27;s method implementation</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void childAction() &#123;</span><br><span class="line">        this.protectedField = &quot;value&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Inheritance is a very large topic by itself, with a lot of subtle details specific to Java. However, there are a couple of easy to follow rules which could help a lot to keep your class hierarchies concise. In Java, every subclass may override any inherited method of its parent unless it was declared as final (please refer to the section Final classes and methods).</p>
<p>继承本身就是一个非常大的主题，有许多 Java 特有的细节。然而，有一些易于遵循的规则可以帮助你保持类层次结构的简洁。在 Java 中，每个子类都可以重写其父类的任何继承方法，除非它被声明为 final（请参阅 final 类和方法一节）。</p>
<p>However, there is no special syntax or keyword to mark the method as being overridden which may cause a lot of confusion. That is why the @Override annotation has been introduced: whenever your intention is to override the inherited method, please always use the @Override annotation to indicate that.</p>
<p>但是，没有特殊的语法或关键字将方法标记为被覆盖，这可能会导致很多混乱。这就是为什么引入了 @Override 注解：当你打算重写继承的方法时，请始终使用 @Override 注解来表示。</p>
<p>Another dilemma Java developers are often facing in design is building class hierarchies (with concrete or abstract classes) versus interface implementations. It is strongly advised to prefer interfaces to classes or abstract classes whenever possible. Interfaces are much more lightweight, easier to test (using mocks) and maintain, plus they minimize the side effects of implementation changes. Many advanced programming techniques like creating class proxies in standard Java library heavily rely on interfaces.</p>
<p>Java 开发人员在设计中经常面临的另一个难题是构建类层次结构(使用具体的或抽象的类)和接口实现。强烈建议尽可能选择接口而不是类或抽象类。接口更轻量，更易于测试(使用模拟)和维护，并且它们最小化了实现更改的副作用。许多高级编程技术，如在标准 Java 库中创建类代理，严重依赖于接口。</p>
<h2 id="10、Multiple-inheritance"><a href="#10、Multiple-inheritance" class="headerlink" title="10、Multiple inheritance"></a>10、Multiple inheritance</h2><p><strong>多重继承</strong></p>
<p>In contrast to C++ and some other languages, Java does not support multiple inheritance: in Java every class has exactly one direct parent (with Object class being on top of the hierarchy as we have already known from part 2 of the tutorial, Using methods common to all objects). However, the class may implement multiple interfaces and as such, stacking interfaces is the only way to achieve (or mimic) multiple inheritance in Java.</p>
<p>与 c++和其他一些语言不同的是，Java 不支持多重继承：在 Java 中，每个类都有一个直接的父类（正如我们在本教程的第 2 部分中已经知道的那样，对象类位于层次结构的顶部，使用所有对象共有的方法）。然而，类可能实现多个接口，因此，堆叠接口是在 Java 中实现（或模拟）多重继承的唯一方法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">public class MultipleInterfaces implements Runnable, AutoCloseable &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        // Some implementation here</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void close() throws Exception &#123;</span><br><span class="line">       // Some implementation here</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Implementation of multiple interfaces is in fact quite powerful, but often the need to reuse an implementation leads to deep class hierarchies as a way to overcome the absence of multiple inheritance support in Java.</p>
<p>实际上，多接口的实现非常强大，但是重用实现的需求常常导致类层次结构的深入，从而克服 Java 中缺乏多继承支持的问题。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class A implements Runnable &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        // Some implementation here</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// Class B wants to inherit the implementation of run() method from class A.</span><br><span class="line">public class B extends A implements AutoCloseable &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void close() throws Exception &#123;</span><br><span class="line">       // Some implementation here</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// Class C wants to inherit the implementation of run() method from class A</span><br><span class="line">// and the implementation of close() method from class B.</span><br><span class="line">public class C extends B implements Readable &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public int read(java.nio.CharBuffer cb) throws IOException &#123;</span><br><span class="line">       // Some implementation here</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And so on… The recent Java 8 release somewhat addressed the problem with the introduction of default methods. Because of default methods, interfaces actually have started to provide not only contract but also implementation. Consequently, the classes which implement those interfaces are automatically inheriting these implemented methods as well. For example:</p>
<p>最近的 Java 8 发行版在一定程度上解决了引入默认方法的问题。由于默认的方法，接口实际上已经开始提供契约和实现。因此，实现这些接口的类也会自动继承这些实现的方法。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">public interface DefaultMethods extends Runnable, AutoCloseable &#123;</span><br><span class="line">    @Override</span><br><span class="line">    default void run() &#123;</span><br><span class="line">        // Some implementation here</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    default void close() throws Exception &#123;</span><br><span class="line">       // Some implementation here</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Class C inherits the implementation of run() and close() methods from the</span><br><span class="line">// DefaultMethods interface.</span><br><span class="line">public class C implements DefaultMethods, Readable &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public int read(java.nio.CharBuffer cb) throws IOException &#123;</span><br><span class="line">       // Some implementation here</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Be aware that multiple inheritance is a powerful, but at the same time a dangerous tool to use. The well known “Diamond of Death” problem is often cited as the fundamental flaw of multiple inheritance implementations, so developers are urged to design class hierarchies very carefully. Unfortunately, the Java 8 interfaces with default methods are becoming the victims of those flaws as well.</p>
<p>请注意，多重继承是一种强大的工具，但同时也是一种危险的工具。众所周知的“死亡钻石”问题经常被认为是多重继承实现的根本缺陷，因此开发人员需要非常仔细地设计类层次结构。不幸的是，带有默认方法的 Java 8 接口也成为这些缺陷的受害者。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">interface A &#123;</span><br><span class="line">    default void performAction() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface B extends A &#123;</span><br><span class="line">    @Override</span><br><span class="line">    default void performAction() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface C extends A &#123;</span><br><span class="line">    @Override</span><br><span class="line">    default void performAction() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For example, the following code snippet fails to compile:</p>
<p>例如，以下代码片段编译失败：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// E is not compilable unless it overrides performAction() as well</span><br><span class="line">interface E extends B, C &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>At this point it is fair to say that Java as a language always tried to escape the corner cases of object-oriented programming, but as the language evolves, some of those cases are started to pop up.</p>
<p>在这一点上，可以说 Java 作为一种语言总是试图逃避面向对象编程的极端情况，但是随着语言的发展，其中一些不利情况也开始出现。</p>
<h2 id="11、Inheritance-and-composition"><a href="#11、Inheritance-and-composition" class="headerlink" title="11、Inheritance and composition"></a>11、Inheritance and composition</h2><p><strong>继承和组合</strong></p>
<p>Fortunately, inheritance is not the only way to design your classes. Another alternative, which many developers consider being better than inheritance, is composition. The idea is very simple: instead of building class hierarchies, the classes should be composed from other classes.</p>
<p>幸运的是，继承并不是设计类的唯一方法。另一种选择是组合，许多开发人员认为它比继承更好。这个想法很简单：类应该由其他类组成，而不是构建类层次结构。</p>
<p>Let us take a look on this example:</p>
<p>让我们来看看这个例子：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class Vehicle &#123;</span><br><span class="line">    private Engine engine;</span><br><span class="line">    private Wheels[] wheels;</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The Vehicle class is composed out of engine and wheels (plus many other parts which are left aside for simplicity). However, one may say that Vehicle class is also an engine and so could be designed using the inheritance.</p>
<p>Vehicle 类由引擎和车轮组成（还有很多其他的部件，为了简单起见，都被放在一边了）。然而，有人可能会说 Vehicle 类也是一个引擎，因此可以使用继承来设计它。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class Vehicle extends Engine &#123;</span><br><span class="line">    private Wheels[] wheels;</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Which design decision is right? The general guidelines（指导方针） are known as IS-A and HAS-A principles. IS-A is the inheritance relationship: the subclass also satisfies the parent class specification and a such IS-A variation of parent class. Consequently, HAS-A is the composition relationship: the class owns (or HAS-A) the objects which belong to it. In most cases, the HAS-A principle works better then IS-A for couple of reasons:</p>
<p>哪个设计决策是正确的？一般准则被称为 IS-A 和 HAS-A 原则。IS-A 是继承关系：子类也满足父类规范，这样的 IS-A 是父类的变体。因此，HAS-A 是复合关系：类拥有（或 HAS-A）属于它的对象。在大多数情况下，HAS-A 原则比 IS-A 更好，原因如下:</p>
<ul>
<li>The design is more flexible（灵活的） in a way it could be changed</li>
<li>The model is more stable as changes are not propagating through class hierarchies</li>
<li>The class and its composites are loosely coupled compared to inheritance which tightly couples parent and its subclasses</li>
<li>The reasoning about class is simpler as all its dependencies are included in it, in one place</li>
</ul>
<p>（1）这种设计在某种程度上更加灵活，便于修改<br>（2）由于更改不通过类层次结构传播，因此模型更加稳定<br>（3）与父类及其子类紧密耦合的继承相比，类及其组合是松散耦合的<br>（4）类的推理更简单，因为它的所有依赖项都包含在类中</p>
<p>However, the inheritance has its own place, solves real design issues in different way and should not be neglected. Please keep those two alternatives in mind while designing your object-oriented models.</p>
<p>然而，继承有它自己的位置，同样以不同的方式解决了真正的设计问题，不应该被忽视。在设计面向对象的模型时，请记住这两个原则。</p>
<h2 id="12、Encapsulation"><a href="#12、Encapsulation" class="headerlink" title="12、Encapsulation"></a>12、Encapsulation</h2><p><strong>封装</strong></p>
<p>The concept of encapsulation in object-oriented programming is all about hiding the implementation details (like state, internal methods, etc.) from the outside world. The benefits of encapsulation are maintainability and ease of change. The less intrinsic details classes expose, the more control the developers have over changing their internal implementation, without the fear to break the existing code (a real problem if you are developing a library or framework used by many people).</p>
<p>面向对象编程中封装的概念就是将实现细节（如状态、内部方法等）对外部世界隐藏。封装的好处是可维护性和易于更改。类暴露的内部细节越少，开发人员对更改内部实现的控制就越强，无需担心破坏现有代码（如果你正在开发许多人使用的库或框架，这是一个真正的问题）。</p>
<p>Encapsulation in Java is achieved using visibility and accessibility rules. It is considered a best practice in Java to never expose the fields directly, only by means of getters and setters (if the field is not declared as final). For example:</p>
<p>Java 中的封装是使用可见性和可访问性规则实现的。在 Java 中，不直接公开字段被认为是一种最佳实践，只有通过 getter 和 setter（如果字段未声明为 final）才能公开字段。例如:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">public class Encapsulation &#123;</span><br><span class="line">    private final String email;</span><br><span class="line">    private String address;</span><br><span class="line"></span><br><span class="line">    public Encapsulation( final String email ) &#123;</span><br><span class="line">        this.email = email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getAddress() &#123;</span><br><span class="line">        return address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAddress(String address) &#123;</span><br><span class="line">        this.address = address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getEmail() &#123;</span><br><span class="line">        return email;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This example resembles what is being called JavaBeans in Java language: the regular Java classes written by following the set of conventions, one of those being allow the access to fields using getter and setter methods only.</p>
<p>这个示例类似于 Java 语言中的 JavaBeans：常规 Java 类是按照一组约定编写的，其中之一是只允许使用 getter 和 setter 方法访问字段。</p>
<p>As we already emphasized in the Inheritance section, please always try to keep the class public contract minimal, following the encapsulation principle. Whatever should not be public, should be private instead (or protected &#x2F; package private, depending on the problem you are solving). In long run it will pay off, giving you the freedom to evolve your design without introducing breaking changes (or at least minimize them).</p>
<p>正如我们在继承部分中已经强调的，请始终按照封装原则尽量减少类 public 契约。任何不应该公开的内容都应该是私有的（或者受保护&#x2F;包私有，这取决于你正在解决的问题）。从长远来看，它会给你带来回报，让你在不引入破坏性变化的情况下自由地改进你的设计（或者最小化破坏）。</p>
<h2 id="13、Final-classes-and-methods"><a href="#13、Final-classes-and-methods" class="headerlink" title="13、Final classes and methods"></a>13、Final classes and methods</h2><p><strong>终态类和终态方法</strong></p>
<p>In Java, there is a way to prevent the class to be subclassed by any other class: it should be declared as final.</p>
<p>在 Java 中，有一种方法可以防止该类被任何其他类子类化：它应该声明为 final。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">public final class FinalClass &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The same final keyword in the method declaration prevents the method in question to be overridden in subclasses.</p>
<p>方法声明中使用 final 关键字可防止在子类中覆盖该方法。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.advanced.design;</span><br><span class="line"></span><br><span class="line">public class FinalMethod &#123;</span><br><span class="line">    public final void performAction() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There are no general rules to decide if class or method should be final or not. Final classes and methods limit the extensibility and it is very hard to think ahead if the class should or should not be subclassed, or method should or should not be overridden. This is particularly important to library developers as the design decisions like that could significantly limit the applicability of the library.</p>
<p>没有通用的规则来决定类或方法是否应该是终态的。终态类和方法限制了可扩展性，很难提前考虑类应该或不应该被子类化，或者方法应该或不应该被重写。这对于库开发人员来说特别重要，因为这样的设计决策可能会极大地限制库的适用性。</p>
<p>Java standard library has some examples of final classes, with most known being String class. On an early stage, the decision has been taken to proactively prevent any developer’s attempts to come up with own, “better” string implementations.</p>
<p>Java 标准库中有一些终态类的例子，其中最著名的是 String 类。在早期阶段，已经采取了积极的措施，以防止任何开发人员试图提出自己的、“更好的”字符串实现。</p>
<h2 id="14、What’s-next"><a href="#14、What’s-next" class="headerlink" title="14、What’s next"></a>14、What’s next</h2><p><strong>接下来是什么</strong></p>
<p>In this part of the tutorial we have looked at object-oriented design concepts in Java. We also briefly walked through contract-based development, touched some functional concepts and saw how the language evolved over time. In next part of the tutorial we are going to meet generics and how they are changing the way we approach type-safe programming.</p>
<p>在本教程的这一部分中，我们讨论了 Java 中的面向对象设计概念。我们还简要介绍了基于契约的开发，触及了一些功能概念，并看到了语言是如何随着时间而发展的。在本教程的下一部分中，我们将介绍泛型以及它们如何改变我们处理类型安全编程的方式。</p>
]]></content>
      <categories>
        <category>文献翻译</category>
        <category>java</category>
      </categories>
      <tags>
        <tag>未标记</tag>
      </tags>
  </entry>
  <entry>
    <title>Java-8-中的-Streams-API-详解</title>
    <url>/4686b6a1-2bb6-11ee-879b-0b2c36f14b2e/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h1 id="Java-8-中的-Streams-API-详解"><a href="#Java-8-中的-Streams-API-详解" class="headerlink" title="Java 8 中的 Streams API 详解"></a>Java 8 中的 Streams API 详解</h1><blockquote>
<p>参考自：<a href="https://www.ibm.com/developerworks/cn/java/j-lo-java8streamapi/">https://www.ibm.com/developerworks/cn/java/j-lo-java8streamapi/</a></p>
</blockquote>
<p><strong>注：本文适当调整了原文内容和结构，并修正代码错误</strong></p>
<p>Java 8 中的 Stream 是对集合（Collection）对象功能的增强，它专注于对集合对象进行各种便利、高效的聚合操作（aggregate operation），或者大批量数据操作（bulk data operation）。Stream API 借助于 Lambda 表达式，极大的提高编程效率和程序可读性。同时它提供串行和并行两种模式进行汇聚操作，并发模式能够充分利用多核处理器的优势，使用 fork&#x2F;join 并行方式来拆分任务和加速处理过程。通常编写并行代码很难而且容易出错, 但使用 Stream API 无需编写一行多线程的代码，就可以很方便地写出高性能的并发程序。</p>
<h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1 前言"></a>1 前言</h2><p>详细讨论之前，先展示一个排序、取值案例在 Java 8 之前版本的实现：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 在原文实现代码基础上添加枚举类 Transaction</span><br><span class="line">enum Transaction &#123;</span><br><span class="line">    GROCERY(0, &quot;grocery&quot;), NONE(1, &quot;none&quot;);</span><br><span class="line"></span><br><span class="line">    private final int id;</span><br><span class="line">    private final String value;</span><br><span class="line"></span><br><span class="line">    Transaction(int id, String value) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">        this.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object getType() &#123; return this; &#125;</span><br><span class="line">    public int getId() &#123; return this.id; &#125;</span><br><span class="line">    public String getValue() &#123; return this.value; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    // 使用泛型初始化一个 Transaction 集合，代替原文使用的原始类型</span><br><span class="line">    List&lt;Transaction&gt; transactions = new ArrayList&lt;&gt;() &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            add(Transaction.NONE);</span><br><span class="line">            add(Transaction.GROCERY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    List&lt;Transaction&gt; groceryTransactions = new Arraylist&lt;&gt;();</span><br><span class="line">    for(Transaction t: transactions)&#123;</span><br><span class="line">        if(t.getType() == Transaction.GROCERY)&#123;</span><br><span class="line">            groceryTransactions.add(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Collections.sort(groceryTransactions, new Comparator()&#123;</span><br><span class="line">        public int compare(Transaction t1, Transaction t2)&#123;</span><br><span class="line">            return t2.getValue().compareTo(t1.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    List&lt;Integer&gt; transactionIds = new ArrayList&lt;&gt;();</span><br><span class="line">    for(Transaction t: groceryTransactions)&#123;</span><br><span class="line">        transactionsIds.add(t.getId());</span><br><span class="line">    &#125;</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>

<p>在 Java 8 中使用 Stream 实现的版本更加简洁：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">List&lt;Integer&gt; transactionsIds = transactions.parallelStream().</span><br><span class="line">    filter(t -&gt; t.getType() == Transaction.GROCERY).</span><br><span class="line">    sorted(comparing(Transaction::getValue).reversed()).</span><br><span class="line">    map(Transaction::getId).</span><br><span class="line">    collect(toList());</span><br></pre></td></tr></table></figure>

<h2 id="2-总览"><a href="#2-总览" class="headerlink" title="2 总览"></a>2 总览</h2><h2 id="2-1-什么是流"><a href="#2-1-什么是流" class="headerlink" title="2-1 什么是流"></a>2-1 什么是流</h2><p>Stream 不是集合元素，它不是数据结构，并不保存数据，它与算法和计算有关，更像一个高级版本的 Iterator。原始版本的 Iterator，用户只能显式地一个一个遍历元素并对其执行某些操作；使用 Stream，用户只要给出需要对其包含的元素执行什么操作，比如：「过滤掉长度大于 10 的字符串」、「获取每个字符串的首字母」等，Stream 会隐式地在内部进行遍历，做出相应的数据转换。</p>
<p>Stream 的处理过程是单向、不可往复的，数据只能遍历一次，遍历过一次后即用尽了，就好比流水从面前流过，一去不复返。Stream 的另外一大特点是，数据源本身可以是无限的。</p>
<p>和迭代器不同的是，Stream 可以并行化操作，迭代器只能命令式地、串行化操作。顾名思义，当使用串行方式去遍历时，只能读取一个 item 后再读下一个 item。而使用并行去遍历时，数据会被分成多个段，每一段都在不同的线程中处理，然后将结果一起输出。Stream 的并行操作依赖于 Java 7 中引入的 Fork&#x2F;Join 框架（JSR166y）来拆分任务和加速处理过程。Java 的并行 API 演变历程概括如下：</p>
<ul>
<li>1.0-1.4 中的 java.lang.Thread</li>
<li>5.0 中的 java.util.concurrent</li>
<li>6.0 中的 Phasers 等</li>
<li>7.0 中的 Fork&#x2F;Join 框架</li>
<li>8.0 中的 Lambda</li>
</ul>
<h2 id="2-2-流的构成"><a href="#2-2-流的构成" class="headerlink" title="2-2 流的构成"></a>2-2 流的构成</h2><p>当我们使用一个流的时候，通常包括三个基本步骤：</p>
<ul>
<li>获取一个数据源（source）</li>
<li>数据转换</li>
<li>执行操作获取想要的结果</li>
</ul>
<p>每次转换，原有 Stream 对象不改变，返回一个新的 Stream 对象（可以有多次转换），这就允许对其操作可以像链条一样排列，变成一个管道。</p>
<h2 id="2-3-生成-Stream"><a href="#2-3-生成-Stream" class="headerlink" title="2-3 生成 Stream"></a>2-3 生成 Stream</h2><p>有多种方式生成 Stream 源</p>
<h2 id="从-Collection-和数组"><a href="#从-Collection-和数组" class="headerlink" title="从 Collection 和数组"></a>从 Collection 和数组</h2><ul>
<li>Collection.stream()</li>
<li>Collection.parallelStream()</li>
<li>Arrays.stream(T array)</li>
<li>Stream.of()</li>
</ul>
<h2 id="从-BufferedReader"><a href="#从-BufferedReader" class="headerlink" title="从 BufferedReader"></a>从 BufferedReader</h2><ul>
<li>java.io.BufferedReader.lines()</li>
</ul>
<h2 id="静态工厂"><a href="#静态工厂" class="headerlink" title="静态工厂"></a>静态工厂</h2><ul>
<li>java.util.stream.IntStream.range()</li>
<li>java.nio.file.Files.walk()</li>
</ul>
<h2 id="自己构建"><a href="#自己构建" class="headerlink" title="自己构建"></a>自己构建</h2><ul>
<li>java.util.Spliterator</li>
</ul>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><ul>
<li>Random.ints()</li>
<li>BitSet.stream()</li>
<li>Pattern.splitAsStream(java.lang.CharSequence)</li>
<li>JarFile.stream()</li>
</ul>
<h2 id="3-流的操作"><a href="#3-流的操作" class="headerlink" title="3 流的操作"></a>3 流的操作</h2><p>当把一个数据结构包装成 Stream 后，就要开始对里面的元素进行各类操作了，流的操作类型分为以下几种：</p>
<h2 id="3-1-Intermediate"><a href="#3-1-Intermediate" class="headerlink" title="3-1 Intermediate"></a>3-1 Intermediate</h2><p>一个流可以后面跟随零个或多个 intermediate 操作。其目的主要是打开流，做出某种程度的数据映射&#x2F;过滤，然后返回一个新的流，交给下一个操作使用。这类操作都是惰性化的（lazy），就是说，仅仅调用到这类方法，并没有真正开始流的遍历。常见的操作如下：</p>
<p><strong>map (mapToInt, flatMap 等)、 filter、 distinct、 sorted、 peek、 limit、 skip、 parallel、 sequential、 unordered</strong></p>
<h2 id="3-2-Terminal"><a href="#3-2-Terminal" class="headerlink" title="3-2 Terminal"></a>3-2 Terminal</h2><p>一个流只能有一个 terminal 操作，当这个操作执行后，流就被使用「光」了，无法再被操作。所以这必定是流的最后一个操作。Terminal 操作的执行，才会真正开始流的遍历，并且会生成一个结果，或者一个 side effect。常见的操作如下：</p>
<p><strong>forEach、 forEachOrdered、 toArray、 reduce、 collect、 min、 max、 count、 anyMatch、 allMatch、 noneMatch、 findFirst、 findAny、 iterator</strong></p>
<p>在对于一个 Stream 进行多次转换操作 (Intermediate 操作)，每次都对 Stream 的每个元素进行转换，而且是执行多次，这样时间复杂度就是 N（转换次数）个 for 循环里把所有操作都做掉的总和吗？其实不是这样的，转换操作都是 lazy 的，多个转换操作只会在 Terminal 操作的时候融合起来，一次循环完成。我们可以这样简单的理解，Stream 里有个操作函数的集合，每次转换操作就是把转换函数放入这个集合中，在 Terminal 操作的时候循环 Stream 对应的集合，然后对每个元素执行所有的函数。</p>
<h2 id="3-3-short-circuiting"><a href="#3-3-short-circuiting" class="headerlink" title="3-3 short-circuiting"></a>3-3 short-circuiting</h2><p>还有一种操作被称为 short-circuiting（短路）。用以指：</p>
<ul>
<li>对于一个 intermediate 操作，如果它接受的是一个无限大（infinite&#x2F;unbounded）的 Stream，但返回一个有限的新 Stream。</li>
<li>对于一个 terminal 操作，如果它接受的是一个无限大的 Stream，但能在有限的时间计算出结果。</li>
</ul>
<p>当操作一个无限大的 Stream，而又希望在有限时间内完成操作，则在管道内拥有一个 short-circuiting 操作是必要非充分条件。常见的操作如下：</p>
<p><strong>anyMatch、 allMatch、 noneMatch、 findFirst、 findAny、 limit</strong></p>
<h2 id="4-流的使用详解"><a href="#4-流的使用详解" class="headerlink" title="4 流的使用详解"></a>4 流的使用详解</h2><p>简单说，对 Stream 的使用就是实现一个 filter-map-reduce 过程，产生一个最终结果，或者导致一个副作用（side effect）。</p>
<h2 id="4-1-构造与转换"><a href="#4-1-构造与转换" class="headerlink" title="4-1 构造与转换"></a>4-1 构造与转换</h2><p>下面提供最常见的几种构造 Stream 的样例。</p>
<p>案例：构造流的几种常见方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 1. Individual values</span><br><span class="line">Stream stream = Stream.of(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;);</span><br><span class="line">// 2. Arrays</span><br><span class="line">String [] strArray = new String[] &#123;&quot;a&quot;, &quot;b&quot;, &quot;c&quot;&#125;;</span><br><span class="line">stream = Stream.of(strArray);</span><br><span class="line">stream = Arrays.stream(strArray);</span><br><span class="line">// 3. Collections</span><br><span class="line">List&lt;String&gt; list = Arrays.asList(strArray);</span><br><span class="line">stream = list.stream();</span><br></pre></td></tr></table></figure>

<p>需要注意的是，对于基本数值型，目前有三种对应的包装类型 Stream：IntStream、LongStream、DoubleStream。当然我们也可以用 Stream<Integer>、Stream<Long> &gt;、Stream<Double>，但是 boxing 和 unboxing 会很耗时，所以特别为这三种基本数值型提供了对应的 Stream。Java 8 中还没有提供其它数值型 Stream，因为这将导致扩增的内容较多。而常规的数值型聚合运算可以通过上面三种 Stream 进行。</p>
<p>案例：数值流的构造</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">IntStream.of(new int[]&#123;1, 2, 3&#125;).forEach(System.out::println);</span><br><span class="line">IntStream.range(1, 3).forEach(System.out::println);</span><br><span class="line">IntStream.rangeClosed(1, 3).forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<p>案例：流转换为其它数据结构</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 1. Array</span><br><span class="line">String[] strArray1 = stream.toArray(String[]::new);</span><br><span class="line">// 2. Collection</span><br><span class="line">List&lt;String&gt; list1 = stream.collect(Collectors.toList());</span><br><span class="line">List&lt;String&gt; list2 = stream.collect(Collectors.toCollection(ArrayList::new));</span><br><span class="line">Set set1 = stream.collect(Collectors.toSet());</span><br><span class="line">Stack stack1 = stream.collect(Collectors.toCollection(Stack::new));</span><br><span class="line">// 3. String</span><br><span class="line">String str = stream.collect(Collectors.joining()).toString();</span><br></pre></td></tr></table></figure>
<p>注：一个 Stream 只可以使用一次，上面的代码为了简洁而重复使用了数次。</p>
<h2 id="4-2-典型用法及案例"><a href="#4-2-典型用法及案例" class="headerlink" title="4-2 典型用法及案例"></a>4-2 典型用法及案例</h2><h2 id="map、flatMap"><a href="#map、flatMap" class="headerlink" title="map、flatMap"></a>map、flatMap</h2><p>我们先来看 map。如果你熟悉 scala 这类函数式语言，对这个方法应该很了解，它的作用就是把 input Stream 的每一个元素，映射成 output Stream 的另外一个元素。</p>
<p>案例：这段代码把所有的单词转换为大写。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; output = wordList.stream()</span><br><span class="line">    .map(String::toUpperCase)</span><br><span class="line">    .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p>案例：这段代码生成一个整数 list 的平方数 {1, 4, 9, 16}。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">List&lt;Integer&gt; nums = Arrays.asList(1, 2, 3, 4);</span><br><span class="line">List&lt;Integer&gt; squareNums = nums.stream()</span><br><span class="line">    .map(n -&gt; n * n)</span><br><span class="line">    .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p>从上面例子可以看出，map 生成的是个 1:1 映射，每个输入元素，都按照规则转换成为另外一个元素。还有一些场景，是一对多映射关系的，这时需要 flatMap。</p>
<p>案例：一对多。flatMap 把 input Stream 中的层级结构扁平化，就是将最底层元素抽出来放到一起，最终 output 的新 Stream 里面已经没有 List 了，都是直接的数字。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tream&lt;List&lt;Integer&gt;&gt; inputStream = Stream.of(</span><br><span class="line">    Arrays.asList(1),</span><br><span class="line">    Arrays.asList(2, 3),</span><br><span class="line">    Arrays.asList(4, 5, 6)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">Stream&lt;Integer&gt; outputStream = inputStream</span><br><span class="line">    .flatMap((childList) -&gt; childList.stream());</span><br></pre></td></tr></table></figure>

<h2 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h2><p>filter 对原始 Stream 进行某项测试，通过测试的元素被留下来生成一个新 Stream。</p>
<p>案例：留下偶数，经过条件「被 2 整除」的 filter，剩下的数字为 {2, 4, 6}。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Integer[] sixNums = &#123;1, 2, 3, 4, 5, 6&#125;;</span><br><span class="line">Integer[] evens =Stream.of(sixNums)</span><br><span class="line">    .filter(n -&gt; n%2 == 0)</span><br><span class="line">    .toArray(Integer[]::new);</span><br></pre></td></tr></table></figure>

<p>案例：把单词挑出来，这段代码首先把每行的单词用 flatMap 整理到新的 Stream，然后保留长度不为 0 的，就是整篇文章中的全部单词了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; output = reader.lines()</span><br><span class="line">    .flatMap(line -&gt; Stream.of(line.split(REGEXP)))</span><br><span class="line">    .filter(word -&gt; word.length() &gt; 0)</span><br><span class="line">    .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<h2 id="forEach、peek"><a href="#forEach、peek" class="headerlink" title="forEach、peek"></a>forEach、peek</h2><p>forEach 方法接收一个 Lambda 表达式，然后在 Stream 的每一个元素上执行该表达式。</p>
<p>案例：打印姓名（forEach 和 pre-java 8 的对比）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// Java 8</span><br><span class="line">roster.stream()</span><br><span class="line">    .filter(p -&gt; p.getGender() == Person.Sex.MALE)</span><br><span class="line">    .forEach(p -&gt; System.out.println(p.getName()));</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// Pre-Java 8</span><br><span class="line">for (Person p : roster) &#123;</span><br><span class="line">    if (p.getGender() == Person.Sex.MALE) &#123;</span><br><span class="line">        System.out.println(p.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对一个人员集合遍历，找出男性并打印姓名。可以看出来，forEach 是为 Lambda 而设计的，保持了最紧凑的风格。而且 Lambda 表达式本身是可以重用的，非常方便。当需要为多核系统优化时，可以 parallelStream().forEach()，只是此时原有元素的次序没法保证，并行的情况下将改变串行时操作的行为，此时 forEach 本身的实现不需要调整，而 Java8 以前的 for 循环 code 可能需要加入额外的多线程逻辑。</p>
<p>但一般认为，forEach 和常规 for 循环的差异不涉及到性能，它们仅仅是函数式风格与传统 Java 风格的差别。</p>
<p>另外一点需要注意，forEach 是 terminal 操作，因此它执行后，Stream 的元素就被「消费」掉了，你无法对一个 Stream 进行两次 terminal 运算。下面的代码是错误的：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">stream.forEach(element -&gt; doOneThing(element));</span><br><span class="line">stream.forEach(element -&gt; doAnotherThing(element));</span><br></pre></td></tr></table></figure>

<p>相反，具有相似功能的 intermediate 操作 peek 可以达到上述目的。如下是出现在该 api javadoc 上的一个示例。</p>
<p>案例：使用 peek 对每个元素执行操作并返回一个新的 Stream</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Stream.of(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;)</span><br><span class="line">    .filter(e -&gt; e.length() &gt; 3)</span><br><span class="line">    .peek(e -&gt; System.out.println(&quot;Filtered value: &quot; + e))</span><br><span class="line">    .map(String::toUpperCase)</span><br><span class="line">    .peek(e -&gt; System.out.println(&quot;Mapped value: &quot; + e))</span><br><span class="line">    .collect(Collectors.toList());</span><br></pre></td></tr></table></figure>

<p>forEach 不能修改自己包含的本地变量值，也不能用 break&#x2F;return 之类的关键字提前结束循环。</p>
<h2 id="findFirst"><a href="#findFirst" class="headerlink" title="findFirst"></a>findFirst</h2><p>这是一个 termimal 兼 short-circuiting 操作，它总是返回 Stream 的第一个元素，或者空。这里比较重点的是它的返回值类型：Optional。这也是一个模仿 Scala 语言中的概念，作为一个容器，它可能含有某值，或者不包含。使用它的目的是尽可能避免 NullPointerException。</p>
<p>案例：Optional 的两个用例</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">String strA = &quot; abcd &quot;, strB = null;</span><br><span class="line">print(strA);</span><br><span class="line">print(&quot;&quot;);</span><br><span class="line">print(strB);</span><br><span class="line">getLength(strA);</span><br><span class="line">getLength(&quot;&quot;);</span><br><span class="line">getLength(strB);</span><br><span class="line"></span><br><span class="line">public static void print(String text) &#123;</span><br><span class="line">     // Java 8</span><br><span class="line">     Optional.ofNullable(text).ifPresent(System.out::println);</span><br><span class="line">     // Pre-Java 8</span><br><span class="line">     if (text != null) &#123;</span><br><span class="line">         System.out.println(text);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">public static int getLength(String text) &#123;</span><br><span class="line">    // Java 8</span><br><span class="line">    return Optional.ofNullable(text).map(String::length).orElse(-1);</span><br><span class="line">    // Pre-Java 8</span><br><span class="line">    // return if (text != null) ? text.length() : -1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在更复杂的 if (xx !&#x3D; null) 的情况中，使用 Optional 代码的可读性更好，而且它提供的是编译时检查，能极大的降低 NPE 这种 Runtime Exception 对程序的影响，或者迫使程序员更早的在编码阶段处理空值问题，而不是留到运行时再发现和调试。</p>
<p>Stream 中的 findAny、max&#x2F;min、reduce 等方法等返回 Optional 值。还有例如 IntStream.average() 返回 OptionalDouble 等等。</p>
<h2 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h2><p>这个方法的主要作用是把 Stream 元素组合起来。它提供一个起始值（种子），然后依照运算规则（BinaryOperator），和前面 Stream 的第一个、第二个、第 n 个元素组合。从这个意义上说，字符串拼接、数值的 sum、min、max、average 都是特殊的 reduce。例如 Stream 的 sum 就相当于 <code>Integer sum = integers.reduce(0, (a, b) -&gt; a+b);</code> 或 <code>Integer sum = integers.reduce(0, Integer::sum);</code>。也有没有起始值的情况，这时会把 Stream 的前面两个元素组合起来，返回的是 Optional。</p>
<p>案例：reduce 的使用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 字符串连接，concat = &quot;ABCD&quot;</span><br><span class="line">String concat = Stream.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;).reduce(&quot;&quot;, String::concat);</span><br><span class="line">// 求最小值，minValue = -3.0</span><br><span class="line">double minValue = Stream.of(-1.5, 1.0, -3.0, -2.0).reduce(Double.MAX_VALUE, Double::min);</span><br><span class="line">// 求和，sumValue = 10, 有起始值</span><br><span class="line">int sumValue = Stream.of(1, 2, 3, 4).reduce(0, Integer::sum);</span><br><span class="line">// 求和，sumValue = 10, 无起始值</span><br><span class="line">sumValue = Stream.of(1, 2, 3, 4).reduce(Integer::sum).get();</span><br><span class="line">// 过滤，字符串连接，concat = &quot;ace&quot;</span><br><span class="line">concat = Stream.of(&quot;a&quot;, &quot;B&quot;, &quot;c&quot;, &quot;D&quot;, &quot;e&quot;, &quot;F&quot;).</span><br><span class="line">    filter(x -&gt; x.compareTo(&quot;Z&quot;) &gt; 0).</span><br><span class="line">    reduce(&quot;&quot;, String::concat);</span><br></pre></td></tr></table></figure>

<p>上面代码例如第一个示例的 reduce()，第一个参数（空白字符）即为起始值，第二个参数（String::concat）为 BinaryOperator。这类有起始值的 reduce() 都返回具体的对象。而对于第四个示例没有起始值的 reduce()，由于可能没有足够的元素，返回的是 Optional，请留意这个区别。</p>
<h2 id="limit、skip"><a href="#limit、skip" class="headerlink" title="limit、skip"></a>limit、skip</h2><p>limit 返回 Stream 的前面 n 个元素；skip 则是扔掉前 n 个元素（它是由一个叫 subStream 的方法改名而来）。</p>
<p>案例：limit 和 skip 对运行次数的影响</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 定义一个 Person 类</span><br><span class="line">private class Person &#123;</span><br><span class="line">    public int no;</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    public Person (int no, String name) &#123;</span><br><span class="line">        this.no = no;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        System.out.print(name + &quot;,&quot;);</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void testLimitAndSkip() &#123;</span><br><span class="line">    List&lt;Person&gt; persons = new ArrayList&lt;&gt;();</span><br><span class="line">    for (int i = 1; i &lt;= 10000; i++) &#123;</span><br><span class="line">        Person person = new Person(i, &quot;name&quot; + i);</span><br><span class="line">        persons.add(person);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; personList2 = persons.stream()</span><br><span class="line">        .map(Person::getName)</span><br><span class="line">        .limit(10).skip(3)</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">    System.out.println(&quot;\n&quot; + personList2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">name1,name2,name3,name4,name5,name6,name7,name8,name9,name10,</span><br><span class="line"></span><br><span class="line">[name4, name5, name6, name7, name8, name9, name10]</span><br></pre></td></tr></table></figure>

<p>这是一个有 10，000 个元素的 Stream，但在 short-circuiting 操作 limit 和 skip 的作用下，管道中 map 操作指定的 getName() 方法的执行次数为 limit 所限定的 10 次，而最终返回结果在跳过前 3 个元素后只有后面 7 个返回。</p>
<p>有一种情况是 limit&#x2F;skip 无法达到 short-circuiting 目的的，就是把它们放在 Stream 的排序操作后，原因跟 sorted 这个 intermediate 操作有关：此时系统并不知道 Stream 排序后的次序如何，所以 sorted 中的操作看上去就像完全没有被 limit 或者 skip 一样。</p>
<p>案例：limit 和 skip 对 sorted 后的运行次数无影响</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">private class Person &#123;</span><br><span class="line">    public int no;</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    public Person (int no, String name) &#123;</span><br><span class="line">        this.no = no;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getName() &#123; return name; &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;&#123;no=&quot; + no + &quot;, name=&#x27;&quot; + name + &quot;&#x27;&#125;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void testLimitAndSkip() &#123;</span><br><span class="line">    Set&lt;Person&gt; persons = new HashSet&lt;&gt;();</span><br><span class="line">    for (int i = 1; i &lt;= 5; i++) &#123;</span><br><span class="line">        Person person = new Person(i, &quot;name&quot; + i);</span><br><span class="line">        persons.add(person);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(persons);</span><br><span class="line">    List&lt;Person&gt; personList2 = persons.stream()</span><br><span class="line">        .sorted((p1, p2) -&gt;p1.getName().compareTo(p2.getName()))</span><br><span class="line">        .limit(2)</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">    System.out.println(&quot;\n&quot; + personList2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 或优化为：</span><br><span class="line">public void testLimitAndSkip() &#123;</span><br><span class="line">    Set&lt;Person&gt; persons = new HashSet&lt;&gt;();</span><br><span class="line">    for (int i = 1; i &lt;= 5; i++) &#123;</span><br><span class="line">        Person person = new Person(i, &quot;name&quot; + i);</span><br><span class="line">        persons.add(person);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(persons);</span><br><span class="line">    List&lt;Person&gt; personList2 = persons.stream()</span><br><span class="line">        .sorted(Comparator.comparing(Person::getName))</span><br><span class="line">        .limit(2)</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">    System.out.println(&quot;\n&quot; + personList2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的示例对案例做了微调，将元素容器修改为 Set，以便能清晰显示出排序效果。仅对 5 个元素的 Stream 排序，然后进行 limit 操作。输出结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[&#123;no=1, name=&#x27;name1&#x27;&#125;, &#123;no=5, name=&#x27;name5&#x27;&#125;, &#123;no=4, name=&#x27;name4&#x27;&#125;, &#123;no=3, name=&#x27;name3&#x27;&#125;, &#123;no=2, name=&#x27;name2&#x27;&#125;]</span><br><span class="line"></span><br><span class="line">[&#123;no=1, name=&#x27;name1&#x27;&#125;, &#123;no=2, name=&#x27;name2&#x27;&#125;]</span><br></pre></td></tr></table></figure>

<p>即虽然最后的返回元素数量是 2，但整个管道中的 sorted 表达式执行次数没有像前面例子相应减少。</p>
<p>最后有一点需要注意的是，对一个 parallel 的 Steam 管道来说，如果其元素是有序的，那么 limit 操作的成本会比较大，因为它的返回对象必须是前 n 个也有一样次序的元素。取而代之的策略是取消元素间的次序，或者不要用 parallel Stream。</p>
<h2 id="sorted"><a href="#sorted" class="headerlink" title="sorted"></a>sorted</h2><p>对 Stream 的排序通过 sorted 进行，它比数组的排序更强之处在于你可以首先对 Stream 进行各类 map、filter、limit、skip 甚至 distinct 来减少元素数量后，再排序，这能帮助程序明显缩短执行时间。</p>
<p>案例：排序前使用 limit 和 skip 优化</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">private class Person &#123;</span><br><span class="line">    public int no;</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    public Person (int no, String name) &#123;</span><br><span class="line">        this.no = no;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getName() &#123; return name; &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;&#123;no=&quot; + no + &quot;, name=&#x27;&quot; + name + &quot;&#x27;&#125;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void testLimitAndSkip() &#123;</span><br><span class="line">    List&lt;Person&gt; persons = new ArrayList&lt;&gt;();</span><br><span class="line">    for (int i = 1; i &lt;= 5; i++) &#123;</span><br><span class="line">        Person person = new Person(i, &quot;name&quot; + i);</span><br><span class="line">        persons.add(person);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(persons);</span><br><span class="line">    List&lt;Person&gt; personList2 = persons.stream()</span><br><span class="line">        .limit(2)</span><br><span class="line">        .sorted((p1, p2) -&gt; p1.getName().compareTo(p2.getName()))</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line">    System.out.println(&quot;\n&quot; + personList2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果会简单很多：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[&#123;no=1, name=&#x27;name1&#x27;&#125;, &#123;no=2, name=&#x27;name2&#x27;&#125;, &#123;no=3, name=&#x27;name3&#x27;&#125;, &#123;no=4, name=&#x27;name4&#x27;&#125;, &#123;no=5, name=&#x27;name5&#x27;&#125;]</span><br><span class="line"></span><br><span class="line">[&#123;no=1, name=&#x27;name1&#x27;&#125;, &#123;no=2, name=&#x27;name2&#x27;&#125;]</span><br></pre></td></tr></table></figure>

<p>当然，这种优化是有 business logic 上的局限性的：即不要求排序后再取值。</p>
<h2 id="min、max、distinct"><a href="#min、max、distinct" class="headerlink" title="min、max、distinct"></a>min、max、distinct</h2><p>min 和 max 的功能也可以通过对 Stream 元素先排序，再 findFirst 来实现，但前者的性能会更好，为 O(n)，而 sorted 的成本是 O(n log n)。同时它们作为特殊的 reduce 方法被独立出来也是因为求最大最小值是很常见的操作。</p>
<p>案例：找出最长一行的长度</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BufferedReader br = new BufferedReader(new FileReader(&quot;c:\\SUService.log&quot;));</span><br><span class="line">int longest = br.lines()</span><br><span class="line">    .mapToInt(String::length)</span><br><span class="line">    .max()</span><br><span class="line">    .getAsInt();</span><br><span class="line">br.close();</span><br><span class="line">System.out.println(longest);</span><br></pre></td></tr></table></figure>

<p>案例：使用 distinct 来找出全文不重复的单词，转小写，并排序</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; words = br.lines()</span><br><span class="line">    .flatMap(line -&gt; Stream.of(line.split(&quot; &quot;)))</span><br><span class="line">    .filter(word -&gt; word.length() &gt; 0)</span><br><span class="line">    .map(String::toLowerCase)</span><br><span class="line">    .distinct()</span><br><span class="line">    .sorted()</span><br><span class="line">    .collect(Collectors.toList());</span><br><span class="line">br.close();</span><br><span class="line">System.out.println(words);</span><br></pre></td></tr></table></figure>

<h2 id="sum"><a href="#sum" class="headerlink" title="sum"></a>sum</h2><p>案例：通过 stream() 获取当前小物件的 source，filter 和 mapToInt 是 intermediate 操作，进行数据筛选和转换，最后一个 sum() 为 terminal 操作，对符合条件的全部小物件作重量求和。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">int sum = widgets.stream()</span><br><span class="line">    .filter(w -&gt; w.getColor() == RED)</span><br><span class="line">    .mapToInt(w -&gt; w.getWeight())</span><br><span class="line">    .sum();</span><br></pre></td></tr></table></figure>

<h2 id="Match"><a href="#Match" class="headerlink" title="Match"></a>Match</h2><p>Stream 有三个 match 方法，从语义上说：</p>
<ul>
<li>allMatch：Stream 中全部元素符合传入的 predicate，返回 true</li>
<li>anyMatch：Stream 中只要有一个元素符合传入的 predicate，返回 true</li>
<li>noneMatch：Stream 中没有一个元素符合传入的 predicate，返回 true</li>
</ul>
<p>它们都不是要遍历全部元素才能返回结果。例如 allMatch 只要一个元素不满足条件，就 skip 剩下的所有元素，返回 false。对清单 13 中的 Person 类稍做修改，加入一个 age 属性和 getAge 方法。</p>
<p>案例：使用 Match</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class Person &#123;</span><br><span class="line">    public int no;</span><br><span class="line">    private String name;</span><br><span class="line">    private int age;</span><br><span class="line"></span><br><span class="line">    public Person(int no, String name, int age) &#123;</span><br><span class="line">        this.no = no;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    public String getName() &#123; return name; &#125;</span><br><span class="line">    public int getAge() &#123; return age; &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;&#123;no=&quot; + no + &quot;, name=&#x27;&quot; + name + &quot;&#x27;&#125;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void testMatch() &#123;</span><br><span class="line">    List&lt;Person&gt; persons = new ArrayList&lt;&gt;() &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            add(new Person(1, &quot;name&quot; + 1, 10));</span><br><span class="line">            add(new Person(2, &quot;name&quot; + 2, 21));</span><br><span class="line">            add(new Person(3, &quot;name&quot; + 3, 34));</span><br><span class="line">            add(new Person(4, &quot;name&quot; + 4, 6));</span><br><span class="line">            add(new Person(5, &quot;name&quot; + 5, 55));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    boolean isAllAdult = persons.stream()</span><br><span class="line">            .allMatch(p -&gt; p.getAge() &gt; 18);</span><br><span class="line">    System.out.println(&quot;All are adult? &quot; + isAllAdult);</span><br><span class="line">    boolean isThereAnyChild = persons.stream()</span><br><span class="line">            .anyMatch(p -&gt; p.getAge() &lt; 12);</span><br><span class="line">    System.out.println(&quot;Any child? &quot; + isThereAnyChild);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">All are adult? false</span><br><span class="line">Any child? true</span><br></pre></td></tr></table></figure>

<h2 id="4-3-进阶：自己生成流"><a href="#4-3-进阶：自己生成流" class="headerlink" title="4-3 进阶：自己生成流"></a>4-3 进阶：自己生成流</h2><h2 id="Stream-generate"><a href="#Stream-generate" class="headerlink" title="Stream.generate"></a>Stream.generate</h2><p>通过实现 Supplier 接口，你可以自己来控制流的生成。这种情形通常用于随机数、常量的 Stream，或者需要前后元素间维持着某种状态信息的 Stream。把 Supplier 实例传递给 Stream.generate() 生成的 Stream，默认是串行（相对 parallel 而言）但无序的（相对 ordered 而言）。由于它是无限的，在管道中，必须利用 limit 之类的操作限制 Stream 大小。</p>
<p>案例：生成 10 个随机整数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Random seed = new Random();</span><br><span class="line">Supplier&lt;Integer&gt; random = seed::nextInt;</span><br><span class="line">Stream.generate(random)</span><br><span class="line">    .limit(10)</span><br><span class="line">    .forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">//Another way</span><br><span class="line">IntStream.generate(() -&gt; (int) (System.nanoTime() % 100))</span><br><span class="line">    .limit(10)</span><br><span class="line">    .forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<p>Stream.generate() 还接受自己实现的 Supplier。例如在构造海量测试数据的时候，用某种自动的规则给每一个变量赋值；或者依据公式计算 Stream 的每个元素值。这些都是维持状态信息的情形。</p>
<p>案例：自实现 Supplier</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Stream.generate(new PersonSupplier())</span><br><span class="line">    .limit(10)</span><br><span class="line">    .forEach(p -&gt; System.out.println(p.getName() + &quot;, &quot; + p.getAge()));</span><br><span class="line"></span><br><span class="line">private class PersonSupplier implements Supplier&lt;Person&gt; &#123;</span><br><span class="line">    private int index = 0;</span><br><span class="line">    private Random random = new Random();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Person get() &#123;</span><br><span class="line">        return new Person(index++, &quot;StormTestUser&quot; + index, random.nextInt(100));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">StormTestUser1, 9</span><br><span class="line">StormTestUser2, 12</span><br><span class="line">StormTestUser3, 88</span><br><span class="line">StormTestUser4, 51</span><br><span class="line">StormTestUser5, 22</span><br><span class="line">StormTestUser6, 28</span><br><span class="line">StormTestUser7, 81</span><br><span class="line">StormTestUser8, 51</span><br><span class="line">StormTestUser9, 4</span><br><span class="line">StormTestUser10, 76</span><br></pre></td></tr></table></figure>

<h2 id="Stream-iterate"><a href="#Stream-iterate" class="headerlink" title="Stream.iterate"></a>Stream.iterate</h2><p>iterate 跟 reduce 操作很像，接受一个种子值，和一个 UnaryOperator（例如 f）。然后种子值成为 Stream 的第一个元素，f(seed) 为第二个，f(f(seed)) 第三个，以此类推。</p>
<p>案例：生成一个等差数列</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Stream.iterate(0, n -&gt; n + 3).limit(10). forEach(x -&gt; System.out.print(x + &quot; &quot;));.</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0 3 6 9 12 15 18 21 24 27</span><br></pre></td></tr></table></figure>

<p>与 Stream.generate 相仿，在 iterate 时候管道必须有 limit 这样的操作来限制 Stream 大小。</p>
<h2 id="4-4-进阶：用-Collectors-来进行-reduction-操作"><a href="#4-4-进阶：用-Collectors-来进行-reduction-操作" class="headerlink" title="4-4 进阶：用 Collectors 来进行 reduction 操作"></a>4-4 进阶：用 Collectors 来进行 reduction 操作</h2><p>java.util.stream.Collectors 类的主要作用就是辅助进行各类有用的 reduction 操作，例如转变输出为 Collection，把 Stream 元素进行归组。</p>
<h2 id="groupingBy-和-partitioningBy"><a href="#groupingBy-和-partitioningBy" class="headerlink" title="groupingBy 和 partitioningBy"></a>groupingBy 和 partitioningBy</h2><p>案例：按照年龄归组</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Map&lt;Integer, List&lt;Person&gt;&gt; personGroups = Stream.generate(new PersonSupplier())</span><br><span class="line">    .limit(100)</span><br><span class="line">    .collect(Collectors.groupingBy(Person::getAge));</span><br><span class="line">Iterator it = personGroups.entrySet().iterator();</span><br><span class="line">while (it.hasNext()) &#123;</span><br><span class="line">    Map.Entry&lt;Integer, List&lt;Person&gt;&gt; persons = (Map.Entry) it.next();</span><br><span class="line">    System.out.println(&quot;Age &quot; + persons.getKey() + &quot; = &quot; + persons.getValue().size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的 code，首先生成 100 人的信息，然后按照年龄归组，相同年龄的人放到同一个 list 中，可以看到如下的输出：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Age 0 = 2</span><br><span class="line">Age 1 = 2</span><br><span class="line">Age 5 = 2</span><br><span class="line">Age 8 = 1</span><br><span class="line">Age 9 = 1</span><br><span class="line">Age 11 = 2</span><br><span class="line">……</span><br></pre></td></tr></table></figure>

<p>案例：按照未成年人和成年人归组</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Map&lt;Boolean, List&lt;Person&gt;&gt; children = Stream.generate(new PersonSupplier())</span><br><span class="line">    .limit(100)</span><br><span class="line">    .collect(Collectors.partitioningBy(p -&gt; p.getAge() &lt; 18));</span><br><span class="line">System.out.println(&quot;Children number: &quot; + children.get(true).size());</span><br><span class="line">System.out.println(&quot;Adult number: &quot; + children.get(false).size());</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Children number: 23</span><br><span class="line">Adult number: 77</span><br></pre></td></tr></table></figure>
<p>在使用条件「年龄小于 18」进行分组后可以看到，不到 18 岁的未成年人是一组，成年人是另外一组。partitioningBy 其实是一种特殊的 groupingBy，它依照条件测试的是否两种结果来构造返回的数据结构，get(true) 和 get(false) 能即为全部的元素对象。</p>
<h2 id="5-结束语"><a href="#5-结束语" class="headerlink" title="5 结束语"></a>5 结束语</h2><p>总之，Stream 的特性可以归纳为：</p>
<ul>
<li><p>不是数据结构</p>
</li>
<li><p>它没有内部存储，它只是用操作管道从 source（数据结构、数组、generator function、IO channel）抓取数据。</p>
</li>
<li><p>它也绝不修改自己所封装的底层数据结构的数据。例如 Stream 的 filter 操作会产生一个不包含被过滤元素的新 Stream，而不是从 source 删除那些元素。</p>
</li>
<li><p>所有 Stream 的操作必须以 lambda 表达式为参数</p>
</li>
<li><p>不支持索引访问</p>
</li>
<li><p>你可以请求第一个元素，但无法请求第二个，第三个，或最后一个。不过请参阅下一项。</p>
</li>
<li><p>很容易生成数组或者 List</p>
</li>
<li><p>惰性化</p>
</li>
<li><p>很多 Stream 操作是向后延迟的，一直到它弄清楚了最后需要多少数据才会开始。</p>
</li>
<li><p>Intermediate 操作永远是惰性化的。</p>
</li>
<li><p>并行能力</p>
</li>
<li><p>当一个 Stream 是并行化的，就不需要再写多线程代码，所有对它的操作会自动并行进行的。</p>
</li>
<li><p>可以是无限的。集合有固定大小，Stream 则不必。limit(n) 和 findFirst() 这类的 short-circuiting 操作可以对无限的 Stream 进行运算并很快完成。</p>
</li>
</ul>
]]></content>
      <categories>
        <category>文献翻译</category>
        <category>java</category>
      </categories>
      <tags>
        <tag>未标记</tag>
      </tags>
  </entry>
  <entry>
    <title>Java-Custom-Exception-Example</title>
    <url>/4686ddb0-2bb6-11ee-879b-0b2c36f14b2e/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h1 id="Java-Custom-Exception-Example"><a href="#Java-Custom-Exception-Example" class="headerlink" title="Java Custom Exception Example"></a>Java Custom Exception Example</h1><p><strong>Java 自定义异常案例</strong></p>
<blockquote>
<p>转译自：<a href="https://examples.javacodegeeks.com/">https://examples.javacodegeeks.com</a></p>
</blockquote>
<p>In this example we will look briefly（短暂的） at the basics of <code>Exception</code>, in Java Programming Language. We will also see, how to create a custom <code>Exception</code> Class.</p>
<p>在这个案例中，我们将使用 Java 语言来简要介绍“异常”的基础知识。我们同样也能够了解如何创建一个自定义的 Exception 类。</p>
<h2 id="1、Basics-of-Exception"><a href="#1、Basics-of-Exception" class="headerlink" title="1、Basics of Exception"></a>1、Basics of Exception</h2><p><strong>异常的基础知识</strong><br>As per（按照） oracle docs, An exception is an event, which occurs during the execution of a program, that disrupts（扰乱） the normal flow of the program’s instructions（指令）.</p>
<p>按照 oracle 的文档介绍，异常是一个在程序运行期间发生的事件，会扰乱正常程序流程的指令。</p>
<p>In laymen（非专业人员） terms, when a condition occurs, in which the routine（程序） is not sure how to proceed in an ordinary way it creates an object of exception and hands it over to the runtime system to find an appropriate handler for the exception object. In case, the runtime system does not find an appropriate handler in the call hierarchy the runtime system terminates.</p>
<p>用非专业的话来说，当满足异常发生条件时，程序不确定能以普通的方式进行时，它创建一个异常对象并递交给运行时系统，以查找处理异常对象的合适的处理程序。在这种情况下，运行时系统在运行时系统终止的调用层次结构中没有找到合适的处理程序。</p>
<p>The exceptions have <code>java.lang.Throwable</code> as their superclass.The three main categories of Exceptional conditions are :</p>
<p>异常以 java.lang.Throwable 类作为父类。异常主要有三大类：</p>
<p>（1）Error(represented by <code>java.lang.Error</code> and its sub-classes)</p>
<p>错误（以 java.lang.Error 类及其子类表示）</p>
<p>（2）Checked Exception(represented by direct subclasses of <code>java.lang.Exception</code> except <code>java.lang.RuntimeException</code>)</p>
<p>Checked 异常（由 java.lang.Exception 除了 java.lang.RuntimeException 类的子类表示）</p>
<p>（3）Unchecked or Runtime Exceptions (represented by <code>java.lang.RuntimeException</code> and its sub-classes)</p>
<p>Unchecked 或运行时异常（由 java.lang.RuntimeException 类及其子类表示）</p>
<p><strong>Errors :</strong> Errors denote serious abnormal（不正常的） condition with the application like <code>OutOfMemoryError</code> or <code>VirtualMachineError</code>. Any reasonable application should not try to recover from such a condition.</p>
<p>错误表示严重的异常情况，如 OutOfMemoryError（内存溢出）或 VirtualMachineError（虚拟机错误）。任何理由都不能使应用程序从这种情况中恢复过来。</p>
<p><strong>Runtime Exception&#x2F;Unchecked Exception :</strong> These types of exceptions usually indicate programming errors like <code>NullPointerException</code> or <code>IllegalArgumentException</code>. The application may or may not choose to recover from the condition.</p>
<p>这些类型的异常通常表示程序错误，如 NullPointerException（空指针异常）或 IllegalArgumentException（参数异常）。应用程序可以选择从该类异常中恢复，也可以选择不恢复。</p>
<p><strong>Checked Exception :</strong> An application is supposed to catch these types of exceptions and recover reasonably from them. Examples include <code>FileNotFoundException</code> and <code>ParseException</code>.</p>
<p>应用程序应该捕获这类异常并合理恢复。例如 FileNotFoundException（文件未找到异常）和 ParseException（解析异常）。</p>
<h2 id="2、Creating-custom-Exception"><a href="#2、Creating-custom-Exception" class="headerlink" title="2、Creating custom Exception"></a>2、Creating custom Exception</h2><p><strong>创建自定义异常</strong><br>The first thing before creating a custom exception, the developer should be able to justify（证明） the creation（创建，n.）. As per（按照） Java Docs, You should write your own exception classes if you answer yes to any of the following questions; otherwise, you can probably use someone else’s.</p>
<p>创建自定义异常前，开发者应为此（行为）找到依据。按照 Java 文档，如果你对以下任何一个问题回答 yes，你应该编写自己的异常类；否则，你（最好）用别人的。</p>
<p>（1）Do you need an exception type that isn’t represented by those in the Java platform?</p>
<p>你需要一个 Java 平台中没有（定义）的异常类型吗？</p>
<p>（2）Would it help users if they could differentiate（区分） your exceptions from those thrown by classes written by other vendors（供应商）?</p>
<p>如果用户可以将你的异常与其他供应商编写的类抛出的异常区分开来，那么这会对用户有帮助吗?</p>
<p>（3）Does your code throw more than one related exception?</p>
<p>你的代码是否会抛出多个相关异常？</p>
<p>（4）If you use someone else’s exceptions, will users have access to those exceptions? A similar question is, should your package be independent and self-contained?</p>
<p>如果你使用其他人的异常，用户是否可以访问这些异常？类似的问题是，你的包应该是独立的、自包含的吗？</p>
<p>Now, that you are sure that you really do want a create a custom Exception class we will begin writing the actual program.To create a custom checked exception, we have to sub-class from the <code>java.lang.Exception</code> class. And that’s it! Yes, creating a custom exception in java is simple as that!</p>
<p>现在，你确信确实想要创建一个自定义的异常类，我们将开始编写实际的程序。要创建一个自定义异常，我们必须从 java.lang.Exception 派生子类。是的，在 java 中创建一个自定义异常很简单！</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class CustomException extends Exception&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>Sometimes though, the <code>CustomException</code> object will have to be constructed from another exception. So its important that we create a constructor for such a scenario.</p>
<p>但有时，CustomException 对象需要通过另一个异常来构造。因此，为这样的场景创建构造函数是很重要的。</p>
<p>So a more complete class would be as below :</p>
<p>因此，一个更完整的类应如下所示：</p>
<p><strong>CustomException.java:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.examples.exception;</span><br><span class="line">public class CustomException extends Exception</span><br><span class="line">&#123;</span><br><span class="line">    private static final long serialVersionUID = 1997753363232807009L;</span><br><span class="line">		public CustomException()</span><br><span class="line">		&#123;&#125;</span><br><span class="line">		public CustomException(String message)</span><br><span class="line">		&#123;</span><br><span class="line">			super(message);</span><br><span class="line">		&#125;</span><br><span class="line">		public CustomException(Throwable cause)</span><br><span class="line">		&#123;</span><br><span class="line">			super(cause);</span><br><span class="line">		&#125;</span><br><span class="line">		public CustomException(String message, Throwable cause)</span><br><span class="line">		&#123;</span><br><span class="line">			super(message, cause);</span><br><span class="line">		&#125;</span><br><span class="line">		public CustomException(String message, Throwable cause,</span><br><span class="line">                         boolean enableSuppression, boolean writableStackTrace)</span><br><span class="line">		&#123;</span><br><span class="line">			super(message, cause, enableSuppression, writableStackTrace);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.1、Testing the custom Exception（测试自定义异常） :</strong><br><strong>CustomExceptionTest.java:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.javacodegeeks.examples.exception;</span><br><span class="line">public class CustomExceptionTest</span><br><span class="line">&#123;</span><br><span class="line">    public static void main(String[] args)</span><br><span class="line">    &#123;</span><br><span class="line">	try</span><br><span class="line">        &#123;</span><br><span class="line">	      testException(null);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (CustomException e)</span><br><span class="line">        &#123;</span><br><span class="line">	      e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public static void testException(String string) throws CustomException</span><br><span class="line">    &#123;</span><br><span class="line">	      if(string == null)</span><br><span class="line">		    throw new CustomException(&quot;The String value is null&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Similarly, an unchecked exception can be created by sub-classing from the <code>java.lang.RuntimeException</code> Class.</p>
<p>类似地，unchecked 异常可以通过 java.lang.RuntimeException 的子类来创建。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class CustomException extends RuntimeException&#123;...&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3、Points-to-note"><a href="#3、Points-to-note" class="headerlink" title="3、Points to note"></a>3、Points to note</h2><p><strong>注意事项</strong><br>（1）An unchecked exception should be preferred（首选） to a checked exception. This will help programmes to be free of unnecessary <code>try..catch blocks</code>.</p>
<p>相比一个 unchecked 异常，应首选 checked 异常。这有助于程序摆脱不必要的 try..catch 块。</p>
<p>（2）Exceptions are abnormal conditions, and as such should not be used for controlling the flow of execution of the programmes(as demonstrated by example below).</p>
<p>异常是异常情况，不应该用于程序的流程控制（如下面示例所示）。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">try</span><br><span class="line">&#123;</span><br><span class="line">	for (int i = 0;; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		System.out.println(args[i]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">catch (ArrayIndexOutOfBoundsException e)</span><br><span class="line">&#123;</span><br><span class="line">		// do nothing</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（3）A <code>catch block</code> should not be empty as shown in the example above. Such exceptions are very difficult to track（跟踪）, since there is no logging.</p>
<p>catch 块不应该是空的，如上面的示例所示。由于没有日志记录，因此很难跟踪这些异常。</p>
<p>（4）The name of a custom exception class should end with Exception. It improves the readability of the code. Instead of naming the class InvalidSerial, the class should be named InvalidSerialException.</p>
<p>自定义异常类的名称应该以 Exception 结尾。它提高了代码的可读性。类不应该命名为 InvalidSerial，而应该命名为 InvalidSerialException。</p>
<p>（5）When using ARM&#x2F;try-with-resources blocks, if exception gets suppressed by the try-with-resources statement, we can use <code>Throwable#getSuppressed()</code> method.</p>
<p>当使用 ARM&#x2F;try-with-resources 块时，如果异常被 try-with-resources 语句抑制，我们可以使用 Throwable# getrepression()方法。</p>
<h2 id="4、Closing-Words"><a href="#4、Closing-Words" class="headerlink" title="4、Closing Words"></a>4、Closing Words</h2><p><strong>结束语</strong></p>
<p>Here,we tried to understand the basics of exception and how to create a custom exception of our own. We learned the best practices while creating a custom exception class and also how to handle（处理） an exception in a reasonable manner.</p>
<p>在这里，我们尝试理解异常的基本原理，以及如何创建我们自己的自定义异常。我们在创建自定义异常类时学习了最佳实践，以及如何以合理的方式处理异常。</p>
<h2 id="附录，相关资料-1"><a href="#附录，相关资料-1" class="headerlink" title="附录，相关资料 1"></a>附录，相关资料 1</h2><p><strong>可与上述转译内容互参</strong><br>Throwable 是所有 Java 中所有异常类的父类，有两种子类：<strong>Error</strong>和<strong>Exception</strong></p>
<p><strong>1、Error：</strong> 表示由 JVM 所侦测到的无法预期的错误，由于这是属于 JVM 层次的严重错误，导致 JVM 无法继续执行，这是不可捕捉到的，无法采取任何恢复的操作，只能显示错误信息。Error 类体系描述了 Java 运行系统中的内部错误以及资源耗尽的情形，应用程序不应该抛出这种类型的对象（一般是由虚拟机抛出）。假如出现这种错误，除了尽力使程序安全退出外，在其他方面是无能为力的。</p>
<p><strong>2、Exception：</strong> 表示可恢复的异常，这是可捕捉到的。Java 提供了两类主要的异常：Runtime Exception 和 checked exception。</p>
<p>（2-1）checked 异常是经常遇到的，如：IO 异常、SQL 异常。对于这种异常，JAVA 编译器强制要求我们对出现的这些异常进行 catch。所以，面对这种异常只能编写 catch 块去处理。这类异常一般是外部错误，例如试图从文件尾后读取数据等，这并不是程序本身的错误，而是在应用环境中出现的外部错误。</p>
<p>（2-2）Runtime Exception 也称运行时异常，我们可以不处理。当出现这样的异常时，总是由虚拟机接管。比如：我们从来没有人去处理过 NullPointerException 异常，它就是运行时异常，并且 NullPointerException 还是最常见的异常之一。Runtime Exception 体系包括错误的类型转换、数组越界访问和试图访问空指针等等。如果出现 Runtime Exception，那么一定是程序员的错误。例如：可以通过检查数组下标和数组边界来避免数组越界访问异常。</p>
<p>出现运行时异常后，系统会把异常一直往上层抛，一直遇到处理代码。如果到最上层还没有处理块，多线程程序就由 Thread.run()抛出，这个线程就退出；如果是单线程就被 main()抛出，整个程序也就退出了。运行时异常是 Exception 的子类，也有一般异常的特点，是可以被 catch 块处理的。只不过往往我们不对他处理罢了。如果不对运行时异常进行处理，那么出现运行时异常之后，要么是线程中止，要么是主程序终止。</p>
<p>如果不想终止线程或程序，则必须捕捉所有的运行时异常，决不让这个处理线程退出。队列里面出现异常数据了，正常的处理应该是把异常数据舍弃，然后记录日志。不应该由于异常数据而影响下面对正常数据的处理。但并不代表在所有的场景你都应该如此，如果在其它场景，遇到了一些错误，如果退出程序比较好，这时你就可以不太理会运行时异常，或者是通过对异常的处理显式的控制程序退出。异常处理的目标之一就是为了把程序从异常中恢复出来。</p>
]]></content>
      <categories>
        <category>文献翻译</category>
        <category>java</category>
      </categories>
      <tags>
        <tag>未标记</tag>
      </tags>
  </entry>
  <entry>
    <title>Java-SimpleDateFormat-Example</title>
    <url>/4686ddb2-2bb6-11ee-879b-0b2c36f14b2e/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h1 id="Java-SimpleDateFormat-Example"><a href="#Java-SimpleDateFormat-Example" class="headerlink" title="Java SimpleDateFormat Example"></a>Java SimpleDateFormat Example</h1><p><strong>Java SimpleDateFormat 使用案例</strong></p>
<blockquote>
<p>转译自：<a href="https://examples.javacodegeeks.com/java-simpledateformat-example/">https://examples.javacodegeeks.com/java-simpledateformat-example/</a></p>
</blockquote>
<p>In this example we will show how to use <code>java.text.SimpleDateFormat</code> class so as to convert a Date into a formatted string or a string to a Date.</p>
<p>在这个案例中，我们将展示如何使用 <code>java.text.SimpleDateFormat</code> 类将 Date 类型转化为字符串或字符串转化为 Date 类型。</p>
<p>You can make this conversion using the constructors provided by <code>java.text.SimpleDateFormat</code> class and some patterns, such as dd&#x2F;MM&#x2F;yyyy, dd-MM-yy and so on, so as to format the Date as you wish. We will show more examples of patterns and format symbols in the following sections.</p>
<p>可以使用 <code>java.text.SimpleDateFormat</code> 类提供的构造方法再结合一些模板字符串来进行上述转化，例如：<code>dd/MM/yyyy</code>, <code>dd-MM-yy</code> 等等，以便按照意愿格式化 Date 类型。下面将展示更多有关模板字符串和格式符的例子。</p>
<p>译注：将 pattern 及其复数形式均译作「模板字符串」</p>
<h2 id="1、SimpleDateFormat-constructors"><a href="#1、SimpleDateFormat-constructors" class="headerlink" title="1、SimpleDateFormat constructors"></a>1、SimpleDateFormat constructors</h2><p><strong>SimpleDateFormat 类的构造方法</strong></p>
<p>There are four constructors that you can use so as to create a <code>java.text.SimpleDateFormat</code>.</p>
<p>创建 <code>java.text.SimpleDateFormat</code> 对象可以使用四种构造方法。</p>
<h2 id="1-1、SimpleDateFormat"><a href="#1-1、SimpleDateFormat" class="headerlink" title="1.1、SimpleDateFormat()"></a>1.1、SimpleDateFormat()</h2><p>The simplest constructor which creates a <code>java.text.SimpleDateFormat</code> with a default pattern of date and a default locale.</p>
<p>这个默认构造方法生成的 <code>java.text.SimpleDateFormat</code> 对象具有默认模板字符串和默认地区设置。</p>
<h2 id="1-2、SimpleDateFormat-String-pattern"><a href="#1-2、SimpleDateFormat-String-pattern" class="headerlink" title="1.2、SimpleDateFormat(String pattern)"></a>1.2、SimpleDateFormat(String pattern)</h2><p>The constructor which creates a <code>java.text.SimpleDateFormat</code> with a given pattern and a default locale.</p>
<p>这个构造方法生成的 <code>java.text.SimpleDateFormat</code> 对象具有指定模板字符串和默认地区设置。</p>
<h2 id="1-3、SimpleDateFormat-String-pattern-DateFormatSymbols-formatSymbols"><a href="#1-3、SimpleDateFormat-String-pattern-DateFormatSymbols-formatSymbols" class="headerlink" title="1.3、SimpleDateFormat(String pattern, DateFormatSymbols formatSymbols)"></a>1.3、SimpleDateFormat(String pattern, DateFormatSymbols formatSymbols)</h2><p>Constructs a <code>java.text.SimpleDateFormat</code> with the given pattern and specific date format symbols. DateFormatSymbols is a class for encapsulating（封装） localizable date-time formatting data, such as the names of the months, the names of the days of the week, and the time zone data.</p>
<p>构造一个具有指定模板字符串和具体的日期格式符的 <code>java.text.SimpleDateFormat</code> 对象。DateFormatSymbols 类封装了本地化的 date-time 格式数据，例如月份的名称、星期的名称和时区数据。</p>
<h2 id="1-4、SimpleDateFormat-String-pattern-Locale-locale"><a href="#1-4、SimpleDateFormat-String-pattern-Locale-locale" class="headerlink" title="1.4、SimpleDateFormat(String pattern, Locale locale)"></a>1.4、SimpleDateFormat(String pattern, Locale locale)</h2><p>Constructs a <code>java.text.SimpleDateFormat</code> with the given pattern and a specific locale.</p>
<p>构造一个具有指定模板字符串和具体地区设置的 <code>java.text.SimpleDateFormat</code> 对象。</p>
<h2 id="2、Example-of-SimpleDateFormat"><a href="#2、Example-of-SimpleDateFormat" class="headerlink" title="2、Example of SimpleDateFormat"></a>2、Example of SimpleDateFormat</h2><p><strong>SimpleDateFormat 类的例子</strong></p>
<p>Create a java class named SimpleDateFormatExample.java with the following code:</p>
<p>创建一个名为 <code>SimpleDateFormatExample.java</code> 的文件，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.text.ParseException;</span><br><span class="line">import java.text.SimpleDateFormat;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.Locale;</span><br><span class="line"></span><br><span class="line">public class TestModule &#123;</span><br><span class="line">    @Test</span><br><span class="line">    public void main() &#123;</span><br><span class="line"></span><br><span class="line">        Date currentDate = new Date();</span><br><span class="line"></span><br><span class="line">        SimpleDateFormat format = new SimpleDateFormat();</span><br><span class="line">        String DateToStr = format.format(currentDate);</span><br><span class="line">        System.out.println(&quot;Default pattern: &quot; + DateToStr);</span><br><span class="line"></span><br><span class="line">        format = new SimpleDateFormat(&quot;yyyy/MM/dd&quot;);</span><br><span class="line">        DateToStr = format.format(currentDate);</span><br><span class="line">        System.out.println(DateToStr);</span><br><span class="line"></span><br><span class="line">        format = new SimpleDateFormat(&quot;dd-M-yyyy hh:mm:ss&quot;);</span><br><span class="line">        DateToStr = format.format(currentDate);</span><br><span class="line">        System.out.println(DateToStr);</span><br><span class="line"></span><br><span class="line">        format = new SimpleDateFormat(&quot;dd MMMM yyyy zzzz&quot;, Locale.CHINESE);</span><br><span class="line">        DateToStr = format.format(currentDate);</span><br><span class="line">        System.out.println(DateToStr);</span><br><span class="line"></span><br><span class="line">        format = new SimpleDateFormat(&quot;MMMM dd HH:mm:ss zzzz yyyy&quot;, Locale.CHINA);</span><br><span class="line">        DateToStr = format.format(currentDate);</span><br><span class="line">        System.out.println(DateToStr);</span><br><span class="line"></span><br><span class="line">        format = new SimpleDateFormat(&quot;E, dd MMM yyyy HH:mm:ss z&quot;);</span><br><span class="line">        DateToStr = format.format(currentDate);</span><br><span class="line">        System.out.println(DateToStr);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            Date strToDate = format.parse(DateToStr);</span><br><span class="line">            System.out.println(strToDate);</span><br><span class="line">        &#125; catch (ParseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Let’s explain the different formats of SimpleDateFormat class in the above code. Firstly, we create a Date object which is initialized with the current date and time. Then, we create different date formatters with different patterns, such as:</p>
<p>让我们来解释上述代码中 SimpleDateFormat 类的不同格式。首先，我们创建了一个初始化为当前日期和时间的 Date 对象。然后，我们用不同的模板字符串创建了不同的日期格式器，例如：</p>
<p>The default pattern, which shows the date in the form of month&#x2F;day&#x2F;year and the time using the 12-hour clock.</p>
<p>默认模板字符串展示日期的格式为 <code>month/day/year</code>，时间使用 12 小时制表示。</p>
<p>yyyy&#x2F;MM&#x2F;dd, which shows the date in the form of year&#x2F;month&#x2F;day. As we can observe（观察）, the pattern for the year has 4 letters, which means that the full form of the year will be used (e.g. 2018). Otherwise（否则） a short or abbreviated（缩写） form is used if available.</p>
<p><code>yyyy/MM/dd</code> 将日期展示为 <code>year/month/day</code>，正如我们所观察到的，年份在该模板字符串下有 4 个字符，这意味着将使用一年的完整形式（例如 2018 年）。否则，可以使用简写或缩写的格式。</p>
<p>dd-M-yyyy hh:mm:ss, which shows the date in the form of date-month-year (the month will be shown in the abbreviated form, as it has only one letter and not two as in the previous case) and futhermore（此外）, it shows the time (hour, minutes and seconds) while the hour is in am&#x2F;pm format.</p>
<p><code>dd-M-yyyy hh:mm:ss</code> 将日期展示为 <code>date-month-year</code> 的格式（月份将以缩写形式显示，因为它只有一个字符，而不像以前那样只有两个字符）此外，它还显示时间（小时、分钟和秒），而小时的格式是 <code>am/pm</code>。</p>
<p>dd MMMM yyyy zzzz, which shows the date and the timezone in full format. We can observe that we also defined the locale of the date&#x2F;time: Locale.ENGLISH or Locale.ITALIAN below.</p>
<p><code>dd MMMM yyyy zzzz</code> 以完整格式显示日期和时区。我们可以观察到，还定义了 <code>date/time</code> 为英国地区，或下文中的意大利地区。</p>
<p>译注：为便于查看效果，已将代码修改为 CHINESE 和 CHINA</p>
<p>E, dd MMM yyyy HH:mm:ss z, which shows the date, the day name of the week and the time (we can see that the hour is in capital, which means that the hour’s values here are between 0 – 23, as we use the 24-hour clock).</p>
<p><code>E, dd MMM yyyy HH:mm:ss z</code> 显示了日期、星期几和时间（我们可以看到小时用大写，这意味着小时的值在 0-23 之间，因为我们使用 24 小时制）。</p>
<p>You may notice that there is a slight but basic difference to the followings:</p>
<p>你可能会注意到下面这些细微但却基本的区别：</p>
<p>mm: representes the minutes.</p>
<p>mm：代表「分钟」</p>
<p>MM: represents the Month.</p>
<p>MM：代表「月份」</p>
<p>dd: represents the day.</p>
<p>dd：代表「日」</p>
<p>DD: represents the day in year (e.g. 189 out of 365).</p>
<p>DD：代表当年中的第几天（例如 365 天中的第 189 天）</p>
<p>hh: represents the hour’s value using the 12-hour clock.</p>
<p>hh：代表使用 12 小时制时的小时数</p>
<p>HH: represents the hour’s value using the 24-hour clock.</p>
<p>HH：代表使用 24 小时制时的小时数</p>
<p>Using all those formatters, we format dates as strings.</p>
<p>使用所有这些格式器，可让我们将 Date 格式化为字符串。</p>
<p>Finally, we show a reverse example, where we parse a string into date, using the parse() method.</p>
<p>最后，我们展示了一个相反的案例，使用 <code>parse()</code> 方法将字符串解析为 Date。</p>
<p>For a detailed explanation of the different existing patterns you can visit the java doc SimpleDateFormat.</p>
<p>对于不同现有模板字符串的详细解释，可以访问 SimpleDateFormat 类的文档。</p>
<p>If we run the above code, we will have the following results:</p>
<p>如果我们运行上述代码，我们将得到以下结果:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Default pattern: 18-8-4 上午11:17</span><br><span class="line">2018/08/04</span><br><span class="line">04-8-2018 11:17:03</span><br><span class="line">04 八月 2018 China Standard Time</span><br><span class="line">八月 04 11:17:03 中国标准时间 2018</span><br><span class="line">星期六, 04 八月 2018 11:17:03 CST</span><br><span class="line">Sat Aug 04 11:17:03 CST 2018</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>文献翻译</category>
        <category>java</category>
      </categories>
      <tags>
        <tag>未标记</tag>
      </tags>
  </entry>
  <entry>
    <title>Java-optional-parameters</title>
    <url>/468704c1-2bb6-11ee-879b-0b2c36f14b2e/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h1 id="Java-optional-parameters"><a href="#Java-optional-parameters" class="headerlink" title="Java optional parameters"></a>Java optional parameters</h1><p><strong>Java 中的可选参数</strong></p>
<blockquote>
<p>转译自：<a href="https://www.javacodegeeks.com/2018/11/java-optional-parameters.html">https://www.javacodegeeks.com/2018/11/java-optional-parameters.html</a></p>
</blockquote>
<p>When you design a method in a Java class, some parameters may be optional for its execution. No matter it is inside a DTO, a fat model domain object, or a simple stateless service class, optional method parameters are common.</p>
<p>在 Java 类中设计方法时，一些参数可能是可选的。无论是 DTO、胖模型域对象还是简单的无状态服务类，可选的方法参数都是常见的。</p>
<p>From this article <strong>you will learn how to handle optional parameters in Java.</strong> We’ll focus on regular method, class constructors with optional fields, and quickly look at bad practices of the discussed topic. We’ll stop for a moment to look at Java 8 Optional and assess（vt. 评定；估价） if it fits our needs.</p>
<p>从本文中，<strong>你将了解如何在 Java 中处理可选参数。</strong> 我们将重点讨论常规方法、带有可选字段的类构造函数，并快速查看所讨论主题的不良实践。我们会停下来看看 Java 8 中的 Optional 类，看看它是否符合我们的需求。</p>
<p>Let’s get started.</p>
<p>让我们开始吧。</p>
<h2 id="1-Optional-method-parameters"><a href="#1-Optional-method-parameters" class="headerlink" title="1. Optional method parameters"></a>1. Optional method parameters</h2><p><strong>可选的方法参数</strong></p>
<p>You can tackle（vt. 处理；抓住） Java optional parameters in method in several different ways. I’ll walk you through from the simplest to more complex.</p>
<p>你可以用几种不同的方法处理方法中的 Java 可选参数。我将引导你（理解）从最简单到更复杂的（情况）。</p>
<h2 id="1-1-Nullable-annotation"><a href="#1-1-Nullable-annotation" class="headerlink" title="1.1 @Nullable annotation"></a>1.1 @Nullable annotation</h2><p><strong>@Nullable 注解</strong></p>
<p>Why just don’t pass the null around? It’s a simple solution which doesn’t require any extra work. You don’t have any object which is required as one of method’s parameters? No problem. Just pass the null and the compiler is happy.</p>
<p>为什么不传递 null 呢？这是一个简单的答案，不需要任何额外的工作。你没有需要作为方法参数之一的对象吗？没有问题。把 null 传递给编译器就好了。</p>
<p><strong>The issue here is readability.</strong> How does the programmer who calls a method knows if he can safely pass the null? For which parameters nulls are acceptable and which are mandatory?</p>
<p><strong>这里的问题是可读性。</strong> 调用方法的程序员如何知道是否可以安全地传递 null？哪些参数是可接受 null 的，哪些是强制的？</p>
<p>To make it clear that the null is a valid input, you can use a @Nullable annotation.</p>
<p>为了说明 null 是一个有效的输入，你可以使用@Nullable 注解。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User createUser(String name, @Nullable Email email) &#123;</span><br><span class="line">   // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Don’t you agree this method declaration is self-explanatory?</p>
<p>你不同意这个方法声明是不言自明的吗？</p>
<p>While simple, the issue with null passing approach is that it can easily get out of control. The team may quickly start overusing it and make the code base <strong>hard to maintain with plenty of null check conditions.</strong></p>
<p>虽然很简单，但是 null 传递方法的问题是它很容易失控。团队可能很快就会开始 <strong>过度使用它，并在大量的 null 检查条件下使代码库难以维护。</strong></p>
<p>There are other options, though.</p>
<p>不过，还有其他选择。</p>
<h2 id="1-2-Optional-lists"><a href="#1-2-Optional-lists" class="headerlink" title="1.2. Optional lists"></a>1.2. Optional lists</h2><p>Instead of null, we can sometime create an empty representation（n. 代表；表现） of a class. Think about Java collections. <strong>If a method accepts a list or a map, you should never use nulls as the input.</strong></p>
<p>有时我们可以创建一个类的空表示，而不是 null。想想 Java 集合。<strong>如果方法接受 List 或 Map（作为参数），则永远不应该使用 null 作为（参数）输入。</strong></p>
<p>An empty collection is always better than null because in majority of cases it doesn’t require any special treatment.</p>
<p>空集合总是比 null 好，因为在大多数情况下，它不需要任何特殊处理。</p>
<p>You may wonder why you should waste memory to create empty collections. After all, null doesn’t cost you anything.</p>
<p>你可能想知道为什么要浪费内存来创建空集合。毕竟，null 不需要任何代价。</p>
<p>Your doubts are justified. Fortunately, there’s a simple solution.</p>
<p>你的怀疑是有道理的。幸运的是，有一个简单的解决方案。</p>
<p>You shouldn’t create a new instance of a collection whenever you need an empty representative. Reuse the same instance across the code base.</p>
<p>在需要空代表时，不应该创建集合的新实例。在代码库中重复使用相同的实例。</p>
<p>And you know what? Java already has empty instances of all collections which you can use. You’ll find them in the Collections utility class.</p>
<p>你知道吗？Java 已经有了可以使用的所有集合的空实例。你可以在 Collections 实用程序类中找到它们。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User createUser(String name, List&lt;Rights&gt; rights) &#123;</span><br><span class="line">   // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.util.Collections;</span><br><span class="line">// ...</span><br><span class="line">create(&quot;bob&quot;, Collections.emptyList());</span><br></pre></td></tr></table></figure>

<h2 id="1-3-Null-object-pattern"><a href="#1-3-Null-object-pattern" class="headerlink" title="1.3. Null object pattern"></a>1.3. Null object pattern</h2><p><strong>Null 对象模式</strong></p>
<p>The concept of empty collections also applies to other classes. An empty collection is just a regular collection with zero elements. By the same token, you can think about other objects in your applications.</p>
<p>空集合的概念也适用于其他类。空集合只是一个包含零元素的常规集合。同样，你可以考虑应用程序中的其他对象。</p>
<p><strong>The Null object is a special instance of a class which represents missing value.</strong> If some method expects an object as a parameter, you can always pass the Null object representation without worry it will cause an unexpected exception at the runtime.</p>
<p><strong>Null 对象是表示缺失值的类的特殊实例。</strong> 如果某些方法希望将对象作为参数，那么总是可以传递 Null 对象表示，而不用担心这会在运行时导致意外异常。</p>
<p>You can implement the Null object pattern in two ways.</p>
<p>你可以通过两种方式实现 Null 对象模式。</p>
<p>For simple value objects, a default instance with predefined values assigned to properties is enough. Usually, you expose this Null object as a constant so you can reuse it multiple times. For instance:</p>
<p>对于简单的值对象，为属性指定预定义值的默认实例就足够了。通常，你将这个 Null 对象作为常量公开，以便可以多次重用它。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class User &#123;</span><br><span class="line"></span><br><span class="line">   public static final User EMPTY = new User(&quot;&quot;, Collections.emptyList());</span><br><span class="line"></span><br><span class="line">   private final String name;</span><br><span class="line">   private final List&lt;Rights&gt; rights;</span><br><span class="line"></span><br><span class="line">   public User(String name, List&lt;Rights&gt; rights) &#123;</span><br><span class="line">       Objects.requireNonNull(name);</span><br><span class="line">       Objects.requireNonNull(rights);</span><br><span class="line">       this.name = name;</span><br><span class="line">       this.rights = rights;</span><br><span class="line">   &#125;</span><br><span class="line">   // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If your Null object also needs to mimic some behavior exposed via methods, a simple instance may not work. In that case, you should extend the class and override such methods.</p>
<p>如果你的 Null 对象也需要模仿一些通过方法暴露的行为，那么简单的实例就不会起作用了。在这种情况下，你应该扩展类并覆盖这些方法。</p>
<p>Here is an example which extends the previous one:</p>
<p>下面是对上一个例子的扩展：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class AnonymousUser extends User &#123;</span><br><span class="line"></span><br><span class="line">   public static final AnonymousUser INSTANCE = new AnonymousUser();</span><br><span class="line"></span><br><span class="line">   private AnonymousUser() &#123;</span><br><span class="line">      super(&quot;&quot;, Collections.emptyList());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   @Override</span><br><span class="line">   public void changeName(String newName) &#123;</span><br><span class="line">       throw new AuthenticationException(&quot;Only authenticated user can change the name&quot;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>A dedicated Null object class allows you to put many corner cases in a single place which makes maintenance much more pleasant.</p>
<p>一个专用的 Null 对象类允许你将许多偏僻个案放在一个地方，这使得维护更加愉快。</p>
<h2 id="1-4-Method-overloading"><a href="#1-4-Method-overloading" class="headerlink" title="1.4. Method overloading"></a>1.4. Method overloading</h2><p><strong>方法重载</strong></p>
<p>If your design a method with optional parameters, you can expose（vt. 揭露，揭发；使曝光；显示） overloaded versions of that method. <strong>Each method should accept only parameters which are required.</strong></p>
<p>如果你设计的方法具有可选参数，则可以公开该方法的重载版本。<strong>每个方法只能接受需要的参数。</strong></p>
<p>With this approach, you don’t have to expect that the caller will provide default values for optional parameters. You pass the defaults on your own inside overloaded method. In other words, you hide the default values for optional parameters from method’s callers.</p>
<p>使用这种方法，你不必期望调用方会为可选参数提供默认值。你可以在重载方法中自行传递默认值。换句话说，对方法调用者隐藏可选参数的默认值。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User createUser(String name) &#123;</span><br><span class="line">   this.createUser(name, Email.EMPTY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">User createUser(String name, Email email) &#123;</span><br><span class="line">   Objects.requireNonNull(name);</span><br><span class="line">   Objects.requireNonNull(rights);</span><br><span class="line">   // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The overloaded methods can call each other but it’s not mandatory. You can implement each method independently if it’s more convenient. However, usually you validate all parameters and put the logic inside the method with the longest parameter list.</p>
<p>重载的方法可以相互调用，但不是强制的。如果方便的话，可以单独实现每个方法。但是，通常你要验证所有参数，并将逻辑放在具有最长参数列表的方法中。</p>
<p>It’s worth mentioning that method overloading is widely used inside the standard Java library. When you learn how to design APIs, learn from people with greater experience.</p>
<p>值得一提的是，方法重载在标准 Java 库中被广泛使用。当你学习如何设计 API 时，请向具有更丰富经验的人学习。</p>
<h2 id="1-5-Parameter-Object-pattern"><a href="#1-5-Parameter-Object-pattern" class="headerlink" title="1.5. Parameter Object pattern"></a>1.5. Parameter Object pattern</h2><p><strong>参数对象模式</strong></p>
<p>The majority of developers agree that when the list of method parameters grows too long it become hard to read. Usually, you handle the issue with the Parameter Object pattern. The parameter object is a named container class which groups all method parameters.</p>
<p>大多数开发人员都同意，当方法参数列表增长得太长时，就会变得难以读取。通常，你使用参数对象模式来处理这个问题。参数对象是一个命名容器类，它对所有方法参数进行分组。</p>
<p>Does it solve the problem of optional method parameters?</p>
<p>是否解决了方法参数可选的问题?</p>
<p>No. It doesn’t.</p>
<p>不。它不是。</p>
<p>It just moves the problem to the constructor of the parameter object.</p>
<p>它只是将问题移动到参数对象的构造函数中。</p>
<p>Let’s see how do we solve this more general problem with …</p>
<p>让我们看看如何解决这个更普遍的问题。</p>
<h2 id="2-Optional-constructor-parameters"><a href="#2-Optional-constructor-parameters" class="headerlink" title="2. Optional constructor parameters"></a>2. Optional constructor parameters</h2><p><strong>可选的构造函数参数</strong></p>
<p>In the perspective（n. 观点） of the problem with optional parameters, simple constructors don’t differ from regular member methods. You can successfully use all the techniques we’ve already discussed also with constructors.</p>
<p>对于可选参数的问题，简单构造函数与常规成员方法没有区别。你可以成功地使用我们已经与构造函数讨论过的所有技术。</p>
<p>However, when the list of constructor parameters is getting longer and many of them are optional parameters, applying constructor overloading may seem cumbersome.</p>
<p>然而，当构造函数参数的列表越来越长，而且其中许多参数是可选参数时，应用构造函数重载可能看起来很麻烦。</p>
<p>If you agree, you should check out the Builder pattern.</p>
<p>如果你同意，你应该检查构建器模式。</p>
<h2 id="2-1-Builder-pattern"><a href="#2-1-Builder-pattern" class="headerlink" title="2.1. Builder pattern"></a>2.1. Builder pattern</h2><p><strong>构建器模式</strong></p>
<p>Let’s consider a class with multiple optional fields:</p>
<p>让我们考虑一个具有多个可选字段的类：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class ProgrammerProfile &#123;</span><br><span class="line"></span><br><span class="line">   // required field</span><br><span class="line">   private final String name;</span><br><span class="line"></span><br><span class="line">   // optional fields</span><br><span class="line">   private final String blogUrl;</span><br><span class="line">   private final String twitterHandler;</span><br><span class="line">   private final String githubUrl;</span><br><span class="line"></span><br><span class="line">   public ProgrammerProfile(String name) &#123;</span><br><span class="line">       Objects.requireNonNull(name);</span><br><span class="line">       this.name = name;</span><br><span class="line">       // other fields assignment...</span><br><span class="line">   &#125;</span><br><span class="line">   // getters</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you created a constructors to cover all possible combination with optional parameters, you would end up with a quite overwhelming list.</p>
<p>如果你创建了一个构造函数来涵盖所有可能的与可选参数的组合，那么你将得到一个相当庞大的列表。</p>
<p>How to avoid multiple constructors? Use a builder class.</p>
<p>如何避免多个构造函数？使用构建器类。</p>
<p><strong><em>译注：关于构建器的内容，可以参考《Effective-Java-3rd-edition》，Item-2: Consider-a-builder-when-faced-with-many-constructor-parameters（<a href="https://github.com/clxering/Effective-Java-3rd-edition-Chinese-English-bilingual/blob/master/Chapter-2/Chapter-2-Item-2-Consider-a-builder-when-faced-with-many-constructor-parameters.md">Item-2</a>）</em></strong></p>
<p>You usually implement the builder as an inner class of the class it suppose to build. That way, both classes have access to their private members.</p>
<p>你通常将构建器实现为它要构建的类的内部类。这样，两个类都可以访问它们的私有成员。</p>
<p>Take a look at a builder for the class from the previous example:</p>
<p>看看前面例子中类的构建器：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class ProgrammerProfile &#123;</span><br><span class="line"></span><br><span class="line">   // fields, getters, ...</span><br><span class="line"></span><br><span class="line">   private ProgrammerProfile(Builder builder) &#123;</span><br><span class="line">       Objects.requireNonNull(builder.name);</span><br><span class="line">       name = builder.name;</span><br><span class="line">       blogUrl = builder.blogUrl;</span><br><span class="line">       twitterHandler = builder.twitterHandler;</span><br><span class="line">       githubUrl = builder.githubUrl;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public static Builder newBuilder() &#123;</span><br><span class="line">       return new Builder();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   static final class Builder &#123;</span><br><span class="line"></span><br><span class="line">       private String name;</span><br><span class="line">       private String blogUrl;</span><br><span class="line">       private String twitterHandler;</span><br><span class="line">       private String githubUrl;</span><br><span class="line"></span><br><span class="line">       private Builder() &#123;&#125;</span><br><span class="line"></span><br><span class="line">       public Builder withName(String val) &#123;</span><br><span class="line">           name = val;</span><br><span class="line">           return this;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       public Builder withBlogUrl(String val) &#123;</span><br><span class="line">           blogUrl = val;</span><br><span class="line">           return this;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       public Builder withTwitterHandler(String val) &#123;</span><br><span class="line">           twitterHandler = val;</span><br><span class="line">           return this;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       public Builder withGithubUrl(String val) &#123;</span><br><span class="line">           githubUrl = val;</span><br><span class="line">           return this;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       public ProgrammerProfile build() &#123;</span><br><span class="line">           return new ProgrammerProfile(this);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Instead of a public constructor, we only expose one single static factory method for the inner builder class. The private constructor (which the builder calls in the build() method) uses a builder instance to assign all fields and verifies if all required values are present.</p>
<p>我们只为内部构建器类公开一个静态工厂方法，而不是一个公共构造函数。私有构造函数(构建器在 build()方法中调用)使用一个构建器实例来分配所有字段，并验证是否存在所有需要的值。</p>
<p>It’s a pretty simple technique once you think about it.</p>
<p>这是一个非常简单的技巧。</p>
<p>The client code of that builder which sets only a selected optional parameter may look as follows:</p>
<p>该生成器的客户端代码只设置一个选定的可选参数，其代码如下:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ProgrammerProfile.newBuilder()</span><br><span class="line">       .withName(&quot;Daniel&quot;)</span><br><span class="line">       .withBlogUrl(&quot;www.dolszewski.com/blog/&quot;)</span><br><span class="line">       .build();</span><br></pre></td></tr></table></figure>

<p>With the builder, you can create all possible combinations with optional parameters of the object.</p>
<p>使用构建器，你可以使用对象的可选参数创建所有可能的组合。</p>
<h2 id="2-2-Compile-time-safe-class-builder"><a href="#2-2-Compile-time-safe-class-builder" class="headerlink" title="2.2. Compile time safe class builder"></a>2.2. Compile time safe class builder</h2><p><strong>编译时安全类构建器</strong></p>
<p>Unfortunately, just by look at the methods of the builder from the previous paragraph you can’t really tell which parameters are optional and which are required. What is more, without knowing you can omit the required parameters by accident.</p>
<p>不幸的是，仅通过查看前一段中构建器的方法，你无法真正判断哪些参数是可选的，哪些是必需的。更重要的是，如果不知道你可以意外地忽略所需的参数。</p>
<p>Check out the following example of the incorrectly used builder:</p>
<p>查看以下错误使用的构建器示例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ProgrammerProfile.newBuilder()</span><br><span class="line">       .withBlogUrl(&quot;www.dolszewski.com/blog/&quot;)</span><br><span class="line">       .withTwitterHandler(&quot;daolszewski&quot;)</span><br><span class="line">       .build();</span><br></pre></td></tr></table></figure>

<p>The compiler won’t report any error. You’ll realize the problem with the missing required parameter only at the runtime.</p>
<p>编译器不会报告任何错误。只有在运行时，你才会意识到缺少必需参数的问题。</p>
<p>So how do you tackle the issue?</p>
<p>那么如何解决这个问题呢？</p>
<p>You need to slightly modify the builder factory method so that you can call it only with required parameters and left builder methods only for optional parameters.</p>
<p>你需要稍微修改 builder factory 方法，以便只能使用必需的参数调用它，而仅对可选参数使用 left builder 方法。</p>
<p>Here’s all you have to change:</p>
<p>以下是你需要改动的：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class ProgrammerProfile &#123;</span><br><span class="line"></span><br><span class="line">   // ...</span><br><span class="line"></span><br><span class="line">   public static Builder newBuilder(String name) &#123;</span><br><span class="line">      return new Builder(name);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public static final class Builder &#123;</span><br><span class="line"></span><br><span class="line">      private final String name;</span><br><span class="line">      // ...</span><br><span class="line"></span><br><span class="line">      private Builder(String name) &#123;</span><br><span class="line">          this.name = name;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // ...</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-Builder-class-generation"><a href="#2-3-Builder-class-generation" class="headerlink" title="2.3. Builder class generation"></a>2.3. Builder class generation</h2><p><strong>构建器类生成</strong></p>
<p>You may think that builders require hell of a lot of code.</p>
<p>你可能认为构建器需要大量的代码。</p>
<p>Don’t worry.</p>
<p>不必担心。</p>
<p>You don’t have to type all that code on your own. All popular Java IDEs have plugins which allow to generate class builders. IntelliJ users can check the InnerBuilder plugin, while Eclipse fans can take a look at Spart Builder Generator. You can also find alternative plugins in the official repositories.</p>
<p>你不需要自己输入所有的代码。所有流行的 Java IDE 都有允许生成类构建器的插件。IntelliJ 用户可以查看 InnerBuilder 插件，而 Eclipse 的粉丝可以查看 Spart Builder 生成器。你还可以在官方存储库中找到其他插件。</p>
<p>If you use the project Lombok, it also simplify working with class builders. You can check this short introduction to Lombok builders if you need a place to start.</p>
<p>如果你使用 Project Lombok，它还可以简化与类构建器的工作。如果你需要一个开始的地方，可以查看 Lombok 构建器的简短介绍。</p>
<h2 id="3-Java-optional-parameters-anti-patterns"><a href="#3-Java-optional-parameters-anti-patterns" class="headerlink" title="3. Java optional parameters anti-patterns"></a>3. Java optional parameters anti-patterns</h2><p><strong>Java 可选参数的反模式</strong></p>
<p>While browsing the web in search for approaches to work with Java optional parameters, you can find a few additional suggestions than we already covered. Let me explain why you should consider them as wrong approaches.</p>
<p>在浏览 web 以寻找使用 Java 可选参数的方法时，你可以找到一些我们已经介绍过的其他建议。让我解释一下为什么你应该认为它们是错误的方法。</p>
<h2 id="3-1-Maps"><a href="#3-1-Maps" class="headerlink" title="3.1. Maps"></a>3.1. Maps</h2><p>Technically speaking, method’s input is a set of key-value pairs. In Java, we have a standard built-in data structure which matches this description – the Map.</p>
<p>从技术上讲，方法的输入是一组 key-value 对。在 Java 中，我们有一个标准的内置数据结构来匹配这个描述，它就是 Map。</p>
<p>The compile won’t prevent you from using HashMap&lt;String, Object&gt; as a container for all optional method parameters but your common sense should.</p>
<p>编译器不会阻止你使用 HashMap&lt;String, Object&gt;作为所有可选方法参数的容器，这也是你应该具备的常识。</p>
<p>Although you can put anything in such HashMap, it’s wrong idea. This approach is hard to understand, unreadable and will quickly become your maintenance nightmare.</p>
<p>尽管你可以将任何内容放入这样的 HashMap 中，但这种想法是错误的。这种方法很难理解、不可读，并且很快就会成为你的维护噩梦。</p>
<p>Still not convinced（v. 使确信）?</p>
<p>还不相信吗？</p>
<p>You should definitely consider switching your career to a JavaScript developer. It’s much easier to cry in the company.</p>
<p>你绝对应该考虑转行到 JavaScript 开发人员。（和这个相比），在公司里哭要容易得多。</p>
<h2 id="3-2-Java-varargs"><a href="#3-2-Java-varargs" class="headerlink" title="3.2. Java varargs"></a>3.2. Java varargs</h2><p><strong>Java 可变参数</strong></p>
<p>Just to be clear, there’s absolutely nothing wrong in using Java varargs. If you don’t know with how many arguments your method will be called, varargs is a perfect fit.</p>
<p>需要明确的是，使用 Java 的可变参数绝对没有什么错。如果不知道方法将被调用多少个参数，那么可变参数非常适合。</p>
<p>But using varargs as a container for a single value, which might be present or not, is a misuse. Such declaration allows to call a method with more optional values than expected. We discussed much more descriptive approaches for handling a single optional parameters.</p>
<p>但是使用可变参数作为单个值的容器（可能存在也可能不存在）是一种误用。这样的声明允许调用一个方法比预期更多的可选值。我们讨论了更多的描述方法来处理单一的可选参数。</p>
<h2 id="3-3-Why-not-Optional-as-method-argument"><a href="#3-3-Why-not-Optional-as-method-argument" class="headerlink" title="3.3. Why not Optional as method argument?"></a>3.3. Why not Optional as method argument?</h2><p><strong>为什么不将 Optional 对象作为方法参数呢?</strong></p>
<p>Finally, the most controversial approach – Java 8 Optional as a method input. I’ve already written a post about Optional use cases in which I also covered method parameters. Let me extend what you can find there.</p>
<p>最后，最具争议的方法就是将 Java 8 的 Optional 对象作为方法输入。我已经写了一篇关于 Optional 用例的文章，其中也涉及了方法参数。我把你能找到的扩展一下。</p>
<h2 id="Memory-usage"><a href="#Memory-usage" class="headerlink" title="Memory usage"></a>Memory usage</h2><p><strong>内存使用情况</strong></p>
<p>When you create an instance of the Optional class, you have to allocate the memory for it. While the empty optional instance accessed with Optional.empty() is a reusable singleton (just like empty collections we’ve already discussed), non empty instances will occupy the operating memory.</p>
<p>当你创建 Optional 类的实例时，你必须为它分配内存。虽然使用 Optional.empty()访问的空 Optional 实例是可重用的单例（就像我们已经讨论过的空集合一样），但是非空实例将占用操作内存。</p>
<p>Wrapping objects using Optional factory methods just for the purpose of calling a method which will immediately unwrap them doesn’t make sense if you compare this approach with other possibilities.</p>
<p>如果你将这种方法与其他可能的方法进行比较，那么仅为了调用将立即展开它们的方法而使用可选工厂方法包装对象是没有意义的。</p>
<p>Yet, nowadays Garbage Collectors handle short-lived objects very well. The memory allocation isn’t a big deal. Do we have any other cons?</p>
<p>然而，现在垃圾收集器可以很好地处理短期对象。内存分配不是什么大问题。我们还有其他缺点吗?</p>
<h2 id="Coding-with-reader-in-mind"><a href="#Coding-with-reader-in-mind" class="headerlink" title="Coding with reader in mind"></a>Coding with reader in mind</h2><p><strong>为读者编写代码</strong></p>
<p>What about code readability?</p>
<p>那么代码可读性呢?</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">createProfile(&quot;Daniel&quot;, Optional.of(&quot;www.dolszewski.com/blog/&quot;),</span><br><span class="line">       Optional.of(&quot;daolszewski&quot;), Optional.of(&quot;https://github.com/danielolszewski&quot;));</span><br></pre></td></tr></table></figure>

<p>Maybe it’s just a matter of personal preference but for many developers multiple Optional factory calls are distracting. The noise in the code for the reader. But again, it’s just a matter of taste. Let’s find something more convincing.</p>
<p>也许这只是个人喜好的问题，但是对于许多开发人员来说，多个 Optional 工厂调用会分散他们的注意力。代码中的噪声是为读者准备的。但这只是品味的问题。让我们找些更有说服力的。</p>
<h2 id="Java-language-architect-opinion"><a href="#Java-language-architect-opinion" class="headerlink" title="Java language architect opinion"></a>Java language architect opinion</h2><p><strong>Java 语言架构师看法</strong></p>
<p><strong><em>译注：原文的 language 拼写错误</em></strong></p>
<p>Brian Goetz, who is Java language architect at Oracle once stated that Optional was added to the standard library with methods’ results in mind, not their inputs.</p>
<p>Oracle 的 Java 语言架构师 Brian Goetz 曾经说过，将 Optional 添加到标准库时考虑的是方法的结果，而不是方法的输入。</p>
<p>But software developers are rebels and don’t like listening to authorities. This argument may also seems weak. We have to go deeper.</p>
<p>但软件开发者是叛逆者，不喜欢听当局的。这一论点似乎也站不住脚。我们必须更深入。</p>
<h2 id="Does-Optional-solve-optional-parameter-problem"><a href="#Does-Optional-solve-optional-parameter-problem" class="headerlink" title="Does Optional solve optional parameter problem?"></a>Does Optional solve optional parameter problem?</h2><p><strong>可选是否解决可选参数问题？</strong></p>
<p>If you have a method declaration like this:</p>
<p>如果你有这样的方法声明：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">doSomethingWith(Optional&lt;Object&gt; parameter);</span><br></pre></td></tr></table></figure>

<p>How many possible inputs should you expect?</p>
<p>你应该期望多少可能的输入？</p>
<p>The parameter can be either a wrapped value or the empty optional instance. So the answer is 2, right?</p>
<p>参数可以是包装类的值，也可以是空的 Optional 实例。所以答案是 2，对吧？</p>
<p>Wrong.</p>
<p>错。</p>
<p>The real answer is 3 because you can also pass the null as the argument. You should have a limited trust to inputs when you don’t know who will be the caller of your API.</p>
<p>真正的答案是 3，因为你也可以传递 null 作为参数。当你不知道谁将是 API 的调用者时，你应该对输入具有有限的信任。</p>
<p>In that case, before processing the parameter you should check if the Optional isn’t equal to the null and then if the value is present. Quite complicated, don’t you agree?</p>
<p>在这种情况下，在处理参数之前，你应该检查 Optional 是否等于 null，然后检查值是否存在。相当复杂，你同意吗?</p>
<p>I pretty sure I have not exhausted the topic yet. As this is one of potential holy wars of Java programming, you should form your own opinion. If you want to add something to the list of arguments against Optional as a method parameter, please share your thoughts in the comments. It’s more than welcome.</p>
<p>我敢肯定我还没有穷尽这个话题。由于这是 Java 编程的潜在圣战之一，你应该形成自己的观点。如果你想在可选参数的参数列表中添加一些内容，请在评论中分享你的想法。非常欢迎。</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p><strong>结论</strong></p>
<p>Let’s recap what we’ve learned. Java doesn’t have a possibility to set a default value to method parameters. The language provides us we many other alternatives for handling optional parameters.</p>
<p>让我们回顾一下我们所学到的。Java 不可能为方法参数设置默认值。该语言为我们提供了许多处理可选参数的其他选择。</p>
<p>These alternatives include the @Nullable annotation, null objects, method overloading, and the Parameter Object pattern. We also familiarize with class builders for objects with multiple optional fields. Lastly, we reviewed common bad practices and potential misuses.</p>
<p>这些替代方法包括@Nullable 注释、null 对象、方法重载和参数对象模式。我们还熟悉具有多个可选字段的对象的类构建器。最后，我们回顾了常见的不良实践和潜在的误用。</p>
<p>If you find the article helpful, I’ll be grateful for sharing it with your followers. I’d also love to know your thoughts, all comments are welcome.</p>
<p>如果你觉得这篇文章对你有帮助，我会很感激与你的追随者分享它。我也想知道你的想法，欢迎所有的意见。</p>
]]></content>
      <categories>
        <category>文献翻译</category>
        <category>java</category>
      </categories>
      <tags>
        <tag>未标记</tag>
      </tags>
  </entry>
  <entry>
    <title>volatile-变量使用指南</title>
    <url>/468704c0-2bb6-11ee-879b-0b2c36f14b2e/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h1 id="Guidelines-for-using-volatile-variables"><a href="#Guidelines-for-using-volatile-variables" class="headerlink" title="Guidelines for using volatile variables"></a>Guidelines for using volatile variables</h1><p><strong>volatile 变量使用指南</strong></p>
<blockquote>
<p>原文：<a href="https://www.ibm.com/developerworks/java/library/j-jtp06197/index.html">https://www.ibm.com/developerworks/java/library/j-jtp06197/index.html</a></p>
</blockquote>
<blockquote>
<p>参考翻译：<a href="https://www.ibm.com/developerworks/cn/java/j-jtp06197.html">https://www.ibm.com/developerworks/cn/java/j-jtp06197.html</a></p>
</blockquote>
<p>Volatile variables in the Java language can be thought of as “synchronized lite”; they require less coding to use than synchronized blocks and often have less runtime overhead, but they can only be used to do a subset of the things that synchronized can. This article presents some patterns for using volatile variables effectively – and some warnings about when not to use them.</p>
<p>Java 语言中的 volatile 变量可以被看作是一种「程度较轻的 synchronized」；与 synchronized 块相比，volatile 变量所需的编码较少，并且运行时开销也较少，但是它所能实现的功能也仅是 synchronized 的一部分。本文介绍几种有效使用 volatile 变量的模式，并强调几种不适合使用 volatile 变量的情形。</p>
<p>Locks offer two primary features: mutual exclusion and visibility. Mutual exclusion means that only one thread at a time may hold a given lock, and this property can be used to implement protocols for coordinating access to shared data such that only one thread at a time will be using the shared data. Visibility is more subtle and has to do with ensuring that changes made to shared data prior to releasing a lock are made visible to another thread that subsequently acquires that lock – without the visibility guarantees provided by synchronization, threads could see stale or inconsistent values for shared variables, which could cause a host of serious problems.</p>
<p>锁提供了两种主要特性：互斥和可见性。互斥一次只允许一个线程持有某个特定的锁，因此可使用该特性实现对共享数据的协调访问协议，一次就只有一个线程能够使用该共享数据。可见性要更加复杂一些，它必须确保释放锁之前对共享数据做出的更改对于随后获得该锁的另一个线程是可见的：如果没有同步机制提供的这种可见性保证，线程看到的共享变量可能是修改前的值或不一致的值，这将引发许多严重问题。</p>
<h2 id="Volatile-variables"><a href="#Volatile-variables" class="headerlink" title="Volatile variables"></a>Volatile variables</h2><p><strong>Volatile 变量</strong></p>
<p>Volatile variables share the visibility features of synchronized, but none of the atomicity features. This means that threads will automatically see the most up-to-date value for volatile variables. They can be used to provide thread safety, but only in a very restricted set of cases: those that do not impose constraints between multiple variables or between a variable’s current value and its future values. So volatile alone is not strong enough to implement a counter, a mutex, or any class that has invariants that relate multiple variables (such as “start &lt;&#x3D;end”).</p>
<p>Volatile 变量具有 synchronized 的可见性特性，但是不具备原子特性。这就是说线程能够自动发现 volatile 变量的最新值。Volatile 变量可用于提供线程安全，但是只能应用于非常有限的场景：多个变量之间或者某个变量的当前值与修改后值之间没有约束。因此，单独使用 volatile 还不足以实现计数器、互斥锁或任何具有与多个变量相关的不变式（Invariants）的类（例如「start &lt;&#x3D; end」）。</p>
<p>You might prefer to use volatile variables instead of locks for one of two principal reasons: simplicity or scalability. Some idioms are easier to code and read when they use volatile variables instead of locks. In addition, volatile variables (unlike locks) cannot cause a thread to block, so they are less likely to cause scalability problems. In situations where reads greatly outnumber writes, volatile variables may also provide a performance advantage over locking.</p>
<p>出于简易性或可伸缩性的考虑，你可能倾向于使用 volatile 变量而不是锁。当使用 volatile 变量而非锁时，某些习惯用法（idiom）更加易于编码和阅读。此外，volatile 变量不会像锁那样造成线程阻塞，因此也很少造成可伸缩性问题。在某些情况下，如果读操作远远大于写操作，volatile 变量还可以提供优于锁的性能优势。</p>
<h2 id="Conditions-for-correct-use-of-volatile"><a href="#Conditions-for-correct-use-of-volatile" class="headerlink" title="Conditions for correct use of volatile"></a>Conditions for correct use of volatile</h2><p><strong>正确使用 volatile 变量的条件</strong></p>
<p>You can use volatile variables instead of locks only under a restricted set of circumstances. Both of the following criteria must be met for volatile variables to provide the desired thread-safety:</p>
<p>你只能在有限的一些情形下使用 volatile 变量替代锁。要使 volatile 变量提供理想的线程安全，必须同时满足下面两个条件：</p>
<ul>
<li>Writes to the variable do not depend on its current value.</li>
</ul>
<p>对变量的写操作不依赖于当前值。</p>
<ul>
<li>The variable does not participate in invariants with other variables.</li>
</ul>
<p>该变量没有包含在具有其他变量的不变式中。</p>
<p>Basically, these conditions state that the set of valid values that can be written to a volatile variable is independent of any other program state, including the variable’s current state.</p>
<p>实际上，这些条件表明，可以被写入 volatile 变量的这些有效值独立于任何程序的状态，包括变量的当前状态。</p>
<p>The first condition disqualifies volatile variables from being used as thread-safe counters. While the increment operation (x++) may look like a single operation, it is really a compound read-modify-write sequence of operations that must execute atomically – and volatile does not provide the necessary atomicity. Correct operation would require that the value of x stay unchanged for the duration of the operation, which cannot be achieved using volatile variables. (However, if you can arrange that the value is only ever written from a single thread, then you can ignore the first condition.)</p>
<p>第一个条件的限制使 volatile 变量不能用作线程安全计数器。虽然增量操作（x++）看上去类似一个单独操作，实际上它是一个由读取、修改、写入操作序列组成的组合操作，必须以原子方式执行，而 volatile 不能提供必须的原子特性。实现正确的操作需要使 x 的值在操作期间保持不变，而 volatile 变量无法实现这点。（然而，如果将值调整为只从单个线程写入，那么可以忽略第一个条件。）</p>
<p>Most programming situations will fall afoul of either the first or second condition, making volatile variables a less commonly applicable approach to achieving thread-safety than synchronized. Listing 1 shows a non-thread-safe number range class. It contains an invariant – that the lower bound is always less than or equal to the upper bound.</p>
<p>大多数编程情形都会与这两个条件的其中之一冲突，使得 volatile 变量不能像 synchronized 那样普遍适用于实现线程安全。清单 1 显示了一个非线程安全的数值范围类。它包含了一个不变式：下界总是小于或等于上界。</p>
<p>Listing 1. Non-thread-safe number range class</p>
<p>清单 1. 非线程安全的数值范围类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@NotThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NumberRange</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> lower, upper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLower</span><span class="params">()</span> &#123; <span class="keyword">return</span> lower; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getUpper</span><span class="params">()</span> &#123; <span class="keyword">return</span> upper; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLower</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value &gt; upper)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(...);</span><br><span class="line">        lower = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUpper</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value &lt; lower)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(...);</span><br><span class="line">        upper = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Because the state variables of the range are constrained in this manner, making the lower and upper fields volatile would not be sufficient to make the class thread-safe; synchronization would still be needed. Otherwise, with some unlucky timing, two threads executing setLower and setUpper with inconsistent values could leave the range in an inconsistent state. For example, if the initial state is (0, 5), and thread A calls setLower(4) at the same time that thread B calls setUpper(3), and the operations are interleaved just wrong, both could pass the checks that are supposed to protect the invariant and end up with the range holding (4, 3) – an invalid value. We need to make the setLower() and setUpper() operations atomic with respect to other operations on the range – and making the fields volatile can’t do this for us.</p>
<p>这种方式限制了范围的状态变量，因此将 lower 和 upper 字段定义为 volatile 类型不能够充分实现类的线程安全；从而仍然需要使用同步。否则，如果凑巧两个线程在同一时间使用不一致的值执行 setLower 和 setUpper 的话，则会使范围处于不一致的状态。例如，如果初始状态是 (0, 5)，同一时间内，线程 A 调用 setLower(4) 并且线程 B 调用 setUpper(3)，显然这两个操作交叉存入的值是不符合条件的，那么两个线程都会通过用于保护不变式的检查，使得最后的范围值是 (4, 3)：一个无效值。至于针对范围的其他操作，我们需要使 setLower() 和 setUpper() 操作原子化：而将字段定义为 volatile 类型是无法实现这一目的的。</p>
<h2 id="Performance-considerations"><a href="#Performance-considerations" class="headerlink" title="Performance considerations"></a>Performance considerations</h2><p><strong>性能考虑</strong></p>
<p>The primary motivation for using volatile variables is simplicity: In some situations, using a volatile variable is just simpler than using the corresponding locking. A secondary motivation for using volatile variables is performance: In some situations, volatile variables may be a better-performing synchronization mechanism than locking.</p>
<p>使用 volatile 变量的主要原因是其简易性：在某些情形下，使用 volatile 变量要比使用相应的锁简单得多。使用 volatile 变量次要原因是其性能：某些情况下，volatile 变量同步机制的性能要优于锁。</p>
<p>It is exceedingly difficult to make accurate, general statements of the form “X is always faster than Y,” especially when it comes to intrinsic JVM operations. (For example, the VM may be able to remove locking entirely in some situations, which makes it hard to talk about the relative cost of volatile vs. synchronized in the abstract.) That said, on most current processor architectures, volatile reads are cheap – nearly as cheap as nonvolatile reads. Volatile writes are considerably more expensive than nonvolatile writes because of the memory fencing required to guarantee visibility but still generally cheaper than lock acquisition.</p>
<p>很难做出准确、全面的评价，例如「X 总是比 Y 快」，尤其是对 JVM 内在的操作而言。（例如，某些情况下 VM 也许能够完全删除锁机制，这使得我们难以抽象地比较 volatile 和 synchronized 的开销。）就是说，在目前大多数的处理器架构上，volatile 读操作开销非常低：几乎和非 volatile 读操作一样。而 volatile 写操作的开销要比非 volatile 写操作多很多，因为要保证可见性需要实现内存界定（Memory Fence），即便如此，volatile 的总开销仍然要比锁获取低。</p>
<p>Unlike locking, volatile operations will never block, so volatiles offer some scalability advantages over locking in the cases where they can be used safely. In cases where reads greatly outnumber writes, volatile variables can often reduce the performance cost of synchronization compared to locking.</p>
<p>volatile 操作不会像锁一样造成阻塞，因此，在能够安全使用 volatile 的情况下，volatile 可以提供一些优于锁的可伸缩特性。如果读操作的次数要远远超过写操作，与锁相比，volatile 变量通常能够减少同步的性能开销。</p>
<h2 id="Patterns-for-using-volatile-correctly"><a href="#Patterns-for-using-volatile-correctly" class="headerlink" title="Patterns for using volatile correctly"></a>Patterns for using volatile correctly</h2><p><strong>正确使用 volatile 的模式</strong></p>
<p>Many concurrency experts tend to guide users away from using volatile variables at all, because they are harder to use correctly than locks. However, some well-defined patterns exist, which, if you follow them carefully, can be used safely in a wide variety of situations. Always keep in mind the rules about the limits of where volatile can be used – only use volatile for state that is truly independent of everything else in your program – and this should keep you from trying to extend these patterns into dangerous territory.</p>
<p>很多并发性专家事实上往往引导用户远离 volatile 变量，因为使用它们要比使用锁更加容易出错。然而，如果谨慎地遵循一些良好定义的模式，就能够在很多场合内安全地使用 volatile 变量。要始终牢记使用 volatile 的限制：只有在状态真正独立于程序内其他内容时才能使用 volatile，这条规则能够避免将这些模式扩展到不安全的用例。</p>
<h2 id="Pattern-1-status-flags"><a href="#Pattern-1-status-flags" class="headerlink" title="Pattern #1: status flags"></a>Pattern #1: status flags</h2><p><strong>模式 #1：状态标志</strong></p>
<p>Perhaps the canonical use of volatile variables is simple boolean status flags, indicating that an important one-time life-cycle event has happened, such as initialization has completed or shutdown has been requested.</p>
<p>也许实现 volatile 变量的规范使用仅仅是使用一个布尔状态标志，用于指示发生了一个重要的一次性事件，例如完成初始化或请求停机。</p>
<p>Many applications include a control construct of the form, “While we’re not ready to shut down, do more work,” as shown in Listing 2:</p>
<p>很多应用程序包含了一种控制结构，形式为「在还没有准备好停止程序时再执行一些工作」，如清单 2 所示：</p>
<p>Listing 2. Using a volatile variable as a status flag</p>
<p>清单 2. 将 volatile 变量作为状态标志使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="type">boolean</span> shutdownRequested;</span><br><span class="line"></span><br><span class="line">……</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123; shutdownRequested = <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doWork</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (!shutdownRequested) &#123;</span><br><span class="line">        <span class="comment">// do stuff</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It is likely that the shutdown() method is going to be called from somewhere outside the loop – in another thread – and as such, some form of synchronization is required to ensure the proper visibility of the shutdownRequested variable. (It might be called from a JMX listener, an action listener in the GUI event thread, through RMI, through a Web service, and so on.) However, coding the loop with synchronized blocks would be much more cumbersome than coding it with a volatile status flag as in Listing 2. Because volatile simplifies the coding, and the status flag does not depend on any other state in the program, this is a good use for volatile.</p>
<p>很可能会从循环外部调用 shutdown() 方法：即在另一个线程中。因此，需要执行某种同步来确保正确实现 shutdownRequested 变量的可见性。（可能会从 JMX 侦听程序、GUI 事件线程中的操作侦听程序、通过 RMI 、通过一个 Web 服务等调用）。然而，使用 synchronized 块编写循环要比使用清单 2 所示的 volatile 状态标志编写麻烦很多。由于 volatile 简化了编码，并且状态标志并不依赖于程序内任何其他状态，因此此处非常适合使用 volatile。</p>
<p>One common characteristic of status flags of this type is that there is typically only one state transition; the shutdownRequested flag goes from false to true and then the program shuts down. This pattern can be extended to state flags that can change back and forth, but only if it is acceptable for a transition cycle (from false to true to false) to go undetected. Otherwise, some sort of atomic state transition mechanism is needed, such as atomic variables.</p>
<p>这种类型的状态标记的一个公共特性是：通常只有一种状态转换；shutdownRequested 标志从 false 转换为 true，然后程序停止。这种模式可以扩展到来回转换的状态标志，但是只有在转换周期不被察觉的情况下才能扩展（从 false 到 true，再转换到 false）。此外，还需要某些原子状态转换机制，例如原子变量。</p>
<h2 id="Pattern-2-one-time-safe-publication"><a href="#Pattern-2-one-time-safe-publication" class="headerlink" title="Pattern #2: one-time safe publication"></a>Pattern #2: one-time safe publication</h2><p><strong>模式 #2：一次性安全发布</strong></p>
<p>The visibility failures that are possible in the absence of synchronization can get even trickier to reason about when writing to object references instead of primitive values. In the absence of synchronization, it is possible to see an up-to-date value for an object reference that was written by another thread and still see stale values for that object’s state. (This hazard is the root of the problem with the infamous double-checked-locking idiom, where an object reference is read without synchronization, and the risk is that you could see an up-to-date reference but still observe a partially constructed object through that reference.)</p>
<p>缺乏同步会导致无法实现可见性，这使得确定何时写入对象引用而不是原语值变得更加困难。在缺乏同步的情况下，可能会遇到某个对象引用的更新值（由另一个线程写入）和该对象状态的旧值同时存在。（这就是造成著名的双重检查锁定（double-checked-locking）问题的根源，其中对象引用在没有同步的情况下进行读操作，产生的问题是你可能会看到一个更新的引用，但是仍然会通过该引用看到不完全构造的对象）。</p>
<p>One technique for safely publishing an object is to make the object reference volatile. Listing 3 shows an example where during startup, a background thread loads some data from a database. Other code, when it might be able to make use of this data, checks to see if it has been published before trying to use it.</p>
<p>实现安全发布对象的一种技术就是将对象引用定义为 volatile 类型。清单 3 展示了一个示例，其中后台线程在启动阶段从数据库加载一些数据。其他代码在能够利用这些数据时，在使用之前将检查这些数据是否曾经发布过。</p>
<p>Listing 3. Using a volatile variable for safe one-time publication</p>
<p>清单 3. 将 volatile 变量用于一次性安全发布</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BackgroundFloobleLoader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> Flooble theFlooble;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initInBackground</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// do lots of stuff</span></span><br><span class="line">        theFlooble = <span class="keyword">new</span> <span class="title class_">Flooble</span>();  <span class="comment">// this is the only write to theFlooble</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SomeOtherClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doWork</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// do some stuff...</span></span><br><span class="line">            <span class="comment">// use the Flooble, but only if it is ready</span></span><br><span class="line">            <span class="keyword">if</span> (floobleLoader.theFlooble != <span class="literal">null</span>)</span><br><span class="line">                doSomething(floobleLoader.theFlooble);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Without the theFlooble reference being volatile, the code in doWork() would be at risk for seeing a partially constructed Flooble as it dereferences the theFlooble reference.</p>
<p>如果 theFlooble 引用不是 volatile 类型，doWork() 中的代码在解除对 theFlooble 的引用时，将会得到一个不完全构造的 Flooble。</p>
<p>A key requirement for this pattern is that the object being published must either be thread-safe or effectively immutable (effectively immutable means that its state is never modified after its publication). The volatile reference may guarantee the visibility of the object in its as-published form, but if the state of the object is going to change after publication, then additional synchronization is required.</p>
<p>该模式的一个必要条件是：被发布的对象必须是线程安全的，或者是有效的不可变对象（有效不可变意味着对象的状态在发布之后永远不会被修改）。volatile 类型的引用可以确保对象的发布形式的可见性，但是如果对象的状态在发布后将发生更改，那么就需要额外的同步。</p>
<h2 id="Pattern-3-independent-observations"><a href="#Pattern-3-independent-observations" class="headerlink" title="Pattern #3: independent observations"></a>Pattern #3: independent observations</h2><p><strong>模式 #3：独立观察</strong></p>
<p>Another simple pattern for safely using volatile is when observations are periodically “published” for consumption within the program. For example, say there is an environmental sensor that senses the current temperature. A background thread might read this sensor every few seconds and update a volatile variable containing the current temperature. Then, other threads can read this variable knowing that they will always see the most up-to-date value.</p>
<p>安全使用 volatile 的另一种简单模式是：定期「发布」 观察结果供程序内部使用。例如，假设有一种环境传感器能够感觉环境温度。一个后台线程可能会每隔几秒读取一次该传感器，并更新包含当前文档的 volatile 变量。然后，其他线程可以读取这个变量，从而随时能够看到最新的温度值。</p>
<p>Another application for this pattern is gathering statistics about the program. Listing 4 shows how an authentication mechanism might remember the name of the last user to have logged on. The lastUser reference will be repeatedly used to publish a value for consumption by the rest of the program.</p>
<p>使用该模式的另一种应用程序就是收集程序的统计信息。清单 4 展示了身份验证机制如何记忆最近一次登录的用户的名字。将反复使用 lastUser 引用来发布值，以供程序的其他部分使用。</p>
<p>Listing 4. Using a volatile variable for multiple publications of independent observations</p>
<p>清单 4. 将 volatile 变量用于多个独立观察结果的发布</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserManager</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span> String lastUser;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">authenticate</span><span class="params">(String user, String password)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">valid</span> <span class="operator">=</span> passwordIsValid(user, password);</span><br><span class="line">        <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">            <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">            activeUsers.add(u);</span><br><span class="line">            lastUser = user;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> valid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This pattern is an extension of the previous one; a value is being published for use elsewhere within the program, but instead of publication being a one-time event, it is a series of independent events. This pattern requires that the value being published be effectively immutable – that its state not change after publication. Code consuming the value should be aware that it might change at any time.</p>
<p>该模式是前面模式的扩展；将某个值发布以在程序内的其他地方使用，但是与一次性事件的发布不同，这是一系列独立事件。这个模式要求被发布的值是有效不可变的 —— 即值的状态在发布后不会更改。使用该值的代码需要清楚该值可能随时发生变化。</p>
<h2 id="Pattern-4-the-“volatile-bean”-pattern"><a href="#Pattern-4-the-“volatile-bean”-pattern" class="headerlink" title="Pattern #4: the “volatile bean” pattern"></a>Pattern #4: the “volatile bean” pattern</h2><p><strong>模式 #4：「volatile bean」 模式</strong></p>
<p>The volatile bean pattern is applicable in frameworks that use JavaBeans as “glorified structs.” In the volatile bean pattern, a JavaBean is used as a container for a group of independent properties with getters and&#x2F;or setters. The rationale for the volatile bean pattern is that many frameworks provide containers for mutable data holders (for instance, HttpSession), but the objects placed in those containers must be thread safe.</p>
<p>volatile bean 模式适用于将 JavaBeans 作为「荣誉结构」使用的框架。在 volatile bean 模式中，JavaBean 被用作一组具有 getter 和&#x2F;或 setter 方法 的独立属性的容器。volatile bean 模式的基本原理是：很多框架为易变数据的持有者（例如 HttpSession）提供了容器，但是放入这些容器中的对象必须是线程安全的。</p>
<p>In the volatile bean pattern, all the data members of the JavaBean are volatile, and the getters and setters must be trivial – they must contain no logic other than getting or setting the appropriate property. Further, for data members that are object references, the referred-to objects must be effectively immutable. (This prohibits having array-valued properties, as when an array reference is declared volatile, only the reference, not the elements themselves, have volatile semantics.) As with any volatile variable, there may be no invariants or constraints involving the properties of the JavaBean. An example of a JavaBean obeying the volatile bean pattern is shown in Listing 5:</p>
<p>在 volatile bean 模式中，JavaBean 的所有数据成员都是 volatile 类型的，并且 getter 和 setter 方法必须非常普通 —— 除了获取或设置相应的属性外，不能包含任何逻辑。此外，对于对象引用的数据成员，引用的对象必须是有效不可变的。（这将禁止具有数组值的属性，因为当数组引用被声明为 volatile 时，只有引用而不是数组本身具有 volatile 语义）。对于任何 volatile 变量，不变式或约束都不能包含 JavaBean 属性。清单 5 中的示例展示了遵守 volatile bean 模式的 JavaBean：</p>
<p>Listing 5. A Person object obeying the volatile bean pattern</p>
<p>清单 5. 遵守 volatile bean 模式的 Person 对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String firstName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String lastName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFirstName</span><span class="params">()</span> &#123; <span class="keyword">return</span> firstName; &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getLastName</span><span class="params">()</span> &#123; <span class="keyword">return</span> lastName; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123; <span class="keyword">return</span> age; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFirstName</span><span class="params">(String firstName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.firstName = firstName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLastName</span><span class="params">(String lastName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lastName = lastName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Advanced-patterns-for-volatile"><a href="#Advanced-patterns-for-volatile" class="headerlink" title="Advanced patterns for volatile"></a>Advanced patterns for volatile</h2><p><strong>volatile 的高级模式</strong></p>
<p>The patterns in the previous section cover most of the basic cases where the use of volatile is sensible and straightforward. This section looks at a more advanced pattern where volatile might offer a performance or scalability benefit.</p>
<p>前面几节介绍的模式涵盖了大部分的基本用例，在这些模式中使用 volatile 非常有用并且简单。这一节将介绍一种更加高级的模式，在该模式中，volatile 将提供性能或可伸缩性优势。</p>
<p>The more advanced patterns for using volatile can be extremely fragile. It is critical that your assumptions be carefully documented and these patterns strongly encapsulated because very small changes can break your code! Also, given that the primary motivation for the more advanced volatile use cases is performance, be sure that you actually have a demonstrated need for the purported performance gain before you start applying them. These patterns are trade-offs that give up readability or maintainability in exchange for a possible performance boost – if you don’t need the performance boost (or can’t prove you need it through a rigorous measurement program), then it is probably a bad trade because you’re giving up something of value and getting something of lesser value in return.</p>
<p>volatile 应用的的高级模式非常脆弱。因此，必须对假设的条件仔细证明，并且这些模式被严格地封装了起来，因为即使非常小的更改也会损坏你的代码！同样，使用更高级的 volatile 用例的原因是它能够提升性能，确保在开始应用高级模式之前，真正确定需要实现这种性能获益。需要对这些模式进行权衡，放弃可读性或可维护性来换取可能的性能收益：如果你不需要提升性能（或者不能够通过一个严格的测试程序证明你需要它），那么这很可能是一次糟糕的交易，因为你很可能会得不偿失，换来的东西要比放弃的东西价值更低。</p>
<h2 id="Pattern-5-The-cheap-read-write-lock-trick"><a href="#Pattern-5-The-cheap-read-write-lock-trick" class="headerlink" title="Pattern #5: The cheap read-write lock trick"></a>Pattern #5: The cheap read-write lock trick</h2><p><strong>模式 #5：开销较低的读－写锁策略</strong></p>
<p>By now, it should be well-known that volatile is not strong enough to implement a counter. Because ++x is really shorthand for three operations (read, add, store), with some unlucky timing it is possible for updates to be lost if multiple threads tried to increment a volatile counter at once.</p>
<p>目前为止，你应该了解了 volatile 的功能还不足以实现计数器。因为 ++x 实际上是三种操作（读、添加、存储）的简单组合，如果多个线程凑巧试图同时对 volatile 计数器执行增量操作，那么它的更新值有可能会丢失。</p>
<p>However, if reads greatly outnumber modifications, you can combine intrinsic locking and volatile variables to reduce the cost on the common code path. Listing 6 shows a thread-safe counter that uses synchronized to ensure that the increment operation is atomic and uses volatile to guarantee the visibility of the current result. If updates are infrequent, this approach may perform better as the overhead on the read path is only a volatile read, which is generally cheaper than an uncontended lock acquisition.</p>
<p>然而，如果读操作远远超过写操作，你可以结合使用内部锁和 volatile 变量来减少公共代码路径的开销。清单 6 中显示的线程安全的计数器使用 synchronized 确保增量操作是原子的，并使用 volatile 保证当前结果的可见性。如果更新不频繁的话，该方法可实现更好的性能，因为读路径的开销仅仅涉及 volatile 读操作，这通常要优于一个无竞争的锁获取的开销。</p>
<p>Listing 6. Combining volatile and synchronized to form a “cheap read-write lock”</p>
<p>清单 6. 结合使用 volatile 和 synchronized 实现「开销较低的读写锁」</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ThreadSafe</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CheesyCounter</span> &#123;</span><br><span class="line">    <span class="comment">// Employs the cheap read-write lock trick</span></span><br><span class="line">    <span class="comment">// All mutative operations MUST be done with the &#x27;this&#x27; lock held</span></span><br><span class="line">    <span class="meta">@GuardedBy(&quot;this&quot;)</span> <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">increment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The reason this technique is called the “cheap read-write lock” is that you are using different synchronization mechanisms for reads and writes. Because the writes in this case violate the first condition for using volatile, you cannot use volatile to safely implement the counter – you must use locking. However, you can use volatile to ensure the visibility of the current value when reading, so you use locking for all mutative operations and volatile for read-only operations. Where locks only allow one thread to access a value at once, volatile reads allow more than one, so when you use volatile to guard the read code path, you get a higher degree of sharing than you would were you to use locking for all code paths – just like a read-write lock. However, bear in mind the fragility of this pattern: With two competing synchronization mechanisms, this can get very tricky if you branch out beyond the most basic application of this pattern.</p>
<p>之所以将这种技术称之为「开销较低的读－写锁」 是因为你使用了不同的同步机制进行读写操作。因为本例中的写操作违反了使用 volatile 的第一个条件，因此不能使用 volatile 安全地实现计数器，你必须使用锁。然而，你可以在读操作中使用 volatile 确保当前值的可见性，因此可以使用锁进行所有变化的操作，使用 volatile 进行只读操作。其中，锁一次只允许一个线程访问值，volatile 允许多个线程执行读操作，因此当使用 volatile 保证读代码路径时，要比使用锁执行全部代码路径获得更高的共享度，就像读写操作一样。然而，要随时牢记这种模式的弱点：如果超越了该模式的最基本应用，结合这两个竞争的同步机制将变得非常困难。</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p><strong>结束语</strong></p>
<p>Volatile variables are a simpler – but weaker – form of synchronization than locking, which in some cases offers better performance or scalability than intrinsic locking. If you follow the conditions for using volatile safely – that the variable is truly independent of both other variables and its own prior values – you can sometimes simplify code by using volatile instead of synchronized. However, code using volatile is often more fragile than code using locking. The patterns offered here cover the most common cases where volatile is a sensible alternative to synchronized. Following these patterns – taking care not to push them beyond their limits – should help you safely cover the majority of cases where volatile variables are a win.</p>
<p>与锁相比，Volatile 变量是一种非常简单但同时又非常脆弱的同步机制，它在某些情况下将提供优于锁的性能和伸缩性。如果严格遵循 volatile 的使用条件，即变量真正独立于其他变量和自己以前的值，在某些情况下可以使用 volatile 代替 synchronized 来简化代码。然而，使用 volatile 的代码往往比使用锁的代码更加容易出错。本文介绍的模式涵盖了可以使用 volatile 代替 synchronized 的最常见的一些用例。遵循这些模式（注意使用时不要超过各自的限制）可以帮助你安全地实现大多数用例，使用 volatile 变量获得更佳性能。</p>
]]></content>
      <categories>
        <category>文献翻译</category>
        <category>java</category>
      </categories>
      <tags>
        <tag>未标记</tag>
      </tags>
  </entry>
  <entry>
    <title>DataGrip-2018.3.4-数据导出配置案例</title>
    <url>/58859900-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<p>官方文档：<a href="https://www.jetbrains.com/help/datagrip">https://www.jetbrains.com/help/datagrip</a> ，该文档默认是最新版本，可手动选择旧版本。</p>
<h1 id="1-数据导出"><a href="#1-数据导出" class="headerlink" title="1 数据导出"></a>1 数据导出</h1><p>DataGrip 导出整个数据库或单个表均支持两种方式，<code>Dump Data to File(s)</code> 以及 <code>Dump with ‘mysqldump’</code>。以下例子均采用 MySQL</p>
<h2 id="1-1-Dump-Data-to-File-s"><a href="#1-1-Dump-Data-to-File-s" class="headerlink" title="1.1 Dump Data to File(s)"></a>1.1 Dump Data to File(s)</h2><p>导出整个数据库的菜单选项如下所示。导出单个表的菜单选项减少了 <code>Overwrite Existing Files</code> 和 <code>Single File</code>，其余相同。</p>
<blockquote>
<p>注：如果数据库只有一个表，菜单与导出单个表的相同</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">----------------------------------|【导出格式】</span><br><span class="line">SQL Inserts</span><br><span class="line">SQL Updates</span><br><span class="line">HTML Table</span><br><span class="line">----------------------------------|【导出格式】</span><br><span class="line">Tab-separated (TSV)</span><br><span class="line">Comma-separated (CSV)</span><br><span class="line">----------------------------------|【导出格式】</span><br><span class="line">HTML-Groovy.html.groovy</span><br><span class="line">HTML-JavaScript.html.js</span><br><span class="line">SQL-Insert-Statements.sql.groovy</span><br><span class="line">XML-Groovy.xml,groovy</span><br><span class="line">CSV-Groovy.csv.groovy</span><br><span class="line">JSON-Groovy.json.groovy</span><br><span class="line">----------------------------------|【行为】</span><br><span class="line">Skip Computed Columns (SQL)【不添加计算列】</span><br><span class="line">Skip Generated Columns (SQL)【不添加自动生成的列，如自动增长列】</span><br><span class="line">Add Table Definition (SQL)【添加表定义】</span><br><span class="line">Overwrite Existing Files【导出整个数据库时可用。若出现重名，不勾选时生成文件名后有序号，勾选则覆盖】</span><br><span class="line">Single File【导出整个数据库时可用。将各个表的 sql 合并到一个文件，否则每个表分别生成一个文件。勾选 Single File 后，Overwrite Existing Files 失效，无论是否勾选。此时若出现重名，将弹出对话框提示是否覆盖或改名】</span><br><span class="line">----------------------------------|</span><br><span class="line">Configure CSV Formats...</span><br><span class="line">Go to Scripts Directory</span><br><span class="line">----------------------------------|</span><br></pre></td></tr></table></figure>

<p>创建数据库 onlytest，包含两个结构类似的表 employee、manager，其中 employee 包含计算列。创建 sql 如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> onlytest.employee</span><br><span class="line">(</span><br><span class="line">  ID       <span class="type">bigint</span> auto_increment</span><br><span class="line">    <span class="keyword">primary</span> key,</span><br><span class="line">  name     tinytext <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  age      <span class="type">int</span>      <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  tenyears <span class="type">int</span> <span class="keyword">as</span> ((`age` <span class="operator">+</span> <span class="number">10</span>))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> onlytest.manager</span><br><span class="line">(</span><br><span class="line">  ID   <span class="type">bigint</span> auto_increment</span><br><span class="line">    <span class="keyword">primary</span> key,</span><br><span class="line">  name tinytext <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  age  <span class="type">int</span>      <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="1-1-1-Add-Table-Definition-SQL"><a href="#1-1-1-Add-Table-Definition-SQL" class="headerlink" title="1.1.1 Add Table Definition (SQL)"></a>1.1.1 Add Table Definition (SQL)</h3><p>若勾选 <code>Add Table Definition (SQL)</code>、<code>Single File</code>，导出格式选择 <code>SQL Inserts</code>，则在添加数据前创建表时的定义（<code>SQL Updates</code> 结果以此类推）：</p>
<blockquote>
<p>注意：该选项仅对 <code>SQL Inserts</code>、<code>SQL Updates</code> 有效。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> employee</span><br><span class="line">(</span><br><span class="line">  ID       <span class="type">bigint</span> auto_increment</span><br><span class="line">    <span class="keyword">primary</span> key,</span><br><span class="line">  name     tinytext <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  age      <span class="type">int</span>      <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  tenyears <span class="type">int</span> <span class="keyword">as</span> ((`age` <span class="operator">+</span> <span class="number">10</span>))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.employee (ID, name, age, tenyears) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;one&#x27;</span>, <span class="number">22</span>, <span class="number">32</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.employee (ID, name, age, tenyears) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;two&#x27;</span>, <span class="number">17</span>, <span class="number">27</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.employee (ID, name, age, tenyears) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;three&#x27;</span>, <span class="number">20</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> manager</span><br><span class="line">(</span><br><span class="line">  ID   <span class="type">bigint</span> auto_increment</span><br><span class="line">    <span class="keyword">primary</span> key,</span><br><span class="line">  name tinytext <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  age  <span class="type">int</span>      <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.manager (ID, name, age) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;one&#x27;</span>, <span class="number">35</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.manager (ID, name, age) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;two&#x27;</span>, <span class="number">36</span>);</span><br></pre></td></tr></table></figure>

<p>不勾选则仅生成 insert（<code>SQL Updates</code> 结果以此类推）：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.employee (ID, name, age, tenyears) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;one&#x27;</span>, <span class="number">22</span>, <span class="number">32</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.employee (ID, name, age, tenyears) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;two&#x27;</span>, <span class="number">17</span>, <span class="number">27</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.employee (ID, name, age, tenyears) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;three&#x27;</span>, <span class="number">20</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.manager (ID, name, age) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;one&#x27;</span>, <span class="number">35</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.manager (ID, name, age) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;two&#x27;</span>, <span class="number">36</span>);</span><br></pre></td></tr></table></figure>

<h3 id="1-1-2-Skip-Generated-Columns-SQL"><a href="#1-1-2-Skip-Generated-Columns-SQL" class="headerlink" title="1.1.2 Skip Generated Columns (SQL)"></a>1.1.2 Skip Generated Columns (SQL)</h3><p>若勾选 <code>Skip Generated Columns (SQL)</code>、<code>Single File</code>，不勾选 <code>Add Table Definition (SQL)</code>，导出格式选择 <code>SQL Inserts</code>，则没有自动增长的 ID 列，（<code>SQL Updates</code> 结果以此类推）：</p>
<blockquote>
<p>注意：该选项仅对 <code>SQL Inserts</code>、<code>SQL Updates</code> 有效。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.employee (name, age, tenyears) <span class="keyword">VALUES</span> (<span class="string">&#x27;one&#x27;</span>, <span class="number">22</span>, <span class="number">32</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.employee (name, age, tenyears) <span class="keyword">VALUES</span> (<span class="string">&#x27;two&#x27;</span>, <span class="number">17</span>, <span class="number">27</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.employee (name, age, tenyears) <span class="keyword">VALUES</span> (<span class="string">&#x27;three&#x27;</span>, <span class="number">20</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.manager (name, age) <span class="keyword">VALUES</span> (<span class="string">&#x27;one&#x27;</span>, <span class="number">35</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.manager (name, age) <span class="keyword">VALUES</span> (<span class="string">&#x27;two&#x27;</span>, <span class="number">36</span>);</span><br></pre></td></tr></table></figure>

<h3 id="1-1-3-Skip-Computed-Columns-SQL"><a href="#1-1-3-Skip-Computed-Columns-SQL" class="headerlink" title="1.1.3 Skip Computed Columns (SQL)"></a>1.1.3 Skip Computed Columns (SQL)</h3><p>若勾选 <code>Skip Computed Columns (SQL)</code>、<code>Single File</code>，不勾选 <code>Add Table Definition (SQL)</code>，导出格式选择 <code>SQL Inserts</code>，则没有 tenyears 列，（<code>SQL Updates</code> 结果以此类推）：</p>
<blockquote>
<p>注意：该选项仅对 <code>SQL Inserts</code>、<code>SQL Updates</code> 有效。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.employee (ID, name, age) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;one&#x27;</span>, <span class="number">22</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.employee (ID, name, age) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;two&#x27;</span>, <span class="number">17</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.employee (ID, name, age) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;three&#x27;</span>, <span class="number">20</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.manager (ID, name, age) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;one&#x27;</span>, <span class="number">35</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> onlytest.manager (ID, name, age) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;two&#x27;</span>, <span class="number">36</span>);</span><br></pre></td></tr></table></figure>

<h2 id="1-2-Dump-with-‘mysqldump’"><a href="#1-2-Dump-with-‘mysqldump’" class="headerlink" title="1.2 Dump with ‘mysqldump’"></a>1.2 Dump with ‘mysqldump’</h2><p>经过实测发现，当数据量较大时，使用 <code>Dump Data to File(s)</code> 方式导出的 sql 文件与 <code>Dump with ‘mysqldump’</code> 方式相比会大很多，可能是由于前者重复字符量大以及换行多导致。因此推荐优先使用后者导出。</p>
<p>导出整个数据库和单个表的菜单选项相同，故合并讨论。<code>Dump with ‘mysqldump’</code> 有如下菜单选项：</p>
<ul>
<li>Multiple rows inserts【将 insert 语句合并为一行】</li>
<li>Add drop table【增加判断条件，若表存在则删除】</li>
<li>Disable keys【禁用索引】</li>
<li>Delay inserts【提示错误 <code>mysqldump: [ERROR] unknown option &#39;--delayed-insert&#39;.</code>，无输出结果】</li>
<li>MySQL create table options【若不勾选，暂时未发现有明显差异】</li>
<li>Lock tables【锁表，可能是防止有新数据在导出时进入】</li>
<li>Add locks【导入时，在执行 insert 前添加 write 锁，完成后解除】</li>
<li>Add drop trigger【导入时，删除对方的触发器】</li>
</ul>
<h3 id="案例-1"><a href="#案例-1" class="headerlink" title="案例 1"></a>案例 1</h3><p>勾选 Multiple rows inserts、Add drop table、MySQL create table options、Add drop trigger，生成结果如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL dump 10.13  Distrib 8.0.18, for osx10.14 (x86_64)</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- Host: 127.0.0.1    Database: onlytest</span></span><br><span class="line"><span class="comment">-- ------------------------------------------------------</span></span><br><span class="line"><span class="comment">-- Server version	8.0.18</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */</span>;</span><br><span class="line"><span class="comment">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */</span>;</span><br><span class="line"><span class="comment">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */</span>;</span><br><span class="line"><span class="comment">/*!50503 SET NAMES utf8mb4 */</span>;</span><br><span class="line"><span class="comment">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */</span>;</span><br><span class="line"><span class="comment">/*!40103 SET TIME_ZONE=&#x27;+00:00&#x27; */</span>;</span><br><span class="line"><span class="comment">/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */</span>;</span><br><span class="line"><span class="comment">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */</span>;</span><br><span class="line"><span class="comment">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&#x27;NO_AUTO_VALUE_ON_ZERO&#x27; */</span>;</span><br><span class="line"><span class="comment">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- Table structure for table `employee`</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `employee`;</span><br><span class="line"><span class="comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;</span><br><span class="line"><span class="comment">/*!50503 SET character_set_client = utf8mb4 */</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `employee` (</span><br><span class="line">  `ID` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` tinytext <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `age` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenyears` <span class="type">int</span>(<span class="number">11</span>) GENERATED ALWAYS <span class="keyword">AS</span> ((`age` <span class="operator">+</span> <span class="number">10</span>)) VIRTUAL,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"><span class="comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- Dumping data for table `employee`</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employee` (`ID`, `name`, `age`) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;one&#x27;</span>,<span class="number">22</span>),(<span class="number">2</span>,<span class="string">&#x27;two&#x27;</span>,<span class="number">17</span>),(<span class="number">3</span>,<span class="string">&#x27;three&#x27;</span>,<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- Table structure for table `manager`</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `manager`;</span><br><span class="line"><span class="comment">/*!40101 SET @saved_cs_client     = @@character_set_client */</span>;</span><br><span class="line"><span class="comment">/*!50503 SET character_set_client = utf8mb4 */</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `manager` (</span><br><span class="line">  `ID` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` tinytext <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `age` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`ID`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">3</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_general_ci;</span><br><span class="line"><span class="comment">/*!40101 SET character_set_client = @saved_cs_client */</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"><span class="comment">-- Dumping data for table `manager`</span></span><br><span class="line"><span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `manager` <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;one&#x27;</span>,<span class="number">35</span>),(<span class="number">2</span>,<span class="string">&#x27;two&#x27;</span>,<span class="number">36</span>);</span><br><span class="line"><span class="comment">/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */</span>;</span><br><span class="line"><span class="comment">/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */</span>;</span><br><span class="line"><span class="comment">/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */</span>;</span><br><span class="line"><span class="comment">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */</span>;</span><br><span class="line"><span class="comment">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */</span>;</span><br><span class="line"><span class="comment">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */</span>;</span><br><span class="line"><span class="comment">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Dump completed on 2020-02-19 20:43:57</span></span><br></pre></td></tr></table></figure>

<h3 id="案例-2"><a href="#案例-2" class="headerlink" title="案例 2"></a>案例 2</h3><p>若增加勾选 Disable keys，禁用索引，在大批量导入时先禁用索引，在完全导入后，再开启索引。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `employee` DISABLE KEYS */</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employee` (`ID`, `name`, `age`) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;one&#x27;</span>,<span class="number">22</span>),(<span class="number">2</span>,<span class="string">&#x27;two&#x27;</span>,<span class="number">17</span>),(<span class="number">3</span>,<span class="string">&#x27;three&#x27;</span>,<span class="number">20</span>);</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `employee` ENABLE KEYS */</span>;</span><br><span class="line">...</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `manager` DISABLE KEYS */</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `manager` <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;one&#x27;</span>,<span class="number">35</span>),(<span class="number">2</span>,<span class="string">&#x27;two&#x27;</span>,<span class="number">36</span>);</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `manager` ENABLE KEYS */</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="案例-3"><a href="#案例-3" class="headerlink" title="案例 3"></a>案例 3</h3><p>勾选 Add locks，添加了 write 锁</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">LOCK TABLES `employee` WRITE;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `employee` (`ID`, `name`, `age`) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;one&#x27;</span>,<span class="number">22</span>),(<span class="number">2</span>,<span class="string">&#x27;two&#x27;</span>,<span class="number">17</span>),(<span class="number">3</span>,<span class="string">&#x27;three&#x27;</span>,<span class="number">20</span>);</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line">...</span><br><span class="line">LOCK TABLES `manager` WRITE;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `manager` <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;one&#x27;</span>,<span class="number">35</span>),(<span class="number">2</span>,<span class="string">&#x27;two&#x27;</span>,<span class="number">36</span>);</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="其他-mysqldump-参数（待定）"><a href="#其他-mysqldump-参数（待定）" class="headerlink" title="其他 mysqldump 参数（待定）"></a>其他 mysqldump 参数（待定）</h3><table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><a href="">xxx</a></td>
<td align="center">xxx</td>
</tr>
</tbody></table>
<h1 id="2-查看创建脚本"><a href="#2-查看创建脚本" class="headerlink" title="2 查看创建脚本"></a>2 查看创建脚本</h1><p>右键 SQL Script 选择 SQL Generator</p>
<h1 id="3-执行-SQL"><a href="#3-执行-SQL" class="headerlink" title="3 执行 SQL"></a>3 执行 SQL</h1><p>右键 New 选择 Console，</p>
]]></content>
      <categories>
        <category>系统和工具配置</category>
      </categories>
      <tags>
        <tag>datagrip</tag>
      </tags>
  </entry>
  <entry>
    <title>IntelliJ-IDEA-快捷键及常用配置</title>
    <url>/5885c010-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<img src="/5885c010-2a1e-11ee-846a-89c1529ebdf1/1.png" class="">

<img src="/5885c010-2a1e-11ee-846a-89c1529ebdf1/2.png" class="">

<!-- 
符号 	说明
⌘ 	Command
⇧ 	Shift
⌥ 	Option
⌃ 	Control
↩︎ 	Return/Enter
⌫ 	Delete
⌦ 	向前删除键（Fn+Delete）
↑ 	上箭头
↓ 	下箭头
→ 	右箭头
← 	左箭头
⇞ 	Page Up（Fn+↑）
⇟ 	Page Down（Fn+↓）
Home 	Fn + ←
End 	Fn + →
⇥ 	右制表符（Tab键）
⇤ 	左制表符（Shift+Tab）
⎋ 	Escape (Esc)
 -->

<h2 id="macOS-IDEA-默认常用快捷键"><a href="#macOS-IDEA-默认常用快捷键" class="headerlink" title="macOS IDEA 默认常用快捷键"></a>macOS IDEA 默认常用快捷键</h2><ul>
<li>删除行 <code>⌘Y</code></li>
<li>查看实现当前接口全部类或当前类的全部子类（Type hierarchy） <code>⌃H</code></li>
<li>查看所有方法 <code>⌘7</code></li>
<li>从当前行切换到下一行 <code>⇧↩︎</code></li>
<li>全局搜索（Search everywhere） <code>Double⇧</code></li>
<li>格式化代码（Reformat Code） <code>⌥⌘L</code></li>
<li>往上移动代码块或行 <code>⇧⌘↑</code></li>
<li>往下移动代码块或行 <code>⇧⌘↓</code></li>
</ul>
<h2 id="格式化-Java-代码时让注释不在行首"><a href="#格式化-Java-代码时让注释不在行首" class="headerlink" title="格式化 Java 代码时让注释不在行首"></a>格式化 Java 代码时让注释不在行首</h2><p>Preference → Editor → Code Style → Java，取消「Line comment at first column」和「Block comment at first column」复选即可。</p>
<h2 id="Java-代码自动导入依赖"><a href="#Java-代码自动导入依赖" class="headerlink" title="Java 代码自动导入依赖"></a>Java 代码自动导入依赖</h2><p>Preference → Editor → General → Auto Import，「Insert imports on paste」选择「All」即可。</p>
<h2 id="自动完成关键字时不区分大小写"><a href="#自动完成关键字时不区分大小写" class="headerlink" title="自动完成关键字时不区分大小写"></a>自动完成关键字时不区分大小写</h2><p>Preference → Editor → General → Code Completion，取消「Match case」复选即可。</p>
]]></content>
      <categories>
        <category>系统和工具配置</category>
      </categories>
      <tags>
        <tag>intelliJ</tag>
      </tags>
  </entry>
  <entry>
    <title>MacOS-或-Win-环境下问题杂烩及备忘</title>
    <url>/5885c011-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="macOS-10-14-6-运行应用时提示「无法打开“xxxxx”，因为-Apple-无法检查其是否包含恶意软件。」"><a href="#macOS-10-14-6-运行应用时提示「无法打开“xxxxx”，因为-Apple-无法检查其是否包含恶意软件。」" class="headerlink" title="macOS 10.14.6 运行应用时提示「无法打开“xxxxx”，因为 Apple 无法检查其是否包含恶意软件。」"></a>macOS 10.14.6 运行应用时提示「无法打开“xxxxx”，因为 Apple 无法检查其是否包含恶意软件。」</h2><p>该提示与「“xxxxx”已损坏，打不开。您应该将它移到废纸娄。」解决方案相同，需要开启「允许安装软件来自任何来源」。打开终端，输入命令：<code>sudo spctl --master-disable</code>，输入密码后生效。</p>
<h2 id="macOS-查看隐藏文件"><a href="#macOS-查看隐藏文件" class="headerlink" title="macOS 查看隐藏文件"></a>macOS 查看隐藏文件</h2><p><code>⌘+⇧+.</code></p>
<h2 id="win10-使用-ssh-连接远程服务器"><a href="#win10-使用-ssh-连接远程服务器" class="headerlink" title="win10 使用 ssh 连接远程服务器"></a>win10 使用 ssh 连接远程服务器</h2><ul>
<li>依次进入：开始菜单 → 设置 → 应用 → 应用和功能，选择「管理可选功能」</li>
<li>进入添加功能，添加「OpenSSH 服务端」</li>
<li>从开始菜单打开 Windows PowerShell 即可使用</li>
</ul>
<h2 id="VSCode-利用正则删除全部空行"><a href="#VSCode-利用正则删除全部空行" class="headerlink" title="VSCode 利用正则删除全部空行"></a>VSCode 利用正则删除全部空行</h2><p><code>^\s*(?=\r?$)\n</code> 匹配所有空行，替换为无字符即可</p>
<h2 id="macOS-每次开机通过-ssh-add-自动添加私钥"><a href="#macOS-每次开机通过-ssh-add-自动添加私钥" class="headerlink" title="macOS 每次开机通过 ssh-add 自动添加私钥"></a>macOS 每次开机通过 ssh-add 自动添加私钥</h2><p>打开自动操作，类型选择「应用程序」</p>
<p>选择「运行 shell 脚本」，双击，在右侧设置「名称」，输入如下命令行（参考）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh-add ~/.ssh/id_rsa</span><br></pre></td></tr></table></figure>

<p>进入「偏好设置」，进入「用户与群组」，进入「登陆项」，选择之前命名的应用即可</p>
]]></content>
      <categories>
        <category>系统和工具配置</category>
      </categories>
      <tags>
        <tag>macos</tag>
        <tag>win</tag>
      </tags>
  </entry>
  <entry>
    <title>VSCode-常用插件及配置</title>
    <url>/58860e30-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="Prettier-Code-formatter"><a href="#Prettier-Code-formatter" class="headerlink" title="Prettier - Code formatter"></a>Prettier - Code formatter</h2><p>代码格式化插件，支持的语言有：JavaScript、TypeScript、Flow、JSX、JSON、CSS、SCSS、Less、HTML、Vue、Angular、GraphQL、Markdown、YAML</p>
<p>Prettier 使用 cosmiconfig 来支持配置文件。这意味着你可以通过以下方式配置 prettier（按优先级顺序）：</p>
<ul>
<li>在 <code>package.json</code> 文件中建立 <code>&quot;prettier&quot;</code> 键</li>
<li>新建一个内容是 JSON 或 YAML 格式的 <code>.prettierrc</code> 文件，扩展名可选：<code>.json/.yaml/.yml</code>，不带扩展名的优先级最高。</li>
<li>使用 <code>.prettierrc.js</code> 或 <code>prettier.config.js</code> 文件导出对象</li>
<li>使用 <code>.prettierrc.toml</code> 文件，格式是 TOML，（ <code>.toml</code> 扩展名是必须的）</li>
</ul>
<p>配置文件将从正在格式化的文件的位置开始解析，并在文件树中搜索，直到找到（或没有找到）配置文件。配置文件的选项与 API 选项相同。JSON 格式的配置文件示例如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;trailingComma&quot;</span><span class="punctuation">:</span> <span class="string">&quot;es5&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tabWidth&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;semi&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;singleQuote&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置项"><a href="#配置项" class="headerlink" title="配置项"></a>配置项</h3><h4 id="jsxBracketSameLine"><a href="#jsxBracketSameLine" class="headerlink" title="jsxBracketSameLine"></a><a href="https://prettier.io/docs/en/options.html#jsx-brackets">jsxBracketSameLine</a></h4><p>将多行 JSX 元素的 <code>&gt;</code> 放在最后一行的末尾，而不是单独放在下一行（不应用于自关闭元素）。默认值为 <code>false</code>。</p>
<h4 id="arrowParens"><a href="#arrowParens" class="headerlink" title="arrowParens"></a><a href="https://prettier.io/docs/en/options.html#arrow-function-parentheses">arrowParens</a></h4><p>箭头函数的单个参数周围包含圆括号。可选值为：<code>&quot;always&quot;</code> 和 <code>&quot;avoid&quot;</code>，默认值为 <code>&quot;avoid&quot;</code>，即单个参数周围默认不包含圆括号。</p>
<h4 id="https-prettier-io-docs-en-options-html-bracket-spacing"><a href="#https-prettier-io-docs-en-options-html-bracket-spacing" class="headerlink" title="https://prettier.io/docs/en/options.html#bracket-spacing"></a><a href="https://prettier.io/docs/en/options.html#bracket-spacing">https://prettier.io/docs/en/options.html#bracket-spacing</a></h4><p>更多说明及示例可参看文档：<a href="https://prettier.io/docs/en/configuration.html">https://prettier.io/docs/en/configuration.html</a></p>
]]></content>
      <categories>
        <category>系统和工具配置</category>
      </categories>
      <tags>
        <tag>vscode</tag>
      </tags>
  </entry>
  <entry>
    <title>修改-host-表开启-gist</title>
    <url>/58865c52-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>win 10 的 hosts 文件路径如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Windows\System32\drivers\etc\hosts.ics</span><br></pre></td></tr></table></figure>

<p>macOS 10.14.6 的 hosts 文件直接通过终端进入：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ sudo vi /etc/hosts</span><br></pre></td></tr></table></figure>

<p>在文件末尾添加以下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">192.30.253.118 gist.github.com</span><br><span class="line">192.30.253.119 gist.github.com</span><br></pre></td></tr></table></figure>

<p>注：该地址可能会变动，可进入 <a href="https://ipchaxun.com/gist.github.com/">https://ipchaxun.com/gist.github.com/</a> 查询地址，目前最新的地址如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">140.82.112.4</span><br><span class="line">140.82.114.4 </span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>系统和工具配置</category>
      </categories>
      <tags>
        <tag>github</tag>
      </tags>
  </entry>
  <entry>
    <title>修改-macOS-的-MAC-地址</title>
    <url>/ef127fe0-4937-11ee-861d-b3cf05b530a5/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、操作步骤"><a href="#1、操作步骤" class="headerlink" title="1、操作步骤"></a>1、操作步骤</h2><p>1）打开终端，输入<code>openssl rand -hex 6 | sed &#39;s/\(..\)/\1:/g; s/.$//&#39;</code>生成一个 MAC 地址</p>
<p>2）断开网卡连接，会要求输入密码。</p>
<p><code>sudo /System/Library/PrivateFrameworks/Apple80211.framework/Resources/airport -z</code></p>
<p>3）修改网卡地址，例如 en0：<code>sudo ifconfig en0 ether xx:xx:xx:xx:xx:xx</code></p>
<p>4）重连网卡，可能会要求输入密码：<code>networksetup -detectnewhardware</code></p>
<p>5）验证 MAC 地址是否修改成功：<code>ifconfig</code></p>
]]></content>
      <categories>
        <category>系统和工具配置</category>
      </categories>
      <tags>
        <tag>macos</tag>
      </tags>
  </entry>
  <entry>
    <title>将-VSCode-添加到右键菜单</title>
    <url>/58868360-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>Windows 10 或 macOS 10.14 下安装 VSCode 后，右键快速打开选项并没有快捷启动。</p>
<h2 id="Windows-10-解决方案"><a href="#Windows-10-解决方案" class="headerlink" title="Windows 10 解决方案"></a>Windows 10 解决方案</h2><p>通过注册表添加三个位置的快速打开选项：文件、目录、桌面（目录内）的空白位置。</p>
<h3 id="1、添加至文件的右键菜单"><a href="#1、添加至文件的右键菜单" class="headerlink" title="1、添加至文件的右键菜单"></a>1、添加至文件的右键菜单</h3><p>定位注册表中如下位置：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HKEY_CLASSES_ROOT\*\shell</span><br></pre></td></tr></table></figure>

<p>参考以下结构，在 shell 下新建一个项 Open with VSCode</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">├── Open with VSCode</span><br><span class="line">    ├── (默认)（在右键菜单显示的名称）</span><br><span class="line">    ├── Icon（在右键菜单显示的图标路径）</span><br><span class="line">    └── command</span><br><span class="line">        └── (默认)（执行的命令行及应用路径）</span><br></pre></td></tr></table></figure>

<p>添加相应字符串值即可实现点击文件的右键菜单进入 VSCode。导出内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\*\shell\Open with VSCode]</span><br><span class="line">&quot;Icon&quot;=&quot;C:\\MyProject\\Microsoft VS Code\\Code.exe&quot;</span><br><span class="line">@=&quot;Open with VSCode&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\*\shell\Open with VSCode\command]</span><br><span class="line">@=&quot;\&quot;C:\\MyProject\\Microsoft VS Code\\Code.exe\&quot; \&quot;%1\&quot;&quot;</span><br></pre></td></tr></table></figure>

<h3 id="2、添加至目录的右键菜单"><a href="#2、添加至目录的右键菜单" class="headerlink" title="2、添加至目录的右键菜单"></a>2、添加至目录的右键菜单</h3><p>定位至 <code>HKEY_CLASSES_ROOT\Directory\shell</code>，按照相同结构设置即可实现点击目录的右键菜单进入 VSCode。导出内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Directory\shell\VSCode]</span><br><span class="line">&quot;Icon&quot;=&quot;C:\\MyProject\\Microsoft VS Code\\Code.exe&quot;</span><br><span class="line">@=&quot;Open Folder as VSCode Project&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Directory\shell\VSCode\command]</span><br><span class="line">@=&quot;\&quot;C:\\MyProject\\Microsoft VS Code\\Code.exe\&quot; \&quot;%1\&quot;&quot;</span><br></pre></td></tr></table></figure>

<h3 id="3、添加至桌面（目录内）的空白位置的右键菜单"><a href="#3、添加至桌面（目录内）的空白位置的右键菜单" class="headerlink" title="3、添加至桌面（目录内）的空白位置的右键菜单"></a>3、添加至桌面（目录内）的空白位置的右键菜单</h3><p>定位至 <code>HKEY_CLASSES_ROOT\Directory\Background\shell</code>，按照相同结构设置即可实现点击桌面（目录内）的空白位置的右键菜单进入 VSCode。导出内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Directory\Background\shell\VSCode]</span><br><span class="line">&quot;Icon&quot;=&quot;C:\\MyProject\\Microsoft VS Code\\Code.exe&quot;</span><br><span class="line">@=&quot;Open Folder as VSCode Project&quot;</span><br><span class="line"></span><br><span class="line">[HKEY_CLASSES_ROOT\Directory\Background\shell\VSCode\command]</span><br><span class="line">@=&quot;\&quot;C:\\MyProject\\Microsoft VS Code\\Code.exe\&quot; \&quot;%V\&quot;&quot;</span><br></pre></td></tr></table></figure>

<h2 id="macOS-10-14-解决方案"><a href="#macOS-10-14-解决方案" class="headerlink" title="macOS 10.14 解决方案"></a>macOS 10.14 解决方案</h2><p>通过快速操作添加两个位置的快速打开选项：文件、目录。</p>
<h3 id="1、打开自动操作，文稿类型选取-快速操作"><a href="#1、打开自动操作，文稿类型选取-快速操作" class="headerlink" title="1、打开自动操作，文稿类型选取 快速操作"></a>1、打开自动操作，文稿类型选取 <code>快速操作</code></h3><img src="/58868360-2a1e-11ee-846a-89c1529ebdf1/1.png" class="">

<h3 id="2、左侧资源库选择-文件和文件夹，对应其右侧子菜单栏双击-打开访达项目，"><a href="#2、左侧资源库选择-文件和文件夹，对应其右侧子菜单栏双击-打开访达项目，" class="headerlink" title="2、左侧资源库选择 文件和文件夹，对应其右侧子菜单栏双击 打开访达项目，"></a>2、左侧资源库选择 <code>文件和文件夹</code>，对应其右侧子菜单栏双击 <code>打开访达项目</code>，</h3><h3 id="3、在-工作流程收到当前-选择-文件或文件夹，位于-选择-访达"><a href="#3、在-工作流程收到当前-选择-文件或文件夹，位于-选择-访达" class="headerlink" title="3、在 工作流程收到当前 选择 文件或文件夹，位于 选择 访达"></a>3、在 <code>工作流程收到当前</code> 选择 <code>文件或文件夹</code>，<code>位于</code> 选择 <code>访达</code></h3><h3 id="4、在-打开方式-找到-Visual-Studio-Code-app"><a href="#4、在-打开方式-找到-Visual-Studio-Code-app" class="headerlink" title="4、在 打开方式 找到 Visual Studio Code.app"></a>4、在 <code>打开方式</code> 找到 <code>Visual Studio Code.app</code></h3><img src="/58868360-2a1e-11ee-846a-89c1529ebdf1/2.png" class="">

<h3 id="5、完成以上设置后，cmd-S-将该快速操作保存为-Open-with-VSCode-即可"><a href="#5、完成以上设置后，cmd-S-将该快速操作保存为-Open-with-VSCode-即可" class="headerlink" title="5、完成以上设置后，cmd+S 将该快速操作保存为 Open with VSCode 即可"></a>5、完成以上设置后，<code>cmd+S</code> 将该快速操作保存为 <code>Open with VSCode</code> 即可</h3>]]></content>
      <categories>
        <category>系统和工具配置</category>
      </categories>
      <tags>
        <tag>vscode</tag>
      </tags>
  </entry>
  <entry>
    <title>GitHub 中使用 issues 模版和 pull request 模版</title>
    <url>/2d5fb050-cd69-11ee-be69-4dedf56c58bd/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、issues-模版"><a href="#1、issues-模版" class="headerlink" title="1、issues 模版"></a>1、issues 模版</h2><p>1）默认模版</p>
<ul>
<li>在代码库新建目录：<code>.github</code></li>
<li>在 <code>.github</code> 目录下添加 <code>ISSUE_TEMPLATE.md</code> 文件作为 issues 默认模版。当创建 issue 时，若未建立多模版或选择了 <code>Open a regular issue</code> 时，系统会引用该模版。</li>
</ul>
<p><img src="/2d5fb050-cd69-11ee-be69-4dedf56c58bd/%E5%9B%BE1-%E9%BB%98%E8%AE%A4%E6%A8%A1%E6%9D%BF%E5%85%A5%E5%8F%A3.png" alt="图1-默认模板入口"></p>
<p>2）多模版</p>
<ul>
<li>在代码库新建目录：<code>.github/ISSUE_TEMPLATE</code></li>
<li>该目录下可添加多个 <code>.md</code> 文件作为 issues 模版。当创建 issue 时，系统会展示这些模版供选择。</li>
<li><code>.md</code> 文件参考格式如下：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">name: 该模版的名称（创建 issue 时，系统展示模版列表时会显示该名称）</span><br><span class="line">about: 该模版的描述（创建 issue 时，系统展示模版列表时会显示该描述）</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">正文内容……</span><br></pre></td></tr></table></figure>

<p>3）注意事项</p>
<ul>
<li>issues 的默认模版和多模版可同时存在。</li>
<li>关于 issues 模版的描述可详见帮助文档：<a href="https://help.github.com/articles/manually-creating-a-single-issue-template-for-your-repository/">https://help.github.com/articles/manually-creating-a-single-issue-template-for-your-repository/</a></li>
</ul>
<h2 id="2、pull-request-模版"><a href="#2、pull-request-模版" class="headerlink" title="2、pull request 模版"></a>2、pull request 模版</h2><p>1）默认模版</p>
<ul>
<li>在代码库新建目录：<code>.github</code></li>
<li>在 <code>.github</code> 目录下添加 <code>PULL_REQUEST_TEMPLATE.md</code> 文件作为 pull request 默认模版。当创建不带参数的 pull request 时，系统会引用该模版。</li>
</ul>
<p>2）多模版</p>
<ul>
<li>在代码库新建目录：<code>.github/PULL_REQUEST_TEMPLATE</code></li>
<li>该目录下可添加多个 <code>.md</code> 文件作为 pull request 模版。</li>
<li>pull request 模版要通过查询参数来调用。例如，要使用 <code>pr-template-1.md</code> 这个模版，可使用如下查询：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://github.com/用户名/代码库名称/compare/分支名称?<span class="built_in">expand</span>=1&amp;template=pr-template-1.md</span><br></pre></td></tr></table></figure>

<p>或参考 GitHub 帮助文档的格式，如下。两者效果相同。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://github.com/用户名/代码库名称/compare/master...分支名称?<span class="built_in">expand</span>=1&amp;template=pr-template-1.md</span><br></pre></td></tr></table></figure>

<ul>
<li>可选查询参数<ul>
<li><code>expand=1</code>，直接跳转到 pull request 界面。如果不带此参数会先到 compare 界面，需手动进入 pull request 界面。</li>
<li><code>template=pr-template-1.md</code>，调用名为 <code>pr-template-1.md</code> 的模版。如果不带此参数，则调用默认模版。</li>
<li><code>title=New+bug+report</code>（或者 <code>title=New%20bug%20report</code>），指定 pull request 的标题为 <code>New bug report</code></li>
<li>其他参数可详见帮助文档：<a href="https://help.github.com/articles/about-automation-for-issues-and-pull-requests-with-query-parameters/">https://help.github.com/articles/about-automation-for-issues-and-pull-requests-with-query-parameters/</a></li>
</ul>
</li>
</ul>
<p>3）注意事项</p>
<ul>
<li>pull request 的默认模版和多模版可同时存在。</li>
<li>关于 pull request 模版的描述可详见帮助文档：<a href="https://help.github.com/articles/creating-a-pull-request-template-for-your-repository/">https://help.github.com/articles/creating-a-pull-request-template-for-your-repository/</a></li>
</ul>
]]></content>
      <categories>
        <category>通用技术</category>
      </categories>
      <tags>
        <tag>github</tag>
      </tags>
  </entry>
  <entry>
    <title>GitHub-中独立仓库与组织的权限</title>
    <url>/5886aa71-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="一、独立仓库（公开或私有）"><a href="#一、独立仓库（公开或私有）" class="headerlink" title="一、独立仓库（公开或私有）"></a>一、独立仓库（公开或私有）</h2><p>独立仓库包含 <strong>仓库拥有者和外部协作者</strong> 两种角色，相关权限如下表</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">直接写入</th>
<th align="center">issue 操作<br>[删除、隐藏、修改]</th>
<th align="center">添加标签</th>
<th align="center">分支操作<br>[删除、创建]</th>
<th align="center">邀请校对</th>
<th align="center">被邀请校对</th>
<th align="center">校对操作<br>[同意、驳回、重校]</th>
<th align="center">强制合并</th>
<th align="center">Setting 菜单可见</th>
</tr>
</thead>
<tbody><tr>
<td align="center">仓库拥有者</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">外部协作者</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">×</td>
<td align="center">×</td>
</tr>
</tbody></table>
<p><strong>注：Setting 菜单是否可见决定了是否具备删库、设置分支规则、邀请外部协作者、密钥设置等高级权限。</strong></p>
<h2 id="二、组织"><a href="#二、组织" class="headerlink" title="二、组织"></a>二、组织</h2><p>组织包含 <strong>组织拥有者、成员、外部协作者</strong> 三种角色，以及 <strong>Read、Write、Admin</strong> 三种权限。</p>
<h3 id="1、Base-permissions（基本权限）"><a href="#1、Base-permissions（基本权限）" class="headerlink" title="1、Base permissions（基本权限）"></a>1、Base permissions（基本权限）</h3><p>Base permissions to the organization’s repositories apply to all members and excludes outside collaborators. Since organization members can have permissions from multiple sources, members and collaborators who have been granted a higher level of access than the base permissions will retain their higher permission privileges.</p>
<p>组织存储库的基本权限适用于所有成员（不含外部协作者）。由于组织成员可以拥有多个库的自定义权限，因此被授予比基本权限更高级别访问权限时，成员和协作者将保留更高的权限。</p>
<p>基本权限包含如下几种：</p>
<ul>
<li>None，Members will only be able to clone and pull public repositories. To give a member additional access, you’ll need to add them to teams or make them collaborators on individual repositories.</li>
</ul>
<p>成员只能对公共库实施 clone 和 pull 操作。要为成员提供额外的访问权限，需要将它们添加到团队中，或者让它们成为各个存储库的外部协作者。</p>
<ul>
<li>Read，Members will be able to clone and pull all repositories.</li>
</ul>
<p>成员可以对所有库实施 clone 和 pull 操作。</p>
<ul>
<li>Write，Members will be able to clone, pull, and push all repositories.</li>
</ul>
<p>成员可以对所有库实施 clone、pull 和 push 操作。</p>
<ul>
<li>Admin，Members will be able to clone, pull, push, and add new collaborators to all repositories.</li>
</ul>
<p>成员可以对所有库实施 clone、pull、push 和添加外部协作者的操作。</p>
<h3 id="2、组织角色"><a href="#2、组织角色" class="headerlink" title="2、组织角色"></a>2、组织角色</h3><ul>
<li>Owner，Has full administrative access to the entire organization.</li>
</ul>
<p>对整个组织具有完全的管理访问权限。<strong>组织角色为 Owner 时，对于组织中每一个库而言，默认权限都是 Admin。</strong></p>
<ul>
<li>Member，Can see every member and non-secret team in the organization, and can create new repositories.</li>
</ul>
<p>可以查看组织中的每个成员和非机密团队，并可以创建新的存储库。<strong>组织角色为 Member 时，对于组织中每一个库而言，默认权限都与基本权限相同。</strong></p>
<h3 id="3、库权限"><a href="#3、库权限" class="headerlink" title="3、库权限"></a>3、库权限</h3><p>Read、Write、Admin，详见基本权限的描述。<strong>如果需要在某一个库中授予某个成员高于基本权限的权限，需要将其添加为外部协作者。</strong></p>
<h3 id="4、组织权限总结如下"><a href="#4、组织权限总结如下" class="headerlink" title="4、组织权限总结如下"></a>4、组织权限总结如下</h3><table>
<thead>
<tr>
<th align="center"></th>
<th align="center">直接写入</th>
<th align="center">issue 操作<br>[删除、隐藏、修改]</th>
<th align="center">添加标签</th>
<th align="center">分支操作<br>[删除、创建]</th>
<th align="center">邀请校对</th>
<th align="center">被邀请校对</th>
<th align="center">校对操作<br>[同意、驳回、重校]</th>
<th align="center">强制合并</th>
<th align="center">库 Setting 菜单可见</th>
<th align="center">组织 Setting 菜单可见</th>
</tr>
</thead>
<tbody><tr>
<td align="center">组织拥有者</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center">Read</td>
<td align="center">×</td>
<td align="center">×</td>
<td align="center">×</td>
<td align="center">×</td>
<td align="center">×</td>
<td align="center">√</td>
<td align="center">×</td>
<td align="center">×</td>
<td align="center">×</td>
<td align="center">×</td>
</tr>
<tr>
<td align="center">Write</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">×</td>
<td align="center">×</td>
<td align="center">×</td>
</tr>
<tr>
<td align="center">Admin</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">×</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>通用技术</category>
      </categories>
      <tags>
        <tag>github</tag>
      </tags>
  </entry>
  <entry>
    <title>conda-依赖管理</title>
    <url>/58860e31-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><p>创建一个新环境：<code>conda create -n &lt;env_name&gt; &lt;python=version&gt; &lt;package_list&gt;</code></p>
<blockquote>
<p>例子：<code>conda create -n env python=3.10 numpy pandas</code>，创建名为<code>env</code>的环境，python 版本为 3.10，同时安装 numpy 和 pandas。</p>
</blockquote>
<p>进入环境：<code>conda activate &lt;env_name&gt;</code></p>
<p>退出环境：<code>conda deavtivate</code></p>
<p>查看所有环境：<code>conda env list</code></p>
<p>复制环境：<code>conda create --name &lt;new_env_name&gt; --clone &lt;old_env_name&gt;</code></p>
<p>精确查找依赖：<code>conda search --full-name &lt;package_full_name&gt;</code></p>
<p>模糊查找依赖：<code>conda search &lt;依赖名称包含的字符串&gt;</code></p>
<p>查看已经安装的依赖：<code>conda list</code></p>
<p>安装依赖：<code>conda install --name &lt;env_name&gt; &lt;package_name&gt;</code></p>
<p>在当前环境安装依赖：<code>conda install &lt;package_name&gt;</code></p>
<p>卸载依赖：<code>conda remove --name &lt;env_name&gt; &lt;package_name&gt;</code></p>
<p>在当前环境卸载依赖：<code>conda remove &lt;package_name&gt;</code></p>
<p>更新全部依赖：<code>conda update --all</code></p>
<p>更新指定依赖：<code>conda update &lt;package_name&gt;</code></p>
<h2 id="环境依赖的导出和恢复"><a href="#环境依赖的导出和恢复" class="headerlink" title="环境依赖的导出和恢复"></a>环境依赖的导出和恢复</h2><p>导出当前环境依赖：<code>conda env export &gt; environment.yaml</code></p>
<p>恢复依赖：<code>conda env create -f environment.yml -n &lt;envname&gt;</code></p>
<blockquote>
<p>注意：<code>environment.yaml</code>文件<code>name</code>属性是导出时环境的名称或绝对路径，恢复时为防止冲突，最好使用<code>-n</code>参数显示指定新名称，此时恢复的环境会出现在<code>env</code>目录下，直接按新名称引用即可。</p>
</blockquote>
<ul>
<li>vscode：<code>ctrl+shift+p</code> -&gt; <code>Select Interpreter</code></li>
<li>pycharm：<code>Settings</code> -&gt; <code>Project</code> -&gt; <code>Python Interpreter</code> -&gt; <code>Add Python Interpreter</code> -&gt; <code>Conda Environment</code></li>
</ul>
<h2 id="删除环境"><a href="#删除环境" class="headerlink" title="删除环境"></a>删除环境</h2><p>常规命令：<code>conda remove --name &lt;env_name&gt; --all</code>，按「Y」确认后执行删除，但<code>env</code>目录下有残余，手动清除即可；若环境没有名称，如下所示。按目前使用经验，用 vscode 插件生成的 conda 环境会出现这种情况，在源码目录下以<code>.conda</code>出现。直接删除即可，再次查看环境列表会消失。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">base                     C:\Users\pro\anaconda3</span><br><span class="line">new                   *  C:\Users\pro\anaconda3\envs\new</span><br><span class="line">python                   C:\Users\pro\anaconda3\envs\python</span><br><span class="line">testq                    C:\Users\pro\anaconda3\envs\testq</span><br><span class="line">testx                    C:\Users\pro\anaconda3\envs\testx</span><br><span class="line">                         c:\Users\Desktop\py_mod\.conda</span><br><span class="line">                         c:\Users\Desktop\test38\.conda</span><br></pre></td></tr></table></figure>

<h2 id="其他管理方式"><a href="#其他管理方式" class="headerlink" title="其他管理方式"></a>其他管理方式</h2><p>管理依赖树：<code>pip install pipdeptree</code>，可查看每个依赖引用的其他依赖。</p>
<p>整体删除依赖及其引用：<code>pip install pip-autoremove</code>，防止遗漏。</p>
]]></content>
      <categories>
        <category>通用技术</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>git-常用命令</title>
    <url>/5886aa72-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<!--
注意：在 issues 使用锚点不能使用 [title](#title) 这种方式
 -->

<h1 id="git-常用命令"><a href="#git-常用命令" class="headerlink" title="git 常用命令"></a>git 常用命令</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a><a name="目录">目录</a></h2><ul>
<li><a href="#初始化仓库">初始化仓库</a></li>
<li><a href="#全局配置用户名和邮箱地址">全局配置用户名和邮箱地址</a></li>
<li><a href="#删除全局配置的用户名和邮箱地址">删除全局配置的用户名和邮箱地址</a></li>
<li><a href="#对当前仓库配置用户名和邮箱地址">对当前仓库配置用户名和邮箱地址</a></li>
<li><a href="#查看全局配置的用户名和邮箱">查看全局配置的用户名和邮箱</a></li>
<li><a href="#查看当前仓库的用户名和邮箱">查看当前仓库的用户名和邮箱</a></li>
<li><a href="#生成-SSH-公钥">生成-SSH-公钥</a></li>
<li><a href="#关联远程仓库">关联远程仓库</a></li>
<li><a href="#把本地库的所有内容推送到远程库">把本地库的所有内容推送到远程库</a></li>
<li><a href="#从远程仓库克隆">从远程仓库克隆</a></li>
<li><a href="#将修改的文件提交到暂存区">将修改的文件提交到暂存区</a></li>
<li><a href="#将文件从暂存区提交到版本库">将文件从暂存区提交到版本库</a></li>
<li><a href="#修改-commit-的注释信息">修改-commit-的注释信息</a></li>
<li><a href="#查看当前提交状态">查看当前提交状态</a></li>
<li><a href="#查看文件具体变更内容">查看文件具体变更内容</a></li>
<li><a href="#查看提交的历史版本">查看提交的历史版本</a></li>
<li><a href="#查看操作命令历史记录">查看操作命令历史记录</a></li>
<li><a href="#版本回退">版本回退</a></li>
<li><a href="#撤销修改或提交">撤销修改或提交</a></li>
<li><a href="#删除文件">删除文件</a></li>
<li><a href="#分支操作">分支操作</a></li>
<li><a href="#对比两个分支差异">对比两个分支差异</a></li>
<li><a href="#保存工作现场">保存工作现场</a></li>
<li><a href="#查看已经保存工作现场">查看已经保存工作现场</a></li>
<li><a href="#恢复工作现场">恢复工作现场</a></li>
<li><a href="#获取远程仓库最新提交到本地">获取远程仓库最新提交到本地</a></li>
<li><a href="#打标签">打标签</a></li>
<li><a href="#查看所有标签">查看所有标签</a></li>
<li><a href="#补标签">补标签</a></li>
<li><a href="#查看标签信息">查看标签信息</a></li>
<li><a href="#删除标签">删除标签</a></li>
<li><a href="#将标签推送到远程">将标签推送到远程</a></li>
<li><a href="#清空缓存">清空缓存</a></li>
</ul>
<h2 id="初始化仓库"><a href="#初始化仓库" class="headerlink" title="初始化仓库"></a><a name="初始化仓库">初始化仓库</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git init</span><br></pre></td></tr></table></figure>

<h2 id="全局配置用户名和邮箱地址"><a href="#全局配置用户名和邮箱地址" class="headerlink" title="全局配置用户名和邮箱地址"></a><a name="全局配置用户名和邮箱地址">全局配置用户名和邮箱地址</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git config --global user.name &quot;Your Name&quot;</span><br><span class="line">$ git config --global user.email email@example.com</span><br></pre></td></tr></table></figure>

<p>注意：如果一台机器需要使用多个 ssh 公钥的方式，不应使用全局配置，而是每个仓库独立配置。否则提交时，远程仓库的 commit 记录会显示是全局用户做的提交操作。</p>
<h2 id="删除全局配置的用户名和邮箱地址"><a href="#删除全局配置的用户名和邮箱地址" class="headerlink" title="删除全局配置的用户名和邮箱地址"></a><a name="删除全局配置的用户名和邮箱地址">删除全局配置的用户名和邮箱地址</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git config --global --unset user.name</span><br><span class="line">$ git config --global --unset user.email</span><br></pre></td></tr></table></figure>

<h2 id="对当前仓库配置用户名和邮箱地址"><a href="#对当前仓库配置用户名和邮箱地址" class="headerlink" title="对当前仓库配置用户名和邮箱地址"></a><a name="对当前仓库配置用户名和邮箱地址">对当前仓库配置用户名和邮箱地址</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git config user.name &quot;Your Name&quot;</span><br><span class="line">$ git config user.email email@example.com</span><br></pre></td></tr></table></figure>

<h2 id="查看全局配置的用户名和邮箱"><a href="#查看全局配置的用户名和邮箱" class="headerlink" title="查看全局配置的用户名和邮箱"></a><a name="查看全局配置的用户名和邮箱">查看全局配置的用户名和邮箱</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git config --global user.name</span><br><span class="line">$ git config --global user.email</span><br></pre></td></tr></table></figure>

<h2 id="查看当前仓库的用户名和邮箱"><a href="#查看当前仓库的用户名和邮箱" class="headerlink" title="查看当前仓库的用户名和邮箱"></a><a name="查看当前仓库的用户名和邮箱">查看当前仓库的用户名和邮箱</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git config user.name</span><br><span class="line">$ git config user.email</span><br></pre></td></tr></table></figure>

<h2 id="生成-SSH-公钥"><a href="#生成-SSH-公钥" class="headerlink" title="生成-SSH-公钥"></a><a name="生成-SSH-公钥">生成-SSH-公钥</a></h2><p>1、为 <code>git@example.com</code> 用户生成 SSH 公钥 <code>id_rsa</code> 文件，并保存在默认目录 <code>~/.ssh</code> 下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ssh-keygen -t rsa -C &quot;git@example.com &quot; -f ~/.ssh/id_rsa</span><br></pre></td></tr></table></figure>

<p>2、测试 username （默认用户名为 git）的 SSH 链接是否正常</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ssh –T &lt;username&gt;</span><br></pre></td></tr></table></figure>

<h2 id="关联远程仓库"><a href="#关联远程仓库" class="headerlink" title="关联远程仓库"></a><a name="关联远程仓库">关联远程仓库</a></h2><p>添加名称为 origin 的关联信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git remote add origin git@github.com:username/name.git</span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git remote add origin https://github.com/username/name.git</span><br></pre></td></tr></table></figure>

<p>查看全部关联的详细信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git remote -v</span><br></pre></td></tr></table></figure>

<h2 id="把本地库的所有内容推送到远程库"><a href="#把本地库的所有内容推送到远程库" class="headerlink" title="把本地库的所有内容推送到远程库"></a><a name="把本地库的所有内容推送到远程库">把本地库的所有内容推送到远程库</a></h2><p>1、通常添加参数 <code>-u</code>，简化提交远程库流程。例如：把本地的 master 分支和远程的 master 分支关联：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git push -u origin master</span><br></pre></td></tr></table></figure>

<p>2、使用参数 -u 关联后，推送最新修改命令简化为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git push</span><br></pre></td></tr></table></figure>

<h2 id="从远程仓库克隆"><a href="#从远程仓库克隆" class="headerlink" title="从远程仓库克隆"></a><a name="从远程仓库克隆">从远程仓库克隆</a></h2><p>1、默认方式，克隆全部分支，并指定本地文件夹名称为 dirName</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git clone git@github.com:username/repositoryname.git dirName</span><br></pre></td></tr></table></figure>

<p>2、克隆指定分支</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git clone -b branchname https://github.com/username/repositoryname.git</span><br></pre></td></tr></table></figure>

<p>git 支持多种协议，包括 https，但通过 ssh 支持的原生 git 协议速度最快。</p>
<h2 id="将修改的文件提交到暂存区"><a href="#将修改的文件提交到暂存区" class="headerlink" title="将修改的文件提交到暂存区"></a><a name="将修改的文件提交到暂存区">将修改的文件提交到暂存区</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git add &lt;filename.xxx&gt; [-u][.][-A]</span><br></pre></td></tr></table></figure>

<p><code>-u</code> 参数：提交被修改（modified）和被删除（deleted）文件，不包括新文件（new）</p>
<p><code>.</code>参数：提交新文件（new）和被修改（modified）文件，不包括被删除（deleted）文件</p>
<p><code>-A</code>参数：提交所有变化，包括新文件（new）、被修改（modified）文件、被删除（deleted）文件</p>
<h2 id="将文件从暂存区提交到版本库"><a href="#将文件从暂存区提交到版本库" class="headerlink" title="将文件从暂存区提交到版本库"></a><a name="将文件从暂存区提交到版本库">将文件从暂存区提交到版本库</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git commit -m &quot;create new file&quot;</span><br></pre></td></tr></table></figure>

<h2 id="修改-commit-的注释信息"><a href="#修改-commit-的注释信息" class="headerlink" title="修改 commit 的注释信息"></a><a name="修改 commit 的注释信息">修改 commit 的注释信息</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git commit --amend</span><br></pre></td></tr></table></figure>

<h2 id="查看当前提交状态"><a href="#查看当前提交状态" class="headerlink" title="查看当前提交状态"></a><a name="查看当前提交状态">查看当前提交状态</a></h2><p>可以查看是否存在变更，但不能查看具体变更了什么内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git status</span><br></pre></td></tr></table></figure>

<h2 id="查看文件具体变更内容"><a href="#查看文件具体变更内容" class="headerlink" title="查看文件具体变更内容"></a><a name="查看文件具体变更内容">查看文件具体变更内容</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git diff &lt;fileName.xxx&gt;</span><br></pre></td></tr></table></figure>

<h2 id="查看提交的历史版本"><a href="#查看提交的历史版本" class="headerlink" title="查看提交的历史版本"></a><a name="查看提交的历史版本">查看提交的历史版本</a></h2><p>默认情况下显示的信息冗长，使用时通常 <code>--pretty=oneline</code> 参数。例子：仅显示提交的最近 3 条提交历史版本号，只能显示 head 指向的当前版本和之前的版本信息</p>
<p>1、本地仓库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git log --pretty=oneline -3</span><br><span class="line">或</span><br><span class="line">$ git log --oneline -3</span><br></pre></td></tr></table></figure>

<p>2、远程仓库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git log origin/master --pretty=oneline -3</span><br><span class="line">或</span><br><span class="line">$ git log origin/master --oneline -3</span><br></pre></td></tr></table></figure>

<h2 id="查看操作命令历史记录"><a href="#查看操作命令历史记录" class="headerlink" title="查看操作命令历史记录"></a><a name="查看操作命令历史记录">查看操作命令历史记录</a></h2><p>使用该命令可以某版本在执行回退后再次返回某版本，前提是不退出当前命令行窗口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git reflog</span><br></pre></td></tr></table></figure>

<h2 id="版本回退"><a href="#版本回退" class="headerlink" title="版本回退"></a><a name="版本回退">版本回退</a></h2><p>1、回退到上一个版本：<code>$ git reset --hard HEAD^</code></p>
<p>2、回退到上上一个版本：<code>$ git reset --hard HEAD^^</code></p>
<p>3、回退到上 50 个版本：<code>$ git reset --hard HEAD~50</code></p>
<p>4、根据版本号回退，版本号不必输入完全，可区别即可：<code>$ git reset --hard &lt;versionCode&gt;</code></p>
<h2 id="撤销修改或提交"><a href="#撤销修改或提交" class="headerlink" title="撤销修改或提交"></a><a name="撤销修改或提交">撤销修改或提交</a></h2><p>1、修改后还没有被放到暂存区</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git checkout -- &lt;fileName.xxx&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2、修改后已经放到暂存区</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git reset HEAD &lt;fileName.xxx&gt;</span><br></pre></td></tr></table></figure>

<p>3、修改后已经提交到版本库。此时，使用版本回退，回退到指定版本</p>
<h2 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a><a name="删除文件">删除文件</a></h2><p>1、从暂存区删除文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git rm &lt;fileName.xxx&gt;</span><br></pre></td></tr></table></figure>

<p>2、从暂存区恢复文件，只能恢复文件到最新版本，并丢失最近一次提交后修改的内容。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git checkout -- &lt;fileName.xxx&gt;</span><br></pre></td></tr></table></figure>

<h2 id="分支操作"><a href="#分支操作" class="headerlink" title="分支操作"></a><a name="分支操作">分支操作</a></h2><p>1、本地分支</p>
<ul>
<li>创建本地分支：<code>$ git branch feature-local</code></li>
<li>切换到本地分支：<code>$ git checkout feature-local</code></li>
<li>创建并同时切换到本地分支：<code>$ git checkout –b feature-local</code></li>
</ul>
<p>2、远程分支</p>
<ul>
<li>在远程开好分支 feature-branch，本地获取：<code>$ git checkout -b feature-local origin/feature-branch</code></li>
<li>本地创建名为 dev 的远程分支：<code>$ git checkout -b dev origin/dev</code></li>
<li>指定推送本地的 feature-local 分支到远程 origin 的 feature-branch 分支，若远程不存在该分支则新建：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$  git push origin feature-local:feature-branch</span><br></pre></td></tr></table></figure>

<p>3、查看所有分支（本地分支和远程分支）:<code>$ git branch -a</code></p>
<p>4、合并分支</p>
<p>要合并 dev 分支到 master 主分支。先切换到 master 分支后，执行命令：<code>$ git merge dev</code></p>
<p>注：通常合并分支时 git 会用 Fast forward 模式，但这种模式下，删除分支后，会丢掉分支信息。如果要强制禁用 Fast forward 模式，git 就会在 merge 时生成一个新的 commit，这样，从分支历史上就可以看出分支信息：<code>$ git merge --no-ff -m &quot;merge with no-ff&quot; dev</code></p>
<p>5、查看分支历史：<code>$ git log --graph --pretty=oneline --abbrev-commit</code>，若内容过多，可仅显示前 10 条：<code>$ git log --oneline -10</code></p>
<p>6、删除分支</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git branch -d &lt;branchName&gt;</span><br></pre></td></tr></table></figure>

<p>如果分支还没有合并，使用上条命令会出现提示阻止删除，此时需要强行删除</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git branch -D &lt;branchName&gt;</span><br></pre></td></tr></table></figure>

<p>7、合并远程分支到本地</p>
<ul>
<li>在本地新建一个 temp 分支，并将远程 origin 仓库的 master 分支代码下载到本地 temp 分支：<code>git fetch origin master:tmp</code></li>
<li>比较本地代码与刚刚从远程下载下来的代码的区别：<code>git diff tmp</code></li>
<li>合并 temp 分支到本地的 master 分支：<code>git merge tmp</code></li>
<li>如果不想保留 temp 分支 可以用这步删除：<code>git branch -d temp</code></li>
</ul>
<p>注意：若提交历史不同，无法合并，参见「合并两个不同提交历史的分支」。</p>
<p>8、合并两个不同提交历史的分支</p>
<ul>
<li>将远程仓库的更新获取到本地分支 temp：<code>git fetch origin master:temp</code></li>
<li>此时若直接合并，因为提交历史不同，出现 fatal: refusing to merge unrelated histories 错误，需要增加参数，强制合并即可。：<code>git merge temp --allow-unrelated-histories</code></li>
</ul>
<p>9、切换分支时出现 “error: The following untracked working tree files……”</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">error: The following untracked working tree files would be overwritten by checkout:</span><br><span class="line">        ……（涉及的文件列表）</span><br><span class="line">Please move or remove them before you switch branches.</span><br><span class="line">Aborting</span><br></pre></td></tr></table></figure>

<p>解决方式：删除上述涉及的文件即可。执行如下命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clean -d -fx</span><br></pre></td></tr></table></figure>

<p>git clean 参数</p>
<ul>
<li>-n 显示将要删除的文件和目录；</li>
<li>-x 删除忽略文件已经对 git 来说不识别的文件</li>
<li>-d 删除未被添加到 git 的路径中的文件</li>
<li>-f 强制运行</li>
</ul>
<h2 id="对比两个分支差异"><a href="#对比两个分支差异" class="headerlink" title="对比两个分支差异"></a><a name="对比两个分支差异">对比两个分支差异</a></h2><p>有 2 个分支：master、dev。</p>
<p>1、查看 dev 有，而 master 中没有的：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git log dev ^master</span><br></pre></td></tr></table></figure>

<p>2、查看 dev 中比 master 中多提交了哪些内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git log master..dev</span><br></pre></td></tr></table></figure>

<p>3、只比较两个分支有什么不一样：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git log dev...master</span><br></pre></td></tr></table></figure>

<p>在上述情况下，再显示出每个提交是在哪个分支上：<code>git log --left-right dev...master</code></p>
<p>根据 <code>–left-right dev…master</code> 的顺序，左箭头 &lt; 表示是 dev 分支提交；右箭头 &gt; 表示 master 分支提交</p>
<h2 id="保存工作现场"><a href="#保存工作现场" class="headerlink" title="保存工作现场"></a><a name="保存工作现场">保存工作现场</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git stash</span><br></pre></td></tr></table></figure>

<p>注意：要提交到暂存区才可以执行 stash，可以执行多次 stash</p>
<h2 id="查看已经保存工作现场"><a href="#查看已经保存工作现场" class="headerlink" title="查看已经保存工作现场"></a><a name="查看已经保存工作现场">查看已经保存工作现场</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git stash list</span><br></pre></td></tr></table></figure>

<h2 id="恢复工作现场"><a href="#恢复工作现场" class="headerlink" title="恢复工作现场"></a><a name="恢复工作现场">恢复工作现场</a></h2><ul>
<li><p>使用 git stash apply 恢复：<code>$ git stash apply stash@&#123;0&#125;</code>，但这种方式恢复后 stash 内容并不删除，需要用 git stash drop 来删除：<code>$ git stash drop stash@&#123;0&#125;</code></p>
</li>
<li><p>另一种方式是用 git stash pop，恢复的同时把 stash 内容也删了：<code>$ git stash pop stash@&#123;0&#125;</code></p>
</li>
</ul>
<h2 id="获取远程仓库最新提交到本地"><a href="#获取远程仓库最新提交到本地" class="headerlink" title="获取远程仓库最新提交到本地"></a><a name="获取远程仓库最新提交到本地">获取远程仓库最新提交到本地</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git pull</span><br></pre></td></tr></table></figure>

<p>如果 git pull 提示 no tracking information，则说明本地分支和远程分支的链接关系没有创建，执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git branch --set-upstream-to &lt;branch-name&gt; origin/&lt;branch-name&gt;</span><br></pre></td></tr></table></figure>

<p>抓取远程分支最新提交到本地分支</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git pull origin 远端分支名:本地分支名</span><br></pre></td></tr></table></figure>

<h2 id="打标签"><a href="#打标签" class="headerlink" title="打标签"></a><a name="打标签">打标签</a></h2><p>切换到需要打标签的分支上执行命令：<code>$ git tag v1.0</code></p>
<h2 id="查看所有标签"><a href="#查看所有标签" class="headerlink" title="查看所有标签"></a><a name="查看所有标签">查看所有标签</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git tag</span><br></pre></td></tr></table></figure>

<h2 id="补标签"><a href="#补标签" class="headerlink" title="补标签"></a><a name="补标签">补标签</a></h2><p>查看历史提交，找到需要补标签的提交的 id，执行命令：<code>$ git tag v0.9 &lt;commitId&gt;</code>，也可以为标签添加说明，用 -a 指定标签名，-m 指定说明文字：<code>$ git tag -a v0.1 -m &quot;version 0.1&quot; &lt;commitId&gt;</code></p>
<p>注：标签不是按时间顺序列出，而是按字母排序的</p>
<h2 id="查看标签信息"><a href="#查看标签信息" class="headerlink" title="查看标签信息"></a><a name="查看标签信息">查看标签信息</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git show &lt;tagName&gt;</span><br></pre></td></tr></table></figure>

<h2 id="删除标签"><a href="#删除标签" class="headerlink" title="删除标签"></a><a name="删除标签">删除标签</a></h2><ul>
<li>删除本地标签</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git tag -d v0.1</span><br></pre></td></tr></table></figure>

<ul>
<li>删除远程标签，要先删除本地标签，再 push</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git tag -d v0.9</span><br><span class="line">$ git push origin :refs/tags/v0.9</span><br></pre></td></tr></table></figure>

<h2 id="将标签推送到远程"><a href="#将标签推送到远程" class="headerlink" title="将标签推送到远程"></a><a name="将标签推送到远程">将标签推送到远程</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git push origin v1.0</span><br></pre></td></tr></table></figure>

<p>一次性推送全部尚未推送到远程的本地标签：<code>$ git push origin –-tags</code></p>
<h2 id="清空缓存"><a href="#清空缓存" class="headerlink" title="清空缓存"></a><a name="清空缓存">清空缓存</a></h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git rm -r --cached .</span><br></pre></td></tr></table></figure>

<p>例如，当 ignore 文件更新时，如果不清空缓存，则不生效。</p>
<h2 id="命令行创建空白-gitignore-文件"><a href="#命令行创建空白-gitignore-文件" class="headerlink" title="命令行创建空白 .gitignore 文件"></a><a name="命令行创建空白 .gitignore 文件">命令行创建空白 .gitignore 文件</a></h2><p>进入库目录，命令行执行 <code>touch .gitignore</code> 即可。</p>
]]></content>
      <categories>
        <category>通用技术</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>git-问题备忘</title>
    <url>/5886d180-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="git-删除远程仓库文件"><a href="#git-删除远程仓库文件" class="headerlink" title="git 删除远程仓库文件"></a>git 删除远程仓库文件</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>git 提交到远程仓库后发现有遗漏的文件未添加到 <code>.ignore</code> 文件中</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>例如不需要提交 target 目录，可执行 <code>git rm -r --cached target</code>，重新 commit 和 push 即可</p>
<p>说明：</p>
<ul>
<li><p>删除工作区文件，并且将这次删除放入暂存区，<code>git rm [file1] [file2] ...</code></p>
</li>
<li><p>停止追踪指定文件，但该文件会保留在工作区，<code>git rm --cached [file]</code></p>
</li>
</ul>
<h2 id="git-提交时出现警告-LF-will-be-replaced-by-CRLF-in"><a href="#git-提交时出现警告-LF-will-be-replaced-by-CRLF-in" class="headerlink" title="git 提交时出现警告 LF-will-be-replaced-by-CRLF-in"></a>git 提交时出现警告 LF-will-be-replaced-by-CRLF-in</h2><h3 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h3><p>提交时出现警告：<code>warning: LF will be replaced by CRLF </code>，但是不影响提交。</p>
<h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><ul>
<li>配置选项修改，把 core.autocrlf 设置成 false。其他选项如下：<ul>
<li>git config –global core.autocrlf true #默认值</li>
<li>git config –global core.autocrlf input #从库中迁出代码不转换</li>
<li>git config –global core.autocrlf false  #不转换</li>
</ul>
</li>
</ul>
<h2 id="git-提交时中文文件名显示的解决方案"><a href="#git-提交时中文文件名显示的解决方案" class="headerlink" title="git 提交时中文文件名显示的解决方案"></a>git 提交时中文文件名显示的解决方案</h2><h3 id="问题描述-2"><a href="#问题描述-2" class="headerlink" title="问题描述"></a>问题描述</h3><p>git 提交时中文显示为乱码，有碍观瞻</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">117 files changed, 11670 insertions(+), 5 deletions(-)</span><br><span class="line"> create mode 100644 &quot;content/Excel/SUMIFS \345\207\275\346\225\260.md&quot;</span><br><span class="line"> create mode 100644 &quot;content/Excel/VBA \344\275\277\347\224\250 ReDim \345\256\236\347\216\260\344\272\214\347\273\264\345\212\250\346\200\201\346\225\260\347\273\204.md&quot;</span><br><span class="line"> create mode 100644 &quot;content/Excel/VBA \345\210\240\351\231\244\346\211\200\346\234\211\345\267\245\344\275\234\350\241\250\347\232\204\347\251\272\350\241\214.md&quot;</span><br></pre></td></tr></table></figure>

<h3 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h3><p>执行 <code>git config --global core.quotepath false</code> 即可，上述提交的文件名已经可以辨认</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">117 files changed, 11670 insertions(+), 5 deletions(-)</span><br><span class="line"> create mode 100644 content/Excel/SUMIFS 函数.md</span><br><span class="line"> create mode 100644 content/Excel/VBA 使用 ReDim 实现二维动态数组.md</span><br><span class="line"> create mode 100644 content/Excel/VBA 删除所有工作表的空行.md</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>通用技术</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>gitignore-文件通用参考版本</title>
    <url>/5886d181-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h2><ul>
<li><code>/mtk/</code>，过滤整个文件夹</li>
<li><code>*.zip</code>，过滤所有.zip 文件</li>
<li><code>/mtk/do.c</code>，过滤某个具体文件</li>
</ul>
<h2 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h2><p>只需要管理 <code>/mtk/</code> 目录中的 one.txt 文件，这个目录中的其他文件都不需要管理：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/mtk/</span><br><span class="line">!/mtk/one.txt</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：</p>
</blockquote>
<ol>
<li>git 对于 .ignore 配置文件是按行从上到下进行规则匹配的，如果前面的规则匹配的范围更大，则后面的规则将不会生效。</li>
<li>如果在创建 .gitignore 文件之前 push，即使在 .gitignore 文件中写入新的过滤规则，这些规则也不会起作用，Git 仍然会对所有文件进行版本管理。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># See https://help.github.com/articles/ignoring-files/ for more about ignoring files.</span><br><span class="line"></span><br><span class="line">.gradle</span><br><span class="line">!gradle/wrapper/gradle-wrapper.jar</span><br><span class="line">!**/src/main/**/build/</span><br><span class="line">!**/src/test/**/build/</span><br><span class="line">HELP.md</span><br><span class="line"></span><br><span class="line"># STS</span><br><span class="line">.apt_generated</span><br><span class="line">.classpath</span><br><span class="line">.factorypath</span><br><span class="line">.project</span><br><span class="line">.settings</span><br><span class="line">.springBeans</span><br><span class="line">.sts4-cache</span><br><span class="line"></span><br><span class="line"># IntelliJ IDEA</span><br><span class="line">.idea</span><br><span class="line">*.iws</span><br><span class="line">*.iml</span><br><span class="line">*.ipr</span><br><span class="line">out/</span><br><span class="line">!**/src/main/**/out/</span><br><span class="line">!**/src/test/**/out/</span><br><span class="line"></span><br><span class="line"># NetBeans</span><br><span class="line">/nbproject/private/</span><br><span class="line">/nbbuild/</span><br><span class="line">/dist/</span><br><span class="line">/nbdist/</span><br><span class="line">/.nb-gradle/</span><br><span class="line"></span><br><span class="line"># VS Code</span><br><span class="line">.vscode/</span><br><span class="line"></span><br><span class="line"># dependencies</span><br><span class="line">/node_modules</span><br><span class="line">/.pnp</span><br><span class="line">.pnp.js</span><br><span class="line"></span><br><span class="line"># testing</span><br><span class="line">/coverage</span><br><span class="line"></span><br><span class="line"># production</span><br><span class="line">/build</span><br><span class="line"></span><br><span class="line"># misc</span><br><span class="line">.DS_Store</span><br><span class="line">.env.local</span><br><span class="line">.env.development.local</span><br><span class="line">.env.test.local</span><br><span class="line">.env.production.local</span><br><span class="line"></span><br><span class="line">npm-debug.log*</span><br><span class="line">yarn-debug.log*</span><br><span class="line">yarn-error.log*</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>通用技术</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>gradle-问题备忘</title>
    <url>/58860e32-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h2><ol>
<li>下载</li>
<li>解压</li>
<li>配置系统变量 <code>%GRADLE_HOME%</code> 指向解压路径，配置 path 变量，添加 <code>%GRADLE_HOME%\bin</code>。</li>
<li>测试，输入命令 <code>gradle -v</code> 提示版本说明配置成功。</li>
</ol>
<blockquote>
<p>环境变量也可以不配置，在 IDE 中（如 Idea）指定路径即可。</p>
</blockquote>
<h2 id="二、异常及报错的解决方案汇总"><a href="#二、异常及报错的解决方案汇总" class="headerlink" title="二、异常及报错的解决方案汇总"></a>二、异常及报错的解决方案汇总</h2><h3 id="⭐-本地仓库配置参考"><a href="#⭐-本地仓库配置参考" class="headerlink" title="⭐ 本地仓库配置参考"></a>⭐ 本地仓库配置参考</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">    mavenLocal()</span><br><span class="line">    maven &#123; url &quot;http://maven.aliyun.com/nexus/content/groups/public/&quot; &#125;</span><br><span class="line">    mavenCentral()</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="⭐-指定编译版本"><a href="#⭐-指定编译版本" class="headerlink" title="⭐ 指定编译版本"></a>⭐ 指定编译版本</h3><p>可选，在 Idea 中可独立配置。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sourceCompatibility = 1.8</span><br><span class="line">targetCompatibility = 1.8</span><br></pre></td></tr></table></figure>

<h3 id="⭐-显示指定依赖版本"><a href="#⭐-显示指定依赖版本" class="headerlink" title="⭐ 显示指定依赖版本"></a>⭐ 显示指定依赖版本</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">configurations.all &#123;</span><br><span class="line">    resolutionStrategy &#123;</span><br><span class="line">        force &#x27;org.apache.tomcat.embed:tomcat-embed-core:8.5.39&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="⭐-如果使用了中文注释，编译时报错"><a href="#⭐-如果使用了中文注释，编译时报错" class="headerlink" title="⭐ 如果使用了中文注释，编译时报错"></a>⭐ 如果使用了中文注释，编译时报错</h3><p>添加 withType，编译时用 UTF-8 处理。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tasks.withType(JavaCompile) &#123;</span><br><span class="line">    options.encoding = &quot;UTF-8&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Gradle-强制刷新依赖"><a href="#Gradle-强制刷新依赖" class="headerlink" title="Gradle 强制刷新依赖"></a>Gradle 强制刷新依赖</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>旧项目更换环境时由于 gradle 版本不一致导致项目初始化失败。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>强制刷新依赖，步骤如下：</p>
<p>1、删除 <code>.gradle</code> 目录，其中包含了旧版本的文件。</p>
<p>2、修改 <code>gradle-wrapper.properties</code> 文件的版本号，内容如下。例如旧环境使用 6.0.1，新环境使用 6.7.1</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">distributionBase=<span class="variable constant_">GRADLE_USER_HOME</span></span><br><span class="line">distributionPath=wrapper/dists</span><br><span class="line">distributionUrl=https\:<span class="comment">//services.gradle.org/distributions/gradle-6.7.1-bin.zip</span></span><br><span class="line">zipStoreBase=<span class="variable constant_">GRADLE_USER_HOME</span></span><br><span class="line">zipStorePath=wrapper/dists</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：仅修改版本即可，其他内容不变。</p>
</blockquote>
<p>3、项目目录下执行如下命令</p>
<ul>
<li><p>macOS：<code>./gradlew build --refresh-dependencies</code></p>
</li>
<li><p>windows：<code>gradlew build --refresh-dependencies</code></p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$ ./gradlew build --refresh-dependencies</span><br><span class="line"></span><br><span class="line"><span class="title class_">Welcome</span> to <span class="title class_">Gradle</span> <span class="number">6.7</span><span class="number">.1</span>!</span><br><span class="line"></span><br><span class="line"><span class="title class_">Here</span> are the highlights <span class="keyword">of</span> <span class="variable language_">this</span> <span class="attr">release</span>:</span><br><span class="line"> - <span class="title class_">File</span> system watching is ready <span class="keyword">for</span> production use</span><br><span class="line"> - <span class="title class_">Declare</span> the version <span class="keyword">of</span> <span class="title class_">Java</span> your build requires</span><br><span class="line"> - <span class="title class_">Java</span> <span class="number">15</span> support</span><br><span class="line"></span><br><span class="line"><span class="title class_">For</span> more details see <span class="attr">https</span>:<span class="comment">//docs.gradle.org/6.7.1/release-notes.html</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="title class_">Task</span> :test</span><br><span class="line"><span class="number">2021</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">04</span>:<span class="number">03</span>:<span class="number">10.262</span>  <span class="variable constant_">INFO</span> <span class="number">633</span> --- [extShutdownHook] org.<span class="property">quartz</span>.<span class="property">core</span>.<span class="property">QuartzScheduler</span>          : <span class="title class_">Scheduler</span> quartzScheduler_$_NON_CLUSTERED paused.</span><br><span class="line"><span class="number">2021</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">04</span>:<span class="number">03</span>:<span class="number">10.263</span>  <span class="variable constant_">INFO</span> <span class="number">633</span> --- [extShutdownHook] o.<span class="property">s</span>.<span class="property">s</span>.<span class="property">quartz</span>.<span class="property">SchedulerFactoryBean</span>        : <span class="title class_">Shutting</span> down <span class="title class_">Quartz</span> <span class="title class_">Scheduler</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">04</span>:<span class="number">03</span>:<span class="number">10.263</span>  <span class="variable constant_">INFO</span> <span class="number">633</span> --- [extShutdownHook] org.<span class="property">quartz</span>.<span class="property">core</span>.<span class="property">QuartzScheduler</span>          : <span class="title class_">Scheduler</span> quartzScheduler_$_NON_CLUSTERED shutting down.</span><br><span class="line"><span class="number">2021</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">04</span>:<span class="number">03</span>:<span class="number">10.263</span>  <span class="variable constant_">INFO</span> <span class="number">633</span> --- [extShutdownHook] org.<span class="property">quartz</span>.<span class="property">core</span>.<span class="property">QuartzScheduler</span>          : <span class="title class_">Scheduler</span> quartzScheduler_$_NON_CLUSTERED paused.</span><br><span class="line"><span class="number">2021</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">04</span>:<span class="number">03</span>:<span class="number">10.263</span>  <span class="variable constant_">INFO</span> <span class="number">633</span> --- [extShutdownHook] org.<span class="property">quartz</span>.<span class="property">core</span>.<span class="property">QuartzScheduler</span>          : <span class="title class_">Scheduler</span> quartzScheduler_$_NON_CLUSTERED shutdown complete.</span><br><span class="line"><span class="number">2021</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">04</span>:<span class="number">03</span>:<span class="number">10.264</span>  <span class="variable constant_">INFO</span> <span class="number">633</span> --- [extShutdownHook] o.<span class="property">s</span>.<span class="property">s</span>.<span class="property">concurrent</span>.<span class="property">ThreadPoolTaskExecutor</span>  : <span class="title class_">Shutting</span> down <span class="title class_">ExecutorService</span> <span class="string">&#x27;applicationTaskExecutor&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable constant_">BUILD</span> <span class="variable constant_">SUCCESSFUL</span> <span class="keyword">in</span> 1m 18s</span><br><span class="line"><span class="number">6</span> actionable <span class="attr">tasks</span>: <span class="number">6</span> executed</span><br></pre></td></tr></table></figure>

<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><p><code>gradlew -? 或 -h 或 --help</code>，显示帮助信息，即会打印可选参数及参数说明信息；</p>
<p><code>gradlew --version</code>，版本号（会打印工程用的 Gradle 的版本号、Kotlin、Groovy、Ant、JVM、OS 等的版本号）；</p>
<p><code>gradlew tasks --all</code>，查看所有任务，包括缓存任务等；</p>
<p><code>gradlew clean</code>，清除工程目录下的 build 文件夹；</p>
<p><code>gradlew build</code>， 检查依赖并编译打包，debug、release 环境的包都会打出来；</p>
<p><code>gradlew assemble**_</code>，编译指定的包，如 Debug 包（gradlew assembleDebug）、Release 包（gradlew assembleRelease）、渠道包（gradlew assembleOemRelease&#x2F;assembleOemDebug）、定制的版本等等；</p>
<p><code>gradlew install_**</code>，编译并安装指定的包，如 Debug 包（gradlew installDebug）、Release 包（gradlew installOemRelease&#x2F;installOemDebug）、定制的版本等等；</p>
<p><code>gradlew uninstall\*\*</code>，卸载已安装的指定模式的包，如 Debug 包（gradlew uninstallDebug）、Release 包（gradlew uninstallRelease）、渠道包（gradlew uninstallOemRelease&#x2F;uninstallOemDebug）、定制的版本等等；</p>
<p><code>gradlew :模块名称:dependencies</code>，查看包依赖关系，如 <code>gradlew :app:dependencies</code>；</p>
<p><code>gradlew build -i 或 --info -d 或 --debug -s 或 --stacktrace</code>，编译（build）并打印 debug 模式和 info 等级的日志及所用异常的堆栈信息（–stacktrace）；</p>
<p><code>gradlew --refresh-dependencies</code>，强制刷新依赖，即检查依赖是否有更新比如动态版本、SHA1 进行本地 cache 和远程仓库散列码的对比等，有更新则下载更新进行构建；使用这种方式可以避免手动删除 cache；</p>
<p><code>gradlew clean build --refresh-dependencies</code>，组合指令，清除构建（gradlew clean）并重新构建（gradlew build），同时强制刷新依赖（gradlew –refresh-dependencies）；</p>
<p><code>gradlew --offline</code>，离线模式，即让 Gradle 只使用本地 cache 里的依赖，如果 cache 中没有也不会更新依赖，而是提示编译失败；</p>
<p><code>--info</code>，打印堆栈信息；</p>
<p><code>gradlew --daemon</code>，守护进程，使用 Gradle 的守护进程构建，能够提高构建效率，如果守护进程没启动或现有的都处于忙碌状态，就启动一个守护进程；</p>
<p><code>gradlew --no-daemon</code>，如果你已经配置为使用守护进程构建，可以使用该选项本次不用守护进程构建；</p>
<p><code>gradlew --continuous</code>，连续构建，即任务队列中即使某个任务失败，不会终止执行，而是会继续执行下一个任务；</p>
<p><code>gradlew --parallel --parallel-threads=N</code>，并行编译；</p>
<p><code>gradlew --configure-on-demand</code>，按需编译。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>gradlew 的指令有简写的方式：</p>
<p><code>gradlew --versio n</code> 可以用简写方式 <code>gradlew -v 代替</code></p>
<p><code>gradlew --hel p</code> 可以用简写方式 <code>gradlew - h</code> 或 <code>gradlew -?</code> 代替</p>
<p><code>gradlew --no-rebuil d</code> 可以用简写方式 <code>gradlew - a</code> 代替</p>
<p><code>gradlew --debu g</code> 可以用简写方式 <code>gradlew - d</code> 代替</p>
<p><code>gradlew --stacktrac e</code> 可以用简写方式 <code>gradlew -s</code> 代替</p>
<p>可以发现简写的指令只需要一个减号（<code>-</code>）开头，没有简写的指令需要用两个减号（即 <code>--</code>）开头。</p>
]]></content>
      <categories>
        <category>通用技术</category>
      </categories>
      <tags>
        <tag>gradle</tag>
      </tags>
  </entry>
  <entry>
    <title>使用-orphan-参数创建独立空白分支</title>
    <url>/58865c50-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<p>创建一个文件夹 testbranch，添加一个文件 main.txt。执行 <code>git init</code> 初始化，执行提交。此时 master 分支有了第一个提交记录：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="attr">macName</span>:testbranch userName$ git init</span><br><span class="line">已初始化空的 <span class="title class_">Git</span> 仓库于 /<span class="title class_">Users</span>/userName/<span class="title class_">Desktop</span>/testbranch/.<span class="property">git</span>/</span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git status</span><br><span class="line">位于分支 master</span><br><span class="line"></span><br><span class="line">尚无提交</span><br><span class="line"></span><br><span class="line">未跟踪的文件:</span><br><span class="line">  （使用 <span class="string">&quot;git add &lt;文件&gt;...&quot;</span> 以包含要提交的内容）</span><br><span class="line">	main.<span class="property">txt</span></span><br><span class="line"></span><br><span class="line">提交为空，但是存在尚未跟踪的文件（使用 <span class="string">&quot;git add&quot;</span> 建立跟踪）</span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git add .</span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git commit -m <span class="string">&quot;init&quot;</span></span><br><span class="line">[master（根提交） cd00bbe] init</span><br><span class="line"> <span class="number">1</span> file changed, <span class="number">0</span> <span class="title function_">insertions</span>(+), <span class="number">0</span> <span class="title function_">deletions</span>(-)</span><br><span class="line"> create mode <span class="number">100644</span> main.<span class="property">txt</span></span><br></pre></td></tr></table></figure>

<p>随意修改一下文件内容，再作一次提交。此时查看 master 的提交状态，可以看到有两次提交：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="attr">macName</span>:testbranch userName$ git add .</span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git commit -m <span class="string">&quot;again&quot;</span></span><br><span class="line">[master 9d01aa3] again</span><br><span class="line"> <span class="number">1</span> file changed, <span class="number">1</span> <span class="title function_">insertion</span>(+)</span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git log --pretty=oneline -<span class="number">3</span></span><br><span class="line">9d01aa3ed29dc9caa1b67175e1e2c7ce4db21712 (<span class="variable constant_">HEAD</span> -&gt; master) again</span><br><span class="line">cd00bbe75405be350fd7c4cc06d4b304ababe8c5 init</span><br></pre></td></tr></table></figure>

<p>此时新建一个分支，other-normal。使用 <code>git branch -a</code> 后可立刻看到新建的分支。再查看提交，发现与 master 是一致的：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="attr">macName</span>:testbranch userName$ git checkout -b other-normal</span><br><span class="line">切换到一个新分支 <span class="string">&#x27;other-normal&#x27;</span></span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git branch -a</span><br><span class="line">  master</span><br><span class="line">* other-normal</span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git log --pretty=oneline -<span class="number">3</span></span><br><span class="line">9d01aa3ed29dc9caa1b67175e1e2c7ce4db21712 (<span class="variable constant_">HEAD</span> -&gt; other-normal, master) again</span><br><span class="line">cd00bbe75405be350fd7c4cc06d4b304ababe8c5 init</span><br></pre></td></tr></table></figure>

<p>返回 master，使用 <code>git checkout --orphan other-orphan</code> 新建并切换到分支 other-orphan。再次使用 <code>git branch -a</code>，发现不能看到新建的分支。使用 <code>git log</code> 查看提交情况，发现当前确实在 other-orphan 分支上。</p>
<blockquote>
<p>注意：使用 –orphan 参数建立的分支必须要有提交后，才真正创建。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="attr">macName</span>:testbranch userName$ git checkout master</span><br><span class="line">切换到分支 <span class="string">&#x27;master&#x27;</span></span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git checkout --orphan other-orphan</span><br><span class="line">切换到一个新分支 <span class="string">&#x27;other-orphan&#x27;</span></span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git branch -a</span><br><span class="line">  master</span><br><span class="line">  other-normal</span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git log</span><br><span class="line"><span class="attr">fatal</span>: 您的当前分支 <span class="string">&#x27;other-orphan&#x27;</span> 尚无任何提交</span><br></pre></td></tr></table></figure>

<p>将 other-orphan 分支的 main.txt 文件改名为 orphan.txt 并提交，再次查看全部分支，已经可以看到 other-orphan，而且提交情况也是独立的，与 master 分支无关。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="attr">macName</span>:testbranch userName$ git status</span><br><span class="line">位于分支 other-orphan</span><br><span class="line"></span><br><span class="line">尚无提交</span><br><span class="line"></span><br><span class="line">要提交的变更：</span><br><span class="line">  （使用 <span class="string">&quot;git rm --cached &lt;文件&gt;...&quot;</span> 以取消暂存）</span><br><span class="line">	新文件：   main.<span class="property">txt</span></span><br><span class="line"></span><br><span class="line">尚未暂存以备提交的变更：</span><br><span class="line">  （使用 <span class="string">&quot;git add/rm &lt;文件&gt;...&quot;</span> 更新要提交的内容）</span><br><span class="line">  （使用 <span class="string">&quot;git restore &lt;文件&gt;...&quot;</span> 丢弃工作区的改动）</span><br><span class="line">	删除：     main.<span class="property">txt</span></span><br><span class="line"></span><br><span class="line">未跟踪的文件:</span><br><span class="line">  （使用 <span class="string">&quot;git add &lt;文件&gt;...&quot;</span> 以包含要提交的内容）</span><br><span class="line">	orphan.<span class="property">txt</span></span><br><span class="line"></span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git add .</span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git commit -m <span class="string">&quot;orphan init&quot;</span></span><br><span class="line">[other-orphan（根提交） c2533ce] orphan init</span><br><span class="line"> <span class="number">1</span> file changed, <span class="number">1</span> <span class="title function_">insertion</span>(+)</span><br><span class="line"> create mode <span class="number">100644</span> orphan.<span class="property">txt</span></span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git branch -a</span><br><span class="line">  master</span><br><span class="line">  other-normal</span><br><span class="line">* other-orphan</span><br><span class="line"><span class="attr">macName</span>:testbranch userName$ git log --pretty=oneline -<span class="number">3</span></span><br><span class="line">c2533cec5738396e99510ff8566f002547e5e000 (<span class="variable constant_">HEAD</span> -&gt; other-orphan) orphan init</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>通用技术</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>使用-push-提交到远程仓库出现-The-requested-URL-returned-error-403-错误</title>
    <url>/58865c51-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>曾用过一个 github 账号进行项目提交，现在使用另一个帐号在同一台机器进行提交时出现错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">remote: Permission to userName/repositorieName.git denied to OldUserName.</span><br><span class="line">fatal: unable to access &#x27;https://github.com/userName/repositorieName.git/&#x27;: The requested URL returned error: 403</span><br></pre></td></tr></table></figure>

<h2 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h2><p>使用第一个账号提交时，系统保存了该账号的用户信息。在使用新帐号提交时，与已保存的用户信息不一致，所以报错。</p>
<h2 id="win10-解决方案"><a href="#win10-解决方案" class="headerlink" title="win10 解决方案"></a>win10 解决方案</h2><ul>
<li>打开 cmd，输入命令：<code>rundll32.exe keymgr.dll,KRShowKeyMgr</code>，出现「存储的用户名和密码」窗口；</li>
<li>将 github 相关的条目删除；</li>
<li>重新执行提交命令，按提示输入账户名及密码后，即可提交成功。</li>
</ul>
<h2 id="macOS-解决方案"><a href="#macOS-解决方案" class="headerlink" title="macOS 解决方案"></a>macOS 解决方案</h2><ul>
<li>进入<code>钥匙串</code>，在「登录」下找到「github.com」条目并删除；</li>
<li>重新执行提交命令，按提示输入账户名及密码后，即可提交成功。</li>
</ul>
<h2 id="通用解决方案"><a href="#通用解决方案" class="headerlink" title="通用解决方案"></a>通用解决方案</h2><p>进入库目录，找到 .git&#x2F;config 文件（macOS 可用终端执行 <code>vi .git/config</code> 直接进入修改），参考内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[core]</span><br><span class="line">	repositoryformatversion = 0</span><br><span class="line">	filemode = true</span><br><span class="line">	bare = false</span><br><span class="line">	logallrefupdates = true</span><br><span class="line">	ignorecase = true</span><br><span class="line">	precomposeunicode = true</span><br><span class="line">[remote &quot;origin&quot;]</span><br><span class="line">	url = https://github.com/userName/repositorieName.git</span><br><span class="line">	fetch = +refs/heads/*:refs/remotes/origin/*</span><br><span class="line">[branch &quot;other&quot;]</span><br><span class="line">	remote = origin</span><br><span class="line">	merge = refs/heads/other</span><br></pre></td></tr></table></figure>

<p>将用户名加入 [remote “origin”] 中的 url，最终修改为 <code>url = https://userName@github.com/userName/repositorieName.git</code>，接下来在提交项目时会要求输入密码。此后，系统将保存密码信息，以后这个库的提交将不再要求输入密码，也不会出现 403 错误。</p>
<h2 id="通用终极解决方案"><a href="#通用终极解决方案" class="headerlink" title="通用终极解决方案"></a>通用终极解决方案</h2><p>在 clone 项目时就将用户名加入路径，原路径如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone -b other https://github.com/userName/repositoryName.git</span><br></pre></td></tr></table></figure>

<p>添加 <code>userName@</code>，该路径修改为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone -b other https://userName@github.com/userName/repositoryName.git</span><br></pre></td></tr></table></figure>

<p>接下来在提交项目时会要求输入密码。此后，系统将保存密码信息，以后这个库的提交将不再要求输入密码，也不会出现 403 错误。</p>
]]></content>
      <categories>
        <category>通用技术</category>
      </categories>
      <tags>
        <tag>github</tag>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>使用多个-SSH-公钥连接多个-GitHub-远程仓库</title>
    <url>/58865c53-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>机器 A 一直使用账户 user1 的 SSH 公钥连接 github。现在新建账户 user2，希望在机器 A 也能够以 SSH 方式连接到 github</p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>默认情况下，即机器 A 一直使用账户 user1。此时使用命令 <code>$ git remote -v</code> 可以查看当前的远程仓库关联如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">origin  git@github.com:user1/repositorieName1.git (fetch)</span><br><span class="line">origin  git@github.com:user1/repositorieName1.git (push)</span><br></pre></td></tr></table></figure>

<p>如果 user2 新建一个名为 repositorieName2 的仓库，此时想在机器 A 上使用命令 <code>$ git push -u origin master</code> 提交到远程仓库，会出现如下的错误。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ERROR: Permission to user2/repositorieName2.git denied to user2.</span><br><span class="line">fatal: Could not read from remote repository. Please make sure you have the correct access rights and the repository exists.</span><br></pre></td></tr></table></figure>

<h2 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h2><p>机器 A 当前的公钥是 user1 的，user2 没有权限使用；想在 user2 的 github 账户中添加 user1 的公钥？也是不可能的，会提示公钥已经被使用。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><ol>
<li>在 user2 的项目目录中打开命令行，执行命令：<code>ssh-keygen -t ed25519 -C &quot;second@email.com&quot; -f ~/.ssh/id_rsa_for_user2</code>，生成专属 user2 的密钥对，再进入 user2 的 github 账户配置公钥。</li>
</ol>
<blockquote>
<p>使用 ed25519 是参考了 github <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent">相关文档</a></p>
</blockquote>
<ol start="2">
<li>在 <code>~/.ssh/</code> 目录下新建 <code>config</code> 文件，写入以下内容：</li>
</ol>
<blockquote>
<p>win10 路径：<code>C:\Users\Admin\.ssh</code></p>
</blockquote>
<blockquote>
<p>macOS 路径：<code>~/user/.ssh</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#Default GitHub</span><br><span class="line">Host user1</span><br><span class="line">HostName github.com</span><br><span class="line">PreferredAuthentications publickey</span><br><span class="line">IdentityFile ~/.ssh/user1_publickey</span><br><span class="line"></span><br><span class="line">Host user2</span><br><span class="line">HostName github.com</span><br><span class="line">PreferredAuthentications publickey</span><br><span class="line">IdentityFile ~/.ssh/user2_publickey</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>回到命令行，执行命令：<code>$ git remote set-url origin git@user1:user1/repositorieName1.git</code>，修改默认的关联。也可以把原有的默认关联删除，重新添加。</li>
<li>再继续执行命令：<code>$ git remote add origin2 git@user2:user2/repositorieName2.git</code>，新添加一个 user2 的关联。</li>
<li>此时执行命令：<code>$ git remote -v</code>，应是以下结果：</li>
</ol>
<blockquote>
<p>如果 clone 用户名 user1 的远程仓库，命令要相应修改为 <code>git clone -b main git@user1:user1/repositorieName1.git</code></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">origin2  git@user2:user2/repositorieName2.git (fetch)</span><br><span class="line">origin2  git@user2:user2/repositorieName2.git (push)</span><br><span class="line">origin  git@user1:user1/repositorieName1.git (fetch)</span><br><span class="line">origin  git@user1:user1/repositorieName1.git (push)</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>验证。可分别执行命令：<code>$ ssh -T git@user1</code>、<code>$ ssh -T git@user2</code>，均出现连接成功提示。至此，实现了多个 SSH 公钥连接多个 github 远程仓库的需求。</li>
</ol>
<blockquote>
<p>要加 <code>git@</code> 前缀，否则提示 <code>Permission denied (publickey)</code>（win10 环境，macOS 未实测）</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Hi user1! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Hi user2! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：github 添加的是如果是 deploy key，会显示库名称，如：username&#x2F;xxx</p>
</blockquote>
]]></content>
      <categories>
        <category>通用技术</category>
      </categories>
      <tags>
        <tag>github</tag>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>有关-Payload-在维基百科的释义</title>
    <url>/58868361-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="Payload-computing"><a href="#Payload-computing" class="headerlink" title="Payload (computing)"></a>Payload (computing)</h2><p>In computing and telecommunications, the payload is the part of transmitted data that is the actual intended message. Headers and metadata are sent only to enable payload delivery.</p>
<p>在计算和通信中，有效载荷是传输数据的一部分，是实际要发送的消息。报头和元数据仅用于支持有效载荷的传递。</p>
<p>In the context of a computer virus or worm, the payload is the portion of the malware which performs malicious action.</p>
<p>在计算机病毒或蠕虫的上下文中，有效载荷是执行恶意行为的恶意软件的一部分。</p>
<p>The term is borrowed from transportation, where payload refers to the part of the load that pays for transportation.</p>
<p>这个术语是从「运输」一词借用而来的，「有效载荷」指的是支付运输费用的那部分载荷。</p>
<h2 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h2><p>In computer security, the payload is the part of the private user text which could also contain malware such as worms or viruses which performs the malicious action; deleting data, sending spam or encrypting data.[3] In addition to the payload, such malware also typically has overhead code aimed at simply spreading itself, or avoiding detection.</p>
<p>在计算机安全中，有效载荷是私人用户文本的一部分，它也可能包含恶意软件，如蠕虫或执行恶意行为的病毒；删除数据、发送垃圾邮件或加密数据。除了有效载荷，这种恶意软件通常也有一些开销代码，目的是简单地传播自己，或者避免检测。</p>
<h2 id="Programming"><a href="#Programming" class="headerlink" title="Programming"></a>Programming</h2><p>In computer programming, the most common usage of the term is in the context of message protocols, to differentiate the protocol overhead from the actual data. For example, a JSON web service response might be:</p>
<p>在计算机编程中，该术语最常见的用法是在消息协议上下文中使用，以将协议开销与实际数据区分开来。例如，JSON web 服务响应可能是：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello, world!&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The string Hello, world! is the payload, while the rest is protocol overhead.</p>
<p>字符串 <code>Hello, world!</code> 为有效负载，其余为协议开销。</p>
<h2 id="Networking"><a href="#Networking" class="headerlink" title="Networking"></a>Networking</h2><p>In the computer networking, data to be transmitted is the payload, but is almost always encapsulated in some type of a frame composed of framing bits and a frame check sequence.[4][5] Examples are Ethernet frames, Point-to-Point Protocol (PPP) frames, Fibre Channel frames, and V.42 modem frames.</p>
<p>在计算机网络中，要传输的数据是有效载荷，但几乎总是封装在由帧位和帧检查序列组成的某种类型的帧中。[4][5]的例子是以太网帧、点对点协议（PPP）帧、光纤通道帧和 V.42 调制解调器帧。</p>
]]></content>
      <categories>
        <category>通用技术</category>
      </categories>
      <tags>
        <tag>payload</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven-配置阿里云中央仓库和自定义本地仓库</title>
    <url>/5885e721-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在国内访问 Maven 仓库的速度太慢，导致使用 IDEA 建立 Maven 项目会出现没有 src 目录结构的情况。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="中央仓库配置"><a href="#中央仓库配置" class="headerlink" title="中央仓库配置"></a>中央仓库配置</h3><p>在 Maven 安装目录下的 settings.xml 文件中的增加以下内容，使用阿里云的中央仓库。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/repositories/central/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="自定义本地仓库配置"><a href="#自定义本地仓库配置" class="headerlink" title="自定义本地仓库配置"></a>自定义本地仓库配置</h3><p>在 Maven 安装目录下的 settings.xml 文件中设置本地仓库。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>D:\myProgram\apache-maven-3.5.2\repositoryx<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx-配置文件的结构详解及案例</title>
    <url>/5885e720-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>nginx 源码：<a href="https://trac.nginx.org/nginx/browser">https://trac.nginx.org/nginx/browser</a></li>
<li>nginx 官网：<a href="http://www.nginx.org/">http://www.nginx.org/</a></li>
</ul>
<h2 id="配置文件结构"><a href="#配置文件结构" class="headerlink" title="配置文件结构"></a>配置文件结构</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">...              #全局块</span><br><span class="line"></span><br><span class="line">events &#123;         #events块</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http      #http块</span><br><span class="line">&#123;</span><br><span class="line">    ...   #http全局块</span><br><span class="line">    server        #server块1</span><br><span class="line">    &#123;</span><br><span class="line">        ...       #server全局块</span><br><span class="line">        location [PATTERN]   #location块1</span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        location [PATTERN]   #location块2</span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server        #server块2</span><br><span class="line">    &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>全局块：配置影响 nginx 全局的指令。一般有运行 nginx 服务器的用户组，nginx 进程 pid 存放路径，日志存放路径，配置文件引入，允许生成 worker process 数等。</li>
<li>events 块：配置影响 nginx 服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。</li>
<li>http 块：配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type 定义，日志自定义，是否使用 sendfile 传输文件，连接超时时间，单连接请求数等。</li>
<li>server 块：配置虚拟主机的相关参数，一个 http 中可以有多个 server。</li>
<li>location 块：配置请求的路由，以及各种页面的处理情况。</li>
</ul>
<h2 id="配置文件细节"><a href="#配置文件细节" class="headerlink" title="配置文件细节"></a>配置文件细节</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#配置用户或者组，默认为nobody nobody</span><br><span class="line">user administrator administrators;</span><br><span class="line"></span><br><span class="line">#允许生成的进程数，默认为1，也可以设置为auto，这个数值简单一点可以设置为cpu的核数grep ^processor /proc/cpuinfo | wc -l，也是auto值，如果开启了ssl和gzip更应该设置成与逻辑CPU数量一样甚至为2倍，可以减少I/O操作。如果nginx服务器还有其它服务，可以考虑适当减少。</span><br><span class="line">worker_processes 2;</span><br><span class="line"></span><br><span class="line">#默认是没有设置，可以限制为操作系统最大的限制65535。</span><br><span class="line">worker_rlimit_nofile 10240</span><br><span class="line"></span><br><span class="line">#指定nginx进程运行文件存放地址</span><br><span class="line">pid /nginx/pid/nginx.pid;</span><br><span class="line"></span><br><span class="line">#设置日志路径和级别。这个设置可以放入全局块，http块，server块，可选级别：debug|info|notice|warn|error|crit|alert|emerg</span><br><span class="line">error_log log/error.log;</span><br><span class="line">error_log log/error.log notice;</span><br><span class="line">error_log log/error.log debug;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">  #设置网路连接序列化，防止惊群现象发生，默认为on，惊群现象：一个网路连接到来，多个睡眠的进程被同时叫醒，但只有一个进程能获得链接，这样会影响系统性能。</span><br><span class="line">  accept_mutex on;</span><br><span class="line"></span><br><span class="line">  #设置一个进程是否同时接受多个网络连接，默认为off</span><br><span class="line">  multi_accept on;</span><br><span class="line"></span><br><span class="line">  #事件驱动模型，可选：select|poll|kqueue|epoll|resig|/dev/poll|eventport，在Linux操作系统下，nginx默认使用epoll事件模型，得益于此，nginx在Linux操作系统下效率相当高。同时Nginx在OpenBSD或FreeBSD操作系统上采用类似于epoll的高效事件模型kqueue。在操作系统不支持这些高效模型时才使用select。</span><br><span class="line">  use epoll;</span><br><span class="line"></span><br><span class="line">  #最大连接数，默认为512，每一个worker进程能并发处理（发起）的最大连接数（包含与客户端或后端被代理服务器间等所有连接数）</span><br><span class="line">  #nginx作为反向代理服务器，计算公式最大连接数 = worker_processes * worker_connections/4，所以这里客户端最大连接数是1024，这个可以增到到8192都没关系，看情况而定，但不能超过后面的worker_rlimit_nofile。当nginx作为http服务器时，计算公式里面是除以2。</span><br><span class="line">  worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">  #文件扩展名与文件类型映射表</span><br><span class="line">  include mime.types;</span><br><span class="line"></span><br><span class="line">  #默认文件类型，默认为text/plain</span><br><span class="line">  default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">  #取消服务日志</span><br><span class="line">  #access_log off;</span><br><span class="line"></span><br><span class="line">  #自定义格式</span><br><span class="line">  log_format myFormat &#x27;$remote_addr–$remote_user [$time_local] $request $status $body_bytes_sent $http_referer $http_user_agent $http_x_forwarded_for&#x27;;</span><br><span class="line"></span><br><span class="line">  #自定义格式含义</span><br><span class="line">  #$remote_addr与$http_x_forwarded_for，记录客户端的ip地址</span><br><span class="line">  #$remote_user，记录客户端用户名称</span><br><span class="line">  #$time_local，记录访问时间与时区</span><br><span class="line">  #$request，记录请求的url与http协议</span><br><span class="line">  #$status，记录请求状态；成功是200</span><br><span class="line">  #$body_bytes_s ent，记录发送给客户端文件主体内容大小</span><br><span class="line">  #$http_referer，记录从那个页面链接访问过来的</span><br><span class="line">  #$http_user_agent，记录客户端浏览器的相关信息</span><br><span class="line"></span><br><span class="line">  #combined为日志格式的默认值</span><br><span class="line">  access_log log/access.log myFormat;</span><br><span class="line"></span><br><span class="line">  #允许sendfile方式传输文件，默认为off，可以在http块，server块，location块，开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数来输出文件，减少用户空间到内核空间的上下文切换。对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。</span><br><span class="line">  sendfile on;</span><br><span class="line"></span><br><span class="line">  #每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限</span><br><span class="line">  sendfile_max_chunk 100k;</span><br><span class="line"></span><br><span class="line">  #连接超时时间，默认为75s，可以在http，server，location块，长连接超时时间，单位是秒，这个参数很敏感，涉及浏览器的种类、后端服务器的超时设置、操作系统的设置。长连接请求大量小文件的时候，可以减少重建连接的开销，但假如有大文件上传，65s内没上传完成会导致失败。如果设置时间过长，用户又多，长时间保持连接会占用大量资源。</span><br><span class="line">  keepalive_timeout 65;</span><br><span class="line"></span><br><span class="line">  #http_proxy 设置</span><br><span class="line">  #允许客户端请求的最大单文件字节数。如果有上传较大文件，请设置它的限制值</span><br><span class="line">  client_max_body_size  10m;</span><br><span class="line"></span><br><span class="line">  #缓冲区代理缓冲用户端请求的最大字节数</span><br><span class="line">  client_body_buffer_size 128k;</span><br><span class="line"></span><br><span class="line">  proxy_connect_timeout 75;</span><br><span class="line">  proxy_send_timeout  75;</span><br><span class="line">  proxy_read_timeout  75;</span><br><span class="line">  proxy_buffer_size 4k;</span><br><span class="line">  proxy_buffers 4 32k;</span><br><span class="line">  proxy_busy_buffers_size 64k;</span><br><span class="line">  proxy_temp_file_write_size  64k;</span><br><span class="line">  proxy_temp_path   /usr/local/nginx/proxy_temp 1 2;</span><br><span class="line"></span><br><span class="line">  #设定实际的服务器列表</span><br><span class="line">  #这个模块通过一个简单的调度算法来实现客户端IP到后端服务器的负载均衡，upstream后接负载均衡器的名字，后端realserver以host:port options; 方式组织在 &#123;&#125; 中。如果后端被代理的只有一台，也可以直接写在</span><br><span class="line">  upstream mysvr &#123;   </span><br><span class="line">    server 127.0.0.1:7878;</span><br><span class="line">    #热备</span><br><span class="line">    server 192.168.10.121:3333 backup;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  #错误页，若该配置要生效，还需要配置proxy_intercept_errors</span><br><span class="line">  error_page 404 https://www.baidu.com;</span><br><span class="line"></span><br><span class="line">  server &#123;</span><br><span class="line">      #单连接请求上限次数</span><br><span class="line">      keepalive_requests  120;</span><br><span class="line">      #监听端口，默认80，小于1024的要以root启动。可以为listen *:80、listen 127.0.0.1:80等形式。</span><br><span class="line">      listen  4545;</span><br><span class="line">      #监听地址，可以通过正则匹配。  </span><br><span class="line">      server_name 127.0.0.1;</span><br><span class="line">      #请求的url过滤，正则匹配，~为区分大小写，~*为不区分大小写。</span><br><span class="line">      location  ~*^.+$ &#123;</span><br><span class="line">        #根目录</span><br><span class="line">        #root path;</span><br><span class="line">        #设置默认页</span><br><span class="line">        #index vv.txt;</span><br><span class="line">        #反向代理的路径（和upstream绑定），location 后面设置映射的路径</span><br><span class="line">        proxy_pass  http://mysvr;</span><br><span class="line">        #拒绝的ip</span><br><span class="line">        deny  127.0.0.1;</span><br><span class="line">        #允许的ip</span><br><span class="line">        allow 172.18.5.54;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  server &#123;</span><br><span class="line">      listen  80;</span><br><span class="line">      server_name  itoatest.example.com;</span><br><span class="line">      root   /apps/oaapp;</span><br><span class="line">      charset utf-8;</span><br><span class="line">      access_log  logs/host.access.log  main;</span><br><span class="line">      #对/所有做负载均衡+反向代理</span><br><span class="line">      location / &#123;</span><br><span class="line">          root   /apps/oaapp;</span><br><span class="line">          index  index.jsp index.html index.htm;</span><br><span class="line">          proxy_pass  http://backend;</span><br><span class="line">          proxy_redirect off;</span><br><span class="line">          # 后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br><span class="line">          proxy_set_header  Host  $host;</span><br><span class="line">          proxy_set_header  X-Real-IP  $remote_addr;</span><br><span class="line">          proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">          proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line">      &#125;</span><br><span class="line">      #静态文件，nginx自己处理，不去backend请求tomcat</span><br><span class="line">      location  ~* /download/ &#123;</span><br><span class="line">          root /apps/oa/fs;</span><br><span class="line">          #过期30天，静态文件不怎么更新，过期可以设大一点，如果频繁更新，则可以设置得小一点。</span><br><span class="line">          expires 30d;</span><br><span class="line">      &#125;</span><br><span class="line">      location ~ .*\.(gif|jpg|jpeg|bmp|png|ico|txt|js|css)$</span><br><span class="line">      &#123;   </span><br><span class="line">          root /apps/oaapp;</span><br><span class="line">          expires 7d;</span><br><span class="line">      &#125;</span><br><span class="line">      location /nginx_status &#123;</span><br><span class="line">          stub_status on;</span><br><span class="line">          access_log off;</span><br><span class="line">          allow 192.168.10.0/24;</span><br><span class="line">          deny all;</span><br><span class="line">      &#125;</span><br><span class="line">      location ~ ^/(WEB-INF)/ &#123;</span><br><span class="line">          deny all;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      #error_page  404  /404.html;</span><br><span class="line">      # redirect server error pages to the static page /50x.html</span><br><span class="line">      error_page   500 502 503 504  /50x.html;</span><br><span class="line">      location = /50x.html &#123;</span><br><span class="line">          root   html;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="宝塔Linux面板默认配置（Nginx-1-8）"><a href="#宝塔Linux面板默认配置（Nginx-1-8）" class="headerlink" title="宝塔Linux面板默认配置（Nginx 1.8）"></a>宝塔Linux面板默认配置（Nginx 1.8）</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">user  www www;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log  /www/wwwlogs/nginx_error.log  crit;</span><br><span class="line">pid        /www/server/nginx/logs/nginx.pid;</span><br><span class="line">worker_rlimit_nofile 51200;</span><br><span class="line"></span><br><span class="line">events  &#123;</span><br><span class="line">        use epoll;</span><br><span class="line">        worker_connections 51200;</span><br><span class="line">        multi_accept on;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">http  &#123;</span><br><span class="line">        include       mime.types;</span><br><span class="line">    		#include luawaf.conf;</span><br><span class="line"></span><br><span class="line">    		include proxy.conf;</span><br><span class="line"></span><br><span class="line">        default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">        server_names_hash_bucket_size 512;</span><br><span class="line">        client_header_buffer_size 32k;</span><br><span class="line">        large_client_header_buffers 4 32k;</span><br><span class="line">        client_max_body_size 50m;</span><br><span class="line"></span><br><span class="line">        sendfile   on;</span><br><span class="line">        tcp_nopush on;</span><br><span class="line"></span><br><span class="line">        keepalive_timeout 60;</span><br><span class="line"></span><br><span class="line">        tcp_nodelay on;</span><br><span class="line"></span><br><span class="line">        fastcgi_connect_timeout 300;</span><br><span class="line">        fastcgi_send_timeout 300;</span><br><span class="line">        fastcgi_read_timeout 300;</span><br><span class="line">        fastcgi_buffer_size 64k;</span><br><span class="line">        fastcgi_buffers 4 64k;</span><br><span class="line">        fastcgi_busy_buffers_size 128k;</span><br><span class="line">        fastcgi_temp_file_write_size 256k;</span><br><span class="line">    		fastcgi_intercept_errors on;</span><br><span class="line"></span><br><span class="line">        gzip on;</span><br><span class="line">        gzip_min_length  1k;</span><br><span class="line">        gzip_buffers     4 16k;</span><br><span class="line">        gzip_http_version 1.1;</span><br><span class="line">        gzip_comp_level 2;</span><br><span class="line">        gzip_types     text/plain application/javascript application/x-javascript text/javascript text/css application/xml;</span><br><span class="line">        gzip_vary on;</span><br><span class="line">        gzip_proxied   expired no-cache no-store private auth;</span><br><span class="line">        gzip_disable   &quot;MSIE [1-6]\.&quot;;</span><br><span class="line"></span><br><span class="line">        limit_conn_zone $binary_remote_addr zone=perip:10m;</span><br><span class="line">    		limit_conn_zone $server_name zone=perserver:10m;</span><br><span class="line"></span><br><span class="line">        server_tokens off;</span><br><span class="line">        access_log off;</span><br><span class="line"></span><br><span class="line">server  &#123;</span><br><span class="line">        listen 888;</span><br><span class="line">        server_name www.bt.cn;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">        root  /www/server/phpmyadmin;</span><br><span class="line"></span><br><span class="line">        #error_page   404   /404.html;</span><br><span class="line">        include enable-php.conf;</span><br><span class="line"></span><br><span class="line">        location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$</span><br><span class="line">        &#123;</span><br><span class="line">            expires      30d;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ .*\.(js|css)?$</span><br><span class="line">        &#123;</span><br><span class="line">            expires      12h;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ /\.</span><br><span class="line">        &#123;</span><br><span class="line">            deny all;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        access_log  /www/wwwlogs/access.log;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">include /www/server/panel/vhost/nginx/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="http反向代理配置案例"><a href="#http反向代理配置案例" class="headerlink" title="http反向代理配置案例"></a>http反向代理配置案例</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#运行用户</span><br><span class="line">#user www;</span><br><span class="line"></span><br><span class="line">#启动进程,通常设置成和cpu的数量相等</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">#全局错误日志</span><br><span class="line">error_log  /www/server/logs/error.log;</span><br><span class="line">error_log  /www/server/logs/notice.log  notice;</span><br><span class="line">error_log  /www/server/logs/info.log  info;</span><br><span class="line"></span><br><span class="line">#PID文件，记录当前启动的nginx的进程ID</span><br><span class="line">pid        /www/server/logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">#工作模式及连接数上限</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;    #单个后台worker process进程的最大并发链接数</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#设定http服务器，利用它的反向代理功能提供负载均衡支持</span><br><span class="line">http &#123;</span><br><span class="line">    #设定mime类型(邮件支持类型),类型由mime.types文件定义</span><br><span class="line">    include       /www/server/conf/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #设定日志</span><br><span class="line">    log_format  main  &#x27;[$remote_addr] - [$remote_user] [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log    /www/server/logs/access.log main;</span><br><span class="line">    rewrite_log     on;</span><br><span class="line"></span><br><span class="line">    #sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件，对于普通应用，</span><br><span class="line">    #必须设为 on,如果用来进行下载等应用磁盘IO重负载应用，可设置为 off，以平衡磁盘与网络I/O处理速度，降低系统的uptime.</span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #连接超时时间</span><br><span class="line">    keepalive_timeout  120;</span><br><span class="line">    tcp_nodelay        on;</span><br><span class="line"></span><br><span class="line">    #gzip压缩开关</span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    #设定实际的服务器列表</span><br><span class="line">    upstream server_list&#123;</span><br><span class="line">        server 127.0.0.1:8089;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #HTTP服务器</span><br><span class="line">    server &#123;</span><br><span class="line">        listen  80;</span><br><span class="line">        server_name  www.test.cn;</span><br><span class="line">        index index.html</span><br><span class="line">        root /www/server/test;</span><br><span class="line"></span><br><span class="line">        #编码格式</span><br><span class="line">        charset utf-8;</span><br><span class="line"></span><br><span class="line">        #代理配置参数</span><br><span class="line">        proxy_connect_timeout 180;</span><br><span class="line">        proxy_send_timeout 180;</span><br><span class="line">        proxy_read_timeout 180;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Forwarder-For $remote_addr;</span><br><span class="line"></span><br><span class="line">        #反向代理的路径</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://server_list;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #设置静态文件映射的路径</span><br><span class="line">        location ~ ^/(images|javascript|js|css|flash|media|static)/ &#123;</span><br><span class="line">            root /www/server/views;</span><br><span class="line">            #过期时限30天，若变动较少，可适当增加天数；反之减少。</span><br><span class="line">            expires 30d;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #设定查看Nginx状态的地址</span><br><span class="line">        location /NginxStatus &#123;</span><br><span class="line">            stub_status           on;</span><br><span class="line">            access_log            on;</span><br><span class="line">            auth_basic            &quot;NginxStatus&quot;;</span><br><span class="line">            auth_basic_user_file  conf/htpasswd;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #禁止访问.htxxx文件</span><br><span class="line">        location ~ /\.ht &#123;</span><br><span class="line">            deny all;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #错误处理页面（可选）</span><br><span class="line">        #error_page   404              /404.html;</span><br><span class="line">        #error_page   500 502 503 504  /50x.html;</span><br><span class="line">        #location = /50x.html &#123;</span><br><span class="line">        #    root   html;</span><br><span class="line">        #&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="https反向代理配置案例"><a href="#https反向代理配置案例" class="headerlink" title="https反向代理配置案例"></a>https反向代理配置案例</h2><p>安全性要求比较高的站点，可能会使用 HTTPS协议。HTTPS的固定端口号为443，使用SSL标准需要引入安全证书，所以在nginx.conf中需要指定证书和对应的key，其他设置和http反向代理一样，只是在Server部分配置有些不同。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#HTTP服务器</span><br><span class="line">  server &#123;</span><br><span class="line">      #监听443端口</span><br><span class="line">      listen  443 ssl;</span><br><span class="line"></span><br><span class="line">      #定义www.test.cn</span><br><span class="line">      server_name  www.test.cn;</span><br><span class="line"></span><br><span class="line">      #ssl证书文件位置(常见证书文件格式为：crt/pem)</span><br><span class="line">      ssl_certificate      cert.pem;</span><br><span class="line">      #ssl证书key位置</span><br><span class="line">      ssl_certificate_key  cert.key;</span><br><span class="line"></span><br><span class="line">      #ssl配置参数（可选）</span><br><span class="line">      ssl_session_cache    shared:SSL:1m;</span><br><span class="line">      ssl_session_timeout  5m;</span><br><span class="line"></span><br><span class="line">      #数字签名，此处使用MD5</span><br><span class="line">      ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">      ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">      location / &#123;</span><br><span class="line">          root   /root;</span><br><span class="line">          index  index.html index.htm;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="负载均衡案例"><a href="#负载均衡案例" class="headerlink" title="负载均衡案例"></a>负载均衡案例</h2><p>有如下应用场景：</p>
<ul>
<li>应用分别部署在<code>192.168.1.10:80</code>、<code>192.168.1.11:80</code>、<code>192.168.1.12:80</code>三台linux环境的服务器上。</li>
<li>网站域名为：<code>www.test.cn</code>，公网IP为<code>192.168.1.10</code></li>
<li>在公网IP所在的服务器上部署nginx，对所有请求做负载均衡处理</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    #设定mime类型,类型由mime.type文件定义</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    #设定日志格式</span><br><span class="line">    access_log    /var/log/nginx/access.log;</span><br><span class="line"></span><br><span class="line">    #设定负载均衡的服务器列表</span><br><span class="line">    upstream server_list &#123;</span><br><span class="line">        #weigth参数表示权值，权值越高被分配到的几率越大</span><br><span class="line">        server 192.168.1.10:80   weight=1;</span><br><span class="line">        server 192.168.1.11:80   weight=3;</span><br><span class="line">        server 192.168.1.12:80   weight=7;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   #HTTP服务器</span><br><span class="line">   server &#123;</span><br><span class="line">        listen  80;</span><br><span class="line">        server_name  www.test.cn;</span><br><span class="line"></span><br><span class="line">        #对所有请求进行负载均衡请求</span><br><span class="line">        location / &#123;</span><br><span class="line">            #定义服务器的默认网站根目录位置</span><br><span class="line">            root        /root;</span><br><span class="line">            #定义首页索引文件的名称</span><br><span class="line">            index       index.html index.htm;</span><br><span class="line">            #请求转向load_balance_server 定义的服务器列表</span><br><span class="line">            proxy_pass  http://server_list;</span><br><span class="line"></span><br><span class="line">            #其他反向代理的配置(可选)</span><br><span class="line">            #proxy_redirect off;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            #后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br><span class="line">            proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">            proxy_connect_timeout 90;          #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class="line">            proxy_send_timeout 90;             #后端服务器数据回传时间(代理发送超时)</span><br><span class="line">            proxy_read_timeout 90;             #连接成功后，后端服务器响应时间(代理接收超时)</span><br><span class="line">            proxy_buffer_size 4k;              #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class="line">            proxy_buffers 4 32k;               #proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span><br><span class="line">            proxy_busy_buffers_size 64k;       #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class="line">            proxy_temp_file_write_size 64k;    #设定缓存文件夹大小，大于这个值，将从upstream服务器传</span><br><span class="line"></span><br><span class="line">            client_max_body_size 10m;          #允许客户端请求的最大单文件字节数</span><br><span class="line">            client_body_buffer_size 128k;      #缓冲区代理缓冲用户端请求的最大字节数</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="多个webapp的配置案例"><a href="#多个webapp的配置案例" class="headerlink" title="多个webapp的配置案例"></a>多个webapp的配置案例</h2><p>将网站中一些功能相对独立的模块抽离出来，独立维护</p>
<ul>
<li><a href="http://www.test.cn拆分出：A、B、C三个模块">www.test.cn拆分出：A、B、C三个模块</a></li>
<li>访问上述模块的方式通过上下文(context)来进行区分:<ul>
<li><a href="http://www.test.cn/A/">www.test.cn/A/</a></li>
<li><a href="http://www.test.cn/B/">www.test.cn/B/</a></li>
<li><a href="http://www.test.cn/C/">www.test.cn/C/</a></li>
</ul>
</li>
<li>这三个应用需要分别绑定不同的端口号。那么用户在实际访问站点时，访问不同模块时为了避免带端口号访问，需要用到反向代理。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    upstream A_server&#123;</span><br><span class="line">        server www.test.cn:8081;</span><br><span class="line">    &#125;</span><br><span class="line">    upstream B_server&#123;</span><br><span class="line">        server www.test.cn:8082;</span><br><span class="line">    &#125;</span><br><span class="line">    upstream C_server&#123;</span><br><span class="line">        server www.test.cn:8083;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        #默认指向A</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://A_server;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /A/&#123;</span><br><span class="line">            proxy_pass http://A_server;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /B/ &#123;</span><br><span class="line">            proxy_pass http://B_server;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /C/ &#123;</span><br><span class="line">            proxy_pass http://C_server;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="静态站点配置案例"><a href="#静态站点配置案例" class="headerlink" title="静态站点配置案例"></a>静态站点配置案例</h2><p>网站静态资源都放在了&#x2F;app&#x2F;dist目录下，此时要在nginx.conf中指定首页以及这个站点的host即可。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_types text/plain application/x-javascript text/css application/xml text/javascript application/javascript image/jpeg image/gif image/png;</span><br><span class="line">    gzip_vary on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  static.zp.cn;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            #转发任何请求到index.html</span><br><span class="line">            index index.html;</span><br><span class="line">            root /app/dist;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="跨域案例"><a href="#跨域案例" class="headerlink" title="跨域案例"></a>跨域案例</h2><p>解决跨域问题一般有两种思路：</p>
<ul>
<li>jsonp。把后端根据请求，构造json数据并返回，前端用jsonp跨域。</li>
<li>CORS。在后端服务器设置http响应头，把需要运行访问的域名加入加入Access-Control-Allow-Origin中。nginx 根据这个思路，提供了一种解决跨域的解决方案。举例：<a href="http://www.test.cn是由一个前端app,一个后端app组成的.前端端口号为9000,后端端口号为8080.前端和后端如果使用http进行交互时,请求会被拒绝,因为存在跨域问题.此时,在/">www.test.cn是由一个前端app，一个后端app组成的。前端端口号为9000，后端端口号为8080。前端和后端如果使用http进行交互时，请求会被拒绝，因为存在跨域问题。此时，在</a> enable-cors.conf 文件中设置 cors：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># allow origin list</span><br><span class="line">set $ACAO &#x27;*&#x27;;</span><br><span class="line"></span><br><span class="line"># set single origin</span><br><span class="line">if ($http_origin ~* (www.test.cn)$) &#123;</span><br><span class="line">  set $ACAO $http_origin;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($cors = &quot;trueget&quot;) &#123;</span><br><span class="line">    add_header &#x27;Access-Control-Allow-Origin&#x27; &quot;$http_origin&quot;;</span><br><span class="line">    add_header &#x27;Access-Control-Allow-Credentials&#x27; &#x27;true&#x27;;</span><br><span class="line">    add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;</span><br><span class="line">    add_header &#x27;Access-Control-Allow-Headers&#x27; &#x27;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($request_method = &#x27;OPTIONS&#x27;) &#123;</span><br><span class="line">  set $cors &quot;$&#123;cors&#125;options&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($request_method = &#x27;GET&#x27;) &#123;</span><br><span class="line">  set $cors &quot;$&#123;cors&#125;get&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($request_method = &#x27;POST&#x27;) &#123;</span><br><span class="line">  set $cors &quot;$&#123;cors&#125;post&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在服务器中include enable-cors.conf，即引入跨域配置：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 可直接在 nginx config 中 include（推荐）</span><br><span class="line"># www.test.cn域名需配合 dns hosts 进行配置</span><br><span class="line"># 其中，api 开启了 cors，需配合本目录下另一份配置文件</span><br><span class="line"></span><br><span class="line">upstream front_server&#123;</span><br><span class="line">  server www.test.cn:9000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream api_server&#123;</span><br><span class="line">  server www.test.cn:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen       80;</span><br><span class="line">  server_name  www.test.cn;</span><br><span class="line"></span><br><span class="line">  location ~ ^/api/ &#123;</span><br><span class="line">    include enable-cors.conf;</span><br><span class="line">    proxy_pass http://api_server;</span><br><span class="line">    rewrite &quot;^/api/(.*)$&quot; /$1 break;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location ~ ^/ &#123;</span><br><span class="line">    proxy_pass http://front_server;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="upstream的几种配置方式"><a href="#upstream的几种配置方式" class="headerlink" title="upstream的几种配置方式"></a>upstream的几种配置方式</h2><p>第一种：轮询</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">upstream test&#123;</span><br><span class="line">server 192.168.0.1:3000;</span><br><span class="line">server 192.168.0.1:3001;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二种：权重</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">upstream test&#123;</span><br><span class="line">server 192.168.0.1 weight=2;</span><br><span class="line">server 192.168.0.2 weight=3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种模式可解决服务器性能不等的情况下轮询比率的调配</p>
<p>第三种：ip_hash</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">upstream test&#123;</span><br><span class="line">ip_hash;</span><br><span class="line">server 192.168.0.1;</span><br><span class="line">server 192.168.0.2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种模式会根据来源IP和后端配置来做hash分配，确保固定IP只访问一个后端</p>
<p>第四种：fair<br>需要安装Upstream Fair Balancer Module</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">upstream test&#123;</span><br><span class="line">server 192.168.0.1;</span><br><span class="line">server 192.168.0.2;</span><br><span class="line">fair;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种模式会根据后端服务的响应时间来分配，响应时间短的后端优先分配</p>
<p>第五种：自定义hash<br>需要安装Upstream Hash Module</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">upstream test&#123;</span><br><span class="line">server 192.168.0.1;</span><br><span class="line">server 192.168.0.2;</span><br><span class="line">hash $request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种模式可以根据给定的字符串进行Hash分配</p>
<p>具体应用：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name .test.com;</span><br><span class="line">  charset utf-8;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http://test/;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>upstream每个地址可设置参数为：</p>
<ul>
<li>down: 表示此台server暂时不参与负载。</li>
<li>weight: 默认为1，weight越大，负载的权重就越大。</li>
<li>max_fails: 允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream模块定义的错误。</li>
<li>fail_timeout: max_fails次失败后，暂停的时间。</li>
<li>backup: 其它所有的非backup机器down或者忙的时候，请求backup机器，应急措施。</li>
</ul>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>VMware15 安装 win11</title>
    <url>/302e9b10-debd-11ee-bdc4-19fdf0ccb3e7/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、安装要求"><a href="#1、安装要求" class="headerlink" title="1、安装要求"></a>1、安装要求</h2><p>官网地址：<a href="https://www.microsoft.com/en-us/windows/windows-11-specifications">System requirements</a></p>
<p>System requirements</p>
<p>These are the minimum system requirements for installing Windows 11 on a PC. If your device does not meet these requirements, you may not be able to install Windows 11 on your device and might want to consider purchasing a new PC. If you are unsure whether your PC meets these requirements, you can check with your PC Original Equipment Manufacturer (OEM) or, if your device is already running Windows 10, you can use the PC Health Check app to assess compatibility. Note that this app does not check for graphics card or display, as most compatible devices will meet those requirements listed below.</p>
<table>
<thead>
<tr>
<th></th>
<th>项目</th>
<th>要求</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Processor</td>
<td>1 gigahertz (GHz) or faster with 2 or more cores on a compatible 64-bit processor or System on a Chip (SoC).</td>
</tr>
<tr>
<td>2</td>
<td>RAM</td>
<td>4 gigabyte (GB).</td>
</tr>
<tr>
<td>3</td>
<td>Storage</td>
<td>64 GB or larger storage device Note: See below under “More information on storage space to keep Windows 11 up-to-date” for more details.</td>
</tr>
<tr>
<td>4</td>
<td>System firmware</td>
<td>UEFI, Secure Boot capable. Check here for information on how your PC might be able to meet this requirement.</td>
</tr>
<tr>
<td>5</td>
<td>TPM</td>
<td>Trusted Platform Module (TPM) version 2.0. Check here for instructions on how your PC might be enabled to meet this requirement.</td>
</tr>
<tr>
<td>6</td>
<td>Graphics card</td>
<td>Compatible with DirectX 12 or later with WDDM 2.0 driver.</td>
</tr>
<tr>
<td>7</td>
<td>Display</td>
<td>High definition (720p) display that is greater than 9” diagonally, 8 bits per color channel.</td>
</tr>
<tr>
<td>8</td>
<td>Internet connection and Microsoft account</td>
<td>For all Windows 11 editions, internet access is required to perform updates and to download and take advantage of some features. A Microsoft account is required for some features.</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>内存</strong>和 <strong>TPM</strong> 是需要重点设置的部分，否则提示「这台电脑无法运行 Windows 11，这台电脑不符合安装此版本的 Windows 所需的最低系统要求。」</p>
</blockquote>
<h2 id="2、主要安装流程"><a href="#2、主要安装流程" class="headerlink" title="2、主要安装流程"></a>2、主要安装流程</h2><p>1）进入官网下载 win11 镜像：<a href="https://www.microsoft.com/zh-cn/software-download/windows11">Windows 11 磁盘映像 (ISO)</a>，选择「Windows 11 (multi-edition ISO)」，点击「下载」，「选择产品语言」后「确认」开始下载镜像；</p>
<p>2）在 VMware15 新建虚拟机，在向导中选择「稍后安装操作系统」，先修改配置。磁盘大小、CPU 内核等配置均可以使用默认；特别注意<strong>内存至少为 4G</strong></p>
<p>3）设置 TPM：依次进入「编辑虚拟机设置」→「访问控制」→「加密」设置密码；回到「硬件」选项卡，点击「添加」→ 选择「可信平台模块」</p>
<p>4）选择镜像，正常安装即可。</p>
<h2 id="3、其他问题"><a href="#3、其他问题" class="headerlink" title="3、其他问题"></a>3、其他问题</h2><p>1）安装时如果不登陆微软账户，可在添加账户界面选择「注册工作或学校账户」，点击「登陆选项」→「改为域加入」，设置名字后即可跳过登录账号步骤</p>
<p>2）VMware17下载，<a href="https://www.vmware.com/products/workstation-pro.html">官方地址</a>，在「Try Workstation 17 Pro」下载试用版</p>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>win</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows 环境下压缩版 MySQL 安装（8.0.15 版本）</title>
    <url>/ef12a6f0-4937-11ee-861d-b3cf05b530a5/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>


<p>1、下载，解压压缩包至目标位置</p>
<p>2、配置环境变量</p>
<p>3、初始化。进入 bin 目录，用管理员权限打开 cmd 命令行，执行 <code>mysqld --initialize --console</code>，出现的随机密码 <code>,sDmQfi:f9u#</code>。如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\mysql8.0.15\bin&gt;mysqld --initialize --console</span><br><span class="line">2019-03-27T01:01:24.504964Z 0 [System] [MY-013169] [Server] D:\mysql8.0.15\bin\mysqld.exe (mysqld 8.0.15) initializing of server in progress as process 11120</span><br><span class="line">2019-03-27T01:01:50.726845Z 5 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: ,sDmQfi:f9u#</span><br><span class="line">2019-03-27T01:02:01.062899Z 0 [System] [MY-013170] [Server] D:\mysql8.0.15\bin\mysqld.exe (mysqld 8.0.15) initializing of server has completed</span><br></pre></td></tr></table></figure>

<p>4、安装 mysql 服务，运行命令 <code>net start mysql</code></p>
<p><strong>附加内容：执行 <code>net start mysql</code> 时提示：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">服务名无效。</span><br><span class="line"></span><br><span class="line">请键入 NET HELPMSG 2185 以获得更多的帮助。</span><br></pre></td></tr></table></figure>

<p>此时重新安装服务即可：<code>mysqld -install</code></p>
<p>5、登录，命令 <code>mysql -u root -p</code>，输入之前的随机密码</p>
<p>6、修改密码<br>命令：<code>alter user &#39;root&#39;@&#39;localhost&#39; Identified by &#39;新密码&#39;;</code></p>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>docker 下配置 Oracle Database Server 12c R2</title>
    <url>/2d5fd760-cd69-11ee-be69-4dedf56c58bd/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、下载镜像"><a href="#1、下载镜像" class="headerlink" title="1、下载镜像"></a>1、下载镜像</h2><p>1）<code>https://hub.docker.com/_/oracle-database-enterprise-edition</code></p>
<p>2）填写一些信息，命令行输入 <code>docker login</code> 登陆后下载镜像。</p>
<h2 id="2、修改源（可选）"><a href="#2、修改源（可选）" class="headerlink" title="2、修改源（可选）"></a>2、修改源（可选）</h2><p>采用阿里云提供的国内源，Docker Desktop 依次进入 <code>Settings</code>→<code>Docker Engine</code>，在 <code>registry-mirrors</code> 属性下添加地址（仅供参考）：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https://67ewp9up.mirror.aliyuncs.com&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;debug&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;experimental&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;features&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;buildkit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="3、执行镜像"><a href="#3、执行镜像" class="headerlink" title="3、执行镜像"></a>3、执行镜像</h2><p>以 win10 为例。根据文档 Oracle Database Server Docker Image Documentation（Oracle 数据库服务端 Docker 镜像文档）其中 Reusing existing database 小节内容，将本地 <code>D:\oracledata</code> 挂载到 <code>/ORCL</code>，参考命令行如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">docker run --name oracle -d -p <span class="number">1521</span>:<span class="number">1521</span> --restart=always -v <span class="attr">D</span>:<span class="regexp">/oracledata:/</span><span class="variable constant_">ORCL</span> 12a359cd0528</span><br></pre></td></tr></table></figure>

<h2 id="4、登录"><a href="#4、登录" class="headerlink" title="4、登录"></a>4、登录</h2><p>使用 Docker Desktop 进入容器命令行，执行 <code>source /home/oracle/.bashrc</code> 激活环境变量，再执行 <code>sqlplus /nolog</code>，否则提示找不到命令。</p>
<blockquote>
<p>或按照文档提示，直接执行 <code>$ docker exec -it &lt;Oracle-DB&gt; bash -c &quot;source /home/oracle/.bashrc; sqlplus /nolog&quot;</code>，效果相同；或执行 <code>docker exec -it oracle /bin/bash</code> 进入正在运行容器的命令行，执行 <code>sqlplus / as sysdba</code> 登入，这种方式不用激活环境变量。</p>
</blockquote>
<p><code>.bashrc</code> 内容如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># .bashrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source global definitions</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/bashrc ]; <span class="keyword">then</span></span><br><span class="line">        . /etc/bashrc</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following line if you don&#x27;t like systemctl&#x27;s auto-paging feature:</span></span><br><span class="line"><span class="comment"># export SYSTEMD_PAGER=</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User specific aliases and functions</span></span><br><span class="line"><span class="built_in">export</span> ORACLE_HOME=/u01/app/oracle/product/12.2.0/dbhome_1</span><br><span class="line"><span class="built_in">export</span> OH=/u01/app/oracle/product/12.2.0/dbhome_1</span><br><span class="line"><span class="built_in">export</span> PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/u01/app/oracle/product/12.2.0/dbhome_1/bin</span><br><span class="line"><span class="built_in">export</span> TNS_ADMIN=/u01/app/oracle/product/12.2.0/dbhome_1/admin/ORCLCDB</span><br><span class="line"><span class="built_in">export</span> ORACLE_SID=ORCLCDB;</span><br></pre></td></tr></table></figure>

<p>进入后连接至 SYS 账户 <code>connect / as sysdba</code></p>
<h2 id="5、修改密码（可选）"><a href="#5、修改密码（可选）" class="headerlink" title="5、修改密码（可选）"></a>5、修改密码（可选）</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">alter user sys identified by oracle;</span><br><span class="line">alter user system identified by oracle;</span><br></pre></td></tr></table></figure>

<p>之后可在命令行输入 sqlplus，用上述用户登录即可</p>
<blockquote>
<p>注：SYS 账户必需以 dba 权限登录，应输入用户名 <code>sys as sysdba</code></p>
</blockquote>
<h2 id="6、CDB-和-PDB"><a href="#6、CDB-和-PDB" class="headerlink" title="6、CDB 和 PDB"></a>6、CDB 和 PDB</h2><p>Oracle 12c 引入了 CDB 与 PDB，在 ORACLE 12c 数据库引入的多租用户环境（Multitenant Environment）中，允许一个数据库容器（CDB）承载多个可插拔数据库（PDB）。CDB 全称为 Container Database，翻译为数据库容器，PDB 全称为 Pluggable Database，即可插拔数据库。在 ORACLE 12c 之前，实例与数据库是一对一或多对一关系（RAC），即一个实例只能与一个数据库相关联，数据库可以被多个实例所加载。而实例与数据库不可能是一对多的关系。当进入 ORACLE 12c 后，实例与数据库可以是一对多的关系。</p>
<p>CDB 相当于操作系统，调用并管理各个 PDB。PDB 相当于真正提供业务需求的数据库实例。ORACLE 12c 安装后只创建了 CBD，需要自己生成相应的 PDB。平时的数据库操作大多数和 PDB 相关。</p>
<blockquote>
<p>注：数据库创建完成后默认带有一个名为 ORCLPDB1 的 PDB</p>
</blockquote>
<p>相关命令：</p>
<ul>
<li><code>select name,open_mode from v$pdbs;</code> 用来查看当前 CDB 容器中包含的 PDB 容器</li>
<li><code>show pdbs;</code> 查看全部目前的 PDB</li>
<li><code>show con_name;</code> 查看当前所在是 CDB 还是 PDB</li>
</ul>
<h2 id="7、用户分类"><a href="#7、用户分类" class="headerlink" title="7、用户分类"></a>7、用户分类</h2><p>Oracle 12c 的用户分为公共用户和本地用户</p>
<p>公共用户：可以为 CDB 管理员创建，公共用户是在所有的 PDB 中都可以使用的用户，公共用户的信息存在 CDB$ROOT 中，并且存在于所有的 PDB 中。公共用户需要连到 CDB 进行创建和管理。在 CDB 中创建的用户默认就是公共用户，可以省略 container&#x3D;all，在 CDB 中只能创建公共用户，不能创建本地用户。</p>
<p>本地用户：本地用户只会存储在对应的 PDB 中，在 PDB 中创建的用户默认就是本地用户，可以省略 container&#x3D;current，在 PDB 中只能创建本地用户，不能创建公共用户。</p>
<p>为了区分公共用和本地用户，引进了新的参数 common_user_perfix，表示公共用户的前缀，默认为 c##，也就是说如果创建了一个公共用户，必须带上前缀，如果不加 c##，则会提示错误 <code>ORA-65096：公用用户名或角色名无效</code>。此前缀是可以进行修改的，但是建议不要修改。执行以下命令查看前缀：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">show parameter common_user;</span><br></pre></td></tr></table></figure>

<p>创建用户并授权</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">create user C<span class="comment">##test identified by 123456;</span></span><br><span class="line">grant connect,<span class="built_in">source</span>,dba to C<span class="comment">##test;</span></span><br></pre></td></tr></table></figure>

<h2 id="8、切换至-PDB"><a href="#8、切换至-PDB" class="headerlink" title="8、切换至 PDB"></a>8、切换至 PDB</h2><p>注意：使用这个命令需要的 sysdba 级别的权限，否则无法执行。切换后才可使用当前 PDB 的私有用户进行操作，12c 数据库创建完成后，默认情况下，使用 <code>sqlplus / as sysdba</code> 登录连接的是 CDB</p>
<p>执行 <code>show con_name;</code>，当前在 CDB 容器中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CON_NAME</span><br><span class="line">------------------------------</span><br><span class="line">CDB<span class="variable">$ROOT</span></span><br></pre></td></tr></table></figure>

<p>使用 <code>show pdbs;</code> 查询目前现有的 PDB 容器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span><br><span class="line">---------- ------------------------------ ---------- ----------</span><br><span class="line">         2 PDB<span class="variable">$SEED</span>                       READ ONLY  NO</span><br><span class="line">         3 ORCLPDB1                       READ WRITE NO</span><br></pre></td></tr></table></figure>

<p>使用下列命令切换</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter session <span class="built_in">set</span> container=ORCLPDB1;</span><br></pre></td></tr></table></figure>

<p>执行 <code>show con_name;</code> 验证：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CON_NAME</span><br><span class="line">------------------------------</span><br><span class="line">ORCLPDB1</span><br></pre></td></tr></table></figure>

<p>说明切换成功，此时就可以创建本地用户并授权：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; create user <span class="built_in">test</span> identified by 123456;</span><br><span class="line">SQL&gt; grant dba to <span class="built_in">test</span>;</span><br></pre></td></tr></table></figure>

<h2 id="9、切换至-CDB"><a href="#9、切换至-CDB" class="headerlink" title="9、切换至 CDB"></a>9、切换至 CDB</h2><p>如果要切换回 CDB 容器只需将容器名换为 CDB 容器的名字即可，一个 CDB 只有一个根</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter session <span class="built_in">set</span> container=CDB<span class="variable">$ROOT</span>;</span><br></pre></td></tr></table></figure>

<h2 id="10、登陆或连接"><a href="#10、登陆或连接" class="headerlink" title="10、登陆或连接"></a>10、登陆或连接</h2><p>使用 DataGrip 登录 PDB 使用 serviceName 登录，默认为实例名称后加 localdomain（例如 ORCLPDB1.localdomain），可通过 tnsnames.ora 查看。查找文件所在路径：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find / -name tnsnames.ora</span><br><span class="line">/u01/app/oracle/product/12.2.0/dbhome_1/network/admin/samples/tnsnames.ora</span><br><span class="line">/u01/app/oracle/product/12.2.0/dbhome_1/admin/ORCLCDB/tnsnames.ora</span><br></pre></td></tr></table></figure>

<p>观察环境变量 <code>export TNS_ADMIN=/u01/app/oracle/product/12.2.0/dbhome_1/admin/ORCLCDB</code> 可知正确路径。从 <code>ORCLCDB/tnsnames.ora</code> 可看到 ORCLCDB 和 ORCLPDB 的 serviceName，或用命令查询当前可用 serviceName</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; select name,pdb from v<span class="variable">$services</span> order by name;</span><br></pre></td></tr></table></figure>

<h2 id="11、查看用户"><a href="#11、查看用户" class="headerlink" title="11、查看用户"></a>11、查看用户</h2><p>如果处在 CDB$ROOT 中查询 DBA 视图，那么只能查询到公共的数据字典；如果处在 PDB 中，那么查询 DBA 视图只能查到此 PDB 的数据字典。12c 中新增了 CDB 数据字典,可以查看所有的数据字典。所以，当在 CDB 中查询 dba_users，那你只能查询到公共的用户，当处于 PDB 中，只能查到 PDB 中的本地用户；如果想查询所有的用户，可以使用下的语句。其中新增 oracle_maintained 字段提示了此用户是否由 oracle 管理：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; select a.username,a.common,a.con_id,decode(a.CON_ID,1,<span class="string">&#x27;CDB$ROOT&#x27;</span>,b.pdb_name) name from cdb_users a,cdb_pdbs b</span><br><span class="line"><span class="built_in">where</span> a.con_id=b.con_id(+) and oracle_maintained=<span class="string">&#x27;N&#x27;</span></span><br><span class="line">order by a.con_id,a.username;</span><br></pre></td></tr></table></figure>

<p>以此类推，公共用户修改密码只能在 <code>CDB$ROOT</code> 中进行修改；本地用户只能在 PDB 中进行修改：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter user c<span class="comment">##cdb identified by newcdb;</span></span><br></pre></td></tr></table></figure>

<h2 id="12、删除用户"><a href="#12、删除用户" class="headerlink" title="12、删除用户"></a>12、删除用户</h2><p>命令：<code>drop user C##用户名</code></p>
<p>若用户拥有对象，则不能直接删除，否则将返回一个错误值。指定关键字 cascade，可删除用户所有的对象，然后再删除用户。</p>
<h2 id="13、用户授权"><a href="#13、用户授权" class="headerlink" title="13、用户授权"></a>13、用户授权</h2><p>创建一个公共用户，此时是没有任何登录权限的：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; create user c<span class="comment">##cdb identified by cdb;</span></span><br><span class="line"></span><br><span class="line">User created.</span><br><span class="line"></span><br><span class="line">SQL&gt; show pdbs;</span><br><span class="line"></span><br><span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span><br><span class="line">---------- ------------------------------ ---------- ----------</span><br><span class="line">         2 PDB<span class="variable">$SEED</span>                       READ ONLY  NO</span><br><span class="line">         3 ORCLPDB1                       READ WRITE NO</span><br><span class="line"></span><br><span class="line">SQL&gt; show con_name</span><br><span class="line"></span><br><span class="line">CON_NAME</span><br><span class="line">------------------------------</span><br><span class="line">CDB<span class="variable">$ROOT</span></span><br><span class="line"></span><br><span class="line">SQL&gt; conn c<span class="comment">##cdb/cdb</span></span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line">ORA-01045: user c<span class="comment">##cdb lacks CREATE SESSION privilege; logon denied</span></span><br><span class="line"></span><br><span class="line">Warning: You are no longer connected to ORACLE.</span><br></pre></td></tr></table></figure>

<p>在 CDB 中赋予 c##cdb 登录权限后，就可以登录到 CDB。登录 sys 账户进行授权（登录时默认在 CDB 中）：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">conn / as sysdba</span><br><span class="line"></span><br><span class="line">Connected.</span><br><span class="line"></span><br><span class="line">SQL&gt; grant create session to c<span class="comment">##cdb;</span></span><br><span class="line"></span><br><span class="line">Grant succeeded.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：grant 不添加 container 子句，则默认为当前容器，即 <code>grant create session to c##cdb container=current;</code></p>
</blockquote>
<p>配置权限后可成功切换用户：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; conn c<span class="comment">##cdb/cdb</span></span><br><span class="line"></span><br><span class="line">Connected.</span><br></pre></td></tr></table></figure>

<p>在 PDB 内部的授权为本地授权，可以在 PDB 中对公共用户进行授权。公共用户虽然在所有 PDB 中都存在，但并不是创建了公共用户就有权限访问所有 PDB，还需要单独赋予 create session 权限。此时还没有赋予单独的 PDB 权限给账户，当尝试连接其他 PDB 时会报错：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter session <span class="built_in">set</span> container=ORCLPDB1;</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line">ORA-01031: insufficient privileges</span><br></pre></td></tr></table></figure>

<p>通过登录 sys 账户连接 PDB，再对账户进行授权：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; conn / as sysdba</span><br><span class="line"></span><br><span class="line">Connected.</span><br><span class="line"></span><br><span class="line">SQL&gt; show con_name</span><br><span class="line"></span><br><span class="line">CON_NAME</span><br><span class="line">------------------------------</span><br><span class="line">CDB<span class="variable">$ROOT</span></span><br><span class="line"></span><br><span class="line">SQL&gt; alter session <span class="built_in">set</span> container=brent;</span><br><span class="line"></span><br><span class="line">Session altered.</span><br><span class="line"></span><br><span class="line">SQL&gt; grant create session to c<span class="comment">##cdb with admin option container=current;</span></span><br><span class="line"></span><br><span class="line">Grant succeeded.</span><br></pre></td></tr></table></figure>

<p>或者对公共用户进行公共授权，授权之后的用户就拥有了所有 PDB 的相关权限：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; grant create session to c<span class="comment">##cdb container=all;</span></span><br></pre></td></tr></table></figure>

<h2 id="14、查看权限"><a href="#14、查看权限" class="headerlink" title="14、查看权限"></a>14、查看权限</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; select * from dba_sys_privs <span class="built_in">where</span> grantee like <span class="string">&#x27;C##%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="15、撤销权限"><a href="#15、撤销权限" class="headerlink" title="15、撤销权限"></a>15、撤销权限</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt;revoke create table from <span class="built_in">test</span>;</span><br></pre></td></tr></table></figure>

<h2 id="16、通过-pdbseed-新建-PDB"><a href="#16、通过-pdbseed-新建-PDB" class="headerlink" title="16、通过 pdbseed 新建 PDB"></a>16、通过 pdbseed 新建 PDB</h2><p>查找 pdbseed 目录的路径，例如 <code>/u02/app/oracle/oradata/ORCL/pdbseed</code>（可在挂载目录中查看），使用 sys 用户下执行下列命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; create pluggable database ORCLPDB2 admin user pdbadmin identified by oracle roles=(resource) file_name_convert=(<span class="string">&#x27;/u02/app/oracle/oradata/ORCL/pdbseed&#x27;</span>,<span class="string">&#x27;/u02/app/oracle/oradata/ORCL/orclpdb2&#x27;</span>);</span><br><span class="line"></span><br><span class="line">Pluggable database created.</span><br><span class="line"></span><br><span class="line">SQL&gt; show pdbs;</span><br><span class="line"></span><br><span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span><br><span class="line">---------- ------------------------------ ---------- ----------</span><br><span class="line">         2 PDB<span class="variable">$SEED</span>                       READ ONLY  NO</span><br><span class="line">         3 ORCLPDB1                       READ WRITE NO</span><br><span class="line">         4 ORCLPDB2                       MOUNTED</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注 1：orclpdb2 目录不存在，执行后自行建立；注 2：要在 CBD 容器下下执行该命令</p>
</blockquote>
<h2 id="17、克隆本地-PDB-新建-PDB"><a href="#17、克隆本地-PDB-新建-PDB" class="headerlink" title="17、克隆本地 PDB 新建 PDB"></a>17、克隆本地 PDB 新建 PDB</h2><p>被克隆的 PDB 模式要修改为 read only</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter pluggable database ORCLPDB2 close;</span><br><span class="line">SQL&gt; alter pluggable database ORCLPDB2 open <span class="built_in">read</span> only;</span><br><span class="line">SQL&gt; create pluggable database ORCLPDB3 from ORCLPDB2 file_name_convert=(<span class="string">&#x27;/u02/app/oracle/oradata/ORCL/orclpdb2&#x27;</span>,<span class="string">&#x27;/u02/app/oracle/oradata/ORCL/orclpdb3&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="18、更改-PDB-模式"><a href="#18、更改-PDB-模式" class="headerlink" title="18、更改 PDB 模式"></a>18、更改 PDB 模式</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">alter pluggable database ORCLPDB2 open <span class="built_in">read</span> write;</span><br></pre></td></tr></table></figure>

<p>登陆时提示错误</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ERROR:</span><br><span class="line">ORA-01017: invalid username/password; logon denied</span><br><span class="line"></span><br><span class="line">Warning: You are no longer connected to ORACLE.</span><br></pre></td></tr></table></figure>

<p>注意用户是否授权，另外要增加连接符，具体在 tnsnames.ora 文件中新加一个连接符，再重新启动监听器 lsnrctl start</p>
<h2 id="19、保持-PDB-模式"><a href="#19、保持-PDB-模式" class="headerlink" title="19、保持 PDB 模式"></a>19、保持 PDB 模式</h2><p>完成常规配置后，当 CDB 实例关闭重新开启后会重置 PDB 的模式为 <code>MOUNTED</code>，此时可执行 <code>alter pluggable database ORCLPDB2 open;</code> 手动启动。或在 PDB 启动后使用 <code>alter pluggable database all save state;</code> 命令，保持状态，让 PDB 保持启动。或者通过在 CDB 新建触发器：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL&gt;create or replace trigger auto_open_pdbs</span><br><span class="line">after startup on database</span><br><span class="line">begin</span><br><span class="line">execute immediate <span class="string">&#x27;alter pluggable database all open&#x27;</span>;</span><br><span class="line">end;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>其他相关命令：</p>
<ul>
<li><code>alter pluggable database all except ORCLPDB2 close;</code>，除 ORCLPDB2 外关闭全部 PDB</li>
<li><code>alter pluggable database all open;</code>，开启全部 PDB</li>
<li><code>alter pluggable database all close immediate;</code>，关闭全部 PDB</li>
<li><code>shutdown immediate;</code>，关闭 CDB</li>
<li><code>startup mount;</code>，启动 CDB</li>
</ul>
<h2 id="20、密码过期"><a href="#20、密码过期" class="headerlink" title="20、密码过期"></a>20、密码过期</h2><p>1、执行 <code>docker exec -it oracle /bin/bash</code> 进入正在运行容器的命令行，执行 <code>sqlplus / as sysdba</code> 登入</p>
<p>2、关闭密码过期机制</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">alter profile default <span class="built_in">limit</span> password_life_time unlimited;</span><br></pre></td></tr></table></figure>

<p>3、切换到所在容器，例如 ORCLPDB1</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">alter session <span class="built_in">set</span> container=ORCLPDB1;</span><br></pre></td></tr></table></figure>

<p>4、重新修改用户密码 abc2，再改回旧密码 abc 即可</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">alter user abc identified by abc2;</span><br></pre></td></tr></table></figure>

<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>1、 如果在 PDB 中已经存在一个用户或者角色，则在 CDB 中不能创建相同的账号或者角色名。</p>
<p>2、 同样在 CDB 中创建账号后不能在 PDB 中出现同名的账号，因 CDB 中的账号对所有的 PDB 都是有效的。</p>
<p>3、 在 CDB 中创建的账号将会在全部的 PDB 中出现，但是在 CDB 中的授权，如非特别指定的话，并不能传递到 PDB 中。</p>
<p>4、 针对同一个共有账号在 PDB 下创建的账号在 CDB 是看不到的。针对同一个共有账号，在 PDB 和 CDB 下创建的共有账号因在 CDB 和 PDB 下被赋予了不同的含义，故在 CDB 下创建的对象和在 PDB 下创建的对象是可以同名的，反之也成立。</p>
<h2 id="其他查询"><a href="#其他查询" class="headerlink" title="其他查询"></a>其他查询</h2><p>1、查看所有用户：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">select * from dba_users;</span><br><span class="line">select * from all_users;</span><br><span class="line">select * from user_users;</span><br></pre></td></tr></table></figure>

<p>2、查看用户或角色系统权限(直接赋值给用户或角色的系 bai 统权限)：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">select * from dba_sys_privs;</span><br><span class="line">select * from user_sys_privs; (查看当前用户所拥有的权限)</span><br></pre></td></tr></table></figure>

<p>3、查看角色(只能查看登陆用户拥有的角色)所包含的权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sql&gt;select * from role_sys_privs;</span><br></pre></td></tr></table></figure>

<p>4、查看用户对象权限：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">select * from dba_tab_privs;</span><br><span class="line">select * from all_tab_privs;</span><br><span class="line">select * from user_tab_privs;</span><br></pre></td></tr></table></figure>

<p>5、查看所有角色：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">select * from dba_roles;</span><br></pre></td></tr></table></figure>

<p>6、查看用户或角色所拥有的角色：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">select * from dba_role_privs;</span><br><span class="line">select * from user_role_privs;</span><br></pre></td></tr></table></figure>

<p>7.查看哪些用户有 sysdba 或 sysoper 系统权限(查询时需要相应权限)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">select * from V<span class="variable">$PWFILE_USERS</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo-next-主题构建首页动态更新目录</title>
    <url>/5886f890-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<blockquote>
</blockquote>
<!-- more -->

<h3 id="1-问题及需求"><a href="#1-问题及需求" class="headerlink" title="1 问题及需求"></a>1 问题及需求</h3><p><strong>问题</strong></p>
<ul>
<li>首页（home）默认显示按日期排序的文章列表，使用 <code>&lt;!-- more --&gt;</code> 省略内容仍显得繁杂冗长；</li>
<li>分类（categories）页面虽然有按类型、日期排序的文章列表，但切换分类需要往返多次。</li>
</ul>
<p><strong>需求</strong></p>
<ul>
<li>建立一个首页目录，将文章分类（categories 参数）和标题，分别作为列表的一级、二级显示；</li>
<li>标题即为文章链接，点击可直接到达；想查看其他分类，直接回到首页即可。</li>
</ul>
<h3 id="2-解决方案"><a href="#2-解决方案" class="headerlink" title="2 解决方案"></a>2 解决方案</h3><h3 id="2-1-建立文件"><a href="#2-1-建立文件" class="headerlink" title="2.1 建立文件"></a>2.1 建立文件</h3><p>在 <code>source/</code> 下建立 <code>index.md</code>，命名标题，内容留空。</p>
<h3 id="2-2-关闭默认首页"><a href="#2-2-关闭默认首页" class="headerlink" title="2.2 关闭默认首页"></a>2.2 关闭默认首页</h3><p>修改 hexo 配置文件 <code>_config.yml</code>，找到 <code>index_generator</code> 配置项，修改 <code>path</code> 属性为一个无效值：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="attr">index_generator</span>:</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line">  <span class="attr">per_page</span>: <span class="number">10</span></span><br><span class="line">  <span class="attr">order_by</span>: -date</span><br></pre></td></tr></table></figure>

<p>此时启动项目后，首页将不再出现文章列表，转而显示 <code>index.md</code> 内容。</p>
<blockquote>
<p>注：<code>index.md</code> 在渲染后成为 <code>index.html</code></p>
</blockquote>
<h3 id="3-动态更新目录"><a href="#3-动态更新目录" class="headerlink" title="3 动态更新目录"></a>3 动态更新目录</h3><p>若文章分类多，每次更新、调整文章都需要将相应链接手工同步到首页也是一件相当繁琐的事情。因此有必要考虑自动更新首页。</p>
<h3 id="3-1-hexo-加载顺序"><a href="#3-1-hexo-加载顺序" class="headerlink" title="3.1 hexo 加载顺序"></a>3.1 hexo 加载顺序</h3><p>根据 hexo 文档 <a href="https://hexo.io/zh-cn/api/posts#%E6%B8%B2%E6%9F%93">https://hexo.io/zh-cn/api/posts#%E6%B8%B2%E6%9F%93</a> 关于渲染顺序的说明，要实现 <code>index.md</code> 的写入，要在 <code>hexo g</code> 命令执行之前完成，可引入 before_post_render 过滤器实现该需求。</p>
<h3 id="3-2-hexo-过滤器"><a href="#3-2-hexo-过滤器" class="headerlink" title="3.2 hexo 过滤器"></a>3.2 hexo 过滤器</h3><p>过滤器文档：<a href="https://hexo.io/zh-cn/api/filter#%E6%A6%82%E8%A6%81">https://hexo.io/zh-cn/api/filter#%E6%A6%82%E8%A6%81</a></p>
<p>在主题目录下 <code>themes\next\filters\</code> 新建 <code>index.js</code>，添加 priority 分别为 9 和 10 的两个 before_post_render 过滤器，如下所示：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> categoriesMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">filter</span>.<span class="title function_">register</span>(<span class="string">&#x27;before_post_render&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 首页目录不显示草稿内容</span></span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">source</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;_drafts&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">path</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;index&quot;</span>) &lt; <span class="number">0</span> &amp;&amp; data.<span class="property">categories</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> curCategorie = data.<span class="property">categories</span>.<span class="property">data</span>[<span class="number">0</span>].<span class="property">name</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (categoriesMap.<span class="title function_">has</span>(curCategorie)) &#123;</span><br><span class="line">            <span class="keyword">let</span> valueArray = categoriesMap.<span class="title function_">get</span>(curCategorie);</span><br><span class="line">            valueArray = valueArray.<span class="title function_">concat</span>(<span class="string">`  - [<span class="subst">$&#123;data.title&#125;</span>](/<span class="subst">$&#123;data.path&#125;</span>)\n`</span>)</span><br><span class="line">            categoriesMap.<span class="title function_">set</span>(curCategorie, valueArray);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            categoriesMap.<span class="title function_">set</span>(curCategorie, [<span class="string">`  - [<span class="subst">$&#123;data.title&#125;</span>](/<span class="subst">$&#123;data.path&#125;</span>)\n`</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">hexo.<span class="property">extend</span>.<span class="property">filter</span>.<span class="title function_">register</span>(<span class="string">&#x27;before_post_render&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 精确定位index.html，防止误写其他路径不同但同名的文件</span></span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">path</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;index&quot;</span>) === <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">of</span> categoriesMap.<span class="title function_">keys</span>()) &#123;</span><br><span class="line">            data.<span class="property">content</span> += <span class="string">`- <span class="subst">$&#123;key&#125;</span>\n`</span></span><br><span class="line">            <span class="keyword">let</span> valueArray = categoriesMap.<span class="title function_">get</span>(key);</span><br><span class="line">            valueArray.<span class="title function_">forEach</span>(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">                data.<span class="property">content</span> += element;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;, <span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p>代码说明</p>
<ul>
<li>第一个过滤器遍历全部文章，获取所有现存的分类及所属文章链接；</li>
<li>第二个过滤器写入 <code>index.html</code></li>
</ul>
<h3 id="3-3-有关属性"><a href="#3-3-有关属性" class="headerlink" title="3.3 有关属性"></a>3.3 有关属性</h3><p>为探究 data 为何物，可打断点观察其结构：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  title<span class="punctuation">:</span> <span class="string">&quot;DataGrip-2018.3.4-数据导出配置案例&quot;</span><span class="punctuation">,</span></span><br><span class="line">  date<span class="punctuation">:</span> <span class="punctuation">&#123;</span>……文章生成日期的有关参数（略）<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  _content<span class="punctuation">:</span> <span class="string">&quot;……正文内容（略）&quot;</span><span class="punctuation">,</span></span><br><span class="line">  source<span class="punctuation">:</span> <span class="string">&quot;_posts/DataGrip-2018-3-4-数据导出配置案例.md&quot;</span><span class="punctuation">,</span></span><br><span class="line">  raw<span class="punctuation">:</span> <span class="string">&quot;……正文内容（略）&quot;</span><span class="punctuation">,</span></span><br><span class="line">  slug<span class="punctuation">:</span> <span class="string">&quot;DataGrip-2018-3-4-数据导出配置案例&quot;</span><span class="punctuation">,</span></span><br><span class="line">  published<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  updated<span class="punctuation">:</span> <span class="punctuation">&#123;</span>……文章更新日期的有关参数（略）<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  comments<span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  layout<span class="punctuation">:</span> <span class="string">&quot;post&quot;</span><span class="punctuation">,</span></span><br><span class="line">  photos<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  link<span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  _id<span class="punctuation">:</span> <span class="string">&quot;cljzhnjmb001oz0u6en5ab6xb&quot;</span><span class="punctuation">,</span></span><br><span class="line">  path<span class="punctuation">:</span> <span class="string">&quot;2022/12/07/DataGrip-2018-3-4-数据导出配置案例/&quot;</span><span class="punctuation">,</span></span><br><span class="line">  permalink<span class="punctuation">:</span> <span class="string">&quot;http://www.dcheng.site/2022/12/07/DataGrip-2018-3-4-%E6%95%B0%E6%8D%AE%E5%AF%BC%E5%87%BA%E9%85%8D%E7%BD%AE%E6%A1%88%E4%BE%8B/&quot;</span><span class="punctuation">,</span></span><br><span class="line">  full_source<span class="punctuation">:</span> <span class="string">&quot;C:\\mainProjects\\blog\\source\\_posts\\DataGrip-2018-3-4-数据导出配置案例.md&quot;</span><span class="punctuation">,</span></span><br><span class="line">  asset_dir<span class="punctuation">:</span> <span class="string">&quot;C:\\mainProjects\\blog\\source\\_posts\\DataGrip-2018-3-4-数据导出配置案例\\&quot;</span><span class="punctuation">,</span></span><br><span class="line">  tags<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    data<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        name<span class="punctuation">:</span> <span class="string">&quot;DataGrip&quot;</span><span class="punctuation">,</span></span><br><span class="line">        _id<span class="punctuation">:</span> <span class="string">&quot;cljzhnjmc001uz0u6hlov172o&quot;</span><span class="punctuation">,</span></span><br><span class="line">        slug<span class="punctuation">:</span> <span class="string">&quot;DataGrip&quot;</span><span class="punctuation">,</span></span><br><span class="line">        path<span class="punctuation">:</span> <span class="string">&quot;tags/DataGrip/&quot;</span><span class="punctuation">,</span></span><br><span class="line">        permalink<span class="punctuation">:</span> <span class="string">&quot;http://www.dcheng.site/tags/DataGrip/&quot;</span><span class="punctuation">,</span></span><br><span class="line">        posts<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          data<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          length<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        length<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    length<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  categories<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    data<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        name<span class="punctuation">:</span> <span class="string">&quot;配置案例&quot;</span><span class="punctuation">,</span></span><br><span class="line">        _id<span class="punctuation">:</span> <span class="string">&quot;cljzhnjmc001tz0u6967u3bji&quot;</span><span class="punctuation">,</span></span><br><span class="line">        slug<span class="punctuation">:</span> <span class="string">&quot;配置案例&quot;</span><span class="punctuation">,</span></span><br><span class="line">        path<span class="punctuation">:</span> <span class="string">&quot;categories/配置案例/&quot;</span><span class="punctuation">,</span></span><br><span class="line">        permalink<span class="punctuation">:</span> <span class="string">&quot;http://www.dcheng.site/categories/%E9%85%8D%E7%BD%AE%E6%A1%88%E4%BE%8B/&quot;</span><span class="punctuation">,</span></span><br><span class="line">        posts<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          data<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          length<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        length<span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    length<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  content<span class="punctuation">:</span> <span class="string">&quot;……正文内容（略）&quot;</span><span class="punctuation">,</span></span><br><span class="line">  site<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    data<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-最终效果"><a href="#4-最终效果" class="headerlink" title="4 最终效果"></a>4 最终效果</h3><p><img src="/5886f890-2a1e-11ee-846a-89c1529ebdf1/%E5%9B%BE1-%E9%BB%98%E8%AE%A4%E6%95%88%E6%9E%9C.png" alt="图1-默认效果"></p>
<center>图1-默认效果</center>

</br>

<p><img src="/5886f890-2a1e-11ee-846a-89c1529ebdf1/%E5%9B%BE2-%E5%8A%A8%E6%80%81%E7%9B%AE%E5%BD%95%E6%95%88%E6%9E%9C.png" alt="图2-动态目录效果"></p>
<center>图2-动态目录效果</center>

<hr>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>未标记</tag>
      </tags>
  </entry>
  <entry>
    <title>win-环境下-node-压缩版安装</title>
    <url>/ed0e3b50-441c-11ee-bc1a-25c3478a32d1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、下载-Windows-Binary-zip-包"><a href="#1、下载-Windows-Binary-zip-包" class="headerlink" title="1、下载 Windows Binary (.zip)包"></a>1、下载 Windows Binary (.zip)包</h2><p>地址：<a href="https://nodejs.org/en/download">https://nodejs.org/en/download</a></p>
<h2 id="2、设置"><a href="#2、设置" class="headerlink" title="2、设置"></a>2、设置</h2><p>解压到安装位置后，新建 <code>node-cache</code> 和 <code>node-global</code> 两个目录。开启 cmd 控制台切换到安装位置，执行配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> D:\node-v18.17.1-win-x64</span><br><span class="line">npm config <span class="built_in">set</span> cache <span class="string">&quot;D:\node-v18.17.1-win-x64\node-cache&quot;</span></span><br><span class="line">npm config <span class="built_in">set</span> prefix <span class="string">&quot;D:\node-v18.17.1-win-x64\node-global&quot;</span></span><br></pre></td></tr></table></figure>

<p>添加如下环境变量</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\node-v18.17.1-win-x64</span><br><span class="line">D:\node-v18.17.1-win-x64\node-global</span><br></pre></td></tr></table></figure>

<p>任意位置执行查看版本命令确认安装情况：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">c:\&gt;npm -v</span><br><span class="line">9.6.7</span><br><span class="line"></span><br><span class="line">c:\&gt;node -v</span><br><span class="line">v18.17.1</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>node</tag>
      </tags>
  </entry>
  <entry>
    <title>ubuntu-配置共享文件夹</title>
    <url>/0255ad60-4353-11ee-bed6-3d33eaf7fa7a/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<p>官网：<a href="https://www.samba.org/">https://www.samba.org/</a></p>
<h2 id="1、安装-samba-服务器"><a href="#1、安装-samba-服务器" class="headerlink" title="1、安装 samba 服务器"></a>1、安装 samba 服务器</h2><p>执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install samba samba-common</span><br></pre></td></tr></table></figure>

<p>可通过 <code>samba -V</code> 查看是否安装成功，输出结果：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Version 4.15.13-Ubuntu</span><br></pre></td></tr></table></figure>

<h2 id="2、创建目录"><a href="#2、创建目录" class="headerlink" title="2、创建目录"></a>2、创建目录</h2><p>假设共享路径为：<code>/home/share</code></p>
<p>修改权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> 777 /home/share</span><br></pre></td></tr></table></figure>

<h2 id="3、修改配置文件"><a href="#3、修改配置文件" class="headerlink" title="3、修改配置文件"></a>3、修改配置文件</h2><p>执行 <code>sudo vim /etc/samba/smb.conf</code> 增加如下内容：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[src_share]</span><br><span class="line">comment = share</span><br><span class="line">path = /home/ubuntu/src</span><br><span class="line">public = <span class="built_in">yes</span></span><br><span class="line">browseable = <span class="built_in">yes</span></span><br><span class="line">writable = <span class="built_in">yes</span></span><br><span class="line">valid <span class="built_in">users</span> = ubuntu</span><br><span class="line">create mask = 777</span><br><span class="line">directory mask = 777</span><br><span class="line">available = <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<p>参数意义</p>
<ul>
<li><code>[src_share]</code>，显示的共享文件夹名称</li>
<li><code>comment</code>：注释说明</li>
<li><code>path</code>：共享路径</li>
<li><code>browseable</code>：是否在 Window Explorer 中显示该目录</li>
<li><code>writable</code>：写权限</li>
<li><code>valid users</code>：可以访问的用户</li>
<li><code>create mask</code>：新建立的文件的属性</li>
<li><code>directory mask</code>：新建立的目录的属性</li>
<li><code>available</code>：共享资源是否可用</li>
</ul>
<h2 id="4、添加-samba-访问账号及密码"><a href="#4、添加-samba-访问账号及密码" class="headerlink" title="4、添加 samba 访问账号及密码"></a>4、添加 samba 访问账号及密码</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo smbpasswd -a username</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：该用户需要在系统用户列表；可执行 <code>sudo pdbedit -L</code> 查看允许访问的用户。</p>
</blockquote>
<h2 id="5、重启服务"><a href="#5、重启服务" class="headerlink" title="5、重启服务"></a>5、重启服务</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo service smbd restart</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title>win、ubuntu 环境安装 postgresql 15</title>
    <url>/0255ad61-4353-11ee-bed6-3d33eaf7fa7a/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、win10-或-Windows-Server-2022-Datacenter"><a href="#1、win10-或-Windows-Server-2022-Datacenter" class="headerlink" title="1、win10 或 Windows Server 2022 Datacenter"></a>1、win10 或 Windows Server 2022 Datacenter</h2><p>下载地址：<a href="https://www.enterprisedb.com/download-postgresql-binaries">https://www.enterprisedb.com/download-postgresql-binaries</a></p>
<h2 id="1-1、执行安装"><a href="#1-1、执行安装" class="headerlink" title="1.1、执行安装"></a>1.1、执行安装</h2><p>1）解压，并添加 <code>pgsql\bin</code> 到环境变量。</p>
<p>2）新建目录 <code>C:\pgsql\data</code>，执行 <code>initdb -U postgres -A password -E UTF-8 -W -D C:\pgsql\data</code>，该步骤将提示输入密码。</p>
<p>3）执行 <code>pg_ctl -D &quot;C:/pgsql/data&quot; start</code> 启动服务。</p>
<p>4）执行 <code>psql -U postgres</code> 登录，输入之前步骤的密码。</p>
<blockquote>
<p>注意：控制台方式启动服务，当关闭控制台时，服务随即终止。若要保持后台启动，需要注册服务。</p>
</blockquote>
<p>5）注册服务：以管理员身份执行 <code>pg_ctl register -N PostgreSQL -D &quot;C:/pgsql/data&quot;</code>，再执行 <code>net start PostgreSQL</code></p>
<h2 id="2、ubuntu-22-04"><a href="#2、ubuntu-22-04" class="headerlink" title="2、ubuntu 22.04"></a>2、ubuntu 22.04</h2><h2 id="2-1、官方文档"><a href="#2-1、官方文档" class="headerlink" title="2.1、官方文档"></a>2.1、官方文档</h2><p>文档地址：<a href="https://www.postgresql.org/download/linux/ubuntu/">https://www.postgresql.org/download/linux/ubuntu/</a> （version：20230726）</p>
<p><strong>Linux downloads (Ubuntu) Ubuntu</strong></p>
<p>PostgreSQL is available in all Ubuntu versions by default. However, Ubuntu “snapshots” a specific version of PostgreSQL that is then supported throughout the lifetime of that Ubuntu version. Other versions of PostgreSQL are available through the PostgreSQL apt repository.</p>
<p><strong>PostgreSQL Apt Repository</strong></p>
<p>If the version included in your version of Ubuntu is not the one you want, you can use the PostgreSQL Apt Repository. This repository will integrate with your normal systems and patch management, and provide automatic updates for all supported versions of PostgreSQL throughout the support lifetime of PostgreSQL.</p>
<p>The PostgreSQL Apt Repository supports the current versions of Ubuntu:</p>
<ul>
<li>kinetic (22.10, non-LTS)</li>
<li>jammy (22.04, LTS)</li>
<li>focal (20.04, LTS)</li>
<li>bionic (18.04, LTS)</li>
</ul>
<p>on the following architectures:</p>
<ul>
<li>amd64</li>
<li>arm64 (18.04 and newer; LTS releases only)</li>
<li>i386 (18.04 and older)</li>
<li>ppc64el (LTS releases only)</li>
</ul>
<p>To use the apt repository, follow these steps:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Create the file repository configuration:</span></span><br><span class="line">sudo sh -c <span class="string">&#x27;echo &quot;deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main&quot; &gt; /etc/apt/sources.list.d/pgdg.list&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Import the repository signing key:</span></span><br><span class="line">wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -</span><br><span class="line"></span><br><span class="line"><span class="comment"># Update the package lists:</span></span><br><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install the latest version of PostgreSQL.</span></span><br><span class="line"><span class="comment"># If you want a specific version, use &#x27;postgresql-12&#x27; or similar instead of &#x27;postgresql&#x27;:</span></span><br><span class="line">sudo apt-get -y install postgresql-15</span><br></pre></td></tr></table></figure>

<p>For more information about the apt repository, including answers to frequent questions, please see the PostgreSQL Apt Repository page on the wiki.</p>
<p><strong>Included in distribution</strong></p>
<p>Ubuntu includes PostgreSQL by default. To install PostgreSQL on Ubuntu, use the apt-get (or other apt-driving) command:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt-get install postgresql-12</span><br></pre></td></tr></table></figure>

<p>The repository contains many different packages including third party addons. The most common and important packages are (substitute the version number as required):</p>
<h2 id="2-2、执行-pg-15-3-安装"><a href="#2-2、执行-pg-15-3-安装" class="headerlink" title="2.2、执行 pg-15.3 安装"></a>2.2、执行 pg-15.3 安装</h2><p>执行 <code>sudo apt-get -y install postgresql-15</code> 将安装 15.3</p>
<h2 id="2-3、查看服务"><a href="#2-3、查看服务" class="headerlink" title="2.3、查看服务"></a>2.3、查看服务</h2><p>执行 <code>sudo systemctl status postgresql</code> 查看服务运行情况：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">postgresql.service - PostgreSQL RDBMS</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/postgresql.service; enabled; vendor preset:&gt;</span><br><span class="line">     Active: active (exited) since Tue 2023-07-25 09:55:14 CST; 12min ago</span><br><span class="line">   Main PID: 4625 (code=exited, status=0/SUCCESS)</span><br><span class="line">        CPU: 2ms</span><br></pre></td></tr></table></figure>

<h2 id="2-3、查看路径"><a href="#2-3、查看路径" class="headerlink" title="2.3、查看路径"></a>2.3、查看路径</h2><p>执行 <code>ps -ef | grep postgres | grep -v &#39;grep&#39;</code> 显示如下内容：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">postgres    5671       1  0 09:55 ?        00:00:00 /usr/lib/postgresql/15/bin/postgres -D /var/lib/postgresql/15/main -c config_file=/etc/postgresql/15/main/postgresql.conf</span><br><span class="line">postgres    5672    5671  0 09:55 ?        00:00:00 postgres: 15/main: checkpointer</span><br><span class="line">postgres    5673    5671  0 09:55 ?        00:00:00 postgres: 15/main: background writer</span><br><span class="line">postgres    5675    5671  0 09:55 ?        00:00:00 postgres: 15/main: walwriter</span><br><span class="line">postgres    5676    5671  0 09:55 ?        00:00:00 postgres: 15/main: autovacuum launcher</span><br><span class="line">postgres    5677    5671  0 09:55 ?        00:00:00 postgres: 15/main: logical replication launcher</span><br></pre></td></tr></table></figure>

<p>可获知以下信息：</p>
<ul>
<li>安装目录：<code>/usr/lib/postgresql/15/bin/postgres</code></li>
<li>初始化数据库的数据目录：<code>/var/lib/postgresql/15/main</code></li>
<li>配置文件路径：<code>/etc/postgresql/15/main/postgresql.conf</code></li>
</ul>
<h2 id="2-4、登录"><a href="#2-4、登录" class="headerlink" title="2.4、登录"></a>2.4、登录</h2><p>1）切换用户：执行 <code>su - postgres</code></p>
<blockquote>
<p>注意：如果提示 <code>su：认证失败</code>，需要执行 <code>sudo passwd postgres</code> 设置密码再切换，输入设置的密码即可。</p>
</blockquote>
<p>2）输入 <code>psql</code> 登录</p>
<blockquote>
<p>如果本地登录需要切换新增的角色，要在 <code>pg_hba.conf</code> 配置认证方式。例如：<code>local  all  all  md5</code></p>
</blockquote>
<h2 id="3、通用部分"><a href="#3、通用部分" class="headerlink" title="3、通用部分"></a>3、通用部分</h2><h2 id="3-1、创建角色"><a href="#3-1、创建角色" class="headerlink" title="3.1、创建角色"></a>3.1、创建角色</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CREATE ROLE name [ [ WITH ] option [ ... ] ]</span><br></pre></td></tr></table></figure>

<p>option 属性</p>
<ul>
<li>登录权限（LOGIN ），具有该属性的角色才能连接数据库。</li>
<li>创建数据库（CREATEDB），具有该属性的角色才能够创建数据库（超级用户除外）。</li>
<li>创建角色（CREATEROLE），具有该属性的角色才能够创建其他角色（超级用户除外）。</li>
<li>启动复制（REPLICATION），具有该属性的角色才能够启动流复制（超级用户除外）。</li>
<li>密码（PASSWORD），只有当用户连接数据库使用的客户端认证方法要求提供密码时，密码属性才有意义。password 和 md5 认证方法需要使用密码。</li>
<li>超级用户（SUPERUSER），数据的超级用户可以避开所有的权限检查，只验证登录权限。</li>
</ul>
<p>例 1，创建角色并赋予【登录、创建数据库、密码】属性：<code>create role abc123 login createdb password &#39;abc123&#39;;</code></p>
<p>例 2，修改角色属性：<code>alter role &lt;role_name&gt; login createdb;</code></p>
<blockquote>
<p>注：可执行 <code>\du</code> 查看当前全部角色</p>
</blockquote>
<h2 id="3-2、查看版本"><a href="#3-2、查看版本" class="headerlink" title="3.2、查看版本"></a>3.2、查看版本</h2><p>执行 <code>psql --version</code> 查看当前版本：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">psql (PostgreSQL) 15.3 (Ubuntu 15.3-1.pgdg22.04+1)</span><br></pre></td></tr></table></figure>

<h2 id="3-3、远程登录"><a href="#3-3、远程登录" class="headerlink" title="3.3、远程登录"></a>3.3、远程登录</h2><ul>
<li>修改 <code>/etc/postgresql/15/main/pg_hba.conf</code>，按需增加配置，如：<code>host  all  all  0.0.0.0/0  md5</code></li>
<li>修改配置文件 <code>postgresql.conf</code>，将 <code>listen_addresses = &#39;localhost&#39;</code> 修改为 <code>listen_addresses = &#39;*&#39;</code></li>
<li>执行 <code>sudo systemctl restart postgresql</code> 重启服务</li>
</ul>
<blockquote>
<p>注意：即使修改配置文件，还应保证防火墙放行。尤其是 win 环境，需要在防火墙入站规则添加 5432 端口的放行规则。</p>
</blockquote>
<h2 id="3-3-1、pg-hba-conf-配置参数"><a href="#3-3-1、pg-hba-conf-配置参数" class="headerlink" title="3.3.1、pg_hba.conf 配置参数"></a>3.3.1、<code>pg_hba.conf</code> 配置参数</h2><p>1）TYPE（主机类型）</p>
<ul>
<li><code>local</code>，unix-domain 的 socket 连接</li>
<li><code>host</code>，TCP&#x2F;IP socket</li>
<li><code>hostssl</code>，SSL 加密的 TCP&#x2F;IP socket</li>
</ul>
<p>2）DATABASE（数据库名称）</p>
<p><code>all</code>、<code>sameuser</code>、<code>samerole</code>、<code>replication</code>、<code>数据库名称</code>，或者多个数据库名称用 <code>逗号</code></p>
<blockquote>
<p>注意：all 不匹配 <code>replication</code></p>
</blockquote>
<p>3）USER（用户名称）</p>
<p><code>all</code>、<code>一个用户名</code>、<code>一组用户名</code>，多个用户时，可以用逗号隔开，或者在用户名称前缀 <code>+</code>，在 USER 和 DATABASE 字段，也可以写一个单独的文件名称用 <code>@</code> 前缀，该文件包含数据库名称或用户名称。</p>
<p>4）ADDRESS（地址范围）</p>
<p>该参数可以为 <code>主机名称</code> 或者 <code>IP/32(IPV4)</code> 或 <code>IP/128(IPV6)</code>，主机名称以 <code>.</code> 开头，<code>samehost</code> 或 <code>samenet</code> 匹配任意 ip 地址</p>
<p>5）METHOD（验证方式）</p>
<ul>
<li><code>trust</code>，无需密码验证可直接连接访问</li>
<li><code>reject</code>，拒绝访问</li>
<li><code>md5</code>，以 md5 加密</li>
<li><code>password</code>，明文传输密码</li>
<li><code>scram-sha-256</code></li>
<li><code>gss</code></li>
<li><code>sspi</code></li>
<li><code>ident</code></li>
<li><code>peer</code></li>
<li><code>pam</code></li>
<li><code>ldap</code></li>
<li><code>radius</code></li>
<li><code>cert</code></li>
</ul>
<blockquote>
<p>注意：若为 <code>password</code> 则发送的为明文密码</p>
</blockquote>
<h2 id="4、问题集锦"><a href="#4、问题集锦" class="headerlink" title="4、问题集锦"></a>4、问题集锦</h2><h3 id="4-1、UTC-时间与系统时间偏差-8-小时"><a href="#4-1、UTC-时间与系统时间偏差-8-小时" class="headerlink" title="4.1、UTC 时间与系统时间偏差 8 小时"></a>4.1、UTC 时间与系统时间偏差 8 小时</h3><p><strong>解决方案：</strong></p>
<p>1）显式指定 PRC</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> now() <span class="keyword">at</span> <span class="type">time</span> zone <span class="string">&#x27;PRC&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>结果：<code>2023-07-30 16:01:17.285747</code></p>
<p>2）进一步指定格式</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> to_char(now() <span class="keyword">at</span> <span class="type">time</span> zone <span class="string">&#x27;PRC&#x27;</span>,<span class="string">&#x27;YYYY-MM-DD hh24:mi:ss&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>结果：<code>2023-07-30 16:03:34</code></p>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>postgresql</tag>
      </tags>
  </entry>
  <entry>
    <title>win 删除服务</title>
    <url>/3a21e150-815b-11ee-8ef0-c118c637cb12/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、在注册表中删除"><a href="#1、在注册表中删除" class="headerlink" title="1、在注册表中删除"></a>1、在注册表中删除</h2><p>1）进入注册表，定位至 <code>计算机\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services</code></p>
<p>2）找到要删除的服务，重启生效</p>
<h2 id="2、cmd-命令行删除"><a href="#2、cmd-命令行删除" class="headerlink" title="2、cmd 命令行删除"></a>2、cmd 命令行删除</h2><p>1）以管理员身份进入 cmd</p>
<p>2）执行 <code>sc delete 服务名称</code>，无需重启，立即生效</p>
<h2 id="3、powershell-命令行删除"><a href="#3、powershell-命令行删除" class="headerlink" title="3、powershell 命令行删除"></a>3、powershell 命令行删除</h2><p>1）执行 <code>sc delete 服务名称</code>，重启生效</p>
<blockquote>
<p>查看系统全部服务状态、名称、描述，可执行 <code>Get-Service</code></p>
</blockquote>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>win</tag>
      </tags>
  </entry>
  <entry>
    <title>win-本地部署-mariadb</title>
    <url>/bf9389c0-446f-11ee-90e9-49c3e96e9425/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、环境"><a href="#1、环境" class="headerlink" title="1、环境"></a>1、环境</h2><ul>
<li>Windows 10 专业版 22H2</li>
<li>mariadb-10.11.5</li>
</ul>
<h2 id="2、部署步骤"><a href="#2、部署步骤" class="headerlink" title="2、部署步骤"></a>2、部署步骤</h2><p>1）进入下载列表 <code>https://mariadb.org/download/?t=mariadb&amp;p=mariadb&amp;r=10.11.5&amp;os=windows&amp;cpu=x86_64&amp;pkg=zip&amp;m=aliyun</code>，获取 <code>mariadb-10.11.5-winx64.zip</code>，解压</p>
<p>2）在 mariadb-10.11.5-winx64 目录下新建 data 文件夹，即为数据目录。并将 <code>mariadb-10.11.5-winx64\bin</code> 添加到环境变量，则以下命令在 cmd 可直接执行。</p>
<p>3）安装 MairaDB 服务<br>管理员权限下在 cmd 终端执行 <code>mysqld.exe --install MariaDB</code></p>
<p>4）初始化<br>管理员权限下在 cmd 终端执行 <code>mysql_install_db.exe</code></p>
<p>5）启动服务<br>管理员权限下在 cmd 终端执行 <code>net start mariaDB</code></p>
<p>6）初始登录配置</p>
<ul>
<li>执行 <code>mariadb -u root</code>（初始登录无密码）</li>
<li>执行 <code>alter user &quot;root&quot;@&quot;localhost&quot; identified by &quot;root&quot;;</code> 修改 root 账户密码</li>
</ul>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>win</tag>
        <tag>mariadb</tag>
      </tags>
  </entry>
  <entry>
    <title>win 配置开机启动时执行脚本</title>
    <url>/2d5ffe70-cd69-11ee-be69-4dedf56c58bd/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、环境"><a href="#1、环境" class="headerlink" title="1、环境"></a>1、环境</h2><p>1）win 或 win server</p>
<p>2）适用于 exe 或 bat</p>
<h2 id="2、启动目录"><a href="#2、启动目录" class="headerlink" title="2、启动目录"></a>2、启动目录</h2><p>win+R 呼出运行栏后输入 <code>shell:startup</code> 进入启动目录，将需要开机执行的脚本放在此处即可。</p>
<h2 id="3、注册表"><a href="#3、注册表" class="headerlink" title="3、注册表"></a>3、注册表</h2><p>1）两个路径</p>
<ul>
<li><code>计算机\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code>，参考内容：</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Windows</span> <span class="title class_">Registry</span> <span class="title class_">Editor</span> <span class="title class_">Version</span> <span class="number">5.00</span></span><br><span class="line"></span><br><span class="line">[<span class="variable constant_">HKEY_LOCAL_MACHINE</span>\<span class="variable constant_">SOFTWARE</span>\<span class="title class_">Microsoft</span>\<span class="title class_">Windows</span>\<span class="title class_">CurrentVersion</span>\<span class="title class_">Run</span>]</span><br><span class="line"><span class="string">&quot;wpsphotoautoasso&quot;</span>=<span class="string">&quot;\&quot;C:\\pro\\WPS Office\\12.1.0.16120\\office6\\photolaunch.exe\&quot; /photo /checkasso&quot;</span></span><br><span class="line"><span class="string">&quot;SunloginClient&quot;</span>=<span class="string">&quot;\&quot;C:\\pro\\SunloginClient\\SunloginClient.exe\&quot; --cmd=autorun&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>计算机\HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code>，参考内容：</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Windows</span> <span class="title class_">Registry</span> <span class="title class_">Editor</span> <span class="title class_">Version</span> <span class="number">5.00</span></span><br><span class="line"></span><br><span class="line">[<span class="variable constant_">HKEY_CURRENT_USER</span>\<span class="variable constant_">SOFTWARE</span>\<span class="title class_">Microsoft</span>\<span class="title class_">Windows</span>\<span class="title class_">CurrentVersion</span>\<span class="title class_">Run</span>]</span><br><span class="line"><span class="string">&quot;BaiduYunDetect&quot;</span>=<span class="string">&quot;\&quot;C:\\Users\\pro\\AppData\\Roaming\\baidu\\BaiduNetdisk\\YunDetectService.exe\&quot;&quot;</span></span><br><span class="line"><span class="string">&quot;Steam&quot;</span>=<span class="string">&quot;\&quot;C:\\pro\\Steam\\steam.exe\&quot; -silent&quot;</span></span><br></pre></td></tr></table></figure>

<p>上述两种路径分别对应系统全局启动项和用户启动项。根据参考内容的格式，增加新「字符串值」，填入脚本路径即可。输入路径要用半角双引号，如：<code>&quot;C:\pro\Steam\steam.exe&quot;</code></p>
<h2 id="4、计划任务"><a href="#4、计划任务" class="headerlink" title="4、计划任务"></a>4、计划任务</h2><p>1）win+R 呼出运行栏后输入 <code>control</code> 进入控制面板，进入「管理工具」，进入「任务计划程序」，右键「计划任务程序库」选择「创建任务」；</p>
<p>2）在「常规」选项卡填写任务名称、描述（可选），选择「不管用户是否登录都要运行」，弹出验证框输入密码即可；勾选「使用最高权限运行」；</p>
<p>3）在「触发器」选项卡点击「新建」，指定启动时机</p>
<p>4）在「操作」选项卡选择要执行的脚本路径，「起始于」填写脚本所在目录</p>
<h2 id="5、组策略添加启动脚本"><a href="#5、组策略添加启动脚本" class="headerlink" title="5、组策略添加启动脚本"></a>5、组策略添加启动脚本</h2><p>1）win+R 呼出运行栏后输入 <code>gpedit.msc</code> 进入本地组策略</p>
<p>2）依次进入「计算机配置」→「Windows设置」→「脚本（启动&#x2F;关机）」，双击进入右侧「启动」，添加脚本路径。</p>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>win</tag>
      </tags>
  </entry>
  <entry>
    <title>win 防火墙配置允许回显请求</title>
    <url>/3a220860-815b-11ee-8ef0-c118c637cb12/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、问题描述"><a href="#1、问题描述" class="headerlink" title="1、问题描述"></a>1、问题描述</h2><p>网络正常状态下，使用 ping 命令试图获取某主机回显信息时出现超时。</p>
<h2 id="2、解决方案"><a href="#2、解决方案" class="headerlink" title="2、解决方案"></a>2、解决方案</h2><p>1）进入 <code>设置</code>，搜索 <code>防火墙</code>，进入 <code>高级设置</code></p>
<p>2）在 <code>入站规则</code> 列表中找到 <code>核心网络诊断-ICMP 回显请求(ICMPv4-In)</code>，勾选 <code>已启用</code></p>
<blockquote>
<p>注：<code>核心网络诊断-ICMP 回显请求(ICMPv4-In)</code> 一般有多个，应选择配置文件为 <code>专用、公用</code> 的条目。</p>
</blockquote>
<p>该解决方案在 win10 专业版、Windows Server 2022 Datacenter 测试可用。</p>
<h2 id="3、其他"><a href="#3、其他" class="headerlink" title="3、其他"></a>3、其他</h2><p>1）仅响应指定 ip 的远程计算机</p>
<p>在 <code>入站规则</code> 列表中找到 <code>核心网络诊断-ICMP 回显请求(ICMPv4-In)</code>，进入 <code>作用域</code> 分页，在 <code>远程 IP 地址</code> 栏目下添加地址即可（默认为 <code>本地子网</code>）。</p>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>win</tag>
      </tags>
  </entry>
  <entry>
    <title>win10-powershell-禁止运行脚本的问题</title>
    <url>/ed0e8970-441c-11ee-bc1a-25c3478a32d1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、问题描述"><a href="#1、问题描述" class="headerlink" title="1、问题描述"></a>1、问题描述</h2><p>使用 vscode 或 powershell 控制台时，由于默认执行策略是 Restricted，执行一些命令会提示报错：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo : 无法加载文件 D:\node-v18.17.1-win-x64\node-global\hexo.ps1，因为在此系统上禁止运行脚本。</span><br></pre></td></tr></table></figure>

<h2 id="2、解决方案"><a href="#2、解决方案" class="headerlink" title="2、解决方案"></a>2、解决方案</h2><p>1）执行如下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser</span><br></pre></td></tr></table></figure>

<p>2）重启应用或控制台</p>
<h2 id="3、其他"><a href="#3、其他" class="headerlink" title="3、其他"></a>3、其他</h2><p>查看当前策略：<code>get-executionpolicy</code></p>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>powershell</tag>
      </tags>
  </entry>
  <entry>
    <title>云服务器部署-JavaWeb-环境</title>
    <url>/bf93b0d0-446f-11ee-90e9-49c3e96e9425/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="0、前言"><a href="#0、前言" class="headerlink" title="0、前言"></a>0、前言</h2><p>2020-03-15 修改，补充增加了内容。</p>
<h2 id="1、环境、工具及版本"><a href="#1、环境、工具及版本" class="headerlink" title="1、环境、工具及版本"></a>1、环境、工具及版本</h2><ul>
<li>CentOS Linux 7.4.1708 (Core)</li>
<li>Amazon Corretto 11</li>
<li>MySQL 5.7.28 或 MySQL 8.0.18</li>
<li>Nginx 1.16.1</li>
</ul>
<h2 id="2、安装-JDK-x2F-JRE-参考步骤"><a href="#2、安装-JDK-x2F-JRE-参考步骤" class="headerlink" title="2、安装 JDK&#x2F;JRE 参考步骤"></a>2、安装 JDK&#x2F;JRE 参考步骤</h2><h2 id="2-1、yum-安装"><a href="#2-1、yum-安装" class="headerlink" title="2.1、yum 安装"></a>2.1、yum 安装</h2><p>1）添加 yum 存储库</p>
<p>在该页面：<a href="https://docs.aws.amazon.com/zh_cn/corretto/latest/corretto-11-ug/downloads-list.html">https://docs.aws.amazon.com/zh_cn/corretto/latest/corretto-11-ug/downloads-list.html</a> 选择适用的发行包，拷贝链接后，使用以下命令安装：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -Uvh https://d3pxv6yz143wms.cloudfront.net/11.0.3.7.1/java-11-amazon-corretto-devel-11.0.3.7-1.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>也可以下载到本地执行安装：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -Uvh java-11-amazon-corretto-devel-11.0.3.7-1.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>2）开始安装</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ9vbe1cif1bx32Z ~]## yum install java</span><br></pre></td></tr></table></figure>

<p>3）输入命令：<code>java -version</code>，查看 JDK 是否安装成功，如果安装成功则显示版本号信息：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ9vbe1cif1bx32Z ~]## java -version</span><br><span class="line">openjdk version &quot;11.0.3&quot; 2019-04-16 LTS</span><br><span class="line">OpenJDK Runtime Environment Corretto-11.0.3.7.1 (build 11.0.3+7-LTS)</span><br><span class="line">OpenJDK 64-Bit Server VM Corretto-11.0.3.7.1 (build 11.0.3+7-LTS, mixed mode)</span><br></pre></td></tr></table></figure>

<h2 id="2-2、手动安装"><a href="#2-2、手动安装" class="headerlink" title="2.2、手动安装"></a>2.2、手动安装</h2><p>1）在 etc 下建立存放目录，可以用图形化工具建立，或者命令行：<code>mkdir /etc/java</code></p>
<p>2）在 etc 下使用命令：<code>wget https://d3pxv6yz143wms.cloudfront.net/11.0.3.7.1/amazon-corretto-11.0.3.7.1-linux-x64.tar.gz</code>，或将本地文件上传。</p>
<p>3）在 etc 下执行命令：<code>tar zxvf jdk-8u171-linux-x64.tar.gz -C /etc/java/</code></p>
<p>4）解压完成后，修改 <code>/etc/profile</code> 文件，在末尾添加内容后保存：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">##set java environment</span><br><span class="line">export JAVA_HOME=/etc/java/amazon-corretto-11.0.3.7.1-linux-x64</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib:$CLASSPATH</span><br><span class="line">export PATH=$JAVA_HOME/bin:$JAVA_HOME:$PATH</span><br></pre></td></tr></table></figure>

<p><strong>附加内容：若安装 JDK 8，环境变量设置可改为：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">##set java environment</span><br><span class="line">export JAVA_HOME=/usr/java/jdk/jdk1.8.0_171</span><br><span class="line">export JRE_HOME=/usr/java/jdk/jdk1.8.0_171/jre</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH</span><br><span class="line">export PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$JAVA_HOME:$PATH</span><br></pre></td></tr></table></figure>

<p>5）使用命令：<code>source /etc/profile</code>，让环境变量生效</p>
<p>6）输入命令：<code>java -version</code>，查看 JDK 是否安装成功。</p>
<h2 id="3、安装-MySQL-参考步骤"><a href="#3、安装-MySQL-参考步骤" class="headerlink" title="3、安装 MySQL 参考步骤"></a>3、安装 MySQL 参考步骤</h2><p>采用官网介绍的安装方法，步骤如下。原文详见：<a href="https://dev.mysql.com/doc/mysql-yum-repo-quick-guide/en/##repo-qg-yum-installing">A Quick Guide to Using the MySQL Yum Repository</a></p>
<p>1）查询并移除 CentOS 7 默认安装的 mariaDB，执行该步骤需要获得 root 权限：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ9vbe1cif1bx32Z ~]## rpm -qa | grep mariadb</span><br><span class="line">mariadb-libs-5.5.60-1.el7_5.x86_64</span><br><span class="line">[root@iZ9vbe1cif1bx32Z ~]## yum -y remove mariadb-libs</span><br></pre></td></tr></table></figure>

<p>2）添加 yum 存储库</p>
<p>在该页面：<a href="https://dev.mysql.com/downloads/repo/yum/">https://dev.mysql.com/downloads/repo/yum/</a> 选择适用的发行包，拷贝链接后，使用以下命令安装：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -Uvh https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm</span><br></pre></td></tr></table></figure>

<p>也可以下载到本地执行安装：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -Uvh mysql80-community-release-el7-3.noarch.rpm</span><br></pre></td></tr></table></figure>

<p>3）选择版本</p>
<p>在 yum 存储库中，不同版本的 MySQL Community Server 托管在不同的子存储库中。默认情况下启用最新版本（当前为 MySQL 8.0）的子存储库，而所有其他系列（例如，MySQL 5.7 系列）的子存储库均被禁用。使用以下命令可查看 yum 存储库中的所有子存储库，并查看已启用或禁用的子存储库：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ9vbe1cif1bx32Z ~]## yum repolist all | grep mysql</span><br><span class="line">mysql-cluster-7.5-community/x86_64 MySQL Cluster 7.5 Community   disabled</span><br><span class="line">mysql-cluster-7.5-community-source MySQL Cluster 7.5 Community - disabled</span><br><span class="line">mysql-cluster-7.6-community/x86_64 MySQL Cluster 7.6 Community   disabled</span><br><span class="line">mysql-cluster-7.6-community-source MySQL Cluster 7.6 Community - disabled</span><br><span class="line">mysql-cluster-8.0-community/x86_64 MySQL Cluster 8.0 Community   disabled</span><br><span class="line">mysql-cluster-8.0-community-source MySQL Cluster 8.0 Community - disabled</span><br><span class="line">mysql-connectors-community/x86_64  MySQL Connectors Community    enabled:    128</span><br><span class="line">mysql-connectors-community-source  MySQL Connectors Community -  disabled</span><br><span class="line">mysql-tools-community/x86_64       MySQL Tools Community         enabled:    100</span><br><span class="line">mysql-tools-community-source       MySQL Tools Community - Sourc disabled</span><br><span class="line">mysql-tools-preview/x86_64         MySQL Tools Preview           disabled</span><br><span class="line">mysql-tools-preview-source         MySQL Tools Preview - Source  disabled</span><br><span class="line">mysql55-community/x86_64           MySQL 5.5 Community Server    disabled</span><br><span class="line">mysql55-community-source           MySQL 5.5 Community Server -  disabled</span><br><span class="line">mysql56-community/x86_64           MySQL 5.6 Community Server    disabled</span><br><span class="line">mysql56-community-source           MySQL 5.6 Community Server -  disabled</span><br><span class="line">mysql57-community/x86_64           MySQL 5.7 Community Server    disabled</span><br><span class="line">mysql57-community-source           MySQL 5.7 Community Server -  disabled</span><br><span class="line">mysql80-community/x86_64           MySQL 8.0 Community Server    enabled:    145</span><br><span class="line">mysql80-community-source           MySQL 8.0 Community Server -  disabled</span><br></pre></td></tr></table></figure>

<p>若安装最新版本则无需进行配置。要安装旧版本，例如 MySQL 5.7 系列，需禁用最新版本的子存储库并启用旧版本子存储库。以下命令禁用 8.0 系列的子存储库并启用 5.7 系列的子存储库：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ9vbe1cif1bx32Z ~]## yum-config-manager --disable mysql80-community</span><br><span class="line">[root@iZ9vbe1cif1bx32Z ~]## yum-config-manager --enable mysql57-community</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>若提示找不到 <code>yum-config-manager</code> 命令，安装即可：<code>yum -y install yum-utils</code></li>
<li>应该随时只为一个系列启用子存储库。如果启用了多个系列的子存储库，那么 yum 将使用最新的系列</li>
</ul>
<p>通过以下命令，验证是否已启用正确的子存储库：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ9vbe1cif1bx32Z ~]## yum repolist enabled | grep mysql</span><br><span class="line">mysql-connectors-community/x86_64 MySQL Connectors Community                 128</span><br><span class="line">mysql-tools-community/x86_64      MySQL Tools Community                      100</span><br><span class="line">mysql57-community/x86_64          MySQL 5.7 Community Server                 384</span><br></pre></td></tr></table></figure>

<p>4）开始安装</p>
<p>通过以下命令安装 MySQL 服务器的软件包以及其他必需的软件包：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ9vbe1cif1bx32Z ~]## yum install mysql-community-server</span><br></pre></td></tr></table></figure>

<p>5）启动 MySQL 服务</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ9vbe1cif1bx32Z ~]## service mysqld start</span><br></pre></td></tr></table></figure>

<p>6）检查状态</p>
<p>使用命令 <code>service mysqld status</code>，出现以下提示说明服务正常运行（MySQL 5.7 和 8.0 的显示结果基本相同）。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ9vbe1cif1bx32Z ~]## service mysqld status</span><br><span class="line">Redirecting to /bin/systemctl status mysqld.service</span><br><span class="line">● mysqld.service - MySQL Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2019-10-28 17:53:00 CST; 3h 25min ago</span><br><span class="line">     Docs: man:mysqld(8)</span><br><span class="line">           http://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class="line">  Process: 3731 ExecStart=/usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid $MYSQLD_OPTS (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 3681 ExecStartPre=/usr/bin/mysqld_pre_systemd (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 3735 (mysqld)</span><br><span class="line">   CGroup: /system.slice/mysqld.service</span><br><span class="line">           └─3735 /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mys...</span><br><span class="line"></span><br><span class="line">Oct 28 17:52:56 iZ9vbe1cif1bx32Z systemd[1]: Starting MySQL Server...</span><br><span class="line">Oct 28 17:53:00 iZ9vbe1cif1bx32Z systemd[1]: Started MySQL Server.</span><br></pre></td></tr></table></figure>

<p>7）查看初始临时密码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ9vbe1cif1bx32Z ~]## grep &#x27;temporary password&#x27; /var/log/mysqld.log</span><br></pre></td></tr></table></figure>

<p>8）使用生成的临时密码登录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ9vbe1cif1bx32Z ~]## mysql -uroot -p</span><br></pre></td></tr></table></figure>

<p>9）尽快为超级用户帐户设置自定义密码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; alter user &#x27;root&#x27;@&#x27;localhost&#x27; identified by &#x27;MyNewPass4!&#x27;;</span><br></pre></td></tr></table></figure>

<p>注意：MySQL 的 validate_password 插件默认安装。要求密码至少包含一个大写字母，一个小写字母，一位数字和一个特殊字符，并且密码总长度至少为 8 个字符。</p>
<h2 id="4、MySQL-通用及专有设置"><a href="#4、MySQL-通用及专有设置" class="headerlink" title="4、MySQL 通用及专有设置"></a>4、MySQL 通用及专有设置</h2><h2 id="4-1、用户控制及授权"><a href="#4-1、用户控制及授权" class="headerlink" title="4.1、用户控制及授权"></a>4.1、用户控制及授权</h2><p>1）创建用户 test 并设置密码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; create user test identified by &#x27;123aI~A!&#x27;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：可不进入 user 表执行该语句</p>
</blockquote>
<p>2）查看用户 test 的权限（没有分配前，无权限）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; show grants for &#x27;test&#x27;@&#x27;%&#x27;;</span><br><span class="line">+----------------------------------+</span><br><span class="line">| Grants for test@%                |</span><br><span class="line">+----------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO &#x27;test&#x27;@&#x27;%&#x27; |</span><br><span class="line">+----------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>3）给用户 test 在 database 数据库中对的所有表授权，如：EXECUTE（执行存储过程），INSERT，SELECT，UPDATE 权限，’%’ 表示来自任意 IP 的访问：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grant execute,insert,select,update on database.* to &#x27;test&#x27;@&#x27;%&#x27;;</span><br></pre></td></tr></table></figure>

<p>常用权限有以下几种：</p>
<ul>
<li>all privileges，所有权限</li>
<li>select，读取权限</li>
<li>delete，删除权限</li>
<li>update，更新权限</li>
<li>create，创建权限</li>
<li>drop，删除数据库、数据表权限</li>
</ul>
<p>4）取消来自远程服务器的 AA 用户对数据库 db 里的表 tb 的所有权限</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">revoke all on db.tb from AA@&quot;%&quot;;</span><br></pre></td></tr></table></figure>

<p>5）刷新权限</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<p>6）删除用户</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drop user test@&#x27;%&#x27;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：可不进入 user 表执行该语句</p>
</blockquote>
<p>7）查看所有用户信息（8.0 版本显示结果稍有不同）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; select user, host, authentication_string from mysql.user;</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| user          | host      | authentication_string                     |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">| root          | localhost | *ACE4C05F67A275C00548651B22A066C15B2AB728 |</span><br><span class="line">| mysql.session | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| mysql.sys     | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE |</span><br><span class="line">| test          | %         | *112D65D910D5E3AFCD5624275229F2C0F1B5ADE4 |</span><br><span class="line">+---------------+-----------+-------------------------------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<h2 id="4-2、重置密码"><a href="#4-2、重置密码" class="headerlink" title="4.2、重置密码"></a>4.2、重置密码</h2><p>1）定位 &#x2F;etc&#x2F;my.cnf，在 my.cnf 文件 <code>[mysqld]</code> 下添加 <code>skip-grant-tables</code> 字符串，开启免密码登陆</p>
<p>2）执行 <code>service mysqld restart</code>，重启服务，使配置生效</p>
<p>3）执行 <code>mysql -u root -p</code>，无需键入内容，直接回车即可登录</p>
<p>4）清空密码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">update mysql.user set authentication_string=&#x27;&#x27; where user=&#x27;root&#x27;;</span><br></pre></td></tr></table></figure>

<p>5）将 <code>skip-grant-tables</code> 字符串删除，执行 <code>service mysqld restart</code>，重启服务，使配置生效</p>
<p>6）执行 <code>mysql -u root -p</code>，无需键入内容，直接回车即可登录</p>
<p>7）执行 <code>alter user &#39;root&#39;@&#39;localhost&#39; identified by &#39;MyNewPass4!&#39;;</code> 重新设置密码</p>
<h2 id="4-3、移除-MySQL"><a href="#4-3、移除-MySQL" class="headerlink" title="4.3、移除 MySQL"></a>4.3、移除 MySQL</h2><p>1）停止服务：<code>service mysqld stop</code></p>
<p>2）执行 <code>rpm -qa | grep -i mysql</code> 查看 MySQL 组件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ9vbe1cif1bx32Z ~]## rpm -qa | grep -i mysql</span><br><span class="line">mysql-community-libs-5.7.28-1.el7.x86_64</span><br><span class="line">mysql80-community-release-el7-3.noarch</span><br><span class="line">mysql-community-common-5.7.28-1.el7.x86_64</span><br><span class="line">mysql-community-client-5.7.28-1.el7.x86_64</span><br><span class="line">mysql-community-server-5.7.28-1.el7.x86_64</span><br></pre></td></tr></table></figure>

<p>3）组件彼此之间有依赖关系，按顺序逐项执行移除</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -ev mysql-community-server-5.7.28-1.el7.x86_64</span><br><span class="line">rpm -ev mysql-community-client-5.7.28-1.el7.x86_64</span><br><span class="line">rpm -ev mysql-community-libs-5.7.28-1.el7.x86_64</span><br><span class="line">rpm -ev mysql-community-common-5.7.28-1.el7.x86_64</span><br><span class="line">rpm -ev mysql80-community-release-el7-3.noarch</span><br></pre></td></tr></table></figure>

<p>4）删除相关目录。执行 <code>find / -name mysql</code>（查找） 和 <code>rm -rf xxx</code>（删除） 逐项执行移除完全为止。可能包含的目录如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@iZ9vbe1cif1bx32Z ~]## find / -name mysql</span><br><span class="line">/etc/selinux/targeted/active/modules/100/mysql</span><br><span class="line">/var/lib/mysql</span><br><span class="line">/var/lib/mysql/mysql</span><br><span class="line">/usr/share/mysql</span><br></pre></td></tr></table></figure>

<h2 id="4-4、MySQL-8-使用简单密码"><a href="#4-4、MySQL-8-使用简单密码" class="headerlink" title="4.4、MySQL 8 使用简单密码"></a>4.4、MySQL 8 使用简单密码</h2><p>MySQL 8 默认不能输入全数字的简单密码，需要进行如下设置：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; set global validate_password.policy=0;</span><br><span class="line">mysql&gt; set global validate_password.length=1;</span><br></pre></td></tr></table></figure>

<h2 id="4-5、MySQL-8-开启外部第三方客户端连接权限"><a href="#4-5、MySQL-8-开启外部第三方客户端连接权限" class="headerlink" title="4.5、MySQL 8 开启外部第三方客户端连接权限"></a>4.5、MySQL 8 开启外部第三方客户端连接权限</h2><p>MySQL 8.0 采用了 caching_sha2_password 加密，是 sha256 的改进版加密方式，多数第三方客户端都不支持这种加密方式，自带的命令行可支持。具体可参看 <a href="https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html##upgrade-caching-sha2-password">官方文档</a> 有关该内容说明。要解决该问题，需要修改加密方式。以 root 用户为例，如果要配置其他用户或授权 IP，对应修改名称和地址即可。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALTER USER &#x27;root&#x27;@&#x27;%&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;MyNewPass4!&#x27;;</span><br></pre></td></tr></table></figure>

<h2 id="5、安装-nginx-参考步骤"><a href="#5、安装-nginx-参考步骤" class="headerlink" title="5、安装 nginx 参考步骤"></a>5、安装 nginx 参考步骤</h2><h2 id="5-1、yum-安装（配置文件，稳定版）"><a href="#5-1、yum-安装（配置文件，稳定版）" class="headerlink" title="5.1、yum 安装（配置文件，稳定版）"></a>5.1、yum 安装（配置文件，稳定版）</h2><p>采用官网介绍的安装方法，步骤如下。原文详见：<a href="https://nginx.org/en/linux_packages.html##sourcepackages">Installation instructions</a></p>
<p>1）新建配置文件 <code>/etc/yum.repos.d/nginx.repo</code>，内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=true</span><br></pre></td></tr></table></figure>

<p>2）配置中 <code>enabled=1</code>，因此默认安装稳定版，直接执行 <code>yum install nginx</code> 即可</p>
<p>3）启动服务：<code>systemctl start nginx.service</code></p>
<p>4）查看运行状态：<code>ps -ef | grep nginx</code>，若有 master process 和 worker process 两个进程说明正常启动。</p>
<p>其他常用命令行：</p>
<ul>
<li>查看版本：nginx -v</li>
<li>停止服务：<code>systemctl stop nginx.service</code></li>
<li>重启服务：<code>systemctl restart nginx.service</code></li>
<li>开机启动服务：<code>systemctl enable nginx.service</code></li>
<li>全局配置文件路径：<code>/etc/nginx/nginx.conf</code></li>
<li>网站文件存放路径：<code>/usr/share/nginx/html</code></li>
<li>网站默认站点配置文件路径：<code>/etc/nginx/conf.d/default.conf</code></li>
<li>自定义 Nginx 站点配置文件存放路径：<code>/etc/nginx/conf.d/</code></li>
<li>查看服务器私有 IP：<code>ip addr show eth0 | grep inet | awk &#39;&#123; print $2; &#125;&#39; | sed &#39;s/\/.*$//&#39;</code></li>
<li>卸载：<code>yum remove nginx</code>，之后可用 <code>which nginx</code> 确认是否卸载情况</li>
</ul>
<h2 id="5-2、yum-安装（手动，稳定版）"><a href="#5-2、yum-安装（手动，稳定版）" class="headerlink" title="5.2、yum 安装（手动，稳定版）"></a>5.2、yum 安装（手动，稳定版）</h2><p>1）在该页面：<a href="http://nginx.org/packages/centos/7/x86_64/RPMS/">http://nginx.org/packages/centos/7/x86_64/RPMS/</a> 选择适用的发行包，拷贝链接后，使用以下命令安装：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -Uvh http://nginx.org/packages/centos/7/x86_64/RPMS/nginx-1.16.1-1.el7.ngx.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>也可以下载到本地执行安装：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rpm -Uvh nginx-1.16.1-1.el7.ngx.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>2）执行 <code>yum install nginx</code> 即可</p>
<p>3）启动服务：<code>systemctl start nginx.service</code></p>
<h2 id="5-3、编译安装"><a href="#5-3、编译安装" class="headerlink" title="5.3、编译安装"></a>5.3、编译安装</h2><p>nginx 中 gzip 模块需要 zlib 库，rewrite 模块需要 pcre 库，ssl 功能需要 openssl 库。以 <code>/usr/mix</code> 安装目录为例：</p>
<ul>
<li>建立 mix 目录</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ mkdir mix</span><br></pre></td></tr></table></figure>

<ul>
<li>安装 GCC 和 GCC-C++</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ yum install gcc</span><br><span class="line">$ yum install gcc-c++</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：<br>若未安装 GCC，安装 Nginx 会报如下错误：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./configure: error: C compiler cc is not found</span><br></pre></td></tr></table></figure>

<p>若未安装 GCC-C++，安装 PCRE 库时报如下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">configure: error: You need a C++ compiler for C++ support.</span><br></pre></td></tr></table></figure>

<ul>
<li>编译安装 PCRE 库</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cd /usr/</span><br><span class="line">$ wget https://sourceforge.net/projects/pcre/files/pcre/8.43/pcre-8.43.tar.gz</span><br><span class="line">$ tar -zxvf pcre-8.43.tar.gz -C /usr/mix/</span><br><span class="line">$ cd mix/pcre-8.43</span><br><span class="line">$ ./configure</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>注意：这里使用 pcre 而不用 pcre2</p>
<ul>
<li>编译安装 zlib 库</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cd /usr/</span><br><span class="line">$ wget http://www.zlib.net/zlib-1.2.11.tar.gz</span><br><span class="line">$ tar -zxvf zlib-1.2.11.tar.gz -C /usr/mix/</span><br><span class="line">$ cd mix/zlib-1.2.11</span><br><span class="line">$ ./configure</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ul>
<li>编译安装 openssl</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cd /usr/</span><br><span class="line">$ wget https://www.openssl.org/source/openssl-1.0.2r.tar.gz</span><br><span class="line">$ tar -zxvf openssl-1.0.2r.tar.gz -C /usr/mix/</span><br><span class="line">$ cd mix/openssl-1.0.2r</span><br><span class="line">$ ./config</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ul>
<li>编译安装 nginx，并添加 PCRE、zlib 、openssl 的源码路径</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cd /usr/</span><br><span class="line">$ wget http://nginx.org/download/nginx-1.16.0.tar.gz</span><br><span class="line">$ tar -zxvf nginx-1.16.0.tar.gz -C /usr/mix/</span><br><span class="line">$ cd mix/nginx-1.16.0</span><br><span class="line">$ ./configure --prefix=/usr/mix/nginx --with-pcre=/usr/mix/pcre-8.43 --with-zlib=/usr/mix/zlib-1.2.11 --with-openssl=/usr/mix/openssl-1.0.2r</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ul>
<li>启动 Nginx，默认端口为 80</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./usr/mix/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>

<ul>
<li>查看工作情况</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ps -ef | grep nginx</span><br></pre></td></tr></table></figure>

<ul>
<li>其他命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./sbin/nginx -s reload            ## 重新载入配置文件</span><br><span class="line">./sbin/nginx -s reopen            ## 重启 Nginx</span><br><span class="line">./sbin/nginx -s stop              ## 停止 Nginx</span><br></pre></td></tr></table></figure>

<h2 id="5-4、问题及解决方案"><a href="#5-4、问题及解决方案" class="headerlink" title="5.4、问题及解决方案"></a>5.4、问题及解决方案</h2><h2 id="5-4-1、nginx-设置反向代理后，页面上的-js-css-文件无法加载"><a href="#5-4-1、nginx-设置反向代理后，页面上的-js-css-文件无法加载" class="headerlink" title="5.4.1、nginx 设置反向代理后，页面上的 js css 文件无法加载"></a>5.4.1、nginx 设置反向代理后，页面上的 js css 文件无法加载</h2><p>可添加如下配置：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">location ~ .*\.(js|css)$ &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1:8866;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整示例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">listen 80;</span><br><span class="line">server_name www.test.com;</span><br><span class="line"></span><br><span class="line">location /&#123;</span><br><span class="line">    proxy_pass http://xxx.xxx.xxx.xxx:9002;</span><br><span class="line">    index index.html;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_set_header  Host  $host;</span><br><span class="line">    proxy_set_header  X-Real-IP  $remote_addr;</span><br><span class="line">    proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~ .*\.(js|css)$ &#123;</span><br><span class="line">    proxy_pass http://xxx.xxx.xxx.xxx:9002;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-4-2、输入域名或-IP，访问不到主页"><a href="#5-4-2、输入域名或-IP，访问不到主页" class="headerlink" title="5.4.2、输入域名或 IP，访问不到主页"></a>5.4.2、输入域名或 IP，访问不到主页</h2><p>1）查看云服务器商防火墙是否放行 80 端口；</p>
<p>2）系统防火墙是否放行 80 端口，相关命令如下：</p>
<ul>
<li><code>systemctl status firewalld.service</code>，查看系统防火墙状态（running&#x2F;dead）</li>
<li><code>firewall-cmd --permanent --add-port=80/tcp</code>，开启 80 端口（重启系统启防火墙后生效）</li>
<li><code>firewall-cmd --reload</code>，重启系统防火墙</li>
<li><code>firewall-cmd --list-ports</code>，查看系统防火墙已开启端口</li>
</ul>
<p><strong>附加内容：防火墙的开启和关闭</strong></p>
<ul>
<li>临时关闭防火墙：<code>systemctl stop firewalld</code></li>
<li>临时开启防火墙：<code>systemctl start firewalld</code></li>
<li>永久关闭防火墙：<code>systemctl disable firewalld</code></li>
<li>永久开启防火墙：<code>systemctl enable firewalld</code></li>
</ul>
<blockquote>
<p>注意事项：临时关闭或开启防火墙，当重启时会回复之前的状态；永久开启或关闭防火墙，重启后生效。</p>
</blockquote>
<p><strong>附加内容：自启动服务命令</strong></p>
<ul>
<li>查看服务是否开机启动：systemctl is-enabled firewalld.service</li>
<li>查看已启动的服务列表：systemctl list-unit-files|grep enabled</li>
<li>查看启动失败的服务列表：systemctl –failed</li>
</ul>
<p><strong>附加内容：添加&#x2F;删除开放端口</strong></p>
<ul>
<li>默认作用域下，每次修改端口和服务相当于修改 <code>/etc/firewalld/zones/public.xml</code> 文件，也可以直接操作文件</li>
<li>添加 http 服务：<code>firewall-cmd --zone=public --add-service=http --permanent</code></li>
<li>查看端口是否开放，开启显示 yes：<code>firewall-cmd --query-port=80/tcp</code></li>
<li>查看服务是否开放，开启显示 yes：<code>firewall-cmd --query-service=ssh</code></li>
<li>删除开放的端口：<code>firewall-cmd --remove-port=80/tcp --permanent</code></li>
<li>删除开放的服务：<code>firewall-cmd --zone=public --remove-service=http --permanent</code></li>
<li>查看所有开启的服务：<code>firewall-cmd --list-services</code></li>
<li>列出指定作用域的所有设置：<code>firewall-cmd --zone=public --list-all</code></li>
<li>查看所有可用区域：<code>firewall-cmd --get-zones</code></li>
<li>列出所有预设服务：<code>firewall-cmd --get-services</code>，将列出 <code>/usr/lib/firewalld/services/</code> 中的服务器名称。配置文件是以服务本身命名的 service-name.xml</li>
<li>列出所有区域的设置：<code>firewall-cmd --list-all-zones</code></li>
</ul>
<blockquote>
<p>注 1：缺省时的作用域为 public，即默认带参数 <code>--zone=public</code>，可通过 <code>firewall-cmd --get-default-zone</code> 命令查看，可通过 <code>firewall-cmd --set-default-zone=dmz</code> 命令更改</p>
</blockquote>
<blockquote>
<p>注 2：<code>--permanent</code> 参数为永久生效</p>
</blockquote>
<blockquote>
<p>注 3：<code>/etc/firewalld/zones/</code> 目录下保存作用域配置文件。如 <code>public.xml</code> 是当前生效配置；<code>public.xml.old</code> 是上一次生效配置。</p>
</blockquote>
<p><strong>附加内容：防火墙作用域</strong></p>
<ul>
<li>public ：仅允许访问本机的 ssh，ping，dhcp 服务（默认）</li>
<li>trusted：允许任何访问</li>
<li>block：阻塞任何来访请求，明确拒绝</li>
<li>drop：丢弃任何来访的数据包，直接丢弃</li>
</ul>
<p><strong>附加内容：其他防火墙操作</strong></p>
<p>定义规则</p>
<ul>
<li>设置某个 ip 访问某个服务：<code>firewall-cmd --permanent --zone=public --add-rich-rule=&#39;rule family=&quot;ipv4&quot; source address=&quot;192.168.0.4/24&quot; service name=&quot;http&quot; accept&#39;</code></li>
<li>删除配置：<code>firewall-cmd --permanent --zone=public --remove-rich-rule=&#39;rule family=&quot;ipv4&quot; source address=&quot;192.168.0.4/24&quot; service name=&quot;http&quot; accept&#39;</code> &#x2F;&#x2F;</li>
<li>设置某个 ip 访问某个端口：<code>firewall-cmd --permanent --add-rich-rule &#39;rule family=ipv4 source address=192.168.0.1/2 port port=80 protocol=tcp accept&#39;</code></li>
<li>删除配置：<code>firewall-cmd --permanent --remove-rich-rule &#39;rule family=ipv4 source address=192.168.0.1/2 port port=80 protocol=tcp accept&#39;</code></li>
<li>将 1.2.3.4 这个源地址的连接全部给 drop 掉：<code>firewall-cmd --add-rich-rule=&#39;rule family=&quot;ipv4&quot; source address=&quot;1.2.3.4&quot; drop&#39;</code></li>
</ul>
<p>伪装 IP</p>
<ul>
<li>检查是否允许伪装 IP：<code>firewall-cmd --query-masquerade</code></li>
<li>允许防火墙伪装 IP：<code>firewall-cmd --add-masquerade</code></li>
<li>禁止防火墙伪装 IP：<code>firewall-cmd --remove-masquerade</code></li>
</ul>
<p>请求转发</p>
<ul>
<li>将 80 端口的请求转发至 8080：<code>firewall-cmd --add-forward-port=port=80:proto=tcp:toport=8080</code></li>
<li>将 80 端口的请求转发至 1 92.168.0.1：<code>firewall-cmd --add-forward-port=proto=80:proto=tcp:toaddr=192.168.1.0.1</code></li>
<li>将 80 端口的请求转发至 192.168.0.1 的 8080 端口：<code>firewall-cmd --add-forward-port=proto=80:proto=tcp:toaddr=192.168.0.1:toport=8080</code></li>
</ul>
<h2 id="6、部署过程中的其他问题"><a href="#6、部署过程中的其他问题" class="headerlink" title="6、部署过程中的其他问题"></a>6、部署过程中的其他问题</h2><h2 id="6-1、解压-filename-tar-xz-文件"><a href="#6-1、解压-filename-tar-xz-文件" class="headerlink" title="6.1、解压 filename.tar.xz 文件"></a>6.1、解压 filename.tar.xz 文件</h2><p>使用命令：<code>tar -xvf filename.tar.xz</code></p>
<h2 id="6-2、在-linux-服务器运行-jar-文件"><a href="#6-2、在-linux-服务器运行-jar-文件" class="headerlink" title="6.2、在 linux 服务器运行 jar 文件"></a>6.2、在 linux 服务器运行 jar 文件</h2><p>通常的方法是：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ java -jar test.jar</span><br></pre></td></tr></table></figure>

<p>但是这种方式在 SSH 窗口关闭时程序将中止运行，或者是运行时没法切出去执行其他任务，有没有办法让 jar 在后台运行。要解决这个问题，可以使用：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ nohup java -jar test.jar &amp;</span><br></pre></td></tr></table></figure>

<p>即不挂断运行命令，账户退出或终端关闭时，程序仍然运行。当用 nohup 命令执行作业时，缺省情况下该作业的所有输出被重定向到 nohup.out 的文件中，除非另外指定了输出文件。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ nohup java -jar test.jar &gt;temp.txt &amp;</span><br></pre></td></tr></table></figure>

<p>此时把日志文件输入到指定的文件中，没有则会自动创建。</p>
<p><strong>附加内容：两种报错的解决</strong></p>
<p>▲ 提示 <code>nohup: failed to run command</code>java’: No such file or directory&#96;</p>
<p>▲ 或者使用 .&#x2F;startup.sh 开启 tomcat 服务报错：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Neither the JAVA_HOME nor the JRE_HOME environment variable is defined</span><br><span class="line">At least one of these environment variable is needed to run this program</span><br></pre></td></tr></table></figure>

<p>以上情况，执行一次 source &#x2F;etc&#x2F;profile 即可。</p>
<h2 id="6-3、linux-kill-命令"><a href="#6-3、linux-kill-命令" class="headerlink" title="6.3、linux kill 命令"></a>6.3、linux kill 命令</h2><p>格式：kill [参数][进程号]</p>
<h2 id="6-4、linux-查询端口情况"><a href="#6-4、linux-查询端口情况" class="headerlink" title="6.4、linux 查询端口情况"></a>6.4、linux 查询端口情况</h2><p>netstat 命令各个参数说明如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-t : 指明显示TCP端口</span><br><span class="line">-u : 指明显示UDP端口</span><br><span class="line">-l : 仅显示监听套接字(所谓套接字就是使应用程序能够读写与收发通讯协议(protocol)与资料的程序)</span><br><span class="line">-p : 显示进程标识符和程序名称，每一个套接字/端口都属于一个程序。</span><br><span class="line">-n : 不进行DNS轮询，显示IP(可以加速操作)</span><br></pre></td></tr></table></figure>

<p>要显示当前服务器上所有端口及进程服务，与 grep 结合可查看某个具体端口及服务情况：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">netstat -ntlp   //查看当前所有tcp端口</span><br><span class="line">netstat -ntulp |grep 80   //查看所有80端口使用情况</span><br><span class="line">netstat -ntulp | grep 3306   //查看所有3306端口使用情况</span><br></pre></td></tr></table></figure>

<p>查询出来的结果，根据 ID 号可以用 kill 命令终止后台运行的任务。</p>
<p><strong>附加内容：使用 netstate 报 -bash: netstate: command not found</strong><br>网络工具没有安装，执行 <code>yum install net-tools</code>，安装即可</p>
<h2 id="6-5、jobs-命令："><a href="#6-5、jobs-命令：" class="headerlink" title="6.5、jobs 命令："></a>6.5、jobs 命令：</h2><p>查看当前终端后台运行的任务。jobs 的状态可以是 running，stopped，Terminated。<code>+</code> 号表示当前任务，<code>-</code> 号表示后一个任务。</p>
<p>注：该命令可在使用 nohup 后紧接使用。</p>
<h2 id="6-7、scp-上传或下载文件"><a href="#6-7、scp-上传或下载文件" class="headerlink" title="6.7、scp 上传或下载文件"></a>6.7、scp 上传或下载文件</h2><ul>
<li>可执行 <code>yum install openssh-clients</code> 命令进行安装</li>
<li>上传文件到服务器：<code>scp /Users/spirit/Documents/WechatIMG135.jpeg root@192.168.1.1:/usr/local</code></li>
<li>上传文件夹到服务器：<code>scp -r /Users/spirit/Documents/fileFolder root@192.168.1.1:/usr/local</code></li>
<li>从服务器下载文件：<code>scp root@192.168.1.1:/usr/local/WechatIMG135.jpeg /Users/spirit/Documents</code></li>
<li>从服务器下载文件夹：<code>scp -r root@192.168.1.1:/usr/local/fileFolder /Users/spirit/Documents</code></li>
</ul>
<p>参数说明：</p>
<ul>
<li><code>-1</code>：强制 scp 命令使用协议 ssh1</li>
<li><code>-2</code>：强制 scp 命令使用协议 ssh2</li>
<li><code>-4</code>：强制 scp 命令只使用 IPv4 寻址</li>
<li><code>-6</code>：强制 scp 命令只使用 IPv6 寻址</li>
<li><code>-B</code>：使用批处理模式（传输过程中不询问传输口令或短语）</li>
<li><code>-C</code>：允许压缩。（将-C 标志传递给 ssh，从而打开压缩功能）</li>
<li><code>-p</code>：保留原文件的修改时间，访问时间和访问权限。</li>
<li><code>-q</code>：不显示传输进度条。</li>
<li><code>-r</code>：递归复制整个目录。</li>
<li><code>-v</code>：详细方式显示输出。scp 和 ssh(1)会显示出整个过程的调试信息。这些信息用于调试连接，验证和配置问题。</li>
<li><code>-c</code>：cipher，以 cipher 将数据传输进行加密，这个选项将直接传递给 ssh。</li>
<li><code>-F</code>：ssh_config，指定一个替代的 ssh 配置文件，此参数直接传递给 ssh。</li>
<li><code>-i</code>：identity_file，从指定文件中读取传输时使用的密钥文件，此参数直接传递给 ssh。</li>
<li><code>-l</code>：limit，限定用户所能使用的带宽，以 Kbit&#x2F;s 为单位。</li>
<li><code>-o</code>：ssh_option，如果习惯于使用 ssh_config(5)中的参数传递方式，</li>
<li><code>-P</code>：port，注意是大写的 P, port 是指定数据传输用到的端口号</li>
<li><code>-S</code>：program，指定加密传输时所使用的程序。此程序必须能够理解 ssh(1)的选项。</li>
</ul>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>JavaWeb</tag>
      </tags>
  </entry>
  <entry>
    <title>使用-Navicat-远程连接阿里云服务器的-MySQL-数据库</title>
    <url>/5886f891-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>使用 Navicat 连接阿里云远程 MySQL 数据库。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="1、开放权限"><a href="#1、开放权限" class="headerlink" title="1、开放权限"></a>1、开放权限</h3><p>登录 MySql，此时用命令指定用户名 root 可以通过密码 123456 访问所有数据库，之后刷新权限。相应的命令及结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt;GRANT ALL PRIVILEGES ON *.* TO &#x27;root&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;123456&#x27; WITH GRANT OPTION;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="2、设置服务器安全组的端口放行规则"><a href="#2、设置服务器安全组的端口放行规则" class="headerlink" title="2、设置服务器安全组的端口放行规则"></a>2、设置服务器安全组的端口放行规则</h3><p><strong>ECS 云服务器安全组设置如下：</strong></p>
<img src="/5886f891-2a1e-11ee-846a-89c1529ebdf1/1.png" class="">

<p><strong>轻量应用服务器防火墙设置如下：</strong></p>
<img src="/5886f891-2a1e-11ee-846a-89c1529ebdf1/2.png" class="">

<h3 id="3、设置-Navicat"><a href="#3、设置-Navicat" class="headerlink" title="3、设置 Navicat"></a>3、设置 Navicat</h3><p>进入 Navicat，新建连接，在「常规」选项卡中输入开放权限时的信息，用户名：root；密码：123456</p>
<img src="/5886f891-2a1e-11ee-846a-89c1529ebdf1/3.png" class="">
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>使用-github+Action-部署-Hexo-博客</title>
    <url>/5886f892-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为便于叙述，统一说明如下：</p>
<ul>
<li>博客 github 源码仓库默认分支为 main，ssh 地址：<code>git@github.com:username/blog.git</code></li>
<li><code>username.github.io</code>：博客部署仓库，默认分支为 main</li>
<li><code>hexo_deploy</code>：本地私钥文件</li>
<li>&#96;hexo_deploy.pub：本地公钥文件</li>
<li>主题以 NexT 8.13.2 为例</li>
</ul>
<blockquote>
<p>本地 hexo 安装、主题部署流程较简单，步骤省略。</p>
</blockquote>
<h2 id="1、配置本地博客源代码库"><a href="#1、配置本地博客源代码库" class="headerlink" title="1、配置本地博客源代码库"></a>1、配置本地博客源代码库</h2><p>在本地博客源代码仓库根目录 <code>_config.yml</code> 文件中增加如下部署配置：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/one-command-deployment</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">git@github.com:username/username.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">main</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：github 目前仅允许 ssh 提交，部署仓库必须为 ssh 地址</p>
</blockquote>
<h2 id="2、配置专用密钥对"><a href="#2、配置专用密钥对" class="headerlink" title="2、配置专用密钥对"></a>2、配置专用密钥对</h2><p>本地重新生成一组密钥对，如 <code>hexo_deploy.pub</code> 与 <code>hexo_deploy</code>。私钥配置到 github 源码仓库的 <code>repository secret</code>，公钥配置到 <code>username.github.io</code> 部署仓库的 <code>Deploy keys</code>。该密钥对专用于「源码仓库」与「部署仓库」之间的 Action 自动部署。</p>
<blockquote>
<p>github 源码库新建后即可配置：依次进入 <code>Settings -&gt; Secrets -&gt; Actions -&gt; New repository secret</code>，名称取 <code>HEXO_DEPLOY_SECRET</code>，值取自 <code>hexo_deploy</code> 内容；<code>username.github.io.git</code> 部署仓库配置步骤略。</p>
</blockquote>
<p>也可以拿用户公钥 <code>SSH keys</code>（可访问全部仓库）及其对应的私钥完成该步骤，但是用户公钥不一致时（比如办公室和家里使用的用户公钥不同，除非复制同一份密钥对），Action 自动部署的私钥也要更改，使用专用密钥对可避免这个问题。</p>
<h2 id="3、创建-Action"><a href="#3、创建-Action" class="headerlink" title="3、创建 Action"></a>3、创建 Action</h2><p>在本地博客源代码库根目录下创建 <code>.github/workflows/deploy.yml</code> 文件，参考内容如下：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">hexo-blog-deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">GIT_USER:</span> <span class="string">username</span></span><br><span class="line">  <span class="attr">GIT_EMAIL:</span> <span class="string">username@gmail.com</span></span><br><span class="line">  <span class="attr">DEPLOY_REPO:</span> <span class="string">username/username.github.io</span></span><br><span class="line">  <span class="attr">DEPLOY_BRANCH:</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Build</span> <span class="string">on</span> <span class="string">node</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.node_version</span> <span class="string">&#125;&#125;</span> <span class="string">and</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.os</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">os:</span> [<span class="string">ubuntu-latest</span>]</span><br><span class="line">        <span class="attr">node_version:</span> [<span class="number">19.</span><span class="string">x</span>]</span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">deploy</span> <span class="string">repo</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.DEPLOY_REPO</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.DEPLOY_BRANCH</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">.deploy_git</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Use</span> <span class="string">Node.js</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.node_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.node_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configuration</span> <span class="string">environment</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">HEXO_DEPLOY_SECRET:</span> <span class="string">$&#123;&#123;secrets.HEXO_DEPLOY_SECRET&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          sudo timedatectl set-timezone &quot;Asia/Shanghai&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">          <span class="comment"># 配置私钥，否则无法访问部署库，提示 git@github.com: Permission denied (publickey).</span></span><br><span class="line">          <span class="string">mkdir</span> <span class="string">-p</span> <span class="string">~/.ssh/</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;$HEXO_DEPLOY_SECRET&quot;</span> <span class="string">&gt;</span> <span class="string">~/.ssh/id_rsa</span></span><br><span class="line">          <span class="string">chmod</span> <span class="number">600</span> <span class="string">~/.ssh/id_rsa</span></span><br><span class="line">          <span class="string">ssh-keyscan</span> <span class="string">github.com</span> <span class="string">&gt;&gt;</span> <span class="string">~/.ssh/known_hosts</span></span><br><span class="line"></span><br><span class="line">          <span class="comment"># 设置用户名和邮箱，否则提示 Please tell me who you are.</span></span><br><span class="line">          <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.name</span> <span class="string">$GIT_USER</span></span><br><span class="line">          <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.email</span> <span class="string">$GIT_EMAIL</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          npm install</span></span><br><span class="line"><span class="string">          npm install hexo-deployer-git --save</span></span><br><span class="line"><span class="string">          # 全局搜索插件</span></span><br><span class="line"><span class="string">          npm install hexo-generator-searchdb --save</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">hexo</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">npm</span> <span class="string">run</span> <span class="string">deploy</span></span><br></pre></td></tr></table></figure>

<h2 id="4、常用命令"><a href="#4、常用命令" class="headerlink" title="4、常用命令"></a>4、常用命令</h2><ul>
<li>本地启动：<code>hexo s</code></li>
<li>清除缓存：<code>hexo clean</code></li>
<li>新建草稿：<code>hexo new draft &lt;filename&gt;</code></li>
<li>发布草稿：<code>hexo publish [layout] &lt;filename&gt;</code></li>
</ul>
<h2 id="5、其他"><a href="#5、其他" class="headerlink" title="5、其他"></a>5、其他</h2><h2 id="（可选）部署留言栏-Utterances"><a href="#（可选）部署留言栏-Utterances" class="headerlink" title="（可选）部署留言栏 Utterances"></a>（可选）部署留言栏 Utterances</h2><p>安装 github 应用： <code>https://github.com/apps/utterances</code></p>
<p>next 最新版本已经集成 Utterances，因此不需要复制安装完成后的模板，直接在主题文件根目录下设置 <code>_config.yml</code> 文件即可：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Utterances</span></span><br><span class="line"><span class="comment"># For more information: https://utteranc.es</span></span><br><span class="line"><span class="attr">utterances:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">username/username.github.io</span> <span class="comment"># Github repository owner and name</span></span><br><span class="line">  <span class="comment"># Available values: pathname | url | title | og:title</span></span><br><span class="line">  <span class="attr">issue_term:</span> <span class="string">pathname</span></span><br><span class="line">  <span class="comment"># Available values: github-light | github-dark | preferred-color-scheme | github-dark-orange | icy-dark | dark-blue | photon-dark | boxy-light</span></span><br><span class="line">  <span class="attr">theme:</span> <span class="string">github-light</span></span><br></pre></td></tr></table></figure>

<h2 id="（可选）部署留言栏-giscus"><a href="#（可选）部署留言栏-giscus" class="headerlink" title="（可选）部署留言栏 giscus"></a>（可选）部署留言栏 giscus</h2><p>进入官网（<code>https://giscus.app/</code>）可拿到一段已经填充配置内容的 <code>&lt;script&gt;</code> 标签：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;script src=&quot;https://giscus.app/client.js&quot;</span><br><span class="line">    data-repo=&quot;[在此输入仓库]&quot;</span><br><span class="line">    data-repo-id=&quot;[在此输入仓库 ID]&quot;</span><br><span class="line">    data-category=&quot;[在此输入分类名]&quot;</span><br><span class="line">    data-category-id=&quot;[在此输入分类 ID]&quot;</span><br><span class="line">    data-mapping=&quot;pathname&quot;</span><br><span class="line">    data-strict=&quot;0&quot;</span><br><span class="line">    data-reactions-enabled=&quot;1&quot;</span><br><span class="line">    data-emit-metadata=&quot;0&quot;</span><br><span class="line">    data-input-position=&quot;bottom&quot;</span><br><span class="line">    data-theme=&quot;preferred_color_scheme&quot;</span><br><span class="line">    data-lang=&quot;zh-CN&quot;</span><br><span class="line">    crossorigin=&quot;anonymous&quot;</span><br><span class="line">    async&gt;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>如果要在每一篇文章后添加评论功能，以 next 主题为例，仅供参考。进入 <code>themes/next/layout/_macro/post.njk</code> 文件，找到模板中「文章末尾」（注释标志为 <code>END POST BODY</code>，如下所示），将上述片段加入。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;#####################&#125;</span><br><span class="line">&#123;### <span class="variable constant_">END</span> <span class="variable constant_">POST</span> <span class="variable constant_">BODY</span> ###&#125;</span><br><span class="line">&#123;#####################&#125;</span><br><span class="line">&lt;footer <span class="keyword">class</span>=<span class="string">&quot;post-footer&quot;</span>&gt;</span><br><span class="line">  &#123;%- <span class="keyword">if</span> is_index %&#125;</span><br><span class="line">    &lt;div <span class="keyword">class</span>=<span class="string">&quot;post-eof&quot;</span> style=<span class="string">&quot;margin:20px auto 20px;width:100%;background: transparent;border-top: 1px solid #e2e0e0&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">  &#123;% <span class="keyword">else</span> %&#125;</span><br><span class="line">    &#123;&#123;- <span class="title function_">next_inject</span>(<span class="string">&#x27;postBodyEnd&#x27;</span>) &#125;&#125;</span><br><span class="line">    &#123;%- <span class="keyword">if</span> post.<span class="property">reward_settings</span>.<span class="property">enable</span> %&#125;</span><br><span class="line">      &#123;&#123; <span class="title function_">partial</span>(<span class="string">&#x27;_partials/post/post-reward.njk&#x27;</span>) &#125;&#125;</span><br><span class="line">    &#123;%- endif %&#125;</span><br><span class="line">    &#123;%- <span class="keyword">if</span> theme.<span class="property">creative_commons</span>.<span class="property">license</span> and theme.<span class="property">creative_commons</span>.<span class="property">post</span> and post.<span class="property">copyright</span> !== <span class="literal">false</span> %&#125;</span><br><span class="line">      &#123;&#123; <span class="title function_">partial</span>(<span class="string">&#x27;_partials/post/post-copyright.njk&#x27;</span>) &#125;&#125;</span><br><span class="line">    &#123;%- endif %&#125;</span><br><span class="line">    &#123;%- <span class="keyword">if</span> theme.<span class="property">follow_me</span> %&#125;</span><br><span class="line">      &#123;&#123; <span class="title function_">partial</span>(<span class="string">&#x27;_partials/post/post-followme.njk&#x27;</span>, &#123;&#125;, &#123;<span class="attr">cache</span>: theme.<span class="property">cache</span>.<span class="property">enable</span>&#125;) &#125;&#125;</span><br><span class="line">    &#123;%- endif %&#125;</span><br><span class="line"></span><br><span class="line">    &#123;#####################&#125;</span><br><span class="line">    &#123;###   add giscus  ###&#125;</span><br><span class="line">    &#123;#####################&#125;</span><br><span class="line"></span><br><span class="line">    &lt;script src=<span class="string">&quot;https://giscus.app/client.js&quot;</span></span><br><span class="line">        data-repo=<span class="string">&quot;[在此输入仓库]&quot;</span></span><br><span class="line">        data-repo-id=<span class="string">&quot;[在此输入仓库 ID]&quot;</span></span><br><span class="line">        data-category=<span class="string">&quot;[在此输入分类名]&quot;</span></span><br><span class="line">        data-category-id=<span class="string">&quot;[在此输入分类 ID]&quot;</span></span><br><span class="line">        data-mapping=<span class="string">&quot;pathname&quot;</span></span><br><span class="line">        data-strict=<span class="string">&quot;0&quot;</span></span><br><span class="line">        data-reactions-enabled=<span class="string">&quot;1&quot;</span></span><br><span class="line">        data-emit-metadata=<span class="string">&quot;0&quot;</span></span><br><span class="line">        data-input-position=<span class="string">&quot;bottom&quot;</span></span><br><span class="line">        data-theme=<span class="string">&quot;preferred_color_scheme&quot;</span></span><br><span class="line">        data-lang=<span class="string">&quot;zh-CN&quot;</span></span><br><span class="line">        crossorigin=<span class="string">&quot;anonymous&quot;</span></span><br><span class="line">        <span class="keyword">async</span>&gt;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line"></span><br><span class="line">    &#123;%- <span class="keyword">if</span> post.<span class="property">tags</span> and post.<span class="property">tags</span>.<span class="property">length</span> %&#125;</span><br><span class="line">      &#123;%- set tag_indicate = <span class="string">&#x27;&lt;i class=&quot;fa fa-tag&quot;&gt;&lt;/i&gt;&#x27;</span> <span class="keyword">if</span> theme.<span class="property">tag_icon</span> <span class="keyword">else</span> <span class="string">&#x27;#&#x27;</span> %&#125;</span><br><span class="line">      &lt;div <span class="keyword">class</span>=<span class="string">&quot;post-tags&quot;</span>&gt;</span><br><span class="line">        &#123;%- <span class="keyword">for</span> tag <span class="keyword">in</span> post.<span class="property">tags</span>.<span class="title function_">toArray</span>() %&#125;</span><br><span class="line">          &lt;a href=<span class="string">&quot;&#123;&#123; url_for(tag.path) &#125;&#125;&quot;</span> rel=<span class="string">&quot;tag&quot;</span>&gt;&#123;&#123; tag_indicate &#125;&#125; &#123;&#123; tag.<span class="property">name</span> &#125;&#125;&lt;/a&gt;</span><br><span class="line">        &#123;%- endfor %&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &#123;%- endif %&#125;</span><br></pre></td></tr></table></figure>

<h2 id="（可选）部署域名"><a href="#（可选）部署域名" class="headerlink" title="（可选）部署域名"></a>（可选）部署域名</h2><p>参考官方文档：<a href="%60https://docs.github.com/cn/pages/configuring-a-custom-domain-for-your-github-pages-site/verifying-your-custom-domain-for-github-pages%60">验证用户站点的域</a></p>
<blockquote>
<p>注意：需要在 blog 源代码库 source 目录下放置 CNAME 文件。之后步骤按官方文档进行</p>
</blockquote>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>github</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>在win10+vscode+anaconda3+python3.11.3独立环境部署pytorch2.0.1+cuda11.8</title>
    <url>/148d4630-44e0-11ee-bc05-f9725afef782/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<p>该方式不用提前安装 vs2015_runtime 运行时以及 cuda、cudnn，在执行 pytorch 官网的命令后已经全部带有。因此，可在独立环境中同时存在多个版本的 cuda 或者 pytorch cpu 版本。</p>
<h2 id="1、确定可支持-CUDA-版本"><a href="#1、确定可支持-CUDA-版本" class="headerlink" title="1、确定可支持 CUDA 版本"></a>1、确定可支持 CUDA 版本</h2><p>打开 NVIDIA Control Panel（NVIDIA 控制面板），点击左下角「系统信息」，在「组件」标签页查看支持的最高版本，如图所示：</p>
<p><img src="/148d4630-44e0-11ee-bc05-f9725afef782/%E5%9B%BE1-%E7%A1%AE%E5%AE%9A%E5%8F%AF%E6%94%AF%E6%8C%81CUDA%E7%89%88%E6%9C%AC.png" alt="图1-确定可支持CUDA版本"></p>
<h2 id="2、在-https-pytorch-org-查看-pytorch-支持的最高-CUDA-版本"><a href="#2、在-https-pytorch-org-查看-pytorch-支持的最高-CUDA-版本" class="headerlink" title="2、在 https://pytorch.org/ 查看 pytorch 支持的最高 CUDA 版本"></a>2、在 <a href="https://pytorch.org/">https://pytorch.org/</a> 查看 pytorch 支持的最高 CUDA 版本</h2><p><img src="/148d4630-44e0-11ee-bc05-f9725afef782/%E5%9B%BE2-%E6%9F%A5%E7%9C%8Bpytorch%E6%94%AF%E6%8C%81%E7%9A%84%E6%9C%80%E9%AB%98CUDA%E7%89%88%E6%9C%AC.png" alt="图2-查看pytorch支持的最高CUDA版本"></p>
<h2 id="3、执行部署"><a href="#3、执行部署" class="headerlink" title="3、执行部署"></a>3、执行部署</h2><p>1）确保 anaconda3（python3.11.3）在 vscode 能够正常使用，相关部署参考 <a href="https://www.dcheng.site/148d4631-44e0-11ee-bc05-f9725afef782/">部署win10+vscode+anaconda3环境</a></p>
<p>2）执行下列命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">conda install pytorch torchvision torchaudio pytorch-cuda=11.8 -c pytorch -c nvidia</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：全部安装均采用默认源，其中 libcublas 包的安装比较费时。</p>
</blockquote>
<p>3）验证</p>
<p>执行如下代码：</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="comment"># cuda是否可用</span></span><br><span class="line"><span class="built_in">print</span>(torch.cuda.is_available())</span><br><span class="line"><span class="comment"># 获取GPU信息</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;GPU=&quot;</span>, torch.cuda.get_device_name(torch.device(<span class="string">&quot;cuda:0&quot;</span>)))</span><br><span class="line"><span class="comment"># 获取pytorch版本</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;pytorch version=&quot;</span>, torch.__version__)</span><br><span class="line"><span class="comment"># 获取cuda版本</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;cuda Version=&quot;</span>, torch.version.cuda)</span><br><span class="line"><span class="comment"># 获取cudnn版本</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;cudnn version=&quot;</span>, torch.backends.cudnn.version())</span><br></pre></td></tr></table></figure>

<p>输出如下结果，表明全部组件安装成功：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">True</span><br><span class="line">GPU= NVIDIA GeForce RTX 4070</span><br><span class="line">pytorch version= 2.0.1</span><br><span class="line">cuda Version= 11.8</span><br><span class="line">cudnn version= 8700</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>cuda</tag>
        <tag>pytorch</tag>
        <tag>python3</tag>
      </tags>
  </entry>
  <entry>
    <title>树莓派-ubuntu-环境下-mariadb-部署</title>
    <url>/ef12ce00-4937-11ee-861d-b3cf05b530a5/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<p>1、下载树莓派 Ubuntu Server 20.04.3 LTS</p>
<p><a href="https://cn.ubuntu.com/download/raspberry-pi">https://cn.ubuntu.com/download/raspberry-pi</a></p>
<p>2、使用 balenaEtcher 制作系统到闪存</p>
<p><a href="https://www.balena.io/etcher/">https://www.balena.io/etcher/</a></p>
<p>3、设置 wifi</p>
<p>参考官网步骤：<a href="https://ubuntu.com/tutorials/how-to-install-ubuntu-on-your-raspberry-pi#3-wifi-or-ethernet">https://ubuntu.com/tutorials/how-to-install-ubuntu-on-your-raspberry-pi#3-wifi-or-ethernet</a></p>
<p>启动系统前，在闪存找到 network-config 文件，移除注释，按需设置。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wifis:</span><br><span class="line">  wlan0:</span><br><span class="line">    dhcp4: true</span><br><span class="line">    optional: true</span><br><span class="line">    access-points:</span><br><span class="line">      &quot;home network&quot;:</span><br><span class="line">        password: &quot;123456789&quot;</span><br></pre></td></tr></table></figure>

<p>4、启动系统</p>
<ul>
<li>默认用户名：ubuntu</li>
<li>默认密码：ubuntu</li>
</ul>
<p>5、安装 ssh</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install openssh-server</span><br></pre></td></tr></table></figure>

<p>执行 apt-get 若出现 Could not get lock… 等类似提示，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">E: Could not get lock /var/lib/dpkg/lock. It is held by process 34781 (dpkg)</span><br><span class="line">N: Be aware that removing the lock file is not a solution and may break your system.</span><br><span class="line">E: Unable to lock the administration directory (/var/lib/dpkg/), is another process using it?</span><br></pre></td></tr></table></figure>

<p>可通过 <code>ps afx|grep apt</code> 命令查看进程，使用 <code>kill -9 &lt;进程编号&gt;</code> 停止占用进程，再执行安装命令即可。</p>
<blockquote>
<p>注：不必删除 lock 文件。</p>
</blockquote>
<p>通过 <code>sudo systemctl status ssh</code> 查看服务状态是否正常，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ sudo systemctl status ssh</span><br><span class="line">● ssh.service - OpenBSD Secure Shell server</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/ssh.service; enabled; vendor preset: enabled)</span><br><span class="line">     Active: active (running) since Fri 2022-02-11 03:48:39 UTC; 1h 43min ago</span><br><span class="line">       Docs: man:sshd(8)</span><br><span class="line">             man:sshd_config(5)</span><br><span class="line">   Main PID: 45984 (sshd)</span><br><span class="line">      Tasks: 1 (limit: 4435)</span><br><span class="line">     CGroup: /system.slice/ssh.service</span><br><span class="line">             └─45984 sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过 <code>ssh ubuntu@xxx.xxx.xxx.xxx</code> 连接即可。</p>
<p>6、安装 mariadb</p>
<p>参考官网步骤，采用阿里云镜像</p>
<p><a href="https://mariadb.org/download/?t=repo-config&d=20.04+%22focal%22&v=10.6&r_m=aliyun">https://mariadb.org/download/?t=repo-config&amp;d=20.04+%22focal%22&amp;v=10.6&amp;r_m=aliyun</a></p>
<p><strong>依次</strong>执行如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install software-properties-common dirmngr apt-transport-https</span><br><span class="line">sudo apt-key adv --fetch-keys &#x27;https://mariadb.org/mariadb_release_signing_key.asc&#x27;</span><br><span class="line">sudo add-apt-repository &#x27;deb [arch=amd64,arm64,ppc64el,s390x] https://mirrors.aliyun.com/mariadb/repo/10.6/ubuntu focal main&#x27;</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install mariadb-server</span><br></pre></td></tr></table></figure>

<p>通过 <code>sudo systemctl status mariadb.service</code> 查看服务状态，正常工作如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ sudo systemctl status mariadb.service</span><br><span class="line"></span><br><span class="line">● mariadb.service - MariaDB 10.6.5 database server</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/mariadb.service; enabled; vendor prese&gt;</span><br><span class="line">    Drop-In: /etc/systemd/system/mariadb.service.d</span><br><span class="line">             └─migrated-from-my.cnf-settings.conf</span><br><span class="line">     Active: active (running) since Fri 2022-02-11 03:56:37 UTC; 39min ago</span><br><span class="line">       Docs: man:mariadbd(8)</span><br><span class="line">             https://mariadb.com/kb/en/library/systemd/</span><br><span class="line">   Main PID: 48637 (mariadbd)</span><br><span class="line">     Status: &quot;Taking your SQL requests now...&quot;</span><br><span class="line">      Tasks: 8 (limit: 4435)</span><br><span class="line">     CGroup: /system.slice/mariadb.service</span><br><span class="line">             └─48637 /usr/sbin/mariadbd</span><br></pre></td></tr></table></figure>

<p>7、修改密码</p>
<p>通过 <code>sudo mariadb -u root -p</code> 登录，不必输入密码，直接回车后修改 root 密码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use mysql;</span><br><span class="line">alter user &#x27;root&#x27;@&#x27;localhost&#x27; identified by &#x27;xxxxxx&#x27;;</span><br></pre></td></tr></table></figure>

<p>可通过 <code>select user, plugin from mysql.user;</code> 查看登陆方式。初始状态为 unix_socket(MariaDB)，配置密码后为 mysql_native_password</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; select user, plugin from mysql.user;</span><br><span class="line">+-------------+-----------------------+</span><br><span class="line">| User        | plugin                |</span><br><span class="line">+-------------+-----------------------+</span><br><span class="line">| mariadb.sys | mysql_native_password |</span><br><span class="line">| root        | mysql_native_password |</span><br><span class="line">| mysql       | mysql_native_password |</span><br><span class="line">+-------------+-----------------------+</span><br><span class="line">4 rows in set (0.011 sec)</span><br></pre></td></tr></table></figure>

<p>8、允许远程连接</p>
<p>通过 <code>sudo vim /etc/mysql/mariadb.conf.d/50-server.cnf</code> 修改配置，将其中 <code>bind-address = 127.0.0.1</code> 修改为 0.0.0.0 或直接注释掉。</p>
<p>新增远程连接用户 <code>create user &lt;username&gt;@xxx.xxx.xxx.xxx identified by &#39;123456&#39;;</code></p>
<p>9、其他</p>
<p>启动 MariaDB 数据库服务 <code>sudo systemctl start mysql</code></p>
<p>重启数据库服务 <code>sudo systemctl restart mysql</code></p>
<p>设置 mysql 随系统服务启动 <code>sudo update-rc.d mysql defaults</code></p>
<p>撤销随系统服务启动 <code>sudo update-rc.d -f mysql remove</code></p>
<h2 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h2><h2 id="磁盘挂载"><a href="#磁盘挂载" class="headerlink" title="磁盘挂载"></a>磁盘挂载</h2><p>以机械硬盘为例，已经在 windows 格式化为 exFAT 格式。通过 USB 接入树莓派后，登入系统，通过 <code>sudo fdisk -l</code> 查看当前磁盘状态如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ sudo fdisk -l</span><br><span class="line">Disk /dev/loop0: 48.92 MiB, 51277824 bytes, 100152 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line">Disk /dev/loop1: 61.98 MiB, 64962560 bytes, 126880 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line">Disk /dev/loop2: 28.7 MiB, 29433856 bytes, 57488 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line"></span><br><span class="line">Disk /dev/mmcblk0: 29.74 GiB, 31914983424 bytes, 62333952 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel type: dos</span><br><span class="line">Disk identifier: 0xf66f0719</span><br><span class="line"></span><br><span class="line">Device         Boot  Start      End  Sectors  Size Id Type</span><br><span class="line">/dev/mmcblk0p1 *      2048   526335   524288  256M  c W95 FAT32 (LBA)</span><br><span class="line">/dev/mmcblk0p2      526336 62333918 61807583 29.5G 83 Linux</span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 298.9 GiB, 320072933376 bytes, 625142448 sectors</span><br><span class="line">Disk model: 00AAJS-00L7A0</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 33553920 bytes</span><br><span class="line">Disklabel type: dos</span><br><span class="line">Disk identifier: 0x91676b87</span><br><span class="line"></span><br><span class="line">Device     Boot Start       End   Sectors   Size Id Type</span><br><span class="line">/dev/sda1        2048 625139711 625137664 298.1G  7 HPFS/NTFS/exFAT</span><br></pre></td></tr></table></figure>

<p>格式化硬盘为 ext4 格式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ sudo mkfs -t ext4 /dev/sda</span><br><span class="line">mke2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Found a dos partition table in /dev/sda</span><br><span class="line">Proceed anyway? (y,N) y</span><br><span class="line">Creating filesystem with 78142806 4k blocks and 19537920 inodes</span><br><span class="line">Filesystem UUID: bfff555b-254e-403a-880e-260601f7c1e5</span><br><span class="line">Superblock backups stored on blocks:</span><br><span class="line">	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,</span><br><span class="line">	4096000, 7962624, 11239424, 20480000, 23887872, 71663616</span><br><span class="line"></span><br><span class="line">Allocating group tables: done</span><br><span class="line">Writing inode tables: done</span><br><span class="line">Creating journal (262144 blocks): done</span><br><span class="line">Writing superblocks and filesystem accounting information: done</span><br></pre></td></tr></table></figure>

<p>通过以下命令建立目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir /mnt/disk</span><br><span class="line">chmod 777 /mnt/disk</span><br></pre></td></tr></table></figure>

<p>挂载硬盘</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mount /dev/sda /mnt/disk</span><br></pre></td></tr></table></figure>

<p>查询 uuid</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ubuntu@ubuntu:~$ sudo blkid</span><br><span class="line">/dev/mmcblk0p1: LABEL_FATBOOT=&quot;system-boot&quot; LABEL=&quot;system-boot&quot; UUID=&quot;5496-E6C8&quot; TYPE=&quot;vfat&quot; PARTUUID=&quot;f66f0719-01&quot;</span><br><span class="line">/dev/mmcblk0p2: LABEL=&quot;writable&quot; UUID=&quot;675ba907-3741-428c-afa4-c00f1b649e3c&quot; TYPE=&quot;ext4&quot; PARTUUID=&quot;f66f0719-02&quot;</span><br><span class="line">/dev/loop0: TYPE=&quot;squashfs&quot;</span><br><span class="line">/dev/loop1: TYPE=&quot;squashfs&quot;</span><br><span class="line">/dev/loop2: TYPE=&quot;squashfs&quot;</span><br><span class="line">/dev/sda: UUID=&quot;bfff555b-254e-403a-880e-260601f7c1e5&quot; TYPE=&quot;ext4&quot;</span><br></pre></td></tr></table></figure>

<p>通过 <code>sudo vim /etc/fstab</code> 在末尾添加下列内容，两者选其一：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UUID=bfff555b-254e-403a-880e-260601f7c1e5 /mnt/disk ext4 defaults 0 0</span><br><span class="line">或</span><br><span class="line">/dev/sda /mnt/disk ext4 defaults 0 0</span><br></pre></td></tr></table></figure>

<p>第一个数字：0 表示开机不检查磁盘，1 表示开机检查磁盘；<br>第二个数字：0 表示交换分区，1 代表启动分区（Linux），2 表示普通分区</p>
<p>其他补充：<br>进入 &#x2F;mnt&#x2F;disk 目录，其中包含</p>
<p>如果你运行 fsck 命令（文件系统检查和修复命令），它也许会找到一些数据碎片，这些文件碎片在硬盘中并没有引用。特别的，fsck 也许能找到看起来是完整的文件，但是在系统中没有名字－一个 inode 但是不对应文件名。这个数据仍然占用硬盘空间，但是并不能通过正常方式访问。</p>
<pre><code>     lost+found目录的文件通常是未链接的文件（名字已经被删除），但是这些文件还被一些进程使用（数据没有删除），在突然关机时（内核panic或者突然断电）出现。这些文件系统会自动删除。

    当因为软件或者硬件出现错误，导致文件系统不一致，也有可能把有问题的文件放到lost+found目录。它提供了恢复丢失文件的一种方法。



    如果你不小心删除了lost+found目录，不能使用mkdir命令创建lost+found目录，应该使用mklost+found命令创建它。
</code></pre>
<p>$ cd &#x2F;<br>$ sudo mklost+found</p>
<h1 id="磁盘容量及分区状况（不能查看未挂载分区）"><a href="#磁盘容量及分区状况（不能查看未挂载分区）" class="headerlink" title="磁盘容量及分区状况（不能查看未挂载分区）"></a>磁盘容量及分区状况（不能查看未挂载分区）</h1><p>df -Th</p>
<h1 id="磁盘容量及分区状况（可以查看未挂载分区）"><a href="#磁盘容量及分区状况（可以查看未挂载分区）" class="headerlink" title="磁盘容量及分区状况（可以查看未挂载分区）"></a>磁盘容量及分区状况（可以查看未挂载分区）</h1><p>sudo fdisk -l<br>sudo lsblk -f</p>
<h1 id="x2F-lib-目录大小"><a href="#x2F-lib-目录大小" class="headerlink" title="&#x2F;lib 目录大小"></a>&#x2F;lib 目录大小</h1><p>du -sh &#x2F;lib</p>
<h1 id="x2F-lib-子目录大小"><a href="#x2F-lib-子目录大小" class="headerlink" title="&#x2F;lib 子目录大小"></a>&#x2F;lib 子目录大小</h1><p>du -sh &#x2F;lib&#x2F;*</p>
<h2 id="转移-mariadb-数据"><a href="#转移-mariadb-数据" class="headerlink" title="转移 mariadb 数据"></a>转移 mariadb 数据</h2><p>执行 <code>sudo systemctl stop mariadb.service</code> 停止服务</p>
<p>新建 &#x2F;mnt&#x2F;disk&#x2F;mariadbdata</p>
<p>通过 <code>sudo vim /etc/mysql/mariadb.conf.d/50-server.cnf</code> 修改 datadir 如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># * Basic Settings</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">user                    = mysql</span><br><span class="line">pid-file                = /run/mysqld/mysqld.pid</span><br><span class="line">basedir                 = /usr</span><br><span class="line">#datadir                 = /var/lib/mysql</span><br><span class="line">datadir                 = /mnt/disk/mariadbdata</span><br><span class="line">tmpdir                  = /tmp</span><br><span class="line">lc-messages-dir         = /usr/share/mysql</span><br><span class="line">lc-messages             = en_US</span><br><span class="line">skip-external-locking</span><br></pre></td></tr></table></figure>

<p>执行 <code>sudo cp -r /var/lib/mysql/* /mnt/disk/mariadbdata/</code> 复制旧数据到新位置。</p>
<p>修改目录权限和组</p>
<p><code>sudo chown -R mysql:mysql /mnt/disk/mariadbdata</code></p>
<blockquote>
<p>注意：若需要保存旧目录数据，应复制文件后再修改所有者，否则无法启动服务。</p>
</blockquote>
<p>执行 <code>sudo systemctl start mariadb.service</code> 重启服务</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>如果将数据转移到 &#x2F;home 目录需要修改 <code>/lib/systemd/system/mariadb.service</code> 为 <code>ProtectHome=false</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Prevent accessing /home, /root and /run/user</span><br><span class="line">ProtectHome=true</span><br></pre></td></tr></table></figure>

<h1 id="The-MariaDB-x2F-MySQL-tools-read-configuration-files-in-the-following-order"><a href="#The-MariaDB-x2F-MySQL-tools-read-configuration-files-in-the-following-order" class="headerlink" title="The MariaDB&#x2F;MySQL tools read configuration files in the following order:"></a>The MariaDB&#x2F;MySQL tools read configuration files in the following order:</h1><h1 id="0-“-x2F-etc-x2F-mysql-x2F-my-cnf”-symlinks-to-this-file-reason-why-all-the-rest-is-read"><a href="#0-“-x2F-etc-x2F-mysql-x2F-my-cnf”-symlinks-to-this-file-reason-why-all-the-rest-is-read" class="headerlink" title="0. “&#x2F;etc&#x2F;mysql&#x2F;my.cnf” symlinks to this file, reason why all the rest is read."></a>0. “&#x2F;etc&#x2F;mysql&#x2F;my.cnf” symlinks to this file, reason why all the rest is read.</h1><h1 id="1-“-x2F-etc-x2F-mysql-x2F-mariadb-cnf”-this-file-to-set-global-defaults"><a href="#1-“-x2F-etc-x2F-mysql-x2F-mariadb-cnf”-this-file-to-set-global-defaults" class="headerlink" title="1. “&#x2F;etc&#x2F;mysql&#x2F;mariadb.cnf” (this file) to set global defaults,"></a>1. “&#x2F;etc&#x2F;mysql&#x2F;mariadb.cnf” (this file) to set global defaults,</h1><h1 id="2-“-x2F-etc-x2F-mysql-x2F-conf-d-x2F-cnf”-to-set-global-options"><a href="#2-“-x2F-etc-x2F-mysql-x2F-conf-d-x2F-cnf”-to-set-global-options" class="headerlink" title="2. “&#x2F;etc&#x2F;mysql&#x2F;conf.d&#x2F;*.cnf” to set global options."></a>2. “&#x2F;etc&#x2F;mysql&#x2F;conf.d&#x2F;*.cnf” to set global options.</h1><h1 id="3-“-x2F-etc-x2F-mysql-x2F-mariadb-conf-d-x2F-cnf”-to-set-MariaDB-only-options"><a href="#3-“-x2F-etc-x2F-mysql-x2F-mariadb-conf-d-x2F-cnf”-to-set-MariaDB-only-options" class="headerlink" title="3. “&#x2F;etc&#x2F;mysql&#x2F;mariadb.conf.d&#x2F;*.cnf” to set MariaDB-only options."></a>3. “&#x2F;etc&#x2F;mysql&#x2F;mariadb.conf.d&#x2F;*.cnf” to set MariaDB-only options.</h1><h1 id="4-“-x2F-my-cnf”-to-set-user-specific-options"><a href="#4-“-x2F-my-cnf”-to-set-user-specific-options" class="headerlink" title="4. “~&#x2F;.my.cnf” to set user-specific options."></a>4. “~&#x2F;.my.cnf” to set user-specific options.</h1><p>50-client.cnf 50-mysqld_safe.cnf 60-galera.cnf<br>50-mysql-clients.cnf 50-server.cnf 99-enable-encryption.cnf.preset</p>
<h2 id="部署-java11"><a href="#部署-java11" class="headerlink" title="部署 java11"></a>部署 java11</h2><p>参考 <a href="https://docs.aws.amazon.com/corretto/latest/corretto-11-ug/generic-linux-install.html">https://docs.aws.amazon.com/corretto/latest/corretto-11-ug/generic-linux-install.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget -O- https://apt.corretto.aws/corretto.key | sudo apt-key add -</span><br><span class="line"></span><br><span class="line">sudo add-apt-repository &#x27;deb https://apt.corretto.aws stable main&#x27;</span><br><span class="line"></span><br><span class="line">sudo apt-get update; sudo apt-get install -y java-11-amazon-corretto-jdk</span><br></pre></td></tr></table></figure>

<p>安装路径</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/lib/jvm/java-11-amazon-corretto/bin/</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>ubuntu</tag>
        <tag>mariadb</tag>
        <tag>raspberry-pi</tag>
      </tags>
  </entry>
  <entry>
    <title>激活 win10/11 pro</title>
    <url>/53337b90-4f8d-11ee-9eaf-09d2cd19d790/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、激活步骤"><a href="#1、激活步骤" class="headerlink" title="1、激活步骤"></a>1、激活步骤</h2><p>在需要激活的设备以管理员身份开启 cmd，执行以下步骤：</p>
<p>1）卸载密钥，执行 <code>slmgr /upk</code></p>
<blockquote>
<p>注意：务必要执行卸载步骤</p>
</blockquote>
<p>2）假设已部署的 kms 服务器 ip 为 <code>192.168.1.5</code>，执行 <code>slmgr /skms 192.168.1.5</code> 设置 kms 服务器地址。可参考 <a href="https://www.dcheng.site/faef3d90-4ea4-11ee-addd-c161ce22f848/">部署 kms 服务器</a> 的内容建立 kms 服务器</p>
<blockquote>
<p>win10 部署的服务器要注意防火墙规则是否允许访问</p>
</blockquote>
<p>3）安装密钥，执行 <code>slmgr /ipk W269N-WFGWX-YVC9B-4J6C9-T83GX</code></p>
<blockquote>
<p>该密钥为 win10&#x2F;11 专业版固定，其他密钥详见 <a href="https://learn.microsoft.com/en-us/windows-server/get-started/kms-client-activation-keys">https://learn.microsoft.com/en-us/windows-server/get-started/kms-client-activation-keys</a></p>
</blockquote>
<p>4）激活，执行 <code>slmgr /ato</code>，等待数秒后提示是否成功</p>
<p>5）验证，执行 <code>slmgr /xpr</code> 后若成功激活将显示有效时间 180 天</p>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>win</tag>
      </tags>
  </entry>
  <entry>
    <title>部署 Office LTSC 2021 批量授权版本</title>
    <url>/53337b91-4f8d-11ee-9eaf-09d2cd19d790/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="0、前言"><a href="#0、前言" class="headerlink" title="0、前言"></a>0、前言</h2><p>本文仅提炼总结关键步骤，详情可见官网文档：<a href="https://learn.microsoft.com/zh-cn/deployoffice/ltsc2021/deploy?cid=kerryherger">https://learn.microsoft.com/zh-cn/deployoffice/ltsc2021/deploy?cid=kerryherger</a></p>
<h2 id="1、建立安装目录"><a href="#1、建立安装目录" class="headerlink" title="1、建立安装目录"></a>1、建立安装目录</h2><p>新建任意名称的目录 <code>C:\Users\abc\Desktop\officefiles</code>，用于归档部署过程中产生的文件。</p>
<h2 id="2、下载-Office-部署工具"><a href="#2、下载-Office-部署工具" class="headerlink" title="2、下载 Office 部署工具"></a>2、下载 Office 部署工具</h2><p>1）下载部署工具到 <code>officefiles</code> 目录，官网地址：<a href="https://www.microsoft.com/download/details.aspx?id=49117">https://www.microsoft.com/download/details.aspx?id=49117</a></p>
<p>2）双击 <code>officedeploymenttool.exe</code> 可执行文件，选择提取文件路径，也直接放在 <code>officefiles</code> 目录</p>
<h2 id="3、创建-configuration-xml-文件"><a href="#3、创建-configuration-xml-文件" class="headerlink" title="3、创建 configuration.xml 文件"></a>3、创建 <code>configuration.xml</code> 文件</h2><p>1）使用 Office 自定义工具创建 <code>configuration.xml</code> 文件，工具地址：<a href="https://config.office.com/deploymentsettings">https://config.office.com/deploymentsettings</a></p>
<p>2）根据需求选择 office 套件、语言，大多数选项保持默认即可。配置完成后导出，放在 <code>officefiles</code> 目录</p>
<blockquote>
<p>注意：配置文件名称必须是 <code>configuration.xml</code></p>
</blockquote>
<h2 id="3、下载-Office-LTSC-2021-安装文件"><a href="#3、下载-Office-LTSC-2021-安装文件" class="headerlink" title="3、下载 Office LTSC 2021 安装文件"></a>3、下载 Office LTSC 2021 安装文件</h2><p>1）以管理员身份打开 cmd，进入目录 <code>C:\Users\abc\Desktop\officefiles</code></p>
<p>2）执行 <code>setup /download configuration.xml</code>，此时在 <code>officefiles</code> 中会包含名为 Data 的新目录。</p>
<h2 id="4、安装-Office-LTSC-2021"><a href="#4、安装-Office-LTSC-2021" class="headerlink" title="4、安装 Office LTSC 2021"></a>4、安装 Office LTSC 2021</h2><p>1）以管理员身份打开 cmd，进入目录 <code>C:\Users\abc\Desktop\officefiles</code></p>
<p>2）执行 <code>setup /configure configuration.xml</code>，安装完成后，将返回到命令提示符</p>
<blockquote>
<p>安装路径默认在 <code>C:\Program Files\Microsoft Office</code></p>
</blockquote>
<h2 id="5、激活"><a href="#5、激活" class="headerlink" title="5、激活"></a>5、激活</h2><p>1）以管理员身份打开 cmd，进入目录 <code>C:\Program Files\Microsoft Office\Office16</code></p>
<p>2）假设已部署的 kms 服务器 ip 为 <code>192.168.1.5</code>，执行 <code>cscript ospp.vbs /sethst:192.168.1.5</code> 设置 kms 服务器地址。出现以下提示说明配置成功：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---Processing--------------------------</span><br><span class="line">---------------------------------------</span><br><span class="line">Successfully applied setting.</span><br><span class="line">---------------------------------------</span><br><span class="line">---Exiting-----------------------------</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可参考 <a href="https://www.dcheng.site/faef3d90-4ea4-11ee-addd-c161ce22f848/">部署 kms 服务器</a> 的内容建立 kms 服务器</p>
</blockquote>
<p>3）执行 <code>cscript ospp.vbs /act</code> 激活。出现以下提示说明配置成功：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Microsoft (R) Windows Script Host Version 5.812</span><br><span class="line">版权所有(C) Microsoft Corporation。保留所有权利。</span><br><span class="line"></span><br><span class="line">---Processing--------------------------</span><br><span class="line">---------------------------------------</span><br><span class="line">Installed product key detected - attempting to activate the following product:</span><br><span class="line">SKU ID: fb61ac9a-1688-45d2-8f6b-0674dbffa33c</span><br><span class="line">LICENSE NAME: Office 21, Office21VisioPro2021VL_KMS_Client_AE edition</span><br><span class="line">LICENSE DESCRIPTION: Office 21, VOLUME_KMSCLIENT channel</span><br><span class="line">Last 5 characters of installed product key: K2HT4</span><br><span class="line">&lt;Product activation successful&gt;</span><br><span class="line">---------------------------------------</span><br><span class="line">Installed product key detected - attempting to activate the following product:</span><br><span class="line">SKU ID: fbdb3e18-a8ef-4fb3-9183-dffd60bd0984</span><br><span class="line">LICENSE NAME: Office 21, Office21ProPlus2021VL_KMS_Client_AE edition</span><br><span class="line">LICENSE DESCRIPTION: Office 21, VOLUME_KMSCLIENT channel</span><br><span class="line">Last 5 characters of installed product key: 6F7TH</span><br><span class="line">&lt;Product activation successful&gt;</span><br><span class="line">---------------------------------------</span><br><span class="line">---------------------------------------</span><br><span class="line">---Exiting-----------------------------</span><br></pre></td></tr></table></figure>

<h2 id="6、其他"><a href="#6、其他" class="headerlink" title="6、其他"></a>6、其他</h2><p>官方提供了上述使用到的 GVLK 列表（使用 Office 自定义工具创建 <code>configuration.xml</code> 文件时已经自动填写），详见：<a href="https://learn.microsoft.com/zh-cn/deployoffice/vlactivation/gvlks">用于 KMS 和基于 Active Directory 的 Office、Project 和 Visio 激活的 GVLK</a></p>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>win</tag>
        <tag>office</tag>
      </tags>
  </entry>
  <entry>
    <title>部署 Windows Server 2022 Datacenter</title>
    <url>/077ca5b0-4ec4-11ee-86e1-a907f23a1148/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、下载安装包"><a href="#1、下载安装包" class="headerlink" title="1、下载安装包"></a>1、下载安装包</h2><p>官方下载地址：<a href="https://www.microsoft.com/zh-cn/evalcenter/download-windows-server-2022">https://www.microsoft.com/zh-cn/evalcenter/download-windows-server-2022</a></p>
<blockquote>
<p>注意：该下载为评估版本，需要升到正式版才能够激活。详见后续步骤</p>
</blockquote>
<h2 id="2、设置网络"><a href="#2、设置网络" class="headerlink" title="2、设置网络"></a>2、设置网络</h2><p>安装后没有任何网络驱动，可按如下参考步骤接通有线连接：</p>
<blockquote>
<p>注：该案例主板为 ASUS PRIME B250M-PLUS，官网提供驱动不支持服务器系统</p>
</blockquote>
<p>1）进入「设备管理器」，双击打开「其他设备」</p>
<p>2）此时「以太网控制器」应显示黄色叹号。右键选择「更新驱动程序」，选择「浏览我的电脑以查找驱动程序」，进一步选择「让我从计算机上….列表中选取」</p>
<p>3）设备类型选择「网络适配器」</p>
<p>4）左侧列表选择「intel Corporation」，右侧选择「Intel(R) Ethernet Connection 1219-LM」，下一步选「是」确认安装</p>
<h2 id="3、开启远程桌面"><a href="#3、开启远程桌面" class="headerlink" title="3、开启远程桌面"></a>3、开启远程桌面</h2><p>默认为关闭，可按如下步骤开启：</p>
<p>1）呼出开始菜单，打开「服务器管理器」</p>
<p>2）进入「本地服务器」，点击「远程桌面」，选择允许即可</p>
<h2 id="4、关闭自动更新"><a href="#4、关闭自动更新" class="headerlink" title="4、关闭自动更新"></a>4、关闭自动更新</h2><p>1）打开 cmd，执行 <code>sconfig</code></p>
<p>2）选择 5，更新设置，修改配置为「手动」</p>
<h2 id="5、激活系统"><a href="#5、激活系统" class="headerlink" title="5、激活系统"></a>5、激活系统</h2><p>1）确认当前系统版本</p>
<p>从官网下载的版本为评估版本，可打开 cmd 执行 <code>DISM /online /Get-CurrentEdition</code> 输出系统信息，当前版本带有 <code>Eval</code> 结尾说明是评估版本：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">部署映像服务和管理工具</span><br><span class="line">版本: 10.0.20348.681</span><br><span class="line"></span><br><span class="line">映像版本: 10.0.20348.1787</span><br><span class="line"></span><br><span class="line">当前版本为:</span><br><span class="line"></span><br><span class="line">当前版本 : ServerDatacenterEval</span><br><span class="line"></span><br><span class="line">操作成功完成。</span><br></pre></td></tr></table></figure>

<p>2）前往 <a href="https://learn.microsoft.com/en-us/windows-server/get-started/kms-client-activation-keys">https://learn.microsoft.com/en-us/windows-server/get-started/kms-client-activation-keys</a> 获取 Windows Server 2022 Datacenter 对应的 KMS Client Product Key</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">WX4NM-KYWYW-QJJR4-XV3QB-6VM33</span><br></pre></td></tr></table></figure>

<p>3）执行 <code>DISM /online /Set-Edition:ServerDatacenter /ProductKey:WX4NM-KYWYW-QJJR4-XV3QB-6VM33 /AcceptEula</code> 等待更新完成，重启即可</p>
<blockquote>
<p>注意：默认的系统密钥切勿清除，必须保留</p>
</blockquote>
<p>4）此时系统密钥已经变更为上述从官网获得的 key，但仍提示未激活。可参考 <a href="https://www.dcheng.site/faef3d90-4ea4-11ee-addd-c161ce22f848/">部署 kms 服务器</a> 的内容建立 kms 服务器</p>
<p>5）建立完成后，假设已部署的 kms服务器ip为 <code>192.168.1.5</code>，执行 <code>slmgr /skms 192.168.1.5</code> 设置 kms 服务器地址</p>
<p>6）直接执行 <code>slmgr /ato</code> 激活</p>
<blockquote>
<p>注意：不用执行卸载和安装密钥的步骤</p>
</blockquote>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>win</tag>
        <tag>server</tag>
      </tags>
  </entry>
  <entry>
    <title>部署 kms 服务器</title>
    <url>/faef3d90-4ea4-11ee-addd-c161ce22f848/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、环境"><a href="#1、环境" class="headerlink" title="1、环境"></a>1、环境</h2><ul>
<li>Windows 10 专业版 22H2</li>
<li>Ubuntu 22.04.2 LTS (GNU&#x2F;Linux 5.19.0-35-generic x86_64)</li>
</ul>
<blockquote>
<p>建议在 ubuntu 环境下部署。win 环境容易促使杀毒软件报警；如果使用虚拟机部署，要让同一局域网其他设备访问，应设置虚拟网络为桥接模式</p>
</blockquote>
<h2 id="2、Ubuntu-部署"><a href="#2、Ubuntu-部署" class="headerlink" title="2、Ubuntu 部署"></a>2、Ubuntu 部署</h2><p>1）执行下载 <code>wget https://github.com/Wind4/vlmcsd/releases/download/svn1113/binaries.tar.gz</code></p>
<blockquote>
<p>可到部署工具远程仓库查看最新版本：<a href="https://github.com/Wind4/vlmcsd/releases">https://github.com/Wind4/vlmcsd/releases</a></p>
</blockquote>
<p>2）执行解压 <code>tar -zxvf binaries.tar.gz</code></p>
<p>3）进入目录 <code>cd binaries/Linux/intel/static</code>，执行 <code>./vlmcsdmulti-x64-musl-static vlmcsd</code></p>
<blockquote>
<p>注：如果重启或者关机，需要重新执行</p>
</blockquote>
<blockquote>
<p>根据服务器系统和平台选择对应的文件，本文 ubuntu 环境为 x64，因此选用上述命令。其他可选：</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vlmcsdmulti-x64-musl-static          vlmcsd-x86-musl-static</span><br><span class="line">vlmcsdmulti-x86-musl-static          vlmcsd-x86-musl-static-threads</span><br><span class="line">vlmcsdmulti-x86-musl-static-threads  vlmcs-x64-musl-static</span><br><span class="line">vlmcsd-x64-musl-static               vlmcs-x86-musl-static</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：要开放 1688 端口</p>
</blockquote>
<p>4）验证进程，执行 <code>ps aux | grep vlmcsd</code>，包含如下结果说明部署成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ubuntu      2590  0.0  0.0    296     0 ?        S    20:45   0:00 ./vlmcsdmulti-x64-musl-static vlmcsd</span><br></pre></td></tr></table></figure>

<h2 id="3、win10-部署"><a href="#3、win10-部署" class="headerlink" title="3、win10 部署"></a>3、win10 部署</h2><p>1）下载部署文件，解压两次（<code>binaries.tar.gz</code> -&gt; <code>binaries.tar</code> -&gt; <code>binaries</code>）</p>
<p>2）进入目录 <code>binaries\Windows\intel</code>，以管理员身份打开 cmd，执行 <code>vlmcsd-Windows-x64.exe -s</code> 安装服务</p>
<blockquote>
<p>注：<code>vlmcsd-Windows-x64.exe -S</code> 参数为大写 S 则移除服务</p>
</blockquote>
<p>3）在运行栏执行 <code>services.msc</code> 进入服务管理，找到 <code>Key Management Server</code>，启动该服务</p>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>win</tag>
        <tag>ubuntu</tag>
        <tag>kms</tag>
      </tags>
  </entry>
  <entry>
    <title>部署-ubuntu-服务器</title>
    <url>/58871fa0-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<p>本例使用系统版本为 Ubuntu 22.04.2 LTS (GNU&#x2F;Linux 5.19.0-35-generic x86_64)</p>
<blockquote>
<p>提示：win 环境下最好使用 UltraISO 烧写镜像文件。经实测，按照官方文档推荐的 balenaEtcher 有损坏 U 盘风险。</p>
</blockquote>
<h2 id="安装-ssh"><a href="#安装-ssh" class="headerlink" title="安装 ssh"></a>安装 ssh</h2><p>执行下列命令：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">sudo apt-get install openssh-server</span><br></pre></td></tr></table></figure>

<p>验证服务是否启动：<code>sudo systemctl status ssh</code></p>
<h2 id="安装-Mariadb"><a href="#安装-Mariadb" class="headerlink" title="安装 Mariadb"></a>安装 Mariadb</h2><p>两种主要方式：</p>
<p>1、Repositories 安装方式：<code>https://mariadb.org/download/?t=repo-config&amp;d=22.04+%22jammy%22&amp;v=10.11&amp;r_m=neusoft</code></p>
<p>2、从 <code>https://archive.mariadb.org/mariadb-10.11.2/bintar-linux-systemd-x86_64/</code> 获得链接，直接下载压缩包</p>
<blockquote>
<p>本地二进制压缩包链接：<code>https://archive.mariadb.org/mariadb-10.11.2/bintar-linux-systemd-x86_64/mariadb-10.11.2-linux-systemd-x86_64.tar.gz</code></p>
</blockquote>
<p>本例采用第一种。依次执行下列命令：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">sudo apt-get install apt-transport-https curl</span><br><span class="line">sudo curl -o /etc/apt/trusted.<span class="property">gpg</span>.<span class="property">d</span>/mariadb_release_signing_key.<span class="property">asc</span> <span class="string">&#x27;https://mariadb.org/mariadb_release_signing_key.asc&#x27;</span></span><br><span class="line">sudo sh -c <span class="string">&quot;echo &#x27;deb https://mirrors.neusoft.edu.cn/mariadb/repo/10.11/ubuntu jammy main&#x27; &gt;&gt;/etc/apt/sources.list&quot;</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install mariadb-server</span><br></pre></td></tr></table></figure>

<p>3、验证服务是否启动：<code>sudo systemctl status mariadb</code></p>
<blockquote>
<p>注意：安装完成后要执行 <code>sudo -i</code> 切换 root 再通过 <code>mariadb -u root</code> 进入设置密码：<code>alter user &#39;root&#39;@&#39;localhost&#39; identified by &#39;MyNewPass4!&#39;;</code></p>
</blockquote>
<p>4、配置文件</p>
<p>配置文件路径为：<code>/etc/mysql/mariadb.conf.d/50-server.cnf</code></p>
<p>5、取消 IP 限制</p>
<p>当执行 <code>netstat -an|grep 3306</code> 命令发现如下反馈，说明此时无法远程连接数据库。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">ubuntu@ubuntu-virtual-<span class="attr">machine</span>:~$ netstat -an|grep <span class="number">3306</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3306</span>          <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               <span class="variable constant_">LISTEN</span></span><br></pre></td></tr></table></figure>

<p>打开配置文件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/mysql/mariadb.<span class="property">conf</span>.<span class="property">d</span>/<span class="number">50</span>-server.<span class="property">cnf</span></span><br></pre></td></tr></table></figure>

<p>找到 <code>bind-address = 127.0.0.1</code> 注释掉。</p>
<blockquote>
<p>可能需要安装 vim 编辑器，执行 <code>sudo apt-get install vim</code></p>
</blockquote>
<h2 id="部署-JDK"><a href="#部署-JDK" class="headerlink" title="部署 JDK"></a>部署 JDK</h2><p>以 corretto 为例。按相应 JDK 版本依次执行命令：</p>
<p>官方文档：<a href="https://docs.aws.amazon.com/corretto/latest/corretto-17-ug/generic-linux-install.html">https://docs.aws.amazon.com/corretto/latest/corretto-17-ug/generic-linux-install.html</a></p>
<p>1、JDK11</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget -O- https://apt.corretto.aws/corretto.key | sudo apt-key add -</span><br><span class="line">sudo add-apt-repository &#x27;deb https://apt.corretto.aws stable main&#x27;</span><br><span class="line">sudo apt-get update; sudo apt-get install -y java-11-amazon-corretto-jdk</span><br></pre></td></tr></table></figure>

<p>2、JDK17</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget -O- https://apt.corretto.aws/corretto.key | sudo apt-key add -</span><br><span class="line">sudo add-apt-repository &#x27;deb https://apt.corretto.aws stable main&#x27;</span><br><span class="line">sudo apt-get update; sudo apt-get install -y java-17-amazon-corretto-jdk</span><br></pre></td></tr></table></figure>

<p>3、卸载</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo dpkg --remove java-11-amazon-corretto-jdk</span><br><span class="line">sudo dpkg --remove java-17-amazon-corretto-jdk</span><br></pre></td></tr></table></figure>

<h2 id="修改本地网络地址"><a href="#修改本地网络地址" class="headerlink" title="修改本地网络地址"></a>修改本地网络地址</h2><p>1、固定 IP</p>
<p>通过 <code>ip a</code> 命令查看网咖信息。修改前：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">ubuntu@ubuntu-virtual-<span class="attr">machine</span>:~$ ip a</span><br><span class="line"><span class="number">1</span>: <span class="attr">lo</span>: &lt;<span class="variable constant_">LOOPBACK</span>,<span class="variable constant_">UP</span>,<span class="variable constant_">LOWER_UP</span>&gt; mtu <span class="number">65536</span> qdisc noqueue state <span class="variable constant_">UNKNOWN</span> group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    inet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::<span class="number">1</span>/<span class="number">128</span> scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: <span class="attr">ens33</span>: &lt;<span class="variable constant_">BROADCAST</span>,<span class="variable constant_">MULTICAST</span>,<span class="variable constant_">UP</span>,<span class="variable constant_">LOWER_UP</span>&gt; mtu <span class="number">1500</span> qdisc fq_codel state <span class="variable constant_">UP</span> group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:0<span class="attr">c</span>:<span class="number">29</span>:<span class="attr">cb</span>:<span class="attr">bf</span>:c6 brd <span class="attr">ff</span>:<span class="attr">ff</span>:<span class="attr">ff</span>:<span class="attr">ff</span>:<span class="attr">ff</span>:ff</span><br><span class="line">    altname enp2s1</span><br><span class="line">    inet <span class="number">192.168</span><span class="number">.160</span><span class="number">.133</span>/<span class="number">24</span> brd <span class="number">192.168</span><span class="number">.160</span><span class="number">.255</span> scope <span class="variable language_">global</span> dynamic noprefixroute ens33</span><br><span class="line">       valid_lft 1555sec preferred_lft 1555sec</span><br><span class="line">    inet6 <span class="attr">fe80</span>::85<span class="attr">bd</span>:<span class="attr">d35d</span>:<span class="attr">f025</span>:dcf4/<span class="number">64</span> scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>查看 <code>/etc/netplan</code> 网络配置文件：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">ubuntu@ubuntu-virtual-<span class="attr">machine</span>:~$ ls /etc/netplan</span><br><span class="line"><span class="number">01</span>-network-manager-all.<span class="property">yaml</span></span><br></pre></td></tr></table></figure>

<p>执行 <code>sudo vim /etc/netplan/*.yaml</code>，添加以下内容：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># <span class="title class_">Let</span> <span class="title class_">NetworkManager</span> manage all devices on <span class="variable language_">this</span> system</span><br><span class="line"><span class="attr">network</span>:</span><br><span class="line">    <span class="attr">version</span>: <span class="number">2</span></span><br><span class="line">    <span class="attr">renderer</span>: <span class="title class_">NetworkManager</span></span><br><span class="line">    <span class="attr">ethernets</span>:</span><br><span class="line">       <span class="attr">ens33</span>:</span><br><span class="line">          <span class="attr">addresses</span>: [<span class="number">192.168</span><span class="number">.160</span><span class="number">.134</span>/<span class="number">24</span>]</span><br><span class="line">          <span class="attr">routes</span>:</span><br><span class="line">            - <span class="attr">to</span>: <span class="keyword">default</span></span><br><span class="line">              <span class="attr">via</span>: <span class="number">192.168</span><span class="number">.160</span><span class="number">.2</span></span><br><span class="line">          <span class="attr">nameservers</span>:</span><br><span class="line">             <span class="attr">addresses</span>: [<span class="number">180.76</span><span class="number">.76</span><span class="number">.76</span>, <span class="number">223.5</span><span class="number">.5</span><span class="number">.5</span>]</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>ens33：拟设置的网卡名称</li>
<li>addresses：拟设置的固定 ip 和掩码。掩码 24 表示前 24 位有效，剩下的 8 位可以是 0-254 之间的任一地址（255 为广播地址），例如 255.255.255.255 是 IPv4 中最大可能的 IP 地址，每个数字（255）都是由 8 个比特位表示的，每个比特位非 0 即 1，最大值即为 11111111，因此掩码 24 表示 255.255.255.0。同理，xxx.xxx.xxx.xxx&#x2F;32，表示掩码为 192.168.0.0</li>
<li>routes：网关地址。default 也可以写为 <code>0.0.0.0/0</code> 或 <code>0/0</code></li>
<li>nameservers：DNS 地址</li>
</ul>
<blockquote>
<p>网关若使用 <code>gateway4</code> 属性会提示 <code>** (process:9908): WARNING **: 22:03:51.792: gateway4 has been deprecated, use default routes instead. See the &#39;Default routes&#39; section of the documentation for more details.</code></p>
</blockquote>
<p>执行 <code>sudo netplan try</code> 使配置生效。修改后：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">ubuntu@ubuntu-virtual-<span class="attr">machine</span>:~$ ip a</span><br><span class="line"><span class="number">1</span>: <span class="attr">lo</span>: &lt;<span class="variable constant_">LOOPBACK</span>,<span class="variable constant_">UP</span>,<span class="variable constant_">LOWER_UP</span>&gt; mtu <span class="number">65536</span> qdisc noqueue state <span class="variable constant_">UNKNOWN</span> group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    inet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::<span class="number">1</span>/<span class="number">128</span> scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">2</span>: <span class="attr">ens33</span>: &lt;<span class="variable constant_">BROADCAST</span>,<span class="variable constant_">MULTICAST</span>,<span class="variable constant_">UP</span>,<span class="variable constant_">LOWER_UP</span>&gt; mtu <span class="number">1500</span> qdisc fq_codel state <span class="variable constant_">UP</span> group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/ether <span class="number">00</span>:0<span class="attr">c</span>:<span class="number">29</span>:<span class="attr">cb</span>:<span class="attr">bf</span>:c6 brd <span class="attr">ff</span>:<span class="attr">ff</span>:<span class="attr">ff</span>:<span class="attr">ff</span>:<span class="attr">ff</span>:ff</span><br><span class="line">    altname enp2s1</span><br><span class="line">    inet <span class="number">192.168</span><span class="number">.160</span><span class="number">.134</span>/<span class="number">24</span> brd <span class="number">192.168</span><span class="number">.160</span><span class="number">.255</span> scope <span class="variable language_">global</span> noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 <span class="attr">fe80</span>::20<span class="attr">c</span>:29<span class="attr">ff</span>:<span class="attr">fecb</span>:bfc6/<span class="number">64</span> scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>2、开启 dhcp</p>
<p>无需再设置 addresses 属性（实际上 routes 属性也可以移除）。配置如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># <span class="title class_">Let</span> <span class="title class_">NetworkManager</span> manage all devices on <span class="variable language_">this</span> system</span><br><span class="line"><span class="attr">network</span>:</span><br><span class="line">    <span class="attr">version</span>: <span class="number">2</span></span><br><span class="line">    <span class="attr">renderer</span>: <span class="title class_">NetworkManager</span></span><br><span class="line">    <span class="attr">ethernets</span>:</span><br><span class="line">       <span class="attr">ens33</span>:</span><br><span class="line">          <span class="attr">dhcp4</span>: <span class="literal">true</span></span><br><span class="line">          <span class="attr">routes</span>:</span><br><span class="line">            - <span class="attr">to</span>: <span class="keyword">default</span></span><br><span class="line">              <span class="attr">via</span>: <span class="number">192.168</span><span class="number">.160</span><span class="number">.2</span></span><br><span class="line">          <span class="attr">nameservers</span>:</span><br><span class="line">             <span class="attr">addresses</span>: [<span class="number">180.76</span><span class="number">.76</span><span class="number">.76</span>, <span class="number">223.5</span><span class="number">.5</span><span class="number">.5</span>]</span><br></pre></td></tr></table></figure>

<h2 id="其他工具或命令"><a href="#其他工具或命令" class="headerlink" title="其他工具或命令"></a>其他工具或命令</h2><p>查看 CPU、内存使用情况：<code>sudo apt-get install htop</code></p>
<h2 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h2><p>一般系统默认带有防火墙。安装命令：<code>sudo apt install ufw</code></p>
<p>1、允许 ssh（<strong>特别注意开启，否则下次连接将无法远程连接</strong>）</p>
<p>执行 <code>sudo ufw allow ssh</code> 或 <code>sudo ufw allow 22</code> 创建防火墙规则，允许 22 端口上的所有连接。</p>
<p>2、启用 ufw</p>
<p>执行 <code>sudo ufw enable</code>，确认启动后可通过 <code>sudo ufw status verbose</code> 查看状态。</p>
<blockquote>
<p>注：当状态为 <code>Status: inactive</code> 说明 ufw 未启动。如果处于活动状态，将显示 <code>Status: active</code>，并列出所有规则。</p>
</blockquote>
<p>3、拒绝连接</p>
<p>执行 <code>sudo ufw deny from 192.1.110.24</code>，则拒绝全部来自该 IP 的连接。</p>
<p>4、删除规则</p>
<p>执行 <code>sudo ufw status numbered</code> 查看规则列表，获知规则的序号，再执行 <code>sudo ufw delete 3</code>（删除第 3 条规则）</p>
<p>5、端口规则设置</p>
<p>ufw 默认的策略是允许出，不允许进，这个可以在配置文件 <code>/etc/default/ufw</code> 中看到。出规则需要配置。</p>
<p>配置文件片段：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable constant_">DEFAULT_INPUT_POLICY</span> = <span class="string">&quot;DROP&quot;</span>;</span><br><span class="line"><span class="variable constant_">DEFAULT_OUTPUT_POLICY</span> = <span class="string">&quot;ACCEPT&quot;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>允许 http 连接：<code>sudo ufw allow http</code> 或 <code>sudo ufw allow 80</code></li>
<li>阻止 http 连接：<code>sudo ufw denty http</code> 或 <code>sudo ufw denty 80</code></li>
<li>开放特定端口范围：<code>sudo ufw allow 3000:3007/tcp</code></li>
</ul>
<blockquote>
<p>注：如果不指定协议，会自动允许 tcp 和 udp 两种协议。</p>
</blockquote>
<ul>
<li>限制 IP 允许连接的端口：<code>sudo ufw allow from 192.1.110.24 to any port 22</code></li>
<li>配合子网掩码限制网段：<code>sudo ufw allow from 192.1.110.24/24</code></li>
<li>监听来自指定网卡的连接：<code>sudo ufw allow in on eth1 to any port 3306</code></li>
</ul>
<p>6、停止和重置</p>
<ul>
<li>停用 ufw：<code>sudo ufw disable</code></li>
<li>重置 ufw 规则：<code>sudo ufw reset</code></li>
</ul>
<h2 id="其他相关命令"><a href="#其他相关命令" class="headerlink" title="其他相关命令"></a>其他相关命令</h2><ul>
<li>显示所有连接：<code>lsof -i</code></li>
<li>仅获取 ipv6 流量：<code>lsof -i6</code></li>
<li>显示端口信息：<code>lsof -i :5432</code></li>
</ul>
<blockquote>
<p>lsof 命令参数：<code>lsof -i[46] [protocol][@hostname|hostaddr][:service|port]</code></p>
</blockquote>
<ul>
<li>列出所有：<code>netstat -a </code></li>
<li>使用 ip 地址列出所有监听状态的 tcp 端口以及程序名：<code>netstat -atnlp</code></li>
</ul>
<blockquote>
<p>netstat 命令参数：</p>
</blockquote>
<ul>
<li>显示所有连接中的 Socket：<code>-a</code> 或 <code>--all</code></li>
<li>显示正在使用 Socket 的程序识别码和程序名称：<code>-p</code> 或 <code>--programs</code></li>
<li>显示 TCP 传输协议的连线状况：<code>-t</code> 或 <code>--tcp</code></li>
<li>显示 UDP 传输协议的连线状况：<code>-u</code> 或 <code>--udp</code></li>
</ul>
<p>显示结果参数释义：</p>
<ul>
<li><p><code>Proto</code>：协议名（tcp 协议还是 udp 协议还是 unix 协议）</p>
</li>
<li><p><code>Recv-Q</code>：网络接收队列。表示收到的数据已经在本地接收缓冲，但是还有多少没有被进程取走，recv()如果接收队列 Recv-Q 一直处于阻塞状态，可能是遭受了拒绝服务 denial-of-service 攻击；</p>
</li>
<li><p><code>send-Q</code>：网路发送队列。对方没有收到的数据或者说没有 Ack 的,还是本地缓冲区.</p>
</li>
<li><p><code>Local Address</code>：表示监听服务器上对应的 ip 地址的对应端口 (0.0.0.0 表示本地所有 ip)</p>
</li>
<li><p><code>Foreign Address</code>：与本机端口通信的外部 socket。显示规则与 Local Address 相同</p>
</li>
<li><p><code>State</code>：链路状态。共有 12 中可能的状态</p>
<ul>
<li><p>LISTEN ：正在监听端口，可以接受连接</p>
</li>
<li><p>SYN_SENT：socket 正在积极尝试建立一个连接，即处于发送后连接前的一个等待但未匹配进入连接的状态</p>
</li>
<li><p>SYN_RECV：收到对方的连接建立请求</p>
</li>
<li><p>ESTABLISHED：代表一个打开的连接，双方可以进行或已经在数据交互</p>
</li>
<li><p>FIN_WAIT1：socket 已关闭，连接正在或正要关闭</p>
</li>
<li><p>CLOSE_WAIT：等待关闭。当对方关闭一个 SOCKET 后发送 FIN 报文给自己，系统毫无疑问地会回应一个 ACK 报文给对方，此时则进入到 CLOSE_WAIT 状态。接下来需要考虑的事情是察看你是否还有数据发送给对方，如果没有就可以关闭这个 SOCKET，发送 FIN 报文给对方，也即关闭连接。所以在 CLOSE_WAIT 状态下，需要完成的事情是等待你去关闭连接。</p>
</li>
<li><p>FIN_WAIT2：连接已关闭，并且 socket 正在等待远端结束</p>
</li>
<li><p>LAST_ACK：被动关闭一方在发送 FIN 报文后，最后等待对方的 ACK 报文。当收到 ACK 报文后，也即可以进入到 CLOSED 可用状态</p>
</li>
<li><p>TIME_WAIT：socket 正在等待关闭处理仍在网络上的数据包。表示收到了对方的 FIN 报文，并发送出了 ACK 报文，就等 2MSL 后即可回到 CLOSED 可用状态。如果 FIN_WAIT_1 状态下，收到了对方同时带 FIN 标志和 ACK 标志的报文时，可以直接进入到 TIME_WAIT 状态，而无须经过 FIN_WAIT_2 状态。</p>
</li>
<li><p>CLOSING：比较少见，等待远程 TCP 对连接中断的确认</p>
</li>
<li><p>CLOSED：没有任何连接状态。被动关闭端在接受到 ACK 包后，就进入该状态。连接结束</p>
</li>
<li><p>UNKNOWN：未知的状态</p>
</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>ubuntu</tag>
        <tag>mariadb</tag>
      </tags>
  </entry>
  <entry>
    <title>部署win10+vscode+anaconda3环境</title>
    <url>/148d4631-44e0-11ee-bc05-f9725afef782/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、安装-anaconda3"><a href="#1、安装-anaconda3" class="headerlink" title="1、安装 anaconda3"></a>1、安装 anaconda3</h2><p>务必选择添加环境变量（或用户变量），便于 vscode 新建环境，或者手动添加，假设安装目录为 <code>D:\anaconda3</code>，添加如下路径：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\anaconda3</span><br><span class="line">D:\anaconda3\Library\mingw-w64\bin</span><br><span class="line">D:\anaconda3\Library\usr\bin</span><br><span class="line">D:\anaconda3\Library\bin</span><br><span class="line">D:\anaconda3\Scripts</span><br></pre></td></tr></table></figure>

<h2 id="2、vscode-安装微软官方-python-插件，相关信息如下"><a href="#2、vscode-安装微软官方-python-插件，相关信息如下" class="headerlink" title="2、vscode 安装微软官方 python 插件，相关信息如下"></a>2、vscode 安装微软官方 python 插件，相关信息如下</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Name: Python</span><br><span class="line">Id: ms-python.python</span><br><span class="line">Description: IntelliSense (Pylance), Linting, Debugging (multi-threaded, remote), Jupyter Notebooks, code formatting, refactoring, unit tests, and more.</span><br><span class="line">Version: 2023.10.1</span><br><span class="line">Publisher: Microsoft</span><br><span class="line">VS Marketplace Link: https://marketplace.visualstudio.com/items?itemName=ms-python.python</span><br></pre></td></tr></table></figure>

<h2 id="3、创建或复用-conda-环境"><a href="#3、创建或复用-conda-环境" class="headerlink" title="3、创建或复用 conda 环境"></a>3、创建或复用 conda 环境</h2><p>1）创建匿名 conda 环境</p>
<p>ctrl+shift+P，输入<code>&gt; Create Environment</code> 命令，选择建立 conda 环境，进一步选择 python 版本。</p>
<blockquote>
<p>注意：这种方式会在项目下新建 <code>.conda</code> 目录。</p>
</blockquote>
<p>重新启动终端，将以全路径方式激活：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(base) PS E:\test&gt; activate</span><br><span class="line">(base) PS E:\test&gt; conda activate e:\test\.conda</span><br><span class="line">(e:\test\.conda) PS E:\test&gt;</span><br></pre></td></tr></table></figure>

<p>2）创建指定名称的 conda 环境</p>
<p>终端执行 <code>conda create -n &lt;env_name&gt; python=&lt;version&gt;</code> 即可创建指定 python 版本且名为 env_name 的环境，该环境一般放在目录 <code>anaconda3\envs</code> 下</p>
<p>重新启动终端，将以名称激活：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(base) PS E:\<span class="built_in">test</span>&gt; C:/anaconda3/Scripts/activate</span><br><span class="line">(base) PS E:\<span class="built_in">test</span>&gt; conda activate env_name</span><br><span class="line">(env_name) PS E:\<span class="built_in">test</span>&gt;</span><br></pre></td></tr></table></figure>

<p>3）复用</p>
<p>ctrl+shift+P，输入<code>&gt; Select Interpreter</code> 命令，选择已存在的 conda 环境（包括当前目录的匿名环境），重启终端即可。</p>
<blockquote>
<p>注意：重新选择环境后要重新进入终端</p>
</blockquote>
<h2 id="4、问题及解决方案"><a href="#4、问题及解决方案" class="headerlink" title="4、问题及解决方案"></a>4、问题及解决方案</h2><p><strong>问题 1：</strong> 出现如下提示，应执行 <code>conda init powershell</code>，之后重新启动 vscode</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CommandNotFoundError: Your shell has not been properly configured to use <span class="string">&#x27;conda activate&#x27;</span>.</span><br><span class="line">If using <span class="string">&#x27;conda activate&#x27;</span> from a batch script, change your</span><br><span class="line">invocation to <span class="string">&#x27;CALL conda.bat activate&#x27;</span>.</span><br><span class="line"></span><br><span class="line">To initialize your shell, run</span><br><span class="line"></span><br><span class="line">    $ conda init &lt;SHELL_NAME&gt;</span><br><span class="line"></span><br><span class="line">Currently supported shells are:</span><br><span class="line">  - bash</span><br><span class="line">  - cmd.exe</span><br><span class="line">  - fish</span><br><span class="line">  - tcsh</span><br><span class="line">  - xonsh</span><br><span class="line">  - zsh</span><br><span class="line">  - powershell</span><br><span class="line"></span><br><span class="line">See <span class="string">&#x27;conda init --help&#x27;</span> <span class="keyword">for</span> more information and options.</span><br><span class="line"></span><br><span class="line">IMPORTANT: You may need to close and restart your shell after running <span class="string">&#x27;conda init&#x27;</span>.</span><br></pre></td></tr></table></figure>

<p><strong>问题 2：</strong> 使用终端进入 conda 环境的项目目录时，可能会提示报错信息：“……在此系统上禁止运行脚本”，</p>
<p>vscode 终端选择 Windows PowerShell 时，默认执行策略是 Restricted，即不允许任何脚本运行。</p>
<blockquote>
<p>有关 Windows PowerShell 执行策略的详细信息，请参阅 about_Execution_Policy。</p>
</blockquote>
<blockquote>
<p>可执行 <code>get-executionpolicy</code> 命令查看当前策略</p>
</blockquote>
<p>以管理员身份打开 PowerShell 输入 <code>set-executionpolicy remotesigned</code>，重启 vscode 终端，即可切换到当前 conda 环境。一般而言，解除上述问题后，每次新建终端进入 conda 环境后，会自动执行 <code>active</code> 和 <code>conda active</code> 命令进入默认的 <code>base</code> 环境，例如：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(base) PS E:\<span class="built_in">test</span>&gt; activate</span><br><span class="line">(base) PS E:\<span class="built_in">test</span>&gt; conda activate base</span><br><span class="line">(base) PS E:\<span class="built_in">test</span>&gt;</span><br></pre></td></tr></table></figure>

<h2 id="5、其他相关命令"><a href="#5、其他相关命令" class="headerlink" title="5、其他相关命令"></a>5、其他相关命令</h2><ul>
<li>查看安装源：<code>conda config --show-sources</code></li>
<li>添加安装源：<code>conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</code><ul>
<li>其他安装源：<code>conda config --add channels http://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/</code></li>
<li>其他安装源：<code>conda config --add channels http://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/pytorch/</code></li>
<li>换回 conda 的默认源，删除 channels：<code>conda config --remove-key channels</code></li>
</ul>
</li>
<li>删除安装源：<code>conda config --remove channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</code></li>
<li>查看源优先级：<code>conda config --get channels</code></li>
<li>查看 <code>.condarc</code> 文件位置（执行 <code>conda config</code> 系列命令时生成）：<code>conda info</code></li>
<li>显示 channel 来源： <code>conda config --set show_channel_urls yes</code></li>
<li>查看所有虚拟环境：<code>conda info --envs</code> 或 <code>conda env list</code></li>
<li>安装指定版本依赖：<code>conda install package=version</code></li>
<li>临时指定源：<code>conda install package=version -c https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</code></li>
</ul>
]]></content>
      <categories>
        <category>部署和安装</category>
      </categories>
      <tags>
        <tag>anaconda</tag>
      </tags>
  </entry>
  <entry>
    <title>AtomicInteger-用法</title>
    <url>/ef12ce01-4937-11ee-861d-b3cf05b530a5/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>


<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>AtomicInteger 源自 java.util.concurrent.atomic 包，另外有 AtomicBoolean、AtomicInteger、AtomicLong、AtomicLongArray、AtomicReference 等原子类，主要用于在高并发环境下，简化同步处理.</p>
<p>Atomic 包介绍</p>
<p>Java1.5 的 Atomic 包名为 java.util.concurrent.atomic。这个包提供了一系列原子类。这些类可以保证多线程环境下，当某个线程在执行 atomic 的方法时，不会被其他线程打断，而别的线程就像自旋锁一样，一直等到该方法执行完成，才由 JVM 从等待队列中选择一个线程执行。Atomic 类在软件层面上是非阻塞的，它的原子性其实是在硬件层面上借助相关的指令来保证的。</p>
<p>Atomic 包中的类可以分成 4 组：</p>
<ul>
<li><p>AtomicBoolean，AtomicInteger，AtomicLong，AtomicReference</p>
</li>
<li><p>AtomicIntegerArray，AtomicLongArray</p>
</li>
<li><p>AtomicLongFieldUpdater，AtomicIntegerFieldUpdater，AtomicReferenceFieldUpdater</p>
</li>
<li><p>AtomicMarkableReference，AtomicStampedReference，AtomicReferenceArray</p>
</li>
</ul>
<p>我们来看一下最简单的 AtomicInteger 有哪些常见的方法以及这些方法的作用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">get()             直接返回值</span><br><span class="line"></span><br><span class="line">getAndAdd(<span class="type">int</span>)    增加指定的数据，返回变化前的数据</span><br><span class="line"></span><br><span class="line">getAndDecrement() 减少<span class="number">1</span>，返回减少前的数据</span><br><span class="line"></span><br><span class="line">getAndIncrement() 增加<span class="number">1</span>，返回增加前的数据</span><br><span class="line"></span><br><span class="line">getAndSet(<span class="type">int</span>)    设置指定的数据，返回设置前的数据</span><br><span class="line"></span><br><span class="line">addAndGet(<span class="type">int</span>)    增加指定的数据后返回增加后的数据</span><br><span class="line"></span><br><span class="line">decrementAndGet() 减少<span class="number">1</span>，返回减少后的值</span><br><span class="line"></span><br><span class="line">incrementAndGet() 增加<span class="number">1</span>，返回增加后的值</span><br><span class="line"></span><br><span class="line">lazySet(<span class="type">int</span>)      仅仅当get时才会set</span><br><span class="line"></span><br><span class="line"><span class="title function_">compareAndSet</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>)</span> 尝试新增后对比，若增加成功则返回<span class="literal">true</span>否则返回<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>在 Java 中，++i 和 i++ 操作并不是线程安全的，在使用的时候，不可避免的会用到 synchronized 关键字。而 AtomicInteger 则通过一种线程安全的加减操作接口。</p>
<h2 id="AtomicInteger-的基本方法"><a href="#AtomicInteger-的基本方法" class="headerlink" title="AtomicInteger 的基本方法"></a>AtomicInteger 的基本方法</h2><p>创建一个 AtomicInteger</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println(atomicInteger.get());</span><br></pre></td></tr></table></figure>

<p>输出 ： 123</p>
<p>创建一个不传值的，默认值为 0</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">AtomicInteger</span> <span class="variable">atomicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">System.out.println(atomicInteger.get());</span><br></pre></td></tr></table></figure>

<p>输出： 0</p>
<h2 id="获取和赋值"><a href="#获取和赋值" class="headerlink" title="获取和赋值"></a>获取和赋值</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">atomicInteger.get(); <span class="comment">//获取当前值</span></span><br><span class="line">atomicInteger.set(<span class="number">999</span>); <span class="comment">//设置当前值</span></span><br><span class="line"></span><br><span class="line">atomicInteger.compareAndSet(expectedValue,newValue)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">atomicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        System.out.println(atomicInteger.get());</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">expectedValue</span> <span class="operator">=</span> <span class="number">123</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">newValue</span>      <span class="operator">=</span> <span class="number">234</span>;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">b</span> <span class="operator">=</span>atomicInteger.compareAndSet(expectedValue, newValue);</span><br><span class="line">        System.out.println(b);</span><br><span class="line">        System.out.println(atomicInteger);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>输出结果为： 0 false 0</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       <span class="type">AtomicInteger</span> <span class="variable">atomicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">123</span>);</span><br><span class="line">       System.out.println(atomicInteger.get());</span><br><span class="line"></span><br><span class="line">       <span class="type">int</span> <span class="variable">expectedValue</span> <span class="operator">=</span> <span class="number">123</span>;</span><br><span class="line">       <span class="type">int</span> <span class="variable">newValue</span>      <span class="operator">=</span> <span class="number">234</span>;</span><br><span class="line">       <span class="type">Boolean</span> <span class="variable">b</span> <span class="operator">=</span>atomicInteger.compareAndSet(expectedValue, newValue);</span><br><span class="line">       System.out.println(b);</span><br><span class="line">       System.out.println(atomicInteger);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>输出结果为： 123 true 234</p>
<p>由上可知该方法表示，atomicInteger 的值与 expectedValue 相比较，如果不相等，则返回 false，atomicInteger 原有值保持不变；如果两者相等，则返回 true,atomicInteger 的值更新为 newValue</p>
<h2 id="getAndAdd-方法与-AddAndGet-方法"><a href="#getAndAdd-方法与-AddAndGet-方法" class="headerlink" title="getAndAdd()方法与 AddAndGet 方法"></a>getAndAdd()方法与 AddAndGet 方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">AtomicInteger</span> <span class="variable">atomicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">123</span>);</span><br><span class="line">System.out.println(atomicInteger.get());  --<span class="number">123</span></span><br><span class="line"></span><br><span class="line">System.out.println(atomicInteger.getAndAdd(<span class="number">10</span>)); --<span class="number">123</span> 获取当前值，并加<span class="number">10</span></span><br><span class="line">System.out.println(atomicInteger.get()); --<span class="number">133</span></span><br><span class="line"></span><br><span class="line">System.out.println(atomicInteger.addAndGet(<span class="number">10</span>)); --<span class="number">143</span> 获取加<span class="number">10</span>后的值，先加<span class="number">10</span></span><br><span class="line">System.out.println(atomicInteger.get()); --<span class="number">143</span></span><br></pre></td></tr></table></figure>

<h2 id="getAndDecrement-和-DecrementAndGet-方法"><a href="#getAndDecrement-和-DecrementAndGet-方法" class="headerlink" title="getAndDecrement()和 DecrementAndGet()方法"></a>getAndDecrement()和 DecrementAndGet()方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">AtomicInteger</span> <span class="variable">atomicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">123</span>);</span><br><span class="line">System.out.println(atomicInteger.get());   --<span class="number">123</span></span><br><span class="line"></span><br><span class="line">System.out.println(atomicInteger.getAndDecrement()); --<span class="number">123</span> 获取当前值并自减</span><br><span class="line">System.out.println(atomicInteger.get());  --<span class="number">122</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">System.out.println(atomicInteger.decrementAndGet()); --<span class="number">121</span> 先自减再获取减<span class="number">1</span>后的值</span><br><span class="line">System.out.println(atomicInteger.get()); --<span class="number">121</span></span><br></pre></td></tr></table></figure>

<p>使用 AtomicInteger，即使不用同步块 synchronized，最后的结果也是 100，可用看出 AtomicInteger 的作用，用原子方式更新的 int 值。主要用于在高并发环境下的高效程序处理。使用非阻塞算法来实现并发控制。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">inc</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Thread.sleep(<span class="number">1</span>); <span class="comment">//延迟1毫秒</span></span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException e)&#123; <span class="comment">//catch住中断异常，防止程序中断</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        count.getAndIncrement();<span class="comment">//count值自加1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    Counter.inc();</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">        latch.await();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;运行结果：&quot;</span>+Counter.count);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果： 100</p>
<h2 id="使用普通-Integer"><a href="#使用普通-Integer" class="headerlink" title="使用普通 Integer"></a>使用普通 Integer</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">volatile</span>  <span class="keyword">static</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">inc</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Thread.sleep(<span class="number">1</span>); <span class="comment">//延迟1毫秒</span></span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (InterruptedException e)&#123; <span class="comment">//catch住中断异常，防止程序中断</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        count++;<span class="comment">//count值自加1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    Counter.inc();</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">        latch.await();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;运行结果：&quot;</span>+Counter.count);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：98</p>
<p>如果在 inc 方法前面加个 synchronized 也能是线程安全的；</p>
<p>它用来修饰一个方法或者一个代码块的时候，能够保证在同一时刻最多只有一个线程执行该段代码。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * created by guanguan  on 2017/10/23</span><br><span class="line"> **/</span><br><span class="line">public class Counter &#123;</span><br><span class="line"></span><br><span class="line">     public volatile static  Integer count = 0;</span><br><span class="line"></span><br><span class="line">    public synchronized static void inc()&#123;</span><br><span class="line">        try&#123;</span><br><span class="line">            Thread.sleep(1); //延迟1毫秒</span><br><span class="line"></span><br><span class="line">        &#125;catch (InterruptedException e)&#123; //catch住中断异常，防止程序中断</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">          count++;//count值自加1</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        final CountDownLatch latch = new CountDownLatch(100);</span><br><span class="line"></span><br><span class="line">        for(int i=0;i&lt;100;i++)&#123;</span><br><span class="line">            new Thread(new Runnable() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    Counter.inc();</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">        latch.await();</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;运行结果：&quot;+Counter.count);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：100</p>
<p>synchronized 的使用说明：</p>
<p>一、当两个并发线程访问同一个对象 object 中的这个 synchronized(this)同步代码块时，一个时间内只能有一个线程得到执行。另一个线程必须等待当前线程执行完这个代码块以后才能执行该代码块。</p>
<p>二、然而，当一个线程访问 object 的一个 synchronized(this)同步代码块时，另一个线程仍然可以访问该 object 中的非 synchronized(this)同步代码块。</p>
<p>三、尤其关键的是，当一个线程访问 object 的一个 synchronized(this)同步代码块时，其他线程对 object 中所有其它 synchronized(this)同步代码块的访问将被阻塞。</p>
<p>四、第三个例子同样适用其它同步代码块。也就是说，当一个线程访问 object 的一个 synchronized(this)同步代码块时，它就获得了这个 object 的对象锁。结果，其它线程对该 object 对象所有同步代码部分的访问都被暂时阻塞。</p>
<p>五、以上规则对其它对象锁同样适用.</p>
<p>6、从上面的例子中我们可以看出：使用 AtomicInteger 是非常的安全的.而且因为 AtomicInteger 由硬件提供原子操作指令实现的。在非激烈竞争的情况下，开销更小，速度更快。</p>
<p>java 的关键域有 3 个</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// setup to use Unsafe.compareAndSwapInt for updates</span><br><span class="line">private static final Unsafe unsafe = Unsafe.getUnsafe();</span><br><span class="line">private static final long valueOffset;</span><br><span class="line">private volatile int value;</span><br></pre></td></tr></table></figure>

<p>这里， unsafe 是 java 提供的获得对对象内存地址访问的类，注释已经清楚的写出了，它的作用就是在更新操作时提供“比较并替换”的作用。实际上就是 AtomicInteger 中的一个工具。</p>
<p>valueOffset 是用来记录 value 本身在内存的便宜地址的，这个记录，也主要是为了在更新操作在内存中找到 value 的位置，方便比较。</p>
<p>注意：value 是用来存储整数的时间变量，这里被声明为 volatile，就是为了保证在更新操作时，当前线程可以拿到 value 最新的值（并发环境下，value 可能已经被其他线程更新了）。</p>
<p>这里，我们以自增的代码为例，可以看到这个并发控制的核心算法：</p>
<p>源码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">updateAndGet</span><span class="params">(IntUnaryOperator updateFunction)</span> &#123;</span><br><span class="line">    <span class="type">int</span> prev, next;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        prev = get();</span><br><span class="line">        next = updateFunction.applyAsInt(prev);</span><br><span class="line">    &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="AtomicInteger-源码分析"><a href="#AtomicInteger-源码分析" class="headerlink" title="AtomicInteger 源码分析"></a>AtomicInteger 源码分析</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">incrementAndGet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> get();</span><br><span class="line">        <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> current + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSet(current, next))</span><br><span class="line">            <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法中采用了 CAS 操作，每次从内存中读取数据然后将此数据和+1 后的结果进行 CAS 操作，如果成功就返回结果，否则重试直到成功为止。而 compareAndSet 利用 JNI 来完成 CPU 指令的操作。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(<span class="type">int</span> expect, <span class="type">int</span> update)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="built_in">this</span>, valueOffset, expect, update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整体的过程就是这样子的，利用 CPU 的 CAS 指令，同时借助 JNI 来完成 Java 的非阻塞算法。</p>
<h2 id="什么是-CAS"><a href="#什么是-CAS" class="headerlink" title="什么是 CAS"></a>什么是 CAS</h2><p>CAS，Compare and Swap 即比较并交换。 java.util.concurrent 包借助 CAS 实现了区别于 synchronized 同步锁的一种乐观锁。乐观锁就是每次去取数据的时候都乐观的认为数据不会被修改，所以不会上锁，但是在更新的时候会判断一下在此期间数据有没有更新。CAS 有 3 个操作数：内存值 V，旧的预期值 A，要修改的新值 B。当且仅当预期值 A 和内存值 V 相同时，将内存值 V 修改为 B，否则什么都不做。CAS 的关键点在于，系统在硬件层面保证了比较并交换操作的原子性，处理器使用基于对缓存加锁或总线加锁的方式来实现多处理器之间的原子操作。</p>
<h1 id="CAS-的优缺点"><a href="#CAS-的优缺点" class="headerlink" title="CAS 的优缺点"></a>CAS 的优缺点</h1><p>CAS 由于是在硬件层面保证的原子性，不会锁住当前线程，它的效率是很高的。</p>
<p>CAS 虽然很高效的实现了原子操作，但是它依然存在三个问题。</p>
<p>1、ABA 问题。CAS 在操作值的时候检查值是否已经变化，没有变化的情况下才会进行更新。但是如果一个值原来是 A，变成 B，又变成 A，那么 CAS 进行检查时会认为这个值没有变化，但是实际上却变化了。ABA 问题的解决方法是使用版本号。在变量前面追加上版本号，每次变量更新的时候把版本号加一，那么 A－B－A 就变成 1A-2B－3A。从 Java1.5 开始 JDK 的 atomic 包里提供了一个类 AtomicStampedReference 来解决 ABA 问题。</p>
<p>2、并发越高，失败的次数会越多，CAS 如果长时间不成功，会极大的增加 CPU 的开销。因此 CAS 不适合竞争十分频繁的场景。</p>
<p>3、只能保证一个共享变量的原子操作。当对多个共享变量操作时，CAS 就无法保证操作的原子性，这时就可以用锁，或者把多个共享变量合并成一个共享变量来操作。比如有两个共享变量 i ＝ 2,j&#x3D;a，合并一下 ij&#x3D;2a，然后用 CAS 来操作 ij。从 Java1.5 开始 JDK 提供了 AtomicReference 类来保证引用对象的原子性，你可以把多个变量放在一个对象里来进行 CAS 操作。</p>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>CompletableFuture-异步处理任务</title>
    <url>/58871fa1-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<blockquote>
<p>oracle JDK8 有关内容的文档：<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html">https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html</a></p>
</blockquote>
<h2 id="创建异步任务"><a href="#创建异步任务" class="headerlink" title="创建异步任务"></a>创建异步任务</h2><p>runAsync 执行 CompletableFuture 任务，没有返回值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable)</span></span><br><span class="line"><span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable, Executor executor)</span></span><br></pre></td></tr></table></figure>

<p>supplyAsync 执行 CompletableFuture 任务，可有返回值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier)</span></span><br><span class="line"><span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier, Executor executor)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果不指定 Executor 实现，则使用 <code>ForkJoinPool.commonPool()</code> 作为执行异步代码的线程池</p>
</blockquote>
<p>创建异步任务后，可根据需求进行如下的操作：</p>
<table>
<thead>
<tr>
<th align="left">方法名称</th>
<th align="left">类型</th>
<th align="left">传参</th>
<th align="left">返回值</th>
</tr>
</thead>
<tbody><tr>
<td align="left">thenRun</td>
<td align="left">单任务消费</td>
<td align="left">无传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">thenRunAsync</td>
<td align="left">单任务消费</td>
<td align="left">无传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">thenApply</td>
<td align="left">单任务消费</td>
<td align="left">要传参</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">thenApplyAsync</td>
<td align="left">单任务消费</td>
<td align="left">要传参</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">thenAccept</td>
<td align="left">单任务消费</td>
<td align="left">要传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">thenAcceptAsync</td>
<td align="left">单任务消费</td>
<td align="left">要传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">thenCombine</td>
<td align="left">双任务消费（与）</td>
<td align="left">要传参（两个任务的执行结果）</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">thenCombineAsync</td>
<td align="left">双任务消费（与）</td>
<td align="left">要传参（两个任务的执行结果）</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">thenAcceptBoth</td>
<td align="left">双任务消费（与）</td>
<td align="left">要传参（两个任务的执行结果）</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">thenAcceptBothAsync</td>
<td align="left">双任务消费（与）</td>
<td align="left">要传参（两个任务的执行结果）</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">runAfterBoth</td>
<td align="left">双任务消费（与）</td>
<td align="left">无传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">runAfterBothAsync</td>
<td align="left">双任务消费（与）</td>
<td align="left">无传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">applyToEither</td>
<td align="left">双任务消费（或）</td>
<td align="left">要传参（已完成任务的执行结果）</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">applyToEitherAsync</td>
<td align="left">双任务消费（或）</td>
<td align="left">要传参（已完成任务的执行结果）</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">acceptEither</td>
<td align="left">双任务消费（或）</td>
<td align="left">要传参（已完成任务的执行结果）</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">acceptEitherAsync</td>
<td align="left">双任务消费（或）</td>
<td align="left">要传参（已完成任务的执行结果）</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">runAfterEither</td>
<td align="left">双任务消费（或）</td>
<td align="left">无传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">runAfterEitherAsync</td>
<td align="left">双任务消费（或）</td>
<td align="left">无传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">whenComplete</td>
<td align="left">单任务消费</td>
<td align="left">要传参（正常返回值和异常）</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">whenCompleteAsync</td>
<td align="left">单任务消费</td>
<td align="left">要传参（正常返回值和异常）</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">handle</td>
<td align="left">单任务消费</td>
<td align="left">要传参（正常返回值和异常）</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">handleAsync</td>
<td align="left">单任务消费</td>
<td align="left">要传参（正常返回值和异常）</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">exceptionally</td>
<td align="left">单任务消费</td>
<td align="left">要传参 （异常）</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">thenCompose</td>
<td align="left">单任务消费</td>
<td align="left">要传参</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">allOf</td>
<td align="left">多任务消费（与）</td>
<td align="left">要传参（任务列表）</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">anyOf</td>
<td align="left">多任务消费（或）</td>
<td align="left">要传参（任务列表）</td>
<td align="left">无返回值</td>
</tr>
</tbody></table>
<blockquote>
<p>不带 Async 版本由上一个任务的线程继续执行该任务，Async 版本可以指定执行该异步任务的 Executor 实现，如果不指定，默认使用 <code>ForkJoinPool.commonPool()</code></p>
</blockquote>
<h2 id="单任务消费"><a href="#单任务消费" class="headerlink" title="单任务消费"></a>单任务消费</h2><table>
<thead>
<tr>
<th align="left">回调方法</th>
<th align="left">类型</th>
<th align="left">传参</th>
<th align="left">返回值</th>
</tr>
</thead>
<tbody><tr>
<td align="left">thenRun</td>
<td align="left">单任务消费</td>
<td align="left">无传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">thenRunAsync</td>
<td align="left">单任务消费</td>
<td align="left">无传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">thenAccept</td>
<td align="left">单任务消费</td>
<td align="left">要传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">thenAcceptAsync</td>
<td align="left">单任务消费</td>
<td align="left">要传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">thenApply</td>
<td align="left">单任务消费</td>
<td align="left">要传参</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">thenApplyAsync</td>
<td align="left">单任务消费</td>
<td align="left">要传参</td>
<td align="left">有返回值</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">supplyAsyncTask</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;supplyAsyncTask=&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// thenApply</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">thenApplyTask</span> <span class="operator">=</span> supplyAsyncTask.thenApply((param) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;thenApplyTask=&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// thenApplyAsync不指定线程池</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">thenApplyAsyncTask</span> <span class="operator">=</span> supplyAsyncTask.thenApplyAsync((param) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;thenApplyAsyncTask=&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// thenApplyAsync指定线程池</span></span><br><span class="line">    <span class="type">var</span> <span class="variable">thenApplyAsyncTask2</span> <span class="operator">=</span> supplyAsyncTask.thenApplyAsync((param) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;thenApplyAsyncTask2=&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;, executor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不调用get()将不执行回调</span></span><br><span class="line">    thenApplyAsyncTask.get();</span><br><span class="line">    thenApplyAsyncTask2.get();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭线程池</span></span><br><span class="line">    executor.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">supplyAsyncTask=pool-1-thread-1</span><br><span class="line">thenApplyAsyncTask2=pool-1-thread-2</span><br><span class="line">thenApplyTask=pool-1-thread-2</span><br><span class="line">thenApplyAsyncTask=ForkJoinPool.commonPool-worker-3</span><br></pre></td></tr></table></figure>

<h2 id="双任务消费（与）"><a href="#双任务消费（与）" class="headerlink" title="双任务消费（与）"></a>双任务消费（与）</h2><p>将两个 CompletableFuture 组合起来，只有这两个都正常执行完了，才会执行某个任务。</p>
<table>
<thead>
<tr>
<th align="left">方法名称</th>
<th align="left">类型</th>
<th align="left">传参</th>
<th align="left">返回值</th>
</tr>
</thead>
<tbody><tr>
<td align="left">thenCombine</td>
<td align="left">双任务消费（与）</td>
<td align="left">有传参（两个任务的执行结果）</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">thenCombineAsync</td>
<td align="left">双任务消费（与）</td>
<td align="left">有传参（两个任务的执行结果）</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">thenAcceptBoth</td>
<td align="left">双任务消费（与）</td>
<td align="left">有传参（两个任务的执行结果）</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">thenAcceptBothAsync</td>
<td align="left">双任务消费（与）</td>
<td align="left">有传参（两个任务的执行结果）</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">runAfterBoth</td>
<td align="left">双任务消费（与）</td>
<td align="left">无传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">runAfterBothAsync</td>
<td align="left">双任务消费（与）</td>
<td align="left">无传参</td>
<td align="left">无返回值</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">task1</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;task1&quot;</span>);</span><br><span class="line">    <span class="type">var</span> <span class="variable">task2</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;task2&quot;</span>);</span><br><span class="line">    <span class="type">var</span> <span class="variable">task3</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; <span class="string">&quot;task3&quot;</span>);</span><br><span class="line"></span><br><span class="line">    task1.thenCombine(task2, (param1, param2) -&gt; &#123;</span><br><span class="line">        <span class="comment">// task1task2</span></span><br><span class="line">        System.out.println(param1 + param2);</span><br><span class="line">        <span class="keyword">return</span> param1 + param2;</span><br><span class="line">    &#125;).thenCombine(task3, (param12, param3) -&gt; &#123;</span><br><span class="line">        <span class="comment">// task1task2task3</span></span><br><span class="line">        System.out.println(param12 + param3);</span><br><span class="line">        <span class="keyword">return</span> param12 + param3;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    task1.thenAcceptBoth(task2, (param1, param2) -&gt; &#123;</span><br><span class="line">        <span class="comment">// task1task2</span></span><br><span class="line">        System.out.println(param1 + param2);</span><br><span class="line">    &#125;).thenAcceptBoth(task3, (param12, param3) -&gt; &#123;</span><br><span class="line">        <span class="comment">// nulltask3</span></span><br><span class="line">        System.out.println(param12 + param3);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    task1.runAfterBoth(task2, () -&gt; &#123;</span><br><span class="line">        <span class="comment">// task1 and task2</span></span><br><span class="line">        System.out.println(<span class="string">&quot;task1 and task2&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="双任务消费（或）"><a href="#双任务消费（或）" class="headerlink" title="双任务消费（或）"></a>双任务消费（或）</h2><p>将两个 CompletableFuture 组合起来，只要其中一个执行完了，就执行回调方法。</p>
<table>
<thead>
<tr>
<th align="left">方法名称</th>
<th align="left">类型</th>
<th align="left">传参</th>
<th align="left">返回值</th>
</tr>
</thead>
<tbody><tr>
<td align="left">applyToEither</td>
<td align="left">双任务消费（或）</td>
<td align="left">有传参（已完成任务的执行结果）</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">applyToEitherAsync</td>
<td align="left">双任务消费（或）</td>
<td align="left">有传参（已完成任务的执行结果）</td>
<td align="left">有返回值</td>
</tr>
<tr>
<td align="left">acceptEither</td>
<td align="left">双任务消费（或）</td>
<td align="left">有传参（已完成任务的执行结果）</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">acceptEitherAsync</td>
<td align="left">双任务消费（或）</td>
<td align="left">有传参（已完成任务的执行结果）</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">runAfterEither</td>
<td align="left">双任务消费（或）</td>
<td align="left">无传参</td>
<td align="left">无返回值</td>
</tr>
<tr>
<td align="left">runAfterEitherAsync</td>
<td align="left">双任务消费（或）</td>
<td align="left">无传参</td>
<td align="left">无返回值</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">task1</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;task1&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">var</span> <span class="variable">task2</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;task2&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">var</span> <span class="variable">task3</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;task3&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    task1.applyToEither(task2, (param) -&gt; &#123;</span><br><span class="line">        <span class="comment">// applyToEither=task2</span></span><br><span class="line">        System.out.println(<span class="string">&quot;applyToEither=&quot;</span> + param);</span><br><span class="line">        <span class="keyword">return</span> param;</span><br><span class="line">    &#125;).acceptEither(task3, (param) -&gt; &#123;</span><br><span class="line">        <span class="comment">// acceptEither=task2 或 acceptEither=task3</span></span><br><span class="line">        System.out.println(<span class="string">&quot;acceptEither=&quot;</span> + param);</span><br><span class="line">    &#125;).get();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// task1 or task2</span></span><br><span class="line">    task1.runAfterEither(task2,()-&gt; System.out.println(<span class="string">&quot;task1 or task2&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="whenComplete、whenCompleteAsync"><a href="#whenComplete、whenCompleteAsync" class="headerlink" title="whenComplete、whenCompleteAsync"></a>whenComplete、whenCompleteAsync</h3><p>某个任务执行完成后，执行的回调方法，无返回值。可以访问 CompletableFuture 的结果和异常作为参数，使用它们并执行想要的操作。此方法并不能转换完成的结果。会内部抛出异常。其正常返回的 CompletableFuture 的结果来自上个任务。</p>
<h3 id="handle、handleAsync"><a href="#handle、handleAsync" class="headerlink" title="handle、handleAsync"></a>handle、handleAsync</h3><p>不论正常返回还是出异常都会进入 handle，参数通常为 <code>new BiFunction&lt;T, Throwable, R&gt;();</code>，其中</p>
<ul>
<li>T：上一任务传入的对象类型</li>
<li>Throwable：上一任务传入的异常</li>
<li>R：返回的对象类型</li>
</ul>
<blockquote>
<p>handle 和 thenApply 的区别：如果任务出现异常不会进入 thenApply；任务出现异常也会进入 handle，可对异常处理。</p>
</blockquote>
<blockquote>
<p>handle 和 whenComplete 的区别：handle 可对传入值 T 进行转换，并产生自己的返回结果 R；whenComplete 的返回值和上级任务传入的结果一致，不能转换。</p>
</blockquote>
<blockquote>
<p>whenComplete、whenCompleteAsync、handle 和 handleAsync 的输入参数一个是正常结果一个是异常结果，而 exceptionally 的输入参数为异常结果。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">supplyAsyncTask</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// 制造一个异常</span></span><br><span class="line">        <span class="comment">// int value = 1 / 0;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;supplyAsyncTask&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">handle</span> <span class="operator">=</span> supplyAsyncTask.handle((s, throwable) -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (Optional.ofNullable(throwable).isPresent()) &#123;</span><br><span class="line">            <span class="keyword">return</span> throwable.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>() &#123;&#123;</span><br><span class="line">            add(s);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// supplyAsyncTask异常时，输出1：java.lang.ArithmeticException: / by zero</span></span><br><span class="line">    <span class="comment">// 输出2：[supplyAsyncTask]</span></span><br><span class="line">    System.out.println(handle.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="exceptionally"><a href="#exceptionally" class="headerlink" title="exceptionally"></a>exceptionally</h3><p>某个任务执行抛出异常时执行的回调方法。抛出异常作为参数，传递到回调方法。仅处理异常情况。如果任务成功完成，那么将被跳过。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">supplyAsyncTask</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">double</span> error=<span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">    &#125;, executor).exceptionally((e)-&gt;&#123;</span><br><span class="line">        <span class="comment">// java.lang.ArithmeticException: / by zero</span></span><br><span class="line">        System.out.println(e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &quot;error&quot;</span></span><br><span class="line">    System.out.println(supplyAsyncTask.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="complete"><a href="#complete" class="headerlink" title="complete"></a>complete</h3><p>如果尚未完成，则将 <code>get()</code> 和相关方法返回的值设置为给定值。如果此调用导致此 CompletableFuture 转换到完成状态，则返回 true，否则返回 false。文档描述：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">If not already completed, sets the value returned by get() and related methods to the given value.</span><br><span class="line"></span><br><span class="line">Params:</span><br><span class="line">value – the result value</span><br><span class="line">Returns:</span><br><span class="line">true if this invocation caused this CompletableFuture to transition to a completed state, else false</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">task1</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">15</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若get放在此处，一直等待task1完成，输出10</span></span><br><span class="line">    <span class="comment">// System.out.println(task1.get());</span></span><br><span class="line">    <span class="comment">// 强制task1完成，输出true</span></span><br><span class="line">    System.out.println(task1.complete(<span class="number">5</span>));</span><br><span class="line">    <span class="comment">// 输出5</span></span><br><span class="line">    System.out.println(task1.get());</span><br><span class="line">    <span class="comment">// task1已完成，输出false</span></span><br><span class="line">    System.out.println(task1.complete(<span class="number">50</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="thenCompose"><a href="#thenCompose" class="headerlink" title="thenCompose"></a>thenCompose</h3><p>源码定义</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenCompose</span><span class="params">(Function&lt;? <span class="built_in">super</span> T, ? extends CompletionStage&lt;U&gt;&gt; fn)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenComposeAsync</span><span class="params">(Function&lt;? <span class="built_in">super</span> T, ? extends CompletionStage&lt;U&gt;&gt; fn)</span> ;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenComposeAsync</span><span class="params">(Function&lt;? <span class="built_in">super</span> T, ? extends CompletionStage&lt;U&gt;&gt; fn, Executor executor)</span> ;</span><br></pre></td></tr></table></figure>

<p>thenCompose 方法会在某个任务执行完成后，将该任务的执行结果作为入参，执行指定的方法。该方法会返回一个新的 CompletableFuture 实例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">task1</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">task2</span> <span class="operator">=</span> task1.thenCompose(param -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;this is task2 param=&quot;</span> + param);</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;this is task2 square&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> Math.pow(param, <span class="number">2</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;).thenApply(param -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;thenApply get the square=&quot;</span> + param);</span><br><span class="line">        <span class="keyword">return</span> param;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">task3</span> <span class="operator">=</span> task1.thenCompose(param -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;this is task3 param=&quot;</span> + param);</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;this is task3 square&quot;</span>);</span><br><span class="line">            System.out.println(Math.pow(param, <span class="number">2</span>));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;task2 get=&quot;</span> + task2.get());</span><br><span class="line">    System.out.println(<span class="string">&quot;task3 get=&quot;</span> + task3.get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="built_in">this</span> is task2 param=<span class="number">10</span></span><br><span class="line"><span class="built_in">this</span> is task2 square</span><br><span class="line">thenApply get the square=<span class="number">100.0</span></span><br><span class="line"><span class="built_in">this</span> is task3 param=<span class="number">10</span></span><br><span class="line"><span class="built_in">this</span> is task3 square</span><br><span class="line"><span class="number">100.0</span></span><br><span class="line">task2 get=<span class="number">100.0</span></span><br><span class="line">task3 get=<span class="literal">null</span></span><br></pre></td></tr></table></figure>

<h3 id="allOf"><a href="#allOf" class="headerlink" title="allOf"></a>allOf</h3><p>静态方法，阻塞等待所有给定的 CompletableFuture 执行结束后，返回一个 <code>CompletableFuture&lt;Void&gt;</code> 结果。所有任务都执行完成后，才执行 allOf 的回调方法。如果任意一个任务异常，执行 get 方法时会抛出异常。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">task1</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;task1&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="type">var</span> <span class="variable">task2</span> <span class="operator">=</span> CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;task2 is over&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    CompletableFuture.allOf(task1, task2).whenComplete((param, throwable) -&gt; &#123;</span><br><span class="line">        <span class="comment">// null</span></span><br><span class="line">        System.out.println(param);</span><br><span class="line">    &#125;).exceptionally(throwable -&gt; &#123;</span><br><span class="line">        <span class="comment">// task3 allOf throwable=java.lang.ArithmeticException: / by zero</span></span><br><span class="line">        System.out.println(<span class="string">&quot;task3 allOf throwable=&quot;</span> + throwable.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;).get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="anyOf"><a href="#anyOf" class="headerlink" title="anyOf"></a>anyOf</h3><p>静态方法，阻塞等待任意一个给定的 CompletableFuture 对象执行结束后，返回一个 <code>CompletableFuture&lt;Void&gt;</code> 结果。任意一个任务执行完，就执行 anyOf 的回调方法。如果执行的任务异常，执行 get 方法时会抛出异常。</p>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>CompletionService-及时获取任务返回值</title>
    <url>/588746b0-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="ExecutorService"><a href="#ExecutorService" class="headerlink" title="ExecutorService"></a>ExecutorService</h2><p>定义如下的 TaskCallable 类，返回值的延迟输出时间根据传入值决定：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">TaskCallable</span><span class="params">(String taskID, Double value, Double rate)</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;String&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        TimeUnit.MILLISECONDS.sleep(value.longValue());</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;taskID=&#123; %s &#125; result=&#123; %s*%s -&gt; %s &#125;&quot;</span>, taskID, value, rate, value * rate);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>向线程池添加三个任务，执行时间有所区别，最后依次调用 <code>get()</code> 方法输出结果。</p>
<p><a href="https://github.com/inspiration-lab/java-snippet-testing/blob/main/src/main/java/com/lab/snippet/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5/ExecutorService/ExecutorServiceRun.java">查看完整示例代码</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">var</span> <span class="variable">futureList</span> <span class="operator">=</span> Arrays.asList(</span><br><span class="line">        executorService.submit(<span class="keyword">new</span> <span class="title class_">TaskCallable</span>(<span class="string">&quot;1aa8c994-281e-4fbb-a09b-cdf389eedf3b&quot;</span>, <span class="number">1000.0</span>, <span class="number">0.5</span>)),</span><br><span class="line">        executorService.submit(<span class="keyword">new</span> <span class="title class_">TaskCallable</span>(<span class="string">&quot;321996c2-73c0-411a-8e66-fcfa04d94ae1&quot;</span>, <span class="number">5000.0</span>, <span class="number">1.0</span>)),</span><br><span class="line">        executorService.submit(<span class="keyword">new</span> <span class="title class_">TaskCallable</span>(<span class="string">&quot;3df9d22e-17d9-4b48-a821-867974681d6e&quot;</span>, <span class="number">600.0</span>, <span class="number">1.2</span>))</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; futureList.size(); index++) &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">result</span> <span class="operator">=</span> futureList.get(index).get();</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">executorService.shutdown();</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">taskID=&#123; 1aa8c994-281e-4fbb-a09b-cdf389eedf3b &#125; result=&#123; <span class="number">1000.0</span>*<span class="number">0.5</span> -&gt; <span class="number">500.0</span> &#125;</span><br><span class="line">taskID=&#123; 321996c2-73c0-411a-<span class="number">8e66</span>-fcfa04d94ae1 &#125; result=&#123; <span class="number">5000.0</span>*<span class="number">1.0</span> -&gt; <span class="number">5000.0</span> &#125;</span><br><span class="line">taskID=&#123; 3df9d22e-17d9-4b48-a821-867974681d6e &#125; result=&#123; <span class="number">600.0</span>*<span class="number">1.2</span> -&gt; <span class="number">720.0</span> &#125;</span><br><span class="line">计时器&#123; b10bbd47-63c4-<span class="number">4545</span>-b236-15303f40cc1f &#125;停止，耗时=&#123; 5004ms &#125;</span><br></pre></td></tr></table></figure>

<p>由于 <code>get()</code> 方法是阻塞的，因此如果某个 Future 执行时间太长，整个遍历过程将会阻塞，无法及时从已完成的 Future 拿到返回值。上述例子中，即使 600ms 的任务，也只能等到前两个长时间任务都完成后才能输出。</p>
<h2 id="CompletionService"><a href="#CompletionService" class="headerlink" title="CompletionService"></a>CompletionService</h2><p>CompletionSerive 接口的实现类 ExecutorCompletionService 优化了获取异步操作结果。ExecutorCompletionService 中内置了存放 Future 的队列 completionQueue，在任务调用完成后，将要返回的 future 放入到该队列。客户端通过 <code>take()</code> 方法得到 future，再调用 <code>get()</code> 方法从而获取任务执行结果。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">QueueingFuture</span>&lt;V&gt; <span class="keyword">extends</span> <span class="title class_">FutureTask</span>&lt;Void&gt; &#123;</span><br><span class="line">    QueueingFuture(RunnableFuture&lt;V&gt; task,</span><br><span class="line">                    BlockingQueue&lt;Future&lt;V&gt;&gt; completionQueue) &#123;</span><br><span class="line">        <span class="built_in">super</span>(task, <span class="literal">null</span>);</span><br><span class="line">        <span class="built_in">this</span>.task = task;</span><br><span class="line">        <span class="built_in">this</span>.completionQueue = completionQueue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Future&lt;V&gt; task;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Future&lt;V&gt;&gt; completionQueue;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">done</span><span class="params">()</span> &#123; completionQueue.add(task); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>向 CompletionService 提交任务的方式与 ExecutorService 一样。两者的区别在于取结果的方式。有了 CompletionService，可以不再需要 Future 集合。如果要得到最早的执行结果，调用 <code>completionService.take().get()</code> 即可：</p>
<p><a href="https://github.com/inspiration-lab/java-snippet-testing/blob/main/src/main/java/com/lab/snippet/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5/ExecutorService/CompletionServiceRun.java">查看完整示例代码</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">CompletionService&lt;String&gt; completionService = <span class="keyword">new</span> <span class="title class_">ExecutorCompletionService</span>&lt;&gt;(executorService);</span><br><span class="line"></span><br><span class="line">completionService.submit(<span class="keyword">new</span> <span class="title class_">TaskCallable</span>(<span class="string">&quot;1aa8c994-281e-4fbb-a09b-cdf389eedf3b&quot;</span>, <span class="number">1000.0</span>, <span class="number">0.5</span>));</span><br><span class="line">completionService.submit(<span class="keyword">new</span> <span class="title class_">TaskCallable</span>(<span class="string">&quot;321996c2-73c0-411a-8e66-fcfa04d94ae1&quot;</span>, <span class="number">5000.0</span>, <span class="number">1.0</span>));</span><br><span class="line">completionService.submit(<span class="keyword">new</span> <span class="title class_">TaskCallable</span>(<span class="string">&quot;3df9d22e-17d9-4b48-a821-867974681d6e&quot;</span>, <span class="number">600.0</span>, <span class="number">1.2</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; <span class="number">3</span>; index++) &#123;</span><br><span class="line">    System.out.println(completionService.take().get());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">executorService.shutdown();</span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">taskID=&#123; 3df9d22e-17d9-4b48-a821-867974681d6e &#125; result=&#123; <span class="number">600.0</span>*<span class="number">1.2</span> -&gt; <span class="number">720.0</span> &#125;</span><br><span class="line">taskID=&#123; 1aa8c994-281e-4fbb-a09b-cdf389eedf3b &#125; result=&#123; <span class="number">1000.0</span>*<span class="number">0.5</span> -&gt; <span class="number">500.0</span> &#125;</span><br><span class="line">taskID=&#123; 321996c2-73c0-411a-<span class="number">8e66</span>-fcfa04d94ae1 &#125; result=&#123; <span class="number">5000.0</span>*<span class="number">1.0</span> -&gt; <span class="number">5000.0</span> &#125;</span><br><span class="line">计时器&#123; 7223efb6-ec07-<span class="number">4294</span>-8f23-8b73b536c9b4 &#125;停止，耗时=&#123; 5002ms &#125;</span><br></pre></td></tr></table></figure>

<h2 id="CompletionService-结合异步实现多线程处理任务"><a href="#CompletionService-结合异步实现多线程处理任务" class="headerlink" title="CompletionService 结合异步实现多线程处理任务"></a>CompletionService 结合异步实现多线程处理任务</h2><p>定义一个任务队列，异步执行「入队」和「出队」，最终通过CompletionService获取全部任务的返回结果。</p>
<p><a href="https://github.com/inspiration-lab/java-snippet-testing/blob/main/src/main/java/com/lab/snippet/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5/ExecutorService/AsyncRun.java">查看完整示例代码</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义队列</span></span><br><span class="line">LinkedBlockingDeque&lt;TaskCallable&gt; linkedBlockingDeque = <span class="keyword">new</span> <span class="title class_">LinkedBlockingDeque</span>&lt;&gt;();</span><br><span class="line"><span class="comment">// 模拟任务数量</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskCount</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">// 获取CPU核心数</span></span><br><span class="line"><span class="type">int</span> <span class="variable">coreNum</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line"><span class="comment">// 定义线程池</span></span><br><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">customPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(coreNum, coreNum, coreNum, TimeUnit.MINUTES, <span class="keyword">new</span> <span class="title class_">LinkedBlockingDeque</span>&lt;&gt;(),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadFactory</span>() &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">customPoolCurrent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable runnable)</span> &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, String.format(<span class="string">&quot;customPool-thread-%s&quot;</span>, customPoolCurrent.getAndIncrement()));</span><br><span class="line">                thread.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">                <span class="keyword">return</span> thread;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line"></span><br><span class="line">CompletionService&lt;String&gt; completionService = <span class="keyword">new</span> <span class="title class_">ExecutorCompletionService</span>&lt;&gt;(customPool);</span><br><span class="line"></span><br><span class="line"><span class="type">var</span> <span class="variable">pushElement</span> <span class="operator">=</span> CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; taskCount; index++) &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">value</span> <span class="operator">=</span> Math.random() * <span class="number">1000</span>;</span><br><span class="line">        <span class="type">var</span> <span class="variable">taskCallable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TaskCallable</span>(UUID.randomUUID().toString(), value, Math.random());</span><br><span class="line">        linkedBlockingDeque.push(taskCallable);</span><br><span class="line">        System.out.println(String.format(<span class="string">&quot;线程 %s 完成 %s 入队&quot;</span>, Thread.currentThread().getName(), taskCallable));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">300</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="type">var</span> <span class="variable">submitTask</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flagTask</span> <span class="operator">=</span> pushElement.isDone();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flagPeek</span> <span class="operator">=</span> Optional.ofNullable(linkedBlockingDeque.peek()).isPresent();</span><br><span class="line">            <span class="comment">// 当【入队任务完成】且【队列没有元素可取】时结束</span></span><br><span class="line">            <span class="keyword">if</span> (flagTask == <span class="literal">true</span> &amp;&amp; flagPeek == <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (flagPeek == <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="comment">// 仅【队列没有元素可取】时，跳过</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 【队列有元素可取】时，添加任务到线程池</span></span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">            <span class="type">var</span> <span class="variable">taskCallable</span> <span class="operator">=</span> linkedBlockingDeque.take();</span><br><span class="line">            completionService.submit(taskCallable);</span><br><span class="line">            System.out.println(String.format(<span class="string">&quot;线程 %s 将 %s 提交到线程池&quot;</span>, Thread.currentThread().getName(), taskCallable));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="variable">submit</span> <span class="operator">=</span> submitTask.get();</span><br><span class="line"><span class="keyword">if</span> (!submit) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; taskCount; index++) &#123;</span><br><span class="line">        System.out.println(completionService.take().get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">customPool.shutdown();</span><br><span class="line">customPool.awaitTermination(<span class="number">3</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">线程 ForkJoinPool.commonPool-worker-<span class="number">1</span> 完成 TaskCallable[taskID=29ad9f36-<span class="number">2e25</span>-457a-8a50-40b2619ccd85, value=<span class="number">297.9894322218015</span>, rate=<span class="number">0.39525736986090654</span>] 入队</span><br><span class="line">线程 ForkJoinPool.commonPool-worker-<span class="number">1</span> 完成 TaskCallable[taskID=<span class="number">72434730</span>-e52a-<span class="number">4819</span>-a249-25b1e8450c81, value=<span class="number">861.735810794833</span>, rate=<span class="number">0.0508273434713048</span>] 入队</span><br><span class="line">线程 ForkJoinPool.commonPool-worker-<span class="number">2</span> 将 TaskCallable[taskID=<span class="number">72434730</span>-e52a-<span class="number">4819</span>-a249-25b1e8450c81, value=<span class="number">861.735810794833</span>, rate=<span class="number">0.0508273434713048</span>] 提交到线程池</span><br><span class="line">线程 ForkJoinPool.commonPool-worker-<span class="number">1</span> 完成 TaskCallable[taskID=6f25d9e6-9f38-4d84-ac59-259324f800f1, value=<span class="number">931.5744113116666</span>, rate=<span class="number">0.8237427385465251</span>] 入队</span><br><span class="line">线程 ForkJoinPool.commonPool-worker-<span class="number">1</span> 完成 TaskCallable[taskID=6e3de271-<span class="number">2169</span>-49c7-a425-9973304379a9, value=<span class="number">754.2015420496596</span>, rate=<span class="number">0.480198992823775</span>] 入队</span><br><span class="line">线程 ForkJoinPool.commonPool-worker-<span class="number">2</span> 将 TaskCallable[taskID=6e3de271-<span class="number">2169</span>-49c7-a425-9973304379a9, value=<span class="number">754.2015420496596</span>, rate=<span class="number">0.480198992823775</span>] 提交到线程池</span><br><span class="line">线程 ForkJoinPool.commonPool-worker-<span class="number">1</span> 完成 TaskCallable[taskID=ffcb4a5e-603b-46dd-b4d0-02dc2bc7204c, value=<span class="number">259.60270090020333</span>, rate=<span class="number">0.404730459043419</span>] 入队</span><br><span class="line">线程 ForkJoinPool.commonPool-worker-<span class="number">2</span> 将 TaskCallable[taskID=ffcb4a5e-603b-46dd-b4d0-02dc2bc7204c, value=<span class="number">259.60270090020333</span>, rate=<span class="number">0.404730459043419</span>] 提交到线程池</span><br><span class="line">线程 ForkJoinPool.commonPool-worker-<span class="number">2</span> 将 TaskCallable[taskID=6f25d9e6-9f38-4d84-ac59-259324f800f1, value=<span class="number">931.5744113116666</span>, rate=<span class="number">0.8237427385465251</span>] 提交到线程池</span><br><span class="line">线程 ForkJoinPool.commonPool-worker-<span class="number">2</span> 将 TaskCallable[taskID=29ad9f36-<span class="number">2e25</span>-457a-8a50-40b2619ccd85, value=<span class="number">297.9894322218015</span>, rate=<span class="number">0.39525736986090654</span>] 提交到线程池</span><br><span class="line">taskID=&#123; <span class="number">72434730</span>-e52a-<span class="number">4819</span>-a249-25b1e8450c81 &#125; result=&#123; <span class="number">861.735810794833</span>*<span class="number">0.0508273434713048</span> -&gt; <span class="number">43.7997420367923</span> &#125;</span><br><span class="line">taskID=&#123; 6e3de271-<span class="number">2169</span>-49c7-a425-9973304379a9 &#125; result=&#123; <span class="number">754.2015420496596</span>*<span class="number">0.480198992823775</span> -&gt; <span class="number">362.1668208783845</span> &#125;</span><br><span class="line">taskID=&#123; ffcb4a5e-603b-46dd-b4d0-02dc2bc7204c &#125; result=&#123; <span class="number">259.60270090020333</span>*<span class="number">0.404730459043419</span> -&gt; <span class="number">105.06912030425069</span> &#125;</span><br><span class="line">taskID=&#123; 29ad9f36-<span class="number">2e25</span>-457a-8a50-40b2619ccd85 &#125; result=&#123; <span class="number">297.9894322218015</span>*<span class="number">0.39525736986090654</span> -&gt; <span class="number">117.78251922633414</span> &#125;</span><br><span class="line">taskID=&#123; 6f25d9e6-9f38-4d84-ac59-259324f800f1 &#125; result=&#123; <span class="number">931.5744113116666</span>*<span class="number">0.8237427385465251</span> -&gt; <span class="number">767.3776567337393</span> &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java8-Map-新增方法</title>
    <url>/ef12f511-4937-11ee-861d-b3cf05b530a5/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>


<p>在 Java 8 中的 Map.Entry 接口中增加了 comparingByKey, comparingByValue 方法，它们都返回 <code>Comparator&lt;Map.Entry&lt;K,V&gt;&gt;</code>, Comparator 是一个函数接口，主要是方便 Lambda 表达式的使用。</p>
<p>在 Java 8 中的 Map 接口增加了一些 default 方法，提升了对 key，value 操作的便利性。下面是基本数据的定义，通过这些数据说明新增的一些方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Integer, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="number">1</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">map.put(<span class="number">2</span>, <span class="string">&quot;b&quot;</span>);</span><br><span class="line">map.put(<span class="number">3</span>, <span class="string">&quot;c&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="getOrDefault-方法"><a href="#getOrDefault-方法" class="headerlink" title="getOrDefault 方法"></a>getOrDefault 方法</h2><p>如果指定的 key 存在，则返回该 key 对应的 value，如果不存在，则返回指定的值。例子如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// key为4不存在，输出 d</span></span><br><span class="line">System.out.println(map.getOrDefault(<span class="number">4</span>, <span class="string">&quot;d&quot;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="forEach-方法"><a href="#forEach-方法" class="headerlink" title="forEach 方法"></a>forEach 方法</h2><p>遍历 Map 中的所有 Entry, 对 key, value 进行处理， 接收参数 (K, V) -&gt; void, 例子如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 输出1a, 2b, 3c</span></span><br><span class="line">map.forEach((key, value) -&gt; System.out.println(key + value));</span><br></pre></td></tr></table></figure>

<h2 id="replaceAll-方法"><a href="#replaceAll-方法" class="headerlink" title="replaceAll 方法"></a>replaceAll 方法</h2><p>替换 Map 中所有 Entry 的 value 值，这个值由旧的 key 和 value 计算得出，接收参数 <code>(K, V) -&gt; V</code>, 类似如下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (Map.Entry&lt;K, V&gt; entry : map.entrySet())</span><br><span class="line">    entry.setValue(function.apply(entry.getKey(), entry.getValue()));</span><br></pre></td></tr></table></figure>

<p>例如如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">map.replaceAll((key, value) -&gt; (key + <span class="number">1</span>) + value);</span><br><span class="line"><span class="comment">// 输出 12a 23b 34c</span></span><br><span class="line">map.forEach((key, value) -&gt; System.out.println(key + value));</span><br></pre></td></tr></table></figure>

<h2 id="putIfAbsent-方法"><a href="#putIfAbsent-方法" class="headerlink" title="putIfAbsent 方法"></a>putIfAbsent 方法</h2><p>如果 key 关联的 value 不存在，则关联新的 value 值，返回 key 关联的旧的值，类似如下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">V</span> <span class="variable">v</span> <span class="operator">=</span> map.get(key);</span><br><span class="line"><span class="keyword">if</span> (v == <span class="literal">null</span>)</span><br><span class="line">    v = map.put(key, value);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> v;</span><br></pre></td></tr></table></figure>

<p>示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">map.putIfAbsent(<span class="number">3</span>, <span class="string">&quot;d&quot;</span>);</span><br><span class="line">map.putIfAbsent(<span class="number">4</span>, <span class="string">&quot;d&quot;</span>);</span><br><span class="line"><span class="comment">// 输出 c</span></span><br><span class="line">System.out.println(map.get(<span class="number">3</span>));</span><br><span class="line"><span class="comment">// 输出 d</span></span><br><span class="line">System.out.println(map.get(<span class="number">4</span>));</span><br></pre></td></tr></table></figure>

<h2 id="remove-方法"><a href="#remove-方法" class="headerlink" title="remove 方法"></a>remove 方法</h2><p>接收 2 个参数，key 和 value，如果 key 关联的 value 值与指定的 value 值相等（equals），则删除这个元素，类似代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (map.containsKey(key) &amp;&amp; Objects.equals(map.get(key), value)) &#123;</span><br><span class="line">    map.remove(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">map.remove(<span class="number">1</span>, <span class="string">&quot;b&quot;</span>);</span><br><span class="line"><span class="comment">// 未删除成功， 输出 a</span></span><br><span class="line">System.out.println(map.get(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">map.remove(<span class="number">2</span>, <span class="string">&quot;b&quot;</span>);</span><br><span class="line"><span class="comment">// 删除成功，输出 null</span></span><br><span class="line">System.out.println(map.get(<span class="number">2</span>));</span><br></pre></td></tr></table></figure>

<h2 id="replace-K-key-V-oldValue-V-newValue-方法"><a href="#replace-K-key-V-oldValue-V-newValue-方法" class="headerlink" title="replace(K key, V oldValue, V newValue) 方法"></a>replace(K key, V oldValue, V newValue) 方法</h2><p>如果 key 关联的值与指定的 oldValue 的值相等，则替换成新的 newValue，类似代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (map.containsKey(key) &amp;&amp; Objects.equals(map.get(key), value)) &#123;</span><br><span class="line">    map.put(key, newValue);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>示例代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">map.replace(<span class="number">3</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;z&quot;</span>);</span><br><span class="line"><span class="comment">// 未替换成功，输出 c</span></span><br><span class="line">System.out.println(map.get(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">map.replace(<span class="number">1</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;z&quot;</span>);</span><br><span class="line"><span class="comment">// 替换成功， 输出 z</span></span><br><span class="line">System.out.println(map.get(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>

<h2 id="replace-K-key-V-value-方法"><a href="#replace-K-key-V-value-方法" class="headerlink" title="replace(K key, V value) 方法"></a>replace(K key, V value) 方法</h2><p>如果 map 中存在 key，则替换成 value 值，否则返回 null, 类似代码如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (map.containsKey(key)) &#123;</span><br><span class="line">    <span class="keyword">return</span> map.put(key, value);</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 输出旧的值， a</span></span><br><span class="line">System.out.println(map.replace(<span class="number">1</span>, <span class="string">&quot;aa&quot;</span>));</span><br><span class="line"><span class="comment">// 替换成功，输出新的值， aa</span></span><br><span class="line">System.out.println(map.get(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不存在key为4， 输出 null</span></span><br><span class="line">System.out.println(map.replace(<span class="number">4</span>, <span class="string">&quot;d&quot;</span>));</span><br><span class="line"><span class="comment">// 不存在key为4， 输出 null</span></span><br><span class="line">System.out.println(map.get(<span class="number">4</span>));</span><br></pre></td></tr></table></figure>

<h2 id="computeIfAbsent-方法"><a href="#computeIfAbsent-方法" class="headerlink" title="computeIfAbsent 方法"></a>computeIfAbsent 方法</h2><p>如果指定的 key 不存在，则通过指定的 <code>K -&gt; V</code> 计算出新的值设置为 key 的值，类似代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (map.get(key) == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">V</span> <span class="variable">newValue</span> <span class="operator">=</span> mappingFunction.apply(key);</span><br><span class="line">    <span class="keyword">if</span> (newValue != <span class="literal">null</span>)</span><br><span class="line">        map.put(key, newValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">map.computeIfAbsent(<span class="number">1</span>, key -&gt; key + <span class="string">&quot; computed&quot;</span>);</span><br><span class="line"><span class="comment">// 存在key为1，则不进行计算，输出值 a</span></span><br><span class="line">System.out.println(map.get(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">map.computeIfAbsent(<span class="number">4</span>, key -&gt; key + <span class="string">&quot; computed&quot;</span>);</span><br><span class="line"><span class="comment">// 不存在key为4，则进行计算，输出值 4 computed</span></span><br><span class="line">System.out.println(map.get(<span class="number">4</span>));</span><br></pre></td></tr></table></figure>

<h2 id="computeIfPresent-方法"><a href="#computeIfPresent-方法" class="headerlink" title="computeIfPresent 方法"></a>computeIfPresent 方法</h2><p>如果指定的 key 存在，则根据旧的 key 和 value 计算新的值 newValue, 如果 newValue 不为 null，则设置 key 新的值为 newValue, 如果 newValue 为 null, 则删除该 key 的值，类似代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (map.get(key) != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">    <span class="type">V</span> <span class="variable">newValue</span> <span class="operator">=</span> remappingFunction.apply(key, oldValue);</span><br><span class="line">    <span class="keyword">if</span> (newValue != <span class="literal">null</span>)</span><br><span class="line">        map.put(key, newValue);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        map.remove(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">map.computeIfPresent(<span class="number">1</span>, (key, value) -&gt; (key + <span class="number">1</span>) + value);</span><br><span class="line"><span class="comment">// 存在key为1， 则根据旧的key和value计算新的值，输出 2a</span></span><br><span class="line">System.out.println(map.get(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">map.computeIfPresent(<span class="number">2</span>, (key, value) -&gt; <span class="literal">null</span>);</span><br><span class="line"><span class="comment">// 存在key为2， 根据旧的key和value计算得到null，删除该值，输出 null</span></span><br><span class="line">System.out.println(map.get(<span class="number">2</span>));</span><br></pre></td></tr></table></figure>

<h2 id="compute-方法"><a href="#compute-方法" class="headerlink" title="compute 方法"></a>compute 方法</h2><p>compute 方法是 computeIfAbsent 与 computeIfPresent 的综合体。</p>
<h2 id="merge-方法"><a href="#merge-方法" class="headerlink" title="merge 方法"></a>merge 方法</h2><p>构造</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">merge(K key, V value, BiFunction&lt;? <span class="built_in">super</span> V, ? <span class="built_in">super</span> V, ? <span class="keyword">extends</span> <span class="title class_">V</span>&gt; remappingFunction)</span><br></pre></td></tr></table></figure>

<p>如果指定的 key 不存在，则设置指定的 value 值，否则根据 key 的旧的值 oldvalue，value 计算出新的值 newValue, 如果 newValue 为 null, 则删除该 key，否则设置 key 的新值 newValue。类似如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> map.get(key);</span><br><span class="line"><span class="type">V</span> <span class="variable">newValue</span> <span class="operator">=</span> (oldValue == <span class="literal">null</span>) ? value :</span><br><span class="line">        remappingFunction.apply(oldValue, value);</span><br><span class="line"><span class="keyword">if</span> (newValue == <span class="literal">null</span>)</span><br><span class="line">    map.remove(key);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    map.put(key, newValue);</span><br></pre></td></tr></table></figure>

<p>示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 存在key为1， 输出 a merge</span></span><br><span class="line">System.out.println(map.merge(<span class="number">1</span>, <span class="string">&quot; merge&quot;</span>, (oldValue, newValue) -&gt; oldValue + newValue));</span><br><span class="line"><span class="comment">// 新值为null，删除key，输出 null</span></span><br><span class="line">System.out.println(map.merge(<span class="number">1</span>, <span class="string">&quot; merge&quot;</span>, (oldValue, newValue) -&gt; <span class="literal">null</span>));</span><br><span class="line"><span class="comment">// 输出 &quot; merge&quot;</span></span><br><span class="line">System.out.println(map.merge(<span class="number">4</span>, <span class="string">&quot; merge&quot;</span>, (oldValue, newValue) -&gt; oldValue + newValue));</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 注解之 @ConditionalOnProperty</title>
    <url>/302ec220-debd-11ee-bdc4-19fdf0ccb3e7/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、使用情景"><a href="#1、使用情景" class="headerlink" title="1、使用情景"></a>1、使用情景</h2><p>1）根据配置属性有条件地创建 Bean</p>
<p>2）可以用在类及方法上：标有 <code>@Configuration</code> 的类以及标有 <code>@Bean</code> 的方法</p>
<p>3）当属性满足时才会使标有该注解的类或方法生效</p>
<h2 id="2、使用详情"><a href="#2、使用详情" class="headerlink" title="2、使用详情"></a>2、使用详情</h2><table>
<thead>
<tr>
<th>序号</th>
<th>配置项</th>
<th>having</th>
<th>是否创建 Bean</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>config-test.property.action: true</td>
<td>havingValue&#x3D;”true”</td>
<td>创建</td>
</tr>
<tr>
<td>2</td>
<td>config-test.property.action: false</td>
<td>havingValue&#x3D;”false”</td>
<td>创建</td>
</tr>
<tr>
<td>3</td>
<td>config-test.property.action: enable</td>
<td>havingValue&#x3D;”enable”</td>
<td>创建</td>
</tr>
<tr>
<td>4</td>
<td>config-test.property.action: no</td>
<td>havingValue&#x3D;”enable”</td>
<td><strong>不创建</strong></td>
</tr>
<tr>
<td>5</td>
<td>config-test.property.action: true</td>
<td>不配置</td>
<td>创建</td>
</tr>
<tr>
<td>6</td>
<td>config-test.property.action: false</td>
<td>不配置</td>
<td><strong>不创建</strong></td>
</tr>
<tr>
<td>7</td>
<td>config-test.property.action: enable</td>
<td>不配置</td>
<td>创建</td>
</tr>
<tr>
<td>8</td>
<td>config-test.property.action: no</td>
<td>不配置</td>
<td>创建</td>
</tr>
</tbody></table>
<h2 id="3、案例"><a href="#3、案例" class="headerlink" title="3、案例"></a>3、案例</h2><p>1）创建一个 Cake 类，getKind 方法返回当前蛋糕的口味：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Cake</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> String kind;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getKind</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> kind;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）创建两个子类 PineappleCake、StrawberryCake，表示不同口味的蛋糕：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PineappleCake</span> <span class="keyword">extends</span> <span class="title class_">Cake</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PineappleCake</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.kind = <span class="string">&quot;PineappleCake&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StrawberryCake</span> <span class="keyword">extends</span> <span class="title class_">Cake</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StrawberryCake</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.kind = <span class="string">&quot;StrawberryCake&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）创建 Config 类，其中使用 <code>@ConditionalOnProperty</code> 注解根据配置文件指定的口味创建相应的 Bean</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;customCake&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(prefix = &quot;cake.property&quot;, name = &quot;kind&quot;, havingValue = &quot;PineappleCake&quot;)</span>-</span><br><span class="line">    <span class="keyword">public</span> Cake <span class="title function_">pineappleCake</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PineappleCake</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;customCake&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(prefix = &quot;cake.property&quot;, name = &quot;kind&quot;, havingValue = &quot;StrawberryCake&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Cake <span class="title function_">strawberryCake</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StrawberryCake</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）单元测试用例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestSpringBootApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ApplicationContextRunner</span> <span class="variable">contextRunner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextRunner</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.contextRunner.withPropertyValues(<span class="string">&quot;cake.property.kind=PineappleCake&quot;</span>)</span><br><span class="line">                .withUserConfiguration(Config.class)</span><br><span class="line">                .run(context -&gt; &#123;</span><br><span class="line">                    assertThat(context).hasBean(<span class="string">&quot;customCake&quot;</span>);</span><br><span class="line">                    <span class="type">Cake</span> <span class="variable">cake</span> <span class="operator">=</span> context.getBean(PineappleCake.class);</span><br><span class="line">                    assertThat(cake.getKind()).isEqualTo(<span class="string">&quot;PineappleCake&quot;</span>);</span><br><span class="line">                    assertThat(context).doesNotHaveBean(<span class="string">&quot;StrawberryCake&quot;</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5）使用案例</p>
<p>配置文件 <code>application.yml</code> 添加如下属性：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">cake:</span></span><br><span class="line">  <span class="attr">property:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">PineappleCake</span></span><br></pre></td></tr></table></figure>

<p>按名称注入，获得的 kind 值与配置文件相同</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestSpringBootApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;customCake&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Cake cake;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads2</span><span class="params">()</span> &#123;</span><br><span class="line">        assertThat(cake.getKind()).isEqualTo(<span class="string">&quot;PineappleCake&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>ThreadPoolExecutor-线程池</title>
    <url>/ef12f512-4937-11ee-861d-b3cf05b530a5/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>


<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">                                        阻塞队列为空</span><br><span class="line">                shutdown()           线程池工作线程数为0</span><br><span class="line">            +--------------&gt; SHUTDOWN ----------------+</span><br><span class="line">            |                                         |              terminated()</span><br><span class="line">RUNNING ----+                                         +----&gt; TIDYING ------------&gt; TERMINATED</span><br><span class="line">            | shutdownNow()          线程池工作线程数为0 |</span><br><span class="line">            +--------------&gt;   STOP   ----------------+</span><br></pre></td></tr></table></figure>

<p>构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                            <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                            <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                            TimeUnit unit,</span></span><br><span class="line"><span class="params">                            BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                            ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                            RejectedExecutionHandler handler)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (corePoolSize &lt; <span class="number">0</span> ||</span><br><span class="line">        maximumPoolSize &lt;= <span class="number">0</span> ||</span><br><span class="line">        maximumPoolSize &lt; corePoolSize ||</span><br><span class="line">        keepAliveTime &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="keyword">if</span> (workQueue == <span class="literal">null</span> || threadFactory == <span class="literal">null</span> || handler == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="built_in">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">    <span class="built_in">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">    <span class="built_in">this</span>.workQueue = workQueue;</span><br><span class="line">    <span class="built_in">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">    <span class="built_in">this</span>.threadFactory = threadFactory;</span><br><span class="line">    <span class="built_in">this</span>.handler = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数解析</p>
<ul>
<li>corePoolSize：核心线程池的大小。创建了线程池后，默认情况下线程池中并没有任何线程，而是等待有任务到来才创建线程去执行任务。当有任务来之后，就会创建一个线程去执行任务，当线程池中的线程数目达到 corePoolSize 后，就会把到达的任务放到缓存队列当中；</li>
<li>maximumPoolSize：线程池最大线程数；</li>
<li>keepAliveTime：表示线程没有任务执行时最多保持多久时间会终止；</li>
<li>unit：参数 keepAliveTime 的时间单位（DAYS、HOURS、MINUTES、SECONDS 等）</li>
<li>workQueue：阻塞队列，用来存储等待执行的任务<ul>
<li>ArrayBlockingQueue，有界队列</li>
<li>LinkedBlockingQueue，无界队列</li>
<li>SynchronousQueue</li>
</ul>
</li>
<li>threadFactory：线程工厂，主要用来创建线程</li>
<li>handler：拒绝处理任务的策略<ul>
<li>AbortPolicy：丢弃任务并抛出 RejectedExecutionException 异常，默认策略</li>
<li>DiscardPolicy：丢弃任务，但不抛出异常</li>
<li>DiscardOldestPolicy：丢弃队列最前面的任务，然后重新尝试执行任务，重复此过程</li>
<li>CallerRunsPolicy：由调用线程处理该任务</li>
</ul>
</li>
</ul>
<h2 id="预定义线程池"><a href="#预定义线程池" class="headerlink" title="预定义线程池"></a>预定义线程池</h2><p><strong>FixedThreadPool</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads,</span><br><span class="line">                                    <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>corePoolSize 与 maximumPoolSize 相等，即其线程全为核心线程，是一个固定大小的线程池，是其优势；</li>
<li>keepAliveTime &#x3D; 0 该参数默认对核心线程无效，而 FixedThreadPool 全部为核心线程；</li>
<li>workQueue 为 LinkedBlockingQueue（无界阻塞队列），队列最大值为 Integer.MAX_VALUE。如果任务提交速度持续大余任务处理速度，会造成队列大量阻塞。因为队列很大，很有可能在拒绝策略前，内存溢出。是其劣势；</li>
<li>FixedThreadPool 的任务执行是无序的；</li>
</ul>
<p>适用场景：可用于 Web 服务瞬时削峰，但需注意长时间持续高峰情况造成的队列阻塞。</p>
<p><strong>CachedThreadPool</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                    <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>corePoolSize &#x3D; 0，maximumPoolSize &#x3D; Integer.MAX_VALUE，即线程数量几乎无限制；</li>
<li>keepAliveTime &#x3D; 60s，线程空闲 60s 后自动结束。</li>
<li>workQueue 为 SynchronousQueue 同步队列，这个队列类似于一个接力棒，入队出队必须同时传递，因为 CachedThreadPool 线程创建无限制，不会有队列等待，所以使用 SynchronousQueue；</li>
</ul>
<p>适用场景：快速处理大量耗时较短的任务，如 Netty 的 NIO 接受请求时，可使用 CachedThreadPool。</p>
<p><strong>SingleThreadExecutor</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span></span><br><span class="line">        (<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里多了一层 FinalizableDelegatedExecutorService 包装，这一层有什么用呢，写个 dome 来解释一下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">fixedExecutorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> (ThreadPoolExecutor) fixedExecutorService;</span><br><span class="line">        System.out.println(threadPoolExecutor.getMaximumPoolSize());</span><br><span class="line">        threadPoolExecutor.setCorePoolSize(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">singleExecutorService</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"><span class="comment">//      运行时异常 java.lang.ClassCastException</span></span><br><span class="line"><span class="comment">//      ThreadPoolExecutor threadPoolExecutor2 = (ThreadPoolExecutor) singleExecutorService;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>对比可以看出，FixedThreadPool 可以向下转型为 ThreadPoolExecutor，并对其线程池进行配置，而 SingleThreadExecutor 被包装后，无法成功向下转型。因此，SingleThreadExecutor 被定以后，无法修改，做到了真正的 Single。</p>
<p><strong>ScheduledThreadPool</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ScheduledExecutorService <span class="title function_">newScheduledThreadPool</span><span class="params">(<span class="type">int</span> corePoolSize)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(corePoolSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>newScheduledThreadPool 调用的是 ScheduledThreadPoolExecutor 的构造方法，而 ScheduledThreadPoolExecutor 继承了 ThreadPoolExecutor，构造是还是调用了其父类的构造方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ScheduledThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(corePoolSize, Integer.MAX_VALUE, <span class="number">0</span>, NANOSECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DelayedWorkQueue</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于 ScheduledThreadPool 本文不做描述，其特性请关注后续篇章。</p>
<h2 id="自定义线程池"><a href="#自定义线程池" class="headerlink" title="自定义线程池"></a>自定义线程池</h2><p>以下是自定义线程池，使用了有界队列，自定义 ThreadFactory 和拒绝策略的 demo</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">corePoolSize</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">maximumPoolSize</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">keepAliveTime</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="type">TimeUnit</span> <span class="variable">unit</span> <span class="operator">=</span> TimeUnit.SECONDS;</span><br><span class="line">        BlockingQueue&lt;Runnable&gt; workQueue = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        <span class="type">ThreadFactory</span> <span class="variable">threadFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NameTreadFactory</span>();</span><br><span class="line">        <span class="type">RejectedExecutionHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyIgnorePolicy</span>();</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit,</span><br><span class="line">                workQueue, threadFactory, handler);</span><br><span class="line">        executor.prestartAllCoreThreads(); <span class="comment">// 预启动所有核心线程</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">MyTask</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyTask</span>(String.valueOf(i));</span><br><span class="line">            executor.execute(task);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.in.read(); <span class="comment">//阻塞主线程</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">NameTreadFactory</span> <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">mThreadNum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;my-thread-&quot;</span> + mThreadNum.getAndIncrement());</span><br><span class="line">            System.out.println(t.getName() + <span class="string">&quot; has been created&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyIgnorePolicy</span> <span class="keyword">implements</span> <span class="title class_">RejectedExecutionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> &#123;</span><br><span class="line">            doLog(r, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doLog</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> &#123;</span><br><span class="line">            <span class="comment">// 可做日志记录等</span></span><br><span class="line">            System.err.println( r.toString() + <span class="string">&quot; rejected&quot;</span>);</span><br><span class="line"><span class="comment">//          System.out.println(&quot;completedTaskCount: &quot; + e.getCompletedTaskCount());</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyTask</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="built_in">this</span>.toString() + <span class="string">&quot; is running!&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>); <span class="comment">//让任务执行慢点</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;MyTask [name=&quot;</span> + name + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">my-thread-1 has been created</span><br><span class="line">my-thread-2 has been created</span><br><span class="line">my-thread-3 has been created</span><br><span class="line">MyTask[name=1]is running!</span><br><span class="line">MyTask[name=2]is running!</span><br><span class="line">my-thread-4 has been created</span><br><span class="line">MyTask[name=3]is running!</span><br><span class="line">MyTask[name=6]is running!</span><br><span class="line">MyTask[name=7]is rejected</span><br><span class="line">MyTask[name=8]is rejected</span><br><span class="line">MyTask[name=9]is rejected</span><br><span class="line">MyTask[name=10]is rejected</span><br><span class="line">MyTask[name=4]is running!</span><br><span class="line">MyTask[name=5]is running!</span><br></pre></td></tr></table></figure>

<p>1，由于线程预启动，首先创建了 1，2 号线程，然后 task1，task2 被执行；<br>2，但任务提交没有结束，此时任务 task3，task6 到达发现核心线程已经满了，进入等待队列；<br>3，等待队列满后创建任务线程 3，4 执行任务 task3，task6，同时 task4，task5 进入队列；<br>4，此时创建线程数（4）等于最大线程数，且队列已满，所以 7，8，9，10 任务被拒绝；<br>5，任务执行完毕后回头来执行 task4，task5，队列清空。</p>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>jackson 2.x 解析 json 案例</title>
    <url>/e37eb230-cd6b-11ee-b21c-118c995770df/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、官方参考"><a href="#1、官方参考" class="headerlink" title="1、官方参考"></a>1、官方参考</h2><ul>
<li>Jackson Home Page:<a href="https://github.com/FasterXML/jackson">https://github.com/FasterXML/jackson</a></li>
<li>Jackson Wiki:<a href="http://wiki.fasterxml.com/JacksonHome">http://wiki.fasterxml.com/JacksonHome</a></li>
<li>Jackson doc: <a href="https://github.com/FasterXML/jackson-docs">https://github.com/FasterXML/jackson-docs</a></li>
<li>Jackson Download Page:<a href="http://wiki.fasterxml.com/JacksonDownload">http://wiki.fasterxml.com/JacksonDownload</a></li>
</ul>
<h2 id="2、简介"><a href="#2、简介" class="headerlink" title="2、简介"></a>2、简介</h2><p>Jackson 有两个主要分支，1.x 处于维护状态，只会发布 bug 修复版本。2.x 还在积极地开发当中。这两个版本的 Java 包名和 Maven artifact 不一样，所以它们不互相兼容，但是可以和平共存，项目可以同时依赖 1.x 和 2.x 而不会发生冲突。</p>
<p>Jackson 1.x（目前版本从 1.1~1.9）与 2.x 版本的依赖从包名可以看出来。1.x 的类库中，包命名以：<code>org.codehaus.jackson.xxx</code> 开头，而 2.x 类库中包命令：<code>com.fastxml.jackson.xxx</code> 开头。</p>
<h2 id="3、主要模块"><a href="#3、主要模块" class="headerlink" title="3、主要模块"></a>3、主要模块</h2><p>1）核心模块</p>
<p>核心模块是扩展模块构建的基础，到 2.7 版本为止，共有 3 个核心模块（依赖关系从上到下）:</p>
<ul>
<li><strong>Streaming</strong> : jackson-core jar，定义了底层的 streaming API 和实现了 Json 特性。</li>
<li><strong>Annotations</strong> : jackson-annotations jar，包含了标准的 Jackson 注解。</li>
<li><strong>Databind</strong> : jackson-databind jar，实现了数据绑定和对象序列化，它依赖于 streaming 和 annotations 的包。</li>
</ul>
<p>2）第三方数据类型模块</p>
<p>这些扩展是插件式的 Jackson 模块，用 <code>ObjectMapper.registerModule()</code> 注册，并且通过添加 serializers 和 deserializers 以便 Databind 包（ObjectMapper &#x2F; ObjectReader &#x2F; ObjectWriter）可以读写这些类型，来增加对各种常用的 Java 库的数据类型的支持。参考：<a href="https://github.com/FasterXML/jacksonThird-party">https://github.com/FasterXML/jacksonThird-party</a> datatype modules。</p>
<p>3）数据格式模块</p>
<p>Jackson 也有处理程序对 JAX-RS 标准实现者例如 Jersey, RESTeasy, CXF 等提供了数据格式支持。处理程序实现了 MessageBodyReader 和 MessageBodyWriter，目前支持的数据格式包括 JSON, Smile, XML, YAML 和 CBOR。</p>
<p>数据格式提供了除了 Json 之外的数据格式支持，它们绝大部分仅仅实现了 streaming API abstractions，以便数据绑定组件可以按照原来的方式使用。另一些（几乎不需要）提供了 databind 标准功能来处理例如 schemas。参考<a href="https://github.com/FasterXML/jacksonData">https://github.com/FasterXML/jacksonData</a> format modules</p>
<p>4）jackon 的三个核心类库</p>
<p>maven 依赖:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="4、处理-Json"><a href="#4、处理-Json" class="headerlink" title="4、处理 Json"></a>4、处理 Json</h2><p>Jackson 提供了三种可选的 Json 处理方法：流式 API（Streaming API）、树模型（Tree Model）、数据绑定（Data Binding）。三种处理 Json 的方式的特性：</p>
<ul>
<li>Streaming API：是效率最高的处理方式（开销低、读写速度快，但程序编写复杂度高）</li>
<li>Tree Model：是最灵活的处理方式</li>
<li>Data Binding：是最常用的处理方式</li>
</ul>
<p>1）Data Binding</p>
<ul>
<li>主要使用 ObjectMapper 来操作 Json，默认情况下会使用 BeanSerializer 来序列化 POJO。</li>
<li>如果是解析，那么如下的例子里的 TestJson 必须要有 setters，且 setters 必须是 public 修饰的，否则属性的值将会为 null。</li>
<li>如果是生成，那么必须有 getters，且 getters 必须是 public 修饰的。</li>
<li>如果属性不是 private 修饰，那么可以不用有 getters 和 setters。</li>
</ul>
<p>要点：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">mapper.writeValue(jsonFile, Bean);</span><br><span class="line">mapper.readValue(jsonFile, Bean.class 或 Collection&lt;Bean&gt;);</span><br></pre></td></tr></table></figure>

<p>1）生成 json</p>
<p>city.java 文件：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.myjackson.databinding;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">City</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String cityName;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">City</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCityName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cityName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCityName</span><span class="params">(String cityName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cityName = cityName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>province.java 文件：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.myjackson.databinding;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Province</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Date birthDate;</span><br><span class="line">    <span class="keyword">private</span> List&lt;City&gt; cities;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Province</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;City&gt; <span class="title function_">getCities</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cities;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCities</span><span class="params">(List&lt;City&gt; cities)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cities = cities;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getBirthDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> birthDate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBirthDate</span><span class="params">(Date birthDate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.birthDate = birthDate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>country.java 文件：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.myjackson.databinding;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Country</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String countryName;</span><br><span class="line">    <span class="keyword">private</span> Date establishTime;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Province&gt; provinces;</span><br><span class="line">    <span class="keyword">private</span> String[] lakes;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; forest = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Country</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCountryName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> countryName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCountryName</span><span class="params">(String countryName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.countryName = countryName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getEstablishTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> establishTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEstablishTime</span><span class="params">(Date establishTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.establishTime = establishTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Province&gt; <span class="title function_">getProvinces</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> provinces;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProvinces</span><span class="params">(List&lt;Province&gt; provinces)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.provinces = provinces;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String[] getLakes() &#123;</span><br><span class="line">        <span class="keyword">return</span> lakes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLakes</span><span class="params">(String[] lakes)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lakes = lakes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getForest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> forest;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setForest</span><span class="params">(Map&lt;String, String&gt; forest)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.forest = forest;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试案例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Bean2JsonStr</span><span class="params">()</span> <span class="keyword">throws</span> ParseException, JsonGenerationException, JsonMappingException, IOException&#123;</span><br><span class="line">    <span class="comment">// 使用 ObjectMapper 转化对象为 Json</span></span><br><span class="line">    <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    <span class="type">SimpleDateFormat</span> <span class="variable">dateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">    mapper.setDateFormat(dateFormat); <span class="comment">//设置日期序列化格式</span></span><br><span class="line">    <span class="type">City</span> <span class="variable">city1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">City</span>();</span><br><span class="line">    city1.setId(<span class="number">1</span>);</span><br><span class="line">    city1.setCityName(<span class="string">&quot;gz&quot;</span>);</span><br><span class="line">    <span class="type">City</span> <span class="variable">city2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">City</span>();</span><br><span class="line">    city2.setId(<span class="number">2</span>);</span><br><span class="line">    city2.setCityName(<span class="string">&quot;dg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Province</span> <span class="variable">province</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Province</span>();</span><br><span class="line">    province.setId(<span class="number">1</span>);</span><br><span class="line">    province.setName(<span class="string">&quot;GD&quot;</span>);</span><br><span class="line">    province.setBirthDate(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    List&lt;City&gt; cities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;City&gt;();</span><br><span class="line">    cities.add(city1);</span><br><span class="line">    cities.add(city2);</span><br><span class="line">    province.setCities(cities);</span><br><span class="line"></span><br><span class="line">    <span class="type">Country</span> <span class="variable">country</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Country</span>();</span><br><span class="line">    country.setCountryName(<span class="string">&quot;China&quot;</span>);</span><br><span class="line">    country.setId(<span class="number">1</span>);</span><br><span class="line">    country.setEstablishTime(dateFormat.parse(<span class="string">&quot;1949-10-01&quot;</span>));</span><br><span class="line">    country.setLakes(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;Qinghai Lake&quot;</span>, <span class="string">&quot;Poyang Lake&quot;</span>,<span class="string">&quot;Dongting Lake&quot;</span>, <span class="string">&quot;Taihu Lake&quot;</span> &#125;);</span><br><span class="line">    HashMap&lt;String, String&gt; forest = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">    forest.put(<span class="string">&quot;no.1&quot;</span>, <span class="string">&quot;dxal&quot;</span>);</span><br><span class="line">    forest.put(<span class="string">&quot;no.2&quot;</span>, <span class="string">&quot;xxal&quot;</span>);</span><br><span class="line">    country.setForest(forest);</span><br><span class="line">    List&lt;Province&gt; provinces = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Province&gt;();</span><br><span class="line">    provinces.add(province);</span><br><span class="line">    country.setProvinces(provinces);</span><br><span class="line">    mapper.configure(SerializationFeature.INDENT_OUTPUT, <span class="literal">true</span>);     <span class="comment">// 为了使JSON视觉上的可读性，在生产中不需如此，会增大Json的内容</span></span><br><span class="line">    mapper.setSerializationInclusion(Include.NON_EMPTY);  <span class="comment">// 配置mapper忽略空属性</span></span><br><span class="line">    mapper.writeValue(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;country.json&quot;</span>), country);  <span class="comment">// 默认情况，Jackson使用Java属性字段名称作为 Json的属性名称,也可以使用Jackson annotations(注解)改变Json属性名称</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行得到 country.json：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;countryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;China&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;establishTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1949-10-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;provinces&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GD&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;birthDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2017-02-04&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;cityName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gz&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;cityName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dg&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lakes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;Qinghai Lake&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Poyang Lake&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Dongting Lake&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Taihu Lake&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;forest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;no.1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dxal&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;no.2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxal&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>2）解析 json</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">JsonStr2Bean</span><span class="params">()</span> <span class="keyword">throws</span> JsonParseException, JsonMappingException, IOException&#123;</span><br><span class="line">    <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    <span class="type">File</span> <span class="variable">jsonFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;country.json&quot;</span>);</span><br><span class="line">    <span class="comment">//当反序列化 json 时，未知属性会引起的反序列化被打断，这里我们禁用未知属性打断反序列化功能，</span></span><br><span class="line">    <span class="comment">//因为，例如 json 里有 10 个属性，而我们的 bean 中只定义了 2 个属性，其它 8 个属性将被忽略</span></span><br><span class="line">    mapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);</span><br><span class="line">    <span class="type">Country</span> <span class="variable">country</span> <span class="operator">=</span> mapper.readValue(jsonFile, Country.class);</span><br><span class="line">    System.out.println(country.getCountryName()+country.getEstablishTime());</span><br><span class="line">    List&lt;Province&gt; provinces = country.getProvinces();</span><br><span class="line">    <span class="keyword">for</span> (Province province : provinces) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;province:&quot;</span>+province.getName() + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;birthDate:&quot;</span>+province.getBirthDate());</span><br><span class="line">        <span class="keyword">for</span> (City city: province.getCities()) &#123;</span><br><span class="line">            System.out.println(city.getId()+<span class="string">&quot; &quot;</span>+city.getCityName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ChinaSat Oct 01 08:00:00 CST 1949</span><br><span class="line">province:GD</span><br><span class="line">getBirthDate:Sat Feb 04 08:00:00 CST 2017</span><br><span class="line">1 gz</span><br><span class="line">2 dg</span><br></pre></td></tr></table></figure>

<p>解析的时候如果碰到集合类，那么可以使用 TypeReference 类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">JsonStr2List</span><span class="params">()</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="type">City</span> <span class="variable">city1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">City</span>();</span><br><span class="line">    city1.setId(<span class="number">1</span>);</span><br><span class="line">    city1.setCityName(<span class="string">&quot;gz&quot;</span>);</span><br><span class="line">    <span class="type">City</span> <span class="variable">city2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">City</span>();</span><br><span class="line">    city2.setId(<span class="number">2</span>);</span><br><span class="line">    city2.setCityName(<span class="string">&quot;dg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    List&lt;City&gt; cities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;City&gt;();</span><br><span class="line">    cities.add(city1);</span><br><span class="line">    cities.add(city2);</span><br><span class="line"></span><br><span class="line">    <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">listJsonStr</span> <span class="operator">=</span> mapper.writeValueAsString(cities);</span><br><span class="line">    System.out.println(listJsonStr);</span><br><span class="line">    List&lt;City&gt; list = mapper.readValue(listJsonStr, <span class="keyword">new</span>  <span class="title class_">TypeReference</span>&lt;List&lt;City&gt;&gt;()&#123;&#125; );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (City city: list) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;id:&quot;</span>+city.getId()+<span class="string">&quot; cityName:&quot;</span>+city.getCityName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）Streaming API</p>
<p>Jackson 提供了一套底层 API 来解析 Json 字符串，这个 API 为每个 Json 对象提供了符号。例如， ‘{’ 是解析器提供的第一个对象（writeStartObject()），键值对是解析器提供的另一个单独对象（writeString(key,value)）。这些 API 很强大，但是需要大量的代码。大多数情况下，Tree Model 和 Data Binding 可以代替 Streaming API。</p>
<p>上面代码如果注释掉 city1.setId(1);这行，结果为：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[&#123;<span class="string">&quot;id&quot;</span>:null,<span class="string">&quot;cityName&quot;</span>:<span class="string">&quot;gz&quot;</span>&#125;,&#123;<span class="string">&quot;id&quot;</span>:2,<span class="string">&quot;cityName&quot;</span>:<span class="string">&quot;dg&quot;</span>&#125;]</span><br><span class="line"><span class="built_in">id</span>:null cityName:gz</span><br><span class="line"><span class="built_in">id</span>:2 cityName:dg</span><br></pre></td></tr></table></figure>

<p>但假如想让 id 为 null 的不输出，不为 null 的输出除了 mapper.setSerializationInclusion(Include.NON_EMPTY); &#x2F;&#x2F; 配置 mapper 忽略空属性 这种方法外还可以在 ObjectMapper 中注册一个自定义的序列化 JsonSerializer 和反序列化<br>JsonDeSerializer:</p>
<p>CityJsonSerializer.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.myjackson.databinding;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonGenerator;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonSerializer;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializerProvider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CityJsonSerializer</span> <span class="keyword">extends</span> <span class="title class_">JsonSerializer</span>&lt;City&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(City city, JsonGenerator jsonGenerator, SerializerProvider arg2)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException, JsonProcessingException &#123;</span><br><span class="line">         jsonGenerator.writeStartObject();</span><br><span class="line">         <span class="keyword">if</span> ( city.getId()!=<span class="literal">null</span>) &#123;</span><br><span class="line">             jsonGenerator.writeNumberField(<span class="string">&quot;id&quot;</span>, city.getId());</span><br><span class="line">         &#125;</span><br><span class="line">         jsonGenerator.writeStringField(<span class="string">&quot;cityName&quot;</span>, city.getCityName());</span><br><span class="line">         jsonGenerator.writeEndObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CityJsonDeSerializer.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.myjackson.databinding;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonParser;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonToken;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.DeserializationContext;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CityJsonDeSerializer</span> <span class="keyword">extends</span> <span class="title class_">JsonDeserializer</span>&lt;List&lt;City&gt;&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;City&gt; <span class="title function_">deserialize</span><span class="params">(JsonParser parser,DeserializationContext deserializationcontext)</span> <span class="keyword">throws</span> IOException,</span><br><span class="line">            JsonProcessingException &#123;</span><br><span class="line">        List&lt;City&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;City&gt;();</span><br><span class="line">        <span class="comment">// 开始解析数组，第一个JsonToken必须是JsonToken.START_ARRAY&quot;[&quot;</span></span><br><span class="line">         <span class="keyword">if</span> (!JsonToken.START_ARRAY.equals(parser.getCurrentToken())) &#123;</span><br><span class="line">             System.out.println(parser.getCurrentToken());</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="comment">// 解析符号直到字符串结尾</span></span><br><span class="line">        <span class="keyword">while</span> (!parser.isClosed()) &#123;</span><br><span class="line">            <span class="comment">// 如果有必要的话，这个方法会沿着流前进直到足以确下一个JsonToken的类型</span></span><br><span class="line">            <span class="type">JsonToken</span> <span class="variable">token</span> <span class="operator">=</span> parser.nextToken();</span><br><span class="line">            <span class="comment">// 如果是最后一个JsonToken，那么就结束了</span></span><br><span class="line">            <span class="keyword">if</span> (token == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 数组的每个元素都是对象，因此下一个JsonToken是JsonToken.START_OBJECT&quot;&#123;&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (!JsonToken.START_OBJECT.equals(token)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">City</span> <span class="variable">city</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// 输出id字段的值</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (JsonToken.START_OBJECT.equals(token)) &#123;</span><br><span class="line">                    city = <span class="keyword">new</span> <span class="title class_">City</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                token = parser.nextToken();</span><br><span class="line">                <span class="keyword">if</span> (token == <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (JsonToken.FIELD_NAME.equals(token) ) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(<span class="string">&quot;id&quot;</span>.equals(parser.getCurrentName()))&#123;</span><br><span class="line">                        token = parser.nextToken();</span><br><span class="line">                        city.setId(parser.getIntValue());</span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;cityName&quot;</span>.equals(parser.getCurrentName()))&#123;</span><br><span class="line">                        token = parser.nextToken();</span><br><span class="line">                        city.setCityName(parser.getText());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(JsonToken.END_OBJECT.equals(token))&#123;</span><br><span class="line">                    list.add(city);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">StreamJsonStr2List</span><span class="params">()</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="type">City</span> <span class="variable">city1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">City</span>();</span><br><span class="line">    <span class="comment">//city1.setId(1);</span></span><br><span class="line">    city1.setCityName(<span class="string">&quot;gz&quot;</span>);</span><br><span class="line">    <span class="type">City</span> <span class="variable">city2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">City</span>();</span><br><span class="line">    city2.setId(<span class="number">2</span>);</span><br><span class="line">    city2.setCityName(<span class="string">&quot;dg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    List&lt;City&gt; cities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;City&gt;();</span><br><span class="line">    cities.add(city1);</span><br><span class="line">    cities.add(city2);</span><br><span class="line"></span><br><span class="line">    <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    <span class="type">SimpleModule</span> <span class="variable">module</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleModule</span>();</span><br><span class="line">    <span class="keyword">module</span>.addSerializer(City.class, <span class="keyword">new</span> <span class="title class_">CityJsonSerializer</span>());</span><br><span class="line">    mapper.registerModule(<span class="keyword">module</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">listJsonStr</span> <span class="operator">=</span> mapper.writeValueAsString(cities);</span><br><span class="line"></span><br><span class="line">    System.out.println(listJsonStr);</span><br><span class="line"></span><br><span class="line">    <span class="type">ObjectMapper</span> <span class="variable">mapper2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    <span class="type">SimpleModule</span> <span class="variable">module2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleModule</span>();</span><br><span class="line">    module2.addDeserializer(List.class, <span class="keyword">new</span> <span class="title class_">CityJsonDeSerializer</span>());</span><br><span class="line">    mapper2.registerModule(module2);</span><br><span class="line">    List&lt;City&gt; list = mapper2.readValue(listJsonStr, <span class="keyword">new</span>  <span class="title class_">TypeReference</span>&lt;List&lt;City&gt;&gt;()&#123;&#125; );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (City city: list) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;id:&quot;</span>+city.getId()+<span class="string">&quot; cityName:&quot;</span>+city.getCityName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以简单一点，使用注解，省去在 ObjectMapper 中注册 SimpleModule</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.annotation.JsonSerialize;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JsonSerialize(using=CityJsonSerializer.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">City</span> &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[&#123;<span class="string">&quot;cityName&quot;</span>:<span class="string">&quot;gz&quot;</span>&#125;,&#123;<span class="string">&quot;id&quot;</span>:2,<span class="string">&quot;cityName&quot;</span>:<span class="string">&quot;dg&quot;</span>&#125;]</span><br><span class="line"><span class="built_in">id</span>:null cityName:gz</span><br><span class="line"><span class="built_in">id</span>:2 cityName:dg</span><br></pre></td></tr></table></figure>

<p>3）Tree Mode</p>
<p>如果不想为 Json 结构写一个 class 的话，Tree Mode 是一个很好的选择。</p>
<p>生成 json:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">TreeMode2Json</span><span class="params">()</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建一个节点工厂,为我们提供所有节点</span></span><br><span class="line">        <span class="type">JsonNodeFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonNodeFactory</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//创建一个json factory来写tree modle为json</span></span><br><span class="line">        <span class="type">JsonFactory</span> <span class="variable">jsonFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonFactory</span>();</span><br><span class="line">        <span class="comment">//创建一个json生成器</span></span><br><span class="line">        <span class="type">JsonGenerator</span> <span class="variable">generator</span> <span class="operator">=</span> jsonFactory.createGenerator(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;country2.json&quot;</span>)));</span><br><span class="line">        <span class="comment">//注意，默认情况下对象映射器不会指定根节点，下面设根节点为country</span></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="type">ObjectNode</span> <span class="variable">country</span> <span class="operator">=</span> factory.objectNode();</span><br><span class="line">        country.put(<span class="string">&quot;id&quot;</span>,   <span class="number">1</span>);</span><br><span class="line">        country.put(<span class="string">&quot;countryName&quot;</span>,<span class="string">&quot;China&quot;</span>);</span><br><span class="line">        country.put(<span class="string">&quot;establishTime&quot;</span>, <span class="string">&quot;1949-10-01&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ArrayNode</span> <span class="variable">provinces</span> <span class="operator">=</span> factory.arrayNode();</span><br><span class="line">        <span class="type">ObjectNode</span> <span class="variable">province</span> <span class="operator">=</span> factory.objectNode();</span><br><span class="line">        <span class="type">ObjectNode</span> <span class="variable">city1</span> <span class="operator">=</span> factory.objectNode();</span><br><span class="line">        city1.put(<span class="string">&quot;id&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        city1.put(<span class="string">&quot;cityName&quot;</span>, <span class="string">&quot;gz&quot;</span>);</span><br><span class="line">        <span class="type">ObjectNode</span> <span class="variable">city2</span> <span class="operator">=</span> factory.objectNode();</span><br><span class="line">        city2.put(<span class="string">&quot;id&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        city2.put(<span class="string">&quot;cityName&quot;</span>, <span class="string">&quot;dg&quot;</span>);</span><br><span class="line">        <span class="type">ArrayNode</span> <span class="variable">cities</span> <span class="operator">=</span> factory.arrayNode();</span><br><span class="line">        cities.add(city1).add(city2);</span><br><span class="line">        province.put(<span class="string">&quot;cities&quot;</span>, cities);</span><br><span class="line">        provinces.add(province);</span><br><span class="line">        country.put(<span class="string">&quot;provinces&quot;</span>,provinces);</span><br><span class="line"></span><br><span class="line">        <span class="type">ArrayNode</span> <span class="variable">lakes</span> <span class="operator">=</span> factory.arrayNode();</span><br><span class="line">        lakes.add(<span class="string">&quot;QingHai Lake&quot;</span>).add(<span class="string">&quot;Poyang Lake&quot;</span>).add(<span class="string">&quot;Dongting Lake&quot;</span>).add(<span class="string">&quot;Taihu Lake&quot;</span>);</span><br><span class="line">        country.put(<span class="string">&quot;lakes&quot;</span>,lakes);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectNode</span> <span class="variable">forest</span> <span class="operator">=</span> factory.objectNode();</span><br><span class="line">        forest.put(<span class="string">&quot;no.1&quot;</span>,<span class="string">&quot;dxal&quot;</span>);</span><br><span class="line">        forest.put(<span class="string">&quot;no.2&quot;</span>, <span class="string">&quot;xxal&quot;</span>);</span><br><span class="line">        country.put(<span class="string">&quot;forest&quot;</span>, forest);</span><br><span class="line"></span><br><span class="line">        mapper.setSerializationInclusion(Include.NON_EMPTY);  <span class="comment">// 配置mapper忽略空属性</span></span><br><span class="line">        mapper.writeTree(generator, country);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;countryName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;China&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;establishTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1949-10-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;provinces&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;cities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;cityName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gz&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;cityName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dg&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lakes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;QingHai Lake&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Poyang Lake&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Dongting Lake&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Taihu Lake&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;forest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;no.1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dxal&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;no.2&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xxal&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>读取 json:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">TreeModeReadJson</span><span class="params">()</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">    <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    <span class="comment">// Jackson 提供一个树节点被称为&quot;JsonNode&quot;,ObjectMapper 提供方法来读 json 作为树的 JsonNode 根节点</span></span><br><span class="line">    <span class="type">JsonNode</span> <span class="variable">node</span> <span class="operator">=</span> mapper.readTree(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;country2.json&quot;</span>));</span><br><span class="line">    <span class="comment">// 看看根节点的类型</span></span><br><span class="line">    System.out.println(<span class="string">&quot;node JsonNodeType:&quot;</span>+node.getNodeType());</span><br><span class="line">    System.out.println(<span class="string">&quot;---------得到所有 node 节点的子节点名称----------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Iterator&lt;String&gt; fieldNames = node.fieldNames();</span><br><span class="line">    <span class="keyword">while</span> (fieldNames.hasNext()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fieldName</span> <span class="operator">=</span> fieldNames.next();</span><br><span class="line">        System.out.print(fieldName+<span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;\n---------------------------------------------------&quot;</span>);</span><br><span class="line">    <span class="type">JsonNode</span> <span class="variable">lakes</span> <span class="operator">=</span> node.get(<span class="string">&quot;lakes&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;lakes:&quot;</span>+lakes+<span class="string">&quot; JsonNodeType:&quot;</span>+lakes.getNodeType());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">node JsonNodeType:OBJECT</span><br><span class="line">---------得到所有 node 节点的子节点名称-------------------------</span><br><span class="line">id countryName establishTime provinces lakes forest</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">lakes:[<span class="string">&quot;QingHai Lake&quot;</span>,<span class="string">&quot;Poyang Lake&quot;</span>,<span class="string">&quot;Dongting Lake&quot;</span>,<span class="string">&quot;Taihu Lake&quot;</span>] JsonNodeType:ARRAY</span><br></pre></td></tr></table></figure>

<h2 id="5、结束"><a href="#5、结束" class="headerlink" title="5、结束"></a>5、结束</h2><p>Stream API 方式是开销最低、效率最高，但编写代码复杂度也最高，在生成 Json 时，需要逐步编写符号和字段拼接 json,在解析 Json 时，需要根据 token 指向也查找 json 值，生成和解析 json 都不是很方便，代码可读性也很低。<br>Databinding 处理 Json 是最常用的 json 处理方式，生成 json 时，创建相关的 java 对象，并根据 json 内容结构把 java 对象组装起来，最后调用 writeValue 方法即可生成 json,<br>解析时，就更简单了，直接把 json 映射到相关的 java 对象，然后就可以遍历 java 对象来获取值了。</p>
<p>TreeModel 处理 Json，是以树型结构来生成和解析 json，生成 json 时，根据 json 内容结构，我们创建不同类型的节点对象，组装这些节点生成 json。解析 json 时，它不需要绑定 json 到 java bean，根据 json 结构，使用 path 或 get 方法轻松查找内容。</p>
<h2 id="6、解析-Json"><a href="#6、解析-Json" class="headerlink" title="6、解析 Json"></a>6、解析 Json</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.TimeZone;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonNode;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParseJsonTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;type\&quot;:2,\&quot;range\&quot;:1,\&quot;start\&quot;:1368417600,\&quot;end\&quot;:1368547140,&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;cityName\&quot;:\&quot;天津\&quot;,\&quot;companyIds\&quot;:[\&quot;12000001\&quot;],\&quot;companyNames\&quot;:[\&quot;天津\&quot;],&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;12000001\&quot;:&#123;\&quot;data\&quot;:[47947,48328,48573,48520],&quot;</span></span><br><span class="line">                + <span class="string">&quot;\&quot;timestamps\&quot;:[1368417600,1368417900,1368418200,1368418500]&#125;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">data2</span> <span class="operator">=</span> parseJson(data);</span><br><span class="line">        System.out.println(data2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">parseJson</span><span class="params">(String data)</span> &#123;</span><br><span class="line">        <span class="comment">// 用来展现解析Json得到的值</span></span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">buf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="type">JsonNode</span> <span class="variable">rootNode</span> <span class="operator">=</span> mapper.readTree(data); <span class="comment">// 读取Json</span></span><br><span class="line">        <span class="comment">// rootNode.path(&quot;xx&quot;)返回的还是一个JsonNode对象，调用该JsonNode的相应方法，得到键对应的值</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">type</span> <span class="operator">=</span> rootNode.path(<span class="string">&quot;type&quot;</span>).asInt();</span><br><span class="line">        <span class="type">int</span> <span class="variable">range</span> <span class="operator">=</span> rootNode.path(<span class="string">&quot;range&quot;</span>).asInt();</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> rootNode.path(<span class="string">&quot;start&quot;</span>).asLong();</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> rootNode.path(<span class="string">&quot;end&quot;</span>).asLong();</span><br><span class="line">        <span class="type">String</span> <span class="variable">cityName</span> <span class="operator">=</span> rootNode.path(<span class="string">&quot;cityName&quot;</span>).asText();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 转换时间格式</span></span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyyMMddHHmm&quot;</span>);</span><br><span class="line">        sdf.setTimeZone(TimeZone.getTimeZone(<span class="string">&quot;GMT+8&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;类型(type):&quot;</span> + type + <span class="string">&quot;\r\n&quot;</span> + <span class="string">&quot;范围(range):&quot;</span> + range</span><br><span class="line">                + <span class="string">&quot;\r\n&quot;</span> + <span class="string">&quot;开始时间(start):&quot;</span></span><br><span class="line">                + sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>(start * <span class="number">1000</span>)) + <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">                + <span class="string">&quot;结束时间(end):&quot;</span> + sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>(end * <span class="number">1000</span>)) + <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">                + <span class="string">&quot;城市名称(cityName):&quot;</span> + cityName;</span><br><span class="line">        buf.append(str);</span><br><span class="line">        <span class="comment">// 得到companyIds的JsonNode对象</span></span><br><span class="line">        <span class="type">JsonNode</span> <span class="variable">companyIds</span> <span class="operator">=</span> rootNode.path(<span class="string">&quot;companyIds&quot;</span>);</span><br><span class="line">        <span class="type">JsonNode</span> <span class="variable">companyNames</span> <span class="operator">=</span> rootNode.path(<span class="string">&quot;companyNames&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历companyIds中的内容</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; companyIds.size(); i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">companyId</span> <span class="operator">=</span> companyIds.get(i).asText();</span><br><span class="line">            <span class="comment">// 本例解析的Json字符串中companyIds与companyNames的长度是相同的，所有直接遍历companyNames</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">companyName</span> <span class="operator">=</span> companyNames.get(i).asText();</span><br><span class="line">            <span class="comment">// companyId的值：12000001，对应Json串中的</span></span><br><span class="line">            <span class="comment">// &quot;12000001&quot;:&#123;&quot;data&quot;:[...],&quot;timestamps&quot;:[....]&#125;</span></span><br><span class="line">            <span class="type">JsonNode</span> <span class="variable">infoNode</span> <span class="operator">=</span> rootNode.path(companyId);</span><br><span class="line">            <span class="comment">// 得到&quot;12000001&quot;:&#123;&quot;data&quot;:[...],&quot;timestamps&quot;:[....]&#125;中的data和timestamps的JsonNode对象</span></span><br><span class="line">            <span class="type">JsonNode</span> <span class="variable">dataNode</span> <span class="operator">=</span> infoNode.path(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">            <span class="type">JsonNode</span> <span class="variable">timestampsNode</span> <span class="operator">=</span> infoNode.path(<span class="string">&quot;timestamps&quot;</span>);</span><br><span class="line">            <span class="comment">// 遍历data和timestamps 本例中data.size与timestamps.size是相等的</span></span><br><span class="line"></span><br><span class="line">            buf.append(<span class="string">&quot;\r\n&#123;\r\n  公司ID(companyId):&quot;</span> + companyId</span><br><span class="line">                    + <span class="string">&quot;\r\n  公司名称(companyName):&quot;</span> + companyName + <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">                    + <span class="string">&quot; data:&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; dataNode.size(); j++) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">dataValue</span> <span class="operator">=</span> dataNode.get(j).asLong();</span><br><span class="line">                buf.append(dataValue + <span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            buf.append(<span class="string">&quot;\r\n time:&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; timestampsNode.size(); k++) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">timeValue</span> <span class="operator">=</span> timestampsNode.get(k).asLong();</span><br><span class="line">                buf.append(sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>(timeValue * <span class="number">1000</span>)) + <span class="string">&quot;,&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            buf.append(<span class="string">&quot;\r\n&#125;\r\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buf.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">类型(<span class="built_in">type</span>):2</span><br><span class="line">范围(range):1</span><br><span class="line">开始时间(start):201305131200</span><br><span class="line">结束时间(end):201305142359</span><br><span class="line">城市名称(cityName):天津</span><br><span class="line">&#123;</span><br><span class="line">  公司ID(companyId):12000001</span><br><span class="line">  公司名称(companyName):天津</span><br><span class="line">  data:47947,48328,48573,48520,</span><br><span class="line">  time:201305131200,201305131205,201305131210,201305131215</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>json</tag>
        <tag>jackson</tag>
      </tags>
  </entry>
  <entry>
    <title>jackson 将 json 串转成 List 或 Map 等集合</title>
    <url>/8a9db7f1-e38d-11ee-8d05-110f62540784/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、需求描述"><a href="#1、需求描述" class="headerlink" title="1、需求描述"></a>1、需求描述</h2><p>jackson 将 json 串转成 List、Map 等集合时，需要保证集合内的元素泛型不能丢失。</p>
<h2 id="2、案例"><a href="#2、案例" class="headerlink" title="2、案例"></a>2、案例</h2><p>1）需要构建 TypeReference 参数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">json2Obj</span><span class="params">(String json, TypeReference&lt;T&gt; type)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> objectMapper.readValue(json, type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">json2Obj(json, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;String&gt;&gt;()&#123;&#125;);</span><br><span class="line">json2Obj(json, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, String&gt;&gt;()&#123;&#125;);</span><br></pre></td></tr></table></figure>

<p>2）collectionType</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> JavaType <span class="title function_">collectionType</span><span class="params">(Class&lt;?&gt; collectionClz, Class&lt;?&gt; ...elementClz)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> om.getTypeFactory().constructParametricType(collectionClz, elementClz);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;T&gt; <span class="title function_">json2List</span><span class="params">(String json, Class&lt;T&gt; elementClz)</span> &#123;</span><br><span class="line">    objectMapper.readValue(json, collectionType(List.class, clz));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;T&gt; <span class="title function_">json2Map</span><span class="params">(String json, Class&lt;T&gt; valueClz)</span> &#123;</span><br><span class="line">    objectMapper.readValue(json, collectionType(Map.class, String.class, clz));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">json2List(json, String.class);</span><br><span class="line">json2Map(json. String.class);</span><br></pre></td></tr></table></figure>

<p>3）其他方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">JsonUtils</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ObjectMapper</span> <span class="variable">jackson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 把json转为键值对map</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> jsonStr</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">jsonToMap</span><span class="params">(String jsonStr)</span> &#123;</span><br><span class="line">    <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,Object&gt;();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      map = jackson.readValue(jsonStr, HashMap.class);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 把json转为List</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> jsonStr</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> List <span class="title function_">jsonToList</span><span class="params">(String jsonStr)</span> &#123;</span><br><span class="line">    <span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      list = jackson.readValue(jsonStr,ArrayList.class);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>java-建立定时任务</title>
    <url>/58863540-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<p>Spring 3.0 之后提供了 <code>@EnableScheduling</code> 注解和 <code>@Scheduled</code> 注解实现定时任务功能。本案例使用 SpringBoot 创建定时任务，主要有三种创建方式：</p>
<ul>
<li>使用 <code>@Scheduled</code> 注解</li>
<li>实现 SchedulingConfigurer 接口</li>
<li>基于注解设定多线程定时任务</li>
</ul>
<h3 id="一、-Scheduled-注解"><a href="#一、-Scheduled-注解" class="headerlink" title="一、@Scheduled 注解"></a>一、<code>@Scheduled</code> 注解</h3><p>1、在配置类上使用 <code>@EnableScheduling</code> 注解以开启计划任务。该方式默认为单线程，开启多个任务时，任务的执行时机会受上一个任务执行时间的影响。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SnippetApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SnippetApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、使用 <code>@Scheduled</code> 注解声明这是一个定时任务：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseScheduled</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/10 * *  * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">job</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;-&quot;</span> + LocalDateTime.now());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、<code>@Scheduled</code> 注解有如下属性</p>
<ul>
<li>cron，接收一个 cron 表达式</li>
<li>zone 时区，接收一个 java.util.TimeZone#ID。默认是一个空字符串，取服务器所在地的时区。</li>
<li>fixedDelay，服务启动后任务立即执行首次，延迟指定时间后再次执行。例如指定值 10s，相当于 cron 表达式 <code>&quot;0/10 * * * * ?&quot;</code></li>
<li>fixedDelayString，同 fixedDelay，值为字符串，并支持占位符</li>
<li>fixedRate，上一次开始执行时间点之后多长时间再执行</li>
<li>fixedRateString 同 fixedRate，值为字符串，并支持占位符</li>
<li>initialDelay，第一次延迟多长时间后再执行</li>
<li>initialDelayString，同 initialDelay，值为字符串，并支持占位符</li>
<li>timeUnit，以上计时属性的单位，默认毫秒（<code>TimeUnit.MILLISECONDS</code>）</li>
</ul>
<p>4、cron 属性接收的 cron 表达式支持占位符</p>
<p><code>application.yml</code> 中添加如下定义</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">scheduled:</span></span><br><span class="line">  <span class="attr">cron:</span> <span class="number">0</span><span class="string">/10</span> <span class="string">*</span> <span class="string">*</span>  <span class="string">*</span> <span class="string">*</span> <span class="string">?</span></span><br></pre></td></tr></table></figure>

<p>上述代码可更改为</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseScheduled</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;$&#123;scheduled.cron&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">job</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;-&quot;</span> + LocalDateTime.now());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看完整代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Scheduled(fixedDelayString = &quot;5&quot;, timeUnit = TimeUnit.SECONDS)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">job</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;定时任务开始=&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;-&quot;</span> + LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">    BiFunction&lt;Integer, Integer, Callable&lt;String&gt;&gt; function = (id, second) -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Callable</span>&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(second);</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">&quot;任务&#123; %s &#125;已完成，当前时间=&#123; %s &#125;&quot;</span>, id, LocalDateTime.now());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    completionService.submit(function.apply(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">    completionService.submit(function.apply(<span class="number">2</span>, <span class="number">8</span>));</span><br><span class="line">    completionService.submit(function.apply(<span class="number">3</span>, <span class="number">10</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; <span class="number">3</span>; index++) &#123;</span><br><span class="line">        System.out.println(completionService.take().get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行几个周期，输出如下。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">定时任务开始=scheduling-1-2023-06-25T21:26:36.841582700【job1立即执行首次，理论上5s后执行，但是单线程，要等job2，只能排队】</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T21:26:38.844894 &#125;【job2立即执行首次，任务1的延迟2s】</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T21:26:44.842944900 &#125;【job2立即执行首次，任务2的延迟8s】</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T21:26:46.842699200 &#125;【job2立即执行首次，任务3的延迟10s】</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T21:26:46.842699200【job2完成，job1立刻执行，再次排队】</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T21:26:53.846321200 &#125;【job2等待5s后再次执行，加上任务1的延迟2s，共7s】</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T21:26:59.845000500 &#125;【job2等待5s后再次执行，加上任务2的延迟8s，共13s】</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T21:27:01.844899100 &#125;【job2等待5s后再次执行，加上任务3的延迟10s，共15s】</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T21:27:01.844899100</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T21:27:08.846885700 &#125;</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T21:27:14.846942200 &#125;</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T21:27:16.847136600 &#125;</span><br></pre></td></tr></table></figure>

<p>可见，两个任务的执行时间无法并行，完成后必须等待其他定时任务。若改为 <code>fixedRateString</code>，则结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2023-06-25T22:03:37.192+08:00  INFO 20272 --- [           main] com.lab.snippet.SnippetApplication       : Started SnippetApplication in 1.151 seconds (process running for 1.417)</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T22:03:39.192069600 &#125;</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T22:03:45.193633600 &#125;</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T22:03:47.192106900 &#125;</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:03:47.192106900</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T22:03:49.193520800 &#125;</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T22:03:55.192690800 &#125;</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T22:03:57.194620 &#125;</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:03:57.194620</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T22:03:59.207931100 &#125;</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T22:04:05.203253700 &#125;</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T22:04:07.205267400 &#125;</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:04:07.205267400</span><br></pre></td></tr></table></figure>

<p>此时，job2不在以上一次自己执行结束额时间为准，直接以job1的结束作为基准，2s后开始执行。但还是由于单线程，job1执行完仍然需要排队，等待job2完毕。</p>
<p>改为每5s执行一次，结果不可控</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2023-06-25T22:24:53.688+08:00  INFO 14464 --- [           main] com.lab.snippet.SnippetApplication       : Started SnippetApplication in 1.135 seconds (process running for 1.386)</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T22:24:57.005405200 &#125;</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T22:25:03.004356200 &#125;</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T22:25:05.006176400 &#125;</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:25:05.006176400</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T22:25:12.016198400 &#125;</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T22:25:18.001606600 &#125;</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T22:25:20.001757800 &#125;</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:25:20.001757800</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:25:25.000208500</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T22:25:27.002035 &#125;</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T22:25:33.013051900 &#125;</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T22:25:35.007493700 &#125;</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:25:35.008453200</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:25:40.001605800</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T22:25:42.003821100 &#125;</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T22:25:48.003383700 &#125;</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T22:25:50.002780300 &#125;</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:25:50.002780300</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:25:55.001144200</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T22:25:57.002327300 &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2023-06-25T22:27:40.868+08:00  INFO 8008 --- [           main] com.lab.snippet.SnippetApplication       : Started SnippetApplication in 1.142 seconds (process running for 1.386)</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:27:45.000486300</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T22:27:47.005465 &#125;</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T22:27:53.006984800 &#125;</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T22:27:55.006056500 &#125;</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:27:55.007053500</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T22:28:02.009497100 &#125;</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T22:28:08.013432600 &#125;</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T22:28:10.003280800 &#125;</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:28:10.003280800</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:28:15.000889200</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T22:28:17.005103900 &#125;</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T22:28:23.004417100 &#125;</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T22:28:25.002408 &#125;</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:28:25.002408</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:28:30.000387200</span><br><span class="line">任务&#123; 1 &#125;已完成，当前时间=&#123; 2023-06-25T22:28:32.016138300 &#125;</span><br><span class="line">任务&#123; 2 &#125;已完成，当前时间=&#123; 2023-06-25T22:28:38.003692100 &#125;</span><br><span class="line">任务&#123; 3 &#125;已完成，当前时间=&#123; 2023-06-25T22:28:40.002122500 &#125;</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:28:40.002122500</span><br><span class="line">定时任务开始=scheduling-1-2023-06-25T22:28:45.001217</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>logback-日志配置</title>
    <url>/58863541-2a1e-11ee-846a-89c1529ebdf1/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1-日志级别"><a href="#1-日志级别" class="headerlink" title="1 日志级别"></a>1 日志级别</h2><table>
<thead>
<tr>
<th align="center">优先级</th>
<th align="center">日志级别</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">trace</td>
<td align="center">追踪，指明程序运行轨迹</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">debug</td>
<td align="center">调试，实际应用中一般将其作为最低级别</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">info</td>
<td align="center">输出重要的信息，使用较多</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">warn</td>
<td align="center">警告</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">error</td>
<td align="center">错误</td>
</tr>
</tbody></table>
<h2 id="2-格式"><a href="#2-格式" class="headerlink" title="2 格式"></a>2 格式</h2><table>
<thead>
<tr>
<th align="right">输出格式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td align="right">%date{yyyy-MM-dd HH:mm:ss.SSS}</td>
<td>日志生产时间，精确到毫秒</td>
</tr>
<tr>
<td align="right">%-5level</td>
<td>日志级别。例如 <code>-5</code> 表示左对齐并且固定输出 5 个字符，如果不足在右边补 0（<code>ILoggingEvent.getLevel</code>方法返回值）</td>
</tr>
<tr>
<td align="right">%logger</td>
<td>logger 的名称，例如 <code>logger&#123;36&#125;</code> 表示 logger 名字最长 36 个字符（<code>ILoggingEvent.getLoggerName</code>方法返回值）</td>
</tr>
<tr>
<td align="right">%thread</td>
<td>输出当前线程名称（<code>ILoggingEvent.getThreadName</code>方法返回值）</td>
</tr>
<tr>
<td align="right">%p</td>
<td>日志输出格式</td>
</tr>
<tr>
<td align="right">%msg</td>
<td>日志内容</td>
</tr>
<tr>
<td align="right">%n</td>
<td>换行符</td>
</tr>
<tr>
<td align="right">%class</td>
<td>输出 java 类名</td>
</tr>
<tr>
<td align="right">%file</td>
<td>输出文件名</td>
</tr>
<tr>
<td align="right">%L</td>
<td>输出错误行号</td>
</tr>
<tr>
<td align="right">%method</td>
<td>输出方法名</td>
</tr>
<tr>
<td align="right">%l</td>
<td>输出语句所在的行数, 包括类名、方法名、文件名、行数</td>
</tr>
<tr>
<td align="right">hostName</td>
<td>本地机器名</td>
</tr>
<tr>
<td align="right">hostAddress</td>
<td>本地 ip 地址</td>
</tr>
</tbody></table>
<h2 id="3-配置文件"><a href="#3-配置文件" class="headerlink" title="3 配置文件"></a>3 配置文件</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 定义日志输出格式和存储路径--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;LOG_PATTERN&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%date&#123;HH:mm:ss.SSS&#125;\t[%thread]\t%-5level %logger&#123;36&#125; - %msg%n&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注：如果最后打成jar包，日志将输出在logs目录下 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;INFO_PATH&quot;</span> <span class="attr">value</span>=<span class="string">&quot;logs/info.%d&#123;yyyy-MM-dd&#125;.%i.log&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;WARN_ERR_PATH&quot;</span> <span class="attr">value</span>=<span class="string">&quot;logs/warn_err.%d&#123;yyyy-MM-dd&#125;.%i.log&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 定义控制台输出 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注1：如果最后打成jar包，该部分输出会出现在jar包所在目录下的sout.log文件 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注2：name属性命名随意，引用时对应即可 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;CONSOLE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 打印格式 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- info类型配置（仅显示info，过滤warn、error）--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE_INFO&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- LevelFilter，按日志等级过滤 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>WARN<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 自定义过滤器 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;com.xx.LogbackFilter&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 文件名样式、保存周期、文件大小 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;INFO_PATH&#125;<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>3<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>5MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--WARN、ERROR类型配置（仅显示warn及其以上等级）--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE_WARN_ERR&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.ThresholdFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>WARN<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;WARN_ERR_PATH&#125;<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>10<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- turboFilter类型的过滤器比appender先触发 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">turboFilter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.turbo.DynamicThresholdFilter&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">DefaultThreshold</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">DefaultThreshold</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">OnHigherOrEqual</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">OnHigherOrEqual</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">OnLower</span>&gt;</span>NEUTRAL<span class="tag">&lt;/<span class="name">OnLower</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Key</span>&gt;</span>cando<span class="tag">&lt;/<span class="name">Key</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">MDCValueLevelPair</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>read<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>DEBUG<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">MDCValueLevelPair</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">MDCValueLevelPair</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>write<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>INFO<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">MDCValueLevelPair</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">MDCValueLevelPair</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>all<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>WARN<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">MDCValueLevelPair</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">turboFilter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 根目录输出等级为DEBUG --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_INFO&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_WARN_ERR&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-1-过滤器"><a href="#3-1-过滤器" class="headerlink" title="3.1 过滤器"></a>3.1 过滤器</h3><p>logbcak 允许给日志记录器 appender 配置一个或多个 Filter，或者给整体配置一个或多个 TurboFilter 实现当满足过滤器指定的条件时处理日志。</p>
<table>
<thead>
<tr>
<th align="center">过滤器</th>
<th align="center">类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">LevelFilter</td>
<td align="center">Filter</td>
<td align="left">对等于（onMatch）或不等于（onMismatch）指定 level 的日志进行处理</td>
</tr>
<tr>
<td align="center">ThresholdFilter</td>
<td align="center">Filter</td>
<td align="left">对大于或等于（onMatch）指定 level 的日志进行处理；小于（onMismatch）指定 level 的日志进行处理</td>
</tr>
<tr>
<td align="center">EvaluatorFilter</td>
<td align="center">Filter</td>
<td align="left">对满足（onMatch）或不满足（onMismatch）指定表达式的日志进行处理</td>
</tr>
<tr>
<td align="center">MDCFilter</td>
<td align="center">TurboFilter</td>
<td align="left">对等于（onMatch）或不等于（onMismatch） MDCKey 及其 Value 的日志进行处理</td>
</tr>
<tr>
<td align="center">DuplicateMessageFilter</td>
<td align="center">TurboFilter</td>
<td align="left">不记录多余的重复的日志。有两个子标签：<code>&lt;cacheSize&gt;</code> 表示内部缓存对旧消息引用的个数上限，默认 100；<code>&lt;allowedRepetitions&gt;</code> 表示允许消息出现的重复次数上限，超过次数上限的记录请求将被丢弃</td>
</tr>
<tr>
<td align="center">DynamicThresholdFilter</td>
<td align="center">TurboFilter</td>
<td align="left">动态版的 ThresholdFilter，根据 MDC 域中是否存在某个键，该键对应的值是否相等，可实现日志级别动态切换</td>
</tr>
<tr>
<td align="center">MarkerFilter</td>
<td align="center">TurboFilter</td>
<td align="left">对带有指定标记的日志进行处理</td>
</tr>
</tbody></table>
<blockquote>
<p>onMatch、onMismatch 的三种取值和处理方式：</p>
</blockquote>
<ul>
<li>DENY：拒绝了记录</li>
<li>NEUTRAL：本级过滤器放行，不记录。注意，如果日志途径的所有过滤器都是 NEUTRAL，则记录</li>
<li>ACCEPT：需要记录</li>
</ul>
<p><strong>EvaluatorFilter 例子</strong></p>
<p>在 <code>&lt;appender&gt;</code> 标签中使用，需要额外引入依赖：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// https://mvnrepository.com/artifact/org.codehaus.janino/janino</span></span><br><span class="line">implementation <span class="attr">group</span>: <span class="string">&#x27;org.codehaus.janino&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;janino&#x27;</span>, <span class="attr">version</span>: <span class="string">&#x27;3.1.9&#x27;</span></span><br></pre></td></tr></table></figure>

<p>当前需要拒绝来自 <code>org.apache.http.wire</code> 类和 <code>org.apache.http.headers</code> 类的日志信息，其他日志记录：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.filter.EvaluatorFilter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">evaluator</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">expression</span>&gt;</span></span><br><span class="line">            if(event.getLoggerName().contains(&quot;org.apache.http.wire&quot;) || event.getLoggerName().contains(&quot;org.apache.http.headers&quot;))&#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">expression</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">evaluator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OnMatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">OnMatch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OnMismatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">OnMismatch</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>MDCFilter 例子</strong></p>
<p>例如，仅记录 MDCKey 为 cando，Value 为 read 的日志：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">turboFilter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.turbo.MDCFilter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MDCKey</span>&gt;</span>cando<span class="tag">&lt;/<span class="name">MDCKey</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Value</span>&gt;</span>read<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OnMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">OnMatch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">turboFilter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>DuplicateMessageFilter 例子</strong></p>
<p>限制仅显示 1 条日志</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">turboFilter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.turbo.DuplicateMessageFilter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AllowedRepetitions</span>&gt;</span>1<span class="tag">&lt;/<span class="name">AllowedRepetitions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">turboFilter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">log.info(marker, <span class="string">&quot;this is marker&quot;</span>);</span><br><span class="line">log.info(<span class="string">&quot;this is marker&quot;</span>);</span><br><span class="line">log.info(String.format(<span class="string">&quot;this is marker&quot;</span>, <span class="number">1</span>));</span><br><span class="line">log.info(String.format(<span class="string">&quot;this is marker&quot;</span>, <span class="number">2</span>));</span><br></pre></td></tr></table></figure>

<p>测试代码中第 2-4 行判断为重复，输出结果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">52</span>:<span class="number">01.698</span>	[Test worker]	INFO  s.ApplicationTests - <span class="built_in">this</span> is marker</span><br><span class="line"><span class="number">16</span>:<span class="number">52</span>:<span class="number">01.699</span>	[Test worker]	INFO  s.ApplicationTests - <span class="built_in">this</span> is marker</span><br></pre></td></tr></table></figure>

<p><strong>DynamicThresholdFilter 例子&#96;</strong></p>
<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">MDC.put(<span class="string">&quot;null&quot;</span>, <span class="string">&quot;none&quot;</span>);</span><br><span class="line">log.trace(<span class="string">&quot;key=&#123; null &#125;,value=&#123; none &#125;,level=&#123; TRACE &#125;&quot;</span>);</span><br><span class="line">log.debug(<span class="string">&quot;key=&#123; null &#125;,value=&#123; none &#125;,level=&#123; DEBUG &#125;&quot;</span>);</span><br><span class="line">log.info(<span class="string">&quot;key=&#123; null &#125;,value=&#123; none &#125;,level=&#123; INFO &#125;&quot;</span>);</span><br><span class="line">log.warn(<span class="string">&quot;key=&#123; null &#125;,value=&#123; none &#125;,level=&#123; WARN &#125;&quot;</span>);</span><br><span class="line">log.error(<span class="string">&quot;key=&#123; null &#125;,value=&#123; none &#125;,level=&#123; ERROR &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">MDC.put(<span class="string">&quot;cando&quot;</span>, <span class="string">&quot;read&quot;</span>);</span><br><span class="line">log.trace(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; read &#125;,level=&#123; TRACE &#125;&quot;</span>);</span><br><span class="line">log.debug(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; read &#125;,level=&#123; DEBUG &#125;&quot;</span>);</span><br><span class="line">log.info(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; read &#125;,level=&#123; INFO &#125;&quot;</span>);</span><br><span class="line">log.warn(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; read &#125;,level=&#123; WARN &#125;&quot;</span>);</span><br><span class="line">log.error(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; read &#125;,level=&#123; ERROR &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">MDC.put(<span class="string">&quot;cando&quot;</span>, <span class="string">&quot;write&quot;</span>);</span><br><span class="line">log.trace(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; write &#125;,level=&#123; TRACE &#125;&quot;</span>);</span><br><span class="line">log.debug(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; write &#125;,level=&#123; DEBUG &#125;&quot;</span>);</span><br><span class="line">log.info(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; write &#125;,level=&#123; INFO &#125;&quot;</span>);</span><br><span class="line">log.warn(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; write &#125;,level=&#123; WARN &#125;&quot;</span>);</span><br><span class="line">log.error(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; write &#125;,level=&#123; ERROR &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">MDC.put(<span class="string">&quot;cando&quot;</span>, <span class="string">&quot;none&quot;</span>);</span><br><span class="line">log.trace(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; none &#125;,level=&#123; TRACE &#125;&quot;</span>);</span><br><span class="line">log.debug(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; none &#125;,level=&#123; DEBUG &#125;&quot;</span>);</span><br><span class="line">log.info(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; none &#125;,level=&#123; INFO &#125;&quot;</span>);</span><br><span class="line">log.warn(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; none &#125;,level=&#123; WARN &#125;&quot;</span>);</span><br><span class="line">log.error(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; none &#125;,level=&#123; ERROR &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">MDC.put(<span class="string">&quot;cando&quot;</span>, <span class="string">&quot;all&quot;</span>);</span><br><span class="line">log.trace(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; all &#125;,level=&#123; TRACE &#125;&quot;</span>);</span><br><span class="line">log.debug(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; all &#125;,level=&#123; DEBUG &#125;&quot;</span>);</span><br><span class="line">log.info(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; all &#125;,level=&#123; INFO &#125;&quot;</span>);</span><br><span class="line">log.warn(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; all &#125;,level=&#123; WARN &#125;&quot;</span>);</span><br><span class="line">log.error(<span class="string">&quot;key=&#123; cando &#125;,value=&#123; all &#125;,level=&#123; ERROR &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">MDC.put(<span class="string">&quot;null&quot;</span>, <span class="string">&quot;none&quot;</span>);</span><br><span class="line">log.trace(<span class="string">&quot;key=&#123; null &#125;,value=&#123; none &#125;,level=&#123; TRACE &#125;&quot;</span>);</span><br><span class="line">log.debug(<span class="string">&quot;key=&#123; null &#125;,value=&#123; none &#125;,level=&#123; DEBUG &#125;&quot;</span>);</span><br><span class="line">log.info(<span class="string">&quot;key=&#123; null &#125;,value=&#123; none &#125;,level=&#123; INFO &#125;&quot;</span>);</span><br><span class="line">log.warn(<span class="string">&quot;key=&#123; null &#125;,value=&#123; none &#125;,level=&#123; WARN &#125;&quot;</span>);</span><br><span class="line">log.error(<span class="string">&quot;key=&#123; null &#125;,value=&#123; none &#125;,level=&#123; ERROR &#125;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<ul>
<li>当 key 和 value 都对应时，记录大于等于给定 level 的日志</li>
<li>当 key 对应，value 不对应时，按<code>&lt;DefaultThreshold&gt;</code>标签处理</li>
<li>当 key 不对应时，无论 value 是否对应，所得结果不确定：在首位调用，仅记录<code>ERROR</code>，满足<code>&lt;DefaultThreshold&gt;</code>标签限定；若紧跟其他调用，会与该调用的等级相同。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">13</span>:<span class="number">41</span>:<span class="number">52.810</span>	[Test worker]	ERROR s.ApplicationTests - key=&#123; <span class="literal">null</span> &#125;,value=&#123; none &#125;,level=&#123; ERROR &#125;</span><br><span class="line"><span class="number">13</span>:<span class="number">41</span>:<span class="number">52.811</span>	[Test worker]	DEBUG s.ApplicationTests - key=&#123; cando &#125;,value=&#123; read &#125;,level=&#123; DEBUG &#125;</span><br><span class="line"><span class="number">13</span>:<span class="number">41</span>:<span class="number">52.811</span>	[Test worker]	INFO  s.ApplicationTests - key=&#123; cando &#125;,value=&#123; read &#125;,level=&#123; INFO &#125;</span><br><span class="line"><span class="number">13</span>:<span class="number">41</span>:<span class="number">52.811</span>	[Test worker]	WARN  s.ApplicationTests - key=&#123; cando &#125;,value=&#123; read &#125;,level=&#123; WARN &#125;</span><br><span class="line"><span class="number">13</span>:<span class="number">41</span>:<span class="number">52.811</span>	[Test worker]	ERROR s.ApplicationTests - key=&#123; cando &#125;,value=&#123; read &#125;,level=&#123; ERROR &#125;</span><br><span class="line"><span class="number">13</span>:<span class="number">41</span>:<span class="number">52.811</span>	[Test worker]	INFO  s.ApplicationTests - key=&#123; cando &#125;,value=&#123; write &#125;,level=&#123; INFO &#125;</span><br><span class="line"><span class="number">13</span>:<span class="number">41</span>:<span class="number">52.811</span>	[Test worker]	WARN  s.ApplicationTests - key=&#123; cando &#125;,value=&#123; write &#125;,level=&#123; WARN &#125;</span><br><span class="line"><span class="number">13</span>:<span class="number">41</span>:<span class="number">52.811</span>	[Test worker]	ERROR s.ApplicationTests - key=&#123; cando &#125;,value=&#123; write &#125;,level=&#123; ERROR &#125;</span><br><span class="line"><span class="number">13</span>:<span class="number">41</span>:<span class="number">52.811</span>	[Test worker]	ERROR s.ApplicationTests - key=&#123; cando &#125;,value=&#123; none &#125;,level=&#123; ERROR &#125;</span><br><span class="line"><span class="number">13</span>:<span class="number">41</span>:<span class="number">52.811</span>	[Test worker]	WARN  s.ApplicationTests - key=&#123; cando &#125;,value=&#123; all &#125;,level=&#123; WARN &#125;</span><br><span class="line"><span class="number">13</span>:<span class="number">41</span>:<span class="number">52.811</span>	[Test worker]	ERROR s.ApplicationTests - key=&#123; cando &#125;,value=&#123; all &#125;,level=&#123; ERROR &#125;</span><br><span class="line"><span class="number">13</span>:<span class="number">41</span>:<span class="number">52.811</span>	[Test worker]	WARN  s.ApplicationTests - key=&#123; <span class="literal">null</span> &#125;,value=&#123; none &#125;,level=&#123; WARN &#125;</span><br><span class="line"><span class="number">13</span>:<span class="number">41</span>:<span class="number">52.811</span>	[Test worker]	ERROR s.ApplicationTests - key=&#123; <span class="literal">null</span> &#125;,value=&#123; none &#125;,level=&#123; ERROR &#125;</span><br></pre></td></tr></table></figure>

<p><strong>MarkerFilter 例子</strong></p>
<p>指定记录带有 test 标记的日志：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">turboFilter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.turbo.MarkerFilter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Marker</span>&gt;</span>test<span class="tag">&lt;/<span class="name">Marker</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OnMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">OnMatch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OnMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">OnMismatch</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">turboFilter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Marker</span> <span class="variable">marker</span> <span class="operator">=</span> MarkerFactory.getMarker(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line">log.info(marker,<span class="string">&quot;this is marker&quot;</span>);</span><br><span class="line">log.info(<span class="string">&quot;a normal log&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="3-2-自定义过滤器"><a href="#3-2-自定义过滤器" class="headerlink" title="3.2 自定义过滤器"></a>3.2 自定义过滤器</h3><p>实现一个与上文相同的功能，拒绝来自 <code>org.apache.http.wire</code> 类和 <code>org.apache.http.headers</code> 类的日志信息，其他日志记录：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogbackFilter</span> <span class="keyword">extends</span> <span class="title class_">Filter</span>&lt;ILoggingEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FilterReply <span class="title function_">decide</span><span class="params">(ILoggingEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(event.getLoggerName().contains(<span class="string">&quot;org.apache.http.wire&quot;</span>) || event.getLoggerName().contains(<span class="string">&quot;org.apache.http.headers&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> FilterReply.DENY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> FilterReply.NEUTRAL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>logback</tag>
      </tags>
  </entry>
  <entry>
    <title>spring 之 FileSystemResource</title>
    <url>/3c6aeb00-e213-11ee-8578-cb8bdeddad57/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、来源"><a href="#1、来源" class="headerlink" title="1、来源"></a>1、来源</h2><p>FileSystemResource 是 Spring 框架中 Resource 接口的一个实现类，主要用于访问文件系统中的资源。这个类封装了对文件系统的直接访问能力，使得在 Spring 的上下文中可以方便地以统一的方式处理本地文件。</p>
<h2 id="2、作用"><a href="#2、作用" class="headerlink" title="2、作用"></a>2、作用</h2><p>1）统一资源访问接口</p>
<p>Spring 提供了 Resource 接口来抽象不同类型的资源（如文件、类路径资源、URL 资源等），而 FileSystemResource 是针对文件系统资源的实现，提供了一种与具体文件系统交互的标准方式。</p>
<p>2）读取和操作文件</p>
<p>通过 FileSystemResource，开发者能够根据给定的文件系统路径读取文件内容、获取文件信息（如文件名、路径、是否存在、最后修改时间等）以及进行文件的读写操作。</p>
<p>3）集成到 Spring 框架中</p>
<p>在 Spring 的配置文件加载、组件扫描、自动装配等场景下，当需要从文件系统加载资源时，会隐式或显式地创建 FileSystemResource 对象</p>
<h2 id="3、案例"><a href="#3、案例" class="headerlink" title="3、案例"></a>3、案例</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.core.io.FileSystemResource;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个指向文件系统的资源对象</span></span><br><span class="line"><span class="type">FileSystemResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileSystemResource</span>(<span class="string">&quot;/path/to/myfile.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用资源对象读取文件内容</span></span><br><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> resource.getInputStream();</span><br><span class="line"><span class="type">byte</span>[] contentBytes = StreamUtils.copyToByteArray(inputStream);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者使用Spring的Resource工具方法直接读取字符串内容</span></span><br><span class="line"><span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> FileCopyUtils.copyToString(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(resource.getInputStream()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取文件相关信息</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">exists</span> <span class="operator">=</span> resource.exists();</span><br><span class="line"><span class="type">long</span> <span class="variable">lastModified</span> <span class="operator">=</span> resource.lastModified();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写入文件</span></span><br><span class="line"><span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> resource.getOutputStream();</span><br><span class="line">outputStream.write(someData);</span><br><span class="line">outputStream.close();</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>spring 之 ServletUriComponentsBuilder</title>
    <url>/3c6aeb01-e213-11ee-8578-cb8bdeddad57/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、来源"><a href="#1、来源" class="headerlink" title="1、来源"></a>1、来源</h2><p>ServletUriComponentsBuilder 是 Spring Framework 中用于构建和操作 URI 的一个类，特别适合在基于 Servlet 容器的 Web 应用程序中使用。它主要用于从当前 Servlet 请求上下文中获取相关信息（如主机名、端口、scheme 等），然后构造或修改完整的 URI。</p>
<h2 id="2、作用"><a href="#2、作用" class="headerlink" title="2、作用"></a>2、作用</h2><p>1）基于当前请求构建 URI</p>
<p>当需要生成一个与当前请求相关的新的 URI 时，比如创建一个重定向 URL 或是一个 API 资源链接时，可以利用 ServletUriComponentsBuilder 从当前 Servlet 映射提取信息。</p>
<p>2）动态替换路径变量</p>
<p>类似于 MVC 视图中的模型属性，可以在 URI 模板字符串中定义占位符，并通过 .expand() 方法动态地将实际值插入到这些占位符中。</p>
<p>3）处理反向代理</p>
<p>在有 Nginx 等反向代理服务器的情况下，可以通过读取 X-Forwarded-* 标头来正确识别客户端的原始请求信息，从而构建正确的完整 URI。</p>
<h2 id="3、案例"><a href="#3、案例" class="headerlink" title="3、案例"></a>3、案例</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.support.ServletUriComponentsBuilder;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于当前请求映射构建新URI</span></span><br><span class="line"><span class="type">URI</span> <span class="variable">newLocation</span> <span class="operator">=</span> ServletUriComponentsBuilder.fromCurrentServletMapping()</span><br><span class="line">    .path(<span class="string">&quot;/api/users/&#123;id&#125;&quot;</span>)</span><br><span class="line">    .buildAndExpand(<span class="number">123</span>) <span class="comment">// 替换&#123;id&#125;为实际ID值</span></span><br><span class="line">    .toUri();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接指定主机、端口、路径等构建URI</span></span><br><span class="line"><span class="type">URI</span> <span class="variable">customLocation</span> <span class="operator">=</span> ServletUriComponentsBuilder.newInstance()</span><br><span class="line">    .scheme(<span class="string">&quot;https&quot;</span>)</span><br><span class="line">    .host(<span class="string">&quot;example.com&quot;</span>)</span><br><span class="line">    .port(<span class="number">443</span>)</span><br><span class="line">    .path(<span class="string">&quot;/v1/resources&quot;</span>)</span><br><span class="line">    .build()</span><br><span class="line">    .toUri();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理Nginx反向代理，确保构建出的是用户看到的实际URL</span></span><br><span class="line"><span class="comment">// （假设Spring配置已启用对X-Forwarded-*头的支持）</span></span><br><span class="line"><span class="type">URI</span> <span class="variable">proxiedLocation</span> <span class="operator">=</span> ServletUriComponentsBuilder.fromCurrentRequest()</span><br><span class="line">    .pathSegment(<span class="string">&quot;proxied-resource&quot;</span>)</span><br><span class="line">    .build()</span><br><span class="line">    .toUri();</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot 数据源配置</title>
    <url>/d27a8f70-9bfe-11ee-a92b-05e08d68d559/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、环境及依赖"><a href="#1、环境及依赖" class="headerlink" title="1、环境及依赖"></a>1、环境及依赖</h2><ul>
<li>Amazon Corretto 17</li>
<li>Spring Boot 3.2.0</li>
<li>Gradle 7.4.2</li>
<li>postgresql 15.5-1</li>
<li>mariadb 10.11.6</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">dependencies <span class="punctuation">&#123;</span></span><br><span class="line">    implementation &#x27;org.mybatis.spring.boot<span class="punctuation">:</span>mybatis-spring-boot-starter<span class="punctuation">:</span><span class="number">3.0</span><span class="number">.3</span>&#x27;</span><br><span class="line">    compileOnly &#x27;org.projectlombok<span class="punctuation">:</span>lombok&#x27;</span><br><span class="line">    runtimeOnly &#x27;org.mariadb.jdbc<span class="punctuation">:</span>mariadb-java-client&#x27;</span><br><span class="line">    runtimeOnly &#x27;org.postgresql<span class="punctuation">:</span>postgresql&#x27;</span><br><span class="line">    annotationProcessor &#x27;org.projectlombok<span class="punctuation">:</span>lombok&#x27;</span><br><span class="line">    testImplementation &#x27;org.springframework.boot<span class="punctuation">:</span>spring-boot-starter-test&#x27;</span><br><span class="line">    testImplementation &#x27;org.mybatis.spring.boot<span class="punctuation">:</span>mybatis-spring-boot-starter-test<span class="punctuation">:</span><span class="number">3.0</span><span class="number">.3</span>&#x27;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="2、application-yml"><a href="#2、application-yml" class="headerlink" title="2、application.yml"></a>2、application.yml</h2><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">main:</span></span><br><span class="line">      <span class="attr">driverClassName:</span> <span class="string">org.mariadb.jdbc.Driver</span></span><br><span class="line">      <span class="attr">jdbc-url:</span> <span class="string">jdbc:mariadb://localhost:3306/demo?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=GMT%2B8&amp;allowPublicKeyRetrieval=true</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">secondary:</span></span><br><span class="line">      <span class="attr">driverClassName:</span> <span class="string">org.postgresql.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:postgresql://192.168.1.5:5432/postgres?currentSchema=demo</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">postgres</span></span><br></pre></td></tr></table></figure>

<p><strong>配置要点</strong></p>
<ul>
<li>每个数据库要分别指定名称，必须有一个主数据库。本例中主数据库为 main，次数据库为 secondary</li>
<li>本例使用 Hikari 作为连接池。多数据库的地址字段为应显示指定为 <code>jdbc-url</code> 而非 <code>url</code>。单个数据库时，可配置为 <code>url</code>。主数据库使用 <code>@ConfigurationProperties</code> 注解指定相关配置项。为便于对比，次数据库使用另一种等效方式：从配置文件指定的位置取值，此时不受 <code>jdbc-url</code> 或 <code>url</code> 的限制。</li>
<li>pg 数据库有「模式（Schema）」的概念，配置文件可指定模式，如果不指定，则相应 sql 语句需要带上模式名称，否则默认指向 public，如：<code>insert into demo.test_table(name, age) VALUES (&#39;haha&#39;,123);</code></li>
</ul>
<h2 id="3、配置数据源"><a href="#3、配置数据源" class="headerlink" title="3、配置数据源"></a>3、配置数据源</h2><p><strong>MainDataSourceConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = &quot;com.example.dao.main&quot;, sqlSessionTemplateRef = &quot;mainSqlSessionTemplate&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainDataSourceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;mainDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.main&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;mainSqlSessionFactory&quot;)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">(<span class="meta">@Qualifier(&quot;mainDataSource&quot;)</span> DataSource dataSource)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">sessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        sessionFactory.setDataSource(dataSource);</span><br><span class="line">        sessionFactory.setMapperLocations(<span class="keyword">new</span> <span class="title class_">PathMatchingResourcePatternResolver</span>().getResources(<span class="string">&quot;classpath*:mapper/main/*.xml&quot;</span>));</span><br><span class="line">        sessionFactory.setTypeAliasesPackage(<span class="string">&quot;com.example.entity&quot;</span>);</span><br><span class="line"></span><br><span class="line">        org.apache.ibatis.session.<span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">org</span>.apache.ibatis.session.Configuration();</span><br><span class="line">        configuration.setJdbcTypeForNull(JdbcType.NULL);</span><br><span class="line">        configuration.setCallSettersOnNulls(<span class="literal">true</span>);</span><br><span class="line">        configuration.setLogImpl(StdOutImpl.class);</span><br><span class="line">        sessionFactory.setConfiguration(configuration);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sessionFactory.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;mainTransactionManager&quot;)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceTransactionManager <span class="title function_">dataSourceTransactionManager</span><span class="params">(<span class="meta">@Qualifier(&quot;mainDataSource&quot;)</span> DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;mainSqlSessionTemplate&quot;)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionTemplate <span class="title function_">sqlSessionTemplate</span><span class="params">(<span class="meta">@Qualifier(&quot;mainSqlSessionFactory&quot;)</span> SqlSessionFactory sqlSessionFactory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlSessionTemplate</span>(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>SecondaryDataSourceConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = &quot;com.example.dao.secondary&quot;, sqlSessionTemplateRef = &quot;secondarySqlSessionTemplate&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondaryDataSourceConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.driverClassName&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String driverClassName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.secondary.url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.secondary.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String user;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.datasource.secondary.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;secondaryDataSource&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        DataSourceBuilder&lt;?&gt; dataSourceBuilder = DataSourceBuilder.create();</span><br><span class="line">        dataSourceBuilder.driverClassName(driverClassName);</span><br><span class="line">        dataSourceBuilder.url(url);</span><br><span class="line">        dataSourceBuilder.password(password);</span><br><span class="line">        dataSourceBuilder.username(user);</span><br><span class="line">        <span class="keyword">return</span> dataSourceBuilder.build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 或者使用 DriverManagerDataSource</span></span><br><span class="line">        <span class="comment">// DriverManagerDataSource dataSource = new DriverManagerDataSource();</span></span><br><span class="line">        <span class="comment">// dataSource.setDriverClassName(driverClassName);</span></span><br><span class="line">        <span class="comment">// dataSource.setUrl(url);</span></span><br><span class="line">        <span class="comment">// dataSource.setUsername(user);</span></span><br><span class="line">        <span class="comment">// dataSource.setPassword(password);</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// return dataSource;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;secondarySqlSessionFactory&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">(<span class="meta">@Qualifier(&quot;secondaryDataSource&quot;)</span> DataSource dataSource)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SqlSessionFactoryBean</span> <span class="variable">sessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">        sessionFactory.setDataSource(dataSource);</span><br><span class="line">        sessionFactory.setMapperLocations(<span class="keyword">new</span> <span class="title class_">PathMatchingResourcePatternResolver</span>().getResources(<span class="string">&quot;classpath*:mapper/secondary/*.xml&quot;</span>));</span><br><span class="line">        sessionFactory.setTypeAliasesPackage(<span class="string">&quot;com.example.entity&quot;</span>);</span><br><span class="line"></span><br><span class="line">        org.apache.ibatis.session.<span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">org</span>.apache.ibatis.session.Configuration();</span><br><span class="line">        configuration.setJdbcTypeForNull(JdbcType.NULL);</span><br><span class="line">        configuration.setCallSettersOnNulls(<span class="literal">true</span>);</span><br><span class="line">        configuration.setLogImpl(StdOutImpl.class);</span><br><span class="line">        sessionFactory.setConfiguration(configuration);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sessionFactory.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;secondaryTransactionManager&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceTransactionManager <span class="title function_">dataSourceTransactionManager</span><span class="params">(<span class="meta">@Qualifier(&quot;secondaryDataSource&quot;)</span> DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;secondarySqlSessionTemplate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionTemplate <span class="title function_">sqlSessionTemplate</span><span class="params">(<span class="meta">@Qualifier(&quot;secondarySqlSessionFactory&quot;)</span> SqlSessionFactory sqlSessionFactory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SqlSessionTemplate</span>(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置要点</strong></p>
<ul>
<li>如果使用注解，可不配置 <code>classpath*:mapper/secondary/*.xml</code></li>
</ul>
<h2 id="4、数据表及-dao-接口"><a href="#4、数据表及-dao-接口" class="headerlink" title="4、数据表及 dao 接口"></a>4、数据表及 dao 接口</h2><p><strong>1）测试表定义</strong></p>
<p><strong>mariadb</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_table</span><br><span class="line">(</span><br><span class="line">    id   <span class="type">bigint</span> auto_increment</span><br><span class="line">        <span class="keyword">primary</span> key,</span><br><span class="line">    name <span class="type">char</span>(<span class="number">5</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    age  <span class="type">int</span>     <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>pg</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_table</span><br><span class="line">(</span><br><span class="line">    id   bigserial</span><br><span class="line">        <span class="keyword">constraint</span> test_table_pk</span><br><span class="line">            <span class="keyword">primary</span> key,</span><br><span class="line">    name <span class="type">char</span>(<span class="number">5</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    age  <span class="type">integer</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test_table</span><br><span class="line">    owner <span class="keyword">to</span> postgres;</span><br></pre></td></tr></table></figure>

<p><strong>2）dao</strong></p>
<p><strong>IMain</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IMain</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into test_table(name, age) VALUES (#&#123;name&#125;,23);&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertData</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ISecondary</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ISecondary</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into test_table(name, age) VALUES (#&#123;name&#125;,23);&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertData</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>配置要点</strong></p>
<ul>
<li>pg 数据库如果在配置文件不指定模式，则相应 sql 语句需要带上模式名称，如：<code>insert into demo.test_table(name, age)</code>，否则默认指向 public</li>
</ul>
<h2 id="5、测试"><a href="#5、测试" class="headerlink" title="5、测试"></a>5、测试</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MutiDatabaseApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISecondary iSecondary;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IMain iMain;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        iSecondary.insertData(<span class="string">&quot;jack&quot;</span>);</span><br><span class="line">        iMain.insertData(<span class="string">&quot;mark&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot 服务运行时读取目录下文件</title>
    <url>/3c6aeb02-e213-11ee-8578-cb8bdeddad57/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1-问题描述"><a href="#1-问题描述" class="headerlink" title="1 问题描述"></a>1 问题描述</h2><p>服务执行时，读取 jar 所在目录的外部文件</p>
<h2 id="2-解决方案"><a href="#2-解决方案" class="headerlink" title="2 解决方案"></a>2 解决方案</h2><p>通过 ApplicationHome 获取 jar 所在目录路径</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ApplicationHome</span> <span class="variable">home</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationHome</span>(TestSpringBootApplication.class);</span><br><span class="line"><span class="type">String</span> <span class="variable">jarPath</span> <span class="operator">=</span> home.getDir().toString();</span><br></pre></td></tr></table></figure>

<h2 id="3-案例"><a href="#3-案例" class="headerlink" title="3 案例"></a>3 案例</h2><p>1）建立一个 Controller，响应更新所在目录路径</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActionController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/dir&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">updateDirMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 获取jar所在目录路径</span></span><br><span class="line">        <span class="type">ApplicationHome</span> <span class="variable">home</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationHome</span>(TestSpringBootApplication.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jarPath</span> <span class="operator">=</span> home.getDir().toString();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">BufferedWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(jarPath + <span class="string">&quot;/path.txt&quot;</span>, <span class="literal">true</span>))) &#123;</span><br><span class="line">            writer.write(LocalDateTime.now() + <span class="string">&quot; :&quot;</span> + jarPath);</span><br><span class="line">            writer.newLine();</span><br><span class="line">            writer.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;写入文件时发生错误: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jarPath;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）更进一步，利用路径保存上传的文件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置上传文件的根目录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UPLOAD_ROOT_DIR</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationHome</span>(TestSpringBootApplication.class).getDir().toString();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">uploadFile</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.badRequest().body(<span class="string">&quot;上传的压缩包不能为空&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Path</span> <span class="variable">targetPath</span> <span class="operator">=</span> Paths.get(UPLOAD_ROOT_DIR, file.getOriginalFilename());</span><br><span class="line">            <span class="comment">// 确保父目录存在</span></span><br><span class="line">            Files.createDirectories(targetPath.getParent());</span><br><span class="line">            <span class="comment">// 保存上传的压缩包</span></span><br><span class="line">            file.transferTo(targetPath.toFile());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 解压文件到指定目录</span></span><br><span class="line">            unzipFile(targetPath.toString(), UPLOAD_ROOT_DIR);</span><br><span class="line"></span><br><span class="line">            <span class="type">FileSystemResource</span> <span class="variable">fileSystemResource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileSystemResource</span>(targetPath.toFile());</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok().body(String.valueOf(fileSystemResource));</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(<span class="number">500</span>).body(<span class="string">&quot;上传过程中发生错误：&quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unzipFile</span><span class="params">(String zipFilePath, String destDir)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ZipInputStream</span> <span class="variable">zis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(zipFilePath))) &#123;</span><br><span class="line">            <span class="type">ZipEntry</span> <span class="variable">entry</span> <span class="operator">=</span> zis.getNextEntry();</span><br><span class="line">            <span class="keyword">while</span> (entry != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">Path</span> <span class="variable">filePath</span> <span class="operator">=</span> Paths.get(destDir, entry.getName());</span><br><span class="line">                <span class="keyword">if</span> (!entry.isDirectory()) &#123;</span><br><span class="line">                    Files.createDirectories(filePath.getParent());</span><br><span class="line">                    Files.copy(zis, filePath);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Files.createDirectories(filePath);</span><br><span class="line">                &#125;</span><br><span class="line">                zis.closeEntry();</span><br><span class="line">                entry = zis.getNextEntry();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>相应的前端案例代码</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;title&gt;Upload Zip File&lt;/title&gt;</span><br><span class="line">    &lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;container mt-4&quot;&gt;</span><br><span class="line">    &lt;h2&gt;Upload and Extract ZIP File&lt;/h2&gt;</span><br><span class="line">    &lt;form id=&quot;uploadForm&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;mb-3&quot;&gt;</span><br><span class="line">            &lt;label for=&quot;zipFile&quot; class=&quot;form-label&quot;&gt;Select a ZIP file to upload:&lt;/label&gt;</span><br><span class="line">            &lt;input type=&quot;file&quot; class=&quot;form-control&quot; id=&quot;zipFile&quot; name=&quot;file&quot; accept=&quot;.zip&quot;&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot; id=&quot;uploadButton&quot;&gt;Upload &amp; Extract&lt;/button&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">    &lt;div id=&quot;responseMessage&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    document.addEventListener(&#x27;DOMContentLoaded&#x27;, function() &#123;</span><br><span class="line">        const uploadForm = document.getElementById(&#x27;uploadForm&#x27;);</span><br><span class="line">        const zipFileInput = document.getElementById(&#x27;zipFile&#x27;);</span><br><span class="line">        const responseMessage = document.getElementById(&#x27;responseMessage&#x27;);</span><br><span class="line">        const uploadButton = document.getElementById(&#x27;uploadButton&#x27;);</span><br><span class="line"></span><br><span class="line">        uploadButton.addEventListener(&#x27;click&#x27;, function(event) &#123;</span><br><span class="line">            event.preventDefault(); // 阻止表单默认提交行为</span><br><span class="line"></span><br><span class="line">            if (!zipFileInput.files.length) &#123;</span><br><span class="line">                responseMessage.textContent = &quot;Please select a ZIP file.&quot;;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            const formData = new FormData(uploadForm);</span><br><span class="line"></span><br><span class="line">            fetch(&#x27;/upload&#x27;, &#123;</span><br><span class="line">                method: &#x27;POST&#x27;,</span><br><span class="line">                body: formData,</span><br><span class="line">            &#125;)</span><br><span class="line">                .then(response =&gt; response.text())</span><br><span class="line">                .then(data =&gt; &#123;</span><br><span class="line">                    responseMessage.textContent = data;</span><br><span class="line">                    // 在这里可以添加跳转到查看解压后文件列表的逻辑</span><br><span class="line">                &#125;)</span><br><span class="line">                .catch(error =&gt; &#123;</span><br><span class="line">                    responseMessage.textContent = &quot;An error occurred while uploading the file: &quot; + error;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            // 清空已选择的文件</span><br><span class="line">            zipFileInput.value = &#x27;&#x27;;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Anaconda 下修改 Jupyter 的默认路径</title>
    <url>/8a9db7f0-e38d-11ee-8d05-110f62540784/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、解决步骤"><a href="#1、解决步骤" class="headerlink" title="1、解决步骤"></a>1、解决步骤</h2><p>1）建立要更改的目录，如 <code>D:\Desktop\jupyterDir</code></p>
<p>2）打开 Anaconda Prompt，输入以下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">jupyter notebook --generate-config</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该命令将生成 Jupyter 配置文件，如果提示是否覆盖，确认覆盖即可。</p>
</blockquote>
<p>3）根据上述路径找到 <code>jupyter_notebook_config.py</code>，搜索 <code>c.NotebookApp.notebook_dir</code>，删除 <code>#</code> 取消注释，将路径填入：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">c.NotebookApp.notebook_dir = r<span class="string">&#x27;D:\Desktop\jupyterDir&#x27;</span></span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">c.NotebookApp.notebook_dir = <span class="string">&#x27;D:\\Desktop\\jupyterDir&#x27;</span></span><br></pre></td></tr></table></figure>

<p>4）找到 Jupyter 快捷方式，将 <code>目标</code> 最后面的 <code>%USERPROFILE%</code> 删除。</p>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>python 的字符串前缀</title>
    <url>/97816df0-a133-11ee-9970-39bf61dae061/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、u"><a href="#1、u" class="headerlink" title="1、u"></a>1、<code>u</code></h2><p>例如：<code>u&#39;中文字符串&#39;</code>，表示该字符串是 unicode 编码，一般在 Python2 中使用，用在含有中文字符的字符串前，防止因为编码问题导致中文出现乱码，一般也在文件开关标明编码方式采用 utf8。在 Python3 中，所有字符串默认都是 unicode 字符串，前缀是否带 <code>u</code> 问题不大。</p>
<h2 id="2、r"><a href="#2、r" class="headerlink" title="2、r"></a>2、<code>r</code></h2><p>例如：<code>r&quot;msg.*?\((.*)\)&quot;</code>、<code>r&#39;C:\app\userdata&#39;</code>，不开启反斜杠的转义机制。</p>
<h2 id="3、b"><a href="#3、b" class="headerlink" title="3、b"></a>3、<code>b</code></h2><p>表示 bytes 对象，用在 Python3 中。Python3 里默认的 str 是 unicode 类。Python2 的 str 就是 bytes 类。</p>
<blockquote>
<p>Python3 中，bytes 和 str 的互相转换：</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">str</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="built_in">bytes</span>.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="4、f"><a href="#4、f" class="headerlink" title="4、f"></a>4、<code>f</code></h2><p>例如：<code>f&quot;server received: &#123;data&#125;&quot;</code>，Python3.6 新加特性：格式化字符串。支持在大括号内，运行 Python 表达式。</p>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 poetry 进行依赖管理</title>
    <url>/97819500-a133-11ee-9970-39bf61dae061/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<p>官网：<a href="https://python-poetry.org/">https://python-poetry.org/</a></p>
<h2 id="1、安装及使用"><a href="#1、安装及使用" class="headerlink" title="1、安装及使用"></a>1、安装及使用</h2><p>1）执行 <code>pip install poetry</code></p>
<blockquote>
<p>最好全局安装，不同项目之间切换时不用重复激活和安装依赖，比较方便。</p>
</blockquote>
<p>2）如果是新项目，则可使用 poetry 初始化。执行 <code>poetry new poetry-demo</code>，项目结构如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">poetry-demo</span><br><span class="line">├── pyproject.toml</span><br><span class="line">├── README.md</span><br><span class="line">├── poetry_demo</span><br><span class="line">│   └── __init__.py</span><br><span class="line">└── tests</span><br><span class="line">    └── __init__.py</span><br></pre></td></tr></table></figure>

<p>3）如果是既有项目引入 poetry，可在项目根目录执行 <code>poetry init</code>，通过互动配置生成 <code>pyproject.toml</code> 文件。</p>
<blockquote>
<p>win 环境下，默认虚拟环境在 <code>C:\Users\用户名\AppData\Local\pypoetry\Cache\virtualenvs</code> 目录下，虚拟环境名称会包含项目名称。</p>
</blockquote>
<h2 id="2、常用命令"><a href="#2、常用命令" class="headerlink" title="2、常用命令"></a>2、常用命令</h2><ul>
<li><code>poetry shell</code>，进入虚拟环境</li>
</ul>
<p>根据 <code>pyproject.toml</code> 文件来确定需要启动的虚拟环境。</p>
<ul>
<li><code>poetry install</code>，安装全部依赖。</li>
</ul>
<p>例如从远程仓库 clone 的项目不包含依赖，执行该命令则按 <code>poetry.lock</code> 新建。</p>
<ul>
<li><p><code>poetry install --no-dev</code>，安装非开发环境的依赖，部署时使用</p>
</li>
<li><p><code>poetry add &lt;name&gt;</code>，引入依赖，会同时更新 <code>poetry.lock</code> 文件</p>
</li>
</ul>
<blockquote>
<p>可指定为开发时依赖：<code>poetry add &lt;name&gt; --dev</code>，将添加到 <code>[tool.poetry.dev-dependencies]</code> 区域</p>
</blockquote>
<ul>
<li><code>poetry lock</code>，更新 <code>poetry.lock</code> 文件</li>
</ul>
<p>如果手工修改了 <code>pyproject.toml</code>，比如指定特定模块的版本，此时 <code>poetry.lock</code> 的内容与 <code>pyproject.toml</code> 出现了脱钩，应执行上述命令保持两者一致。注意：该命令仅更新文件，不会安装模块至虚拟环境，要再使用 <code>poetry install</code> 安装模块。</p>
<p>因此，在执行完 poetry lock 指令后，必须再使用 poetry install 来安装模块</p>
<ul>
<li><p><code>poetry update</code>，更新依赖，或 <code>poetry update requests</code> 指定更新某个依赖</p>
</li>
<li><p><code>poetry show</code>，列出当前环境已安装依赖，或 <code>poetry show -t</code> 以树形结构查看</p>
</li>
</ul>
<blockquote>
<p>显示的是 <code>poetry.lock</code> 的内容</p>
</blockquote>
<ul>
<li><p><code>poetry show --tree</code>，树状显示模块依赖层级，或 <code>poetry show requests --tree</code> 仅显示指定模块的依赖层级</p>
</li>
<li><p><code>poetry remove &lt;name&gt;</code>，移除依赖</p>
</li>
<li><p><code>poetry config --list</code>，查看 poetry 配置</p>
</li>
<li><p><code>poetry source show</code>，显示下载源</p>
</li>
<li><p><code>poetry source remove &lt;源名称&gt;</code>，删除下载源</p>
</li>
<li><p>&#96;&#96;</p>
</li>
</ul>
<h2 id="3、实用设置"><a href="#3、实用设置" class="headerlink" title="3、实用设置"></a>3、实用设置</h2><p>1）将虚拟环境建立在项目目录下。</p>
<ul>
<li>使用 <code>poetry config --list</code> 指令查看当前配置，如下所示；</li>
<li>执行 <code>poetry config virtualenvs.in-project true</code>，修改配置，将虚拟环境建立在项目目录；</li>
<li>执行 <code>poetry env remove python</code> 删除默认路径的虚拟环境；</li>
<li>执行 <code>poetry env use python</code> 重建虚拟环境，名称为 <code>.venv</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Using version ^2.1.4 <span class="keyword">for</span> pandas</span><br><span class="line">cache-dir = <span class="string">&quot;C:\\Users\\Admin\\AppData\\Local\\pypoetry\\Cache&quot;</span></span><br><span class="line">experimental.system-git-client = <span class="literal">false</span></span><br><span class="line">installer.max-workers = null</span><br><span class="line">installer.modern-installation = <span class="literal">true</span></span><br><span class="line">installer.no-binary = null</span><br><span class="line">installer.parallel = <span class="literal">true</span></span><br><span class="line">repositories.tsinghua.url = <span class="string">&quot;https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple/&quot;</span></span><br><span class="line">virtualenvs.create = <span class="literal">true</span></span><br><span class="line">virtualenvs.in-project = null</span><br><span class="line">virtualenvs.options.always-copy = <span class="literal">false</span></span><br><span class="line">virtualenvs.options.no-pip = <span class="literal">false</span></span><br><span class="line">virtualenvs.options.no-setuptools = <span class="literal">false</span></span><br><span class="line">virtualenvs.options.system-site-packages = <span class="literal">false</span></span><br><span class="line">virtualenvs.path = <span class="string">&quot;&#123;cache-dir&#125;\\virtualenvs&quot;</span>  <span class="comment"># C:\Users\Admin\AppData\Local\pypoetry\Cache\virtualenvs</span></span><br><span class="line">virtualenvs.prefer-active-python = <span class="literal">false</span></span><br><span class="line">virtualenvs.prompt = <span class="string">&quot;&#123;project_name&#125;-py&#123;python_version&#125;&quot;</span></span><br><span class="line">warnings.export = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>虚拟环境在项目目录时，注意添加 <code>.venv</code> 到 <code>.gitignore</code></p>
</blockquote>
<p>2）增加下载源</p>
<p>使用默认源有时会出现连接超时的情况，可执行 <code>poetry source add &lt;source_name&gt; &lt;source_url&gt;</code> 添加国内源解决这个问题：</p>
<ul>
<li>执行 <code>poetry source add tsinghua https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple/</code>，添加清华源</li>
<li>或 <code>poetry source add tencent https://mirrors.cloud.tencent.com/pypi/simple/</code>，添加腾讯源</li>
<li>或 <code>poetry source add aliyun https://mirrors.aliyun.com/pypi/simple/</code>，添加阿里源</li>
</ul>
<blockquote>
<p>命令参数可见 <a href="https://python-poetry.org/docs/cli#source">https://python-poetry.org/docs/cli#source</a></p>
</blockquote>
<h2 id="4、其他"><a href="#4、其他" class="headerlink" title="4、其他"></a>4、其他</h2><p>1）当添加自定义源后，可能会遇到如下警告：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Warning: In a future version of Poetry, PyPI will be disabled automatically <span class="keyword">if</span> at least one custom primary <span class="built_in">source</span> is configured. In order to avoid a breaking change and make your pyproject.toml forward compatible, add PyPI explicitly via <span class="string">&#x27;poetry source add pypi&#x27;</span>. By the way, this has the advantage that you can <span class="built_in">set</span> the priority of PyPI as with any other <span class="built_in">source</span>.</span><br><span class="line"></span><br><span class="line">警告：在未来版本的 Poetry 中，如果配置了至少一个自定义主源，PyPI 将被自动禁用。为了避免破坏性更改并使 pyproject.toml 向前兼容，请通过 <span class="string">&#x27;poetry source add pypi&#x27;</span> 显式地添加 PyPI。顺便说一下，这样做的好处是你可以像使用任何其他源一样设置 PyPI 的优先级。</span><br></pre></td></tr></table></figure>

<p>按照提示，执行 <code>poetry source add pypi</code> 即可。</p>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL-8.x-问题处理汇总</title>
    <url>/ef12f513-4937-11ee-861d-b3cf05b530a5/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>


<h2 id="●-MySQL-8-0-15-报-SSLException-异常"><a href="#●-MySQL-8-0-15-报-SSLException-异常" class="headerlink" title="● MySQL 8.0.15 报 SSLException 异常"></a>● MySQL 8.0.15 报 SSLException 异常</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>该问题可能会导致连接关闭，</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Sun May 12 22:08:48 CST 2019 WARN: Caught while disconnecting...</span><br><span class="line"></span><br><span class="line">EXCEPTION STACK TRACE:</span><br><span class="line"></span><br><span class="line">** BEGIN NESTED EXCEPTION **</span><br><span class="line"></span><br><span class="line">javax.net.ssl.SSLException</span><br><span class="line">MESSAGE: closing inbound before receiving peer&#x27;s close_notify</span><br><span class="line"></span><br><span class="line">STACKTRACE:</span><br><span class="line"></span><br><span class="line">javax.net.ssl.SSLException: closing inbound before receiving peer&#x27;s close_notify</span><br><span class="line">	at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:133)</span><br><span class="line">	at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:117)</span><br><span class="line">	at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:308)</span><br><span class="line">	at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:264)</span><br><span class="line">	at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:255)</span><br><span class="line">	at java.base/sun.security.ssl.SSLSocketImpl.shutdownInput(SSLSocketImpl.java:645)</span><br><span class="line">	at java.base/sun.security.ssl.SSLSocketImpl.shutdownInput(SSLSocketImpl.java:624)</span><br><span class="line">	at com.mysql.cj.protocol.a.NativeProtocol.quit(NativeProtocol.java:1319)</span><br><span class="line">	at com.mysql.cj.NativeSession.quit(NativeSession.java:182)</span><br><span class="line">	at com.mysql.cj.jdbc.ConnectionImpl.realClose(ConnectionImpl.java:1750)</span><br><span class="line">	at com.mysql.cj.jdbc.ConnectionImpl.close(ConnectionImpl.java:720)</span><br><span class="line">	at com.zaxxer.hikari.pool.PoolBase.quietlyCloseConnection(PoolBase.java:132)</span><br><span class="line">	at com.zaxxer.hikari.pool.HikariPool.lambda$closeConnection$1(HikariPool.java:434)</span><br><span class="line">	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)</span><br><span class="line">	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)</span><br><span class="line">	at java.base/java.lang.Thread.run(Thread.java:834)</span><br><span class="line"></span><br><span class="line">** END NESTED EXCEPTION **</span><br></pre></td></tr></table></figure>

<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>数据库 URL 需要声明是否使用 SSL 安全验证及指定服务器上的时区，将 useSSL 设置为 false，即：<code>?useSSL=false&amp;serverTimezone=UTC&quot;</code></p>
<h2 id="●-MySQL-8-0-15-驱动类名称"><a href="#●-MySQL-8-0-15-驱动类名称" class="headerlink" title="● MySQL 8.0.15 驱动类名称"></a>● MySQL 8.0.15 驱动类名称</h2><h3 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h3><p>旧版驱动类是 <code>com.mysql.jdbc.Driver</code>，但是如果在 8.0 还继续用这个类，就会提示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Loading class `com.mysql.jdbc.Driver&#x27;. This is deprecated. The new driver class is `com.mysql.cj.jdbc.Driver&#x27;. The driver is automatically registered via the SPI and manual loading of the driver class is generally unnecessary.</span><br></pre></td></tr></table></figure>

<h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><p>需要用新的驱动类，在配置文件中改为：<code>driver=com.mysql.cj.jdbc.Driver</code></p>
<h2 id="●-MySQL-8-0-15-时区指定"><a href="#●-MySQL-8-0-15-时区指定" class="headerlink" title="● MySQL 8.0.15 时区指定"></a>● MySQL 8.0.15 时区指定</h2><h3 id="问题描述-2"><a href="#问题描述-2" class="headerlink" title="问题描述"></a>问题描述</h3><p>驱动类正确，但是报错：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java.sql.SQLException: The server time zone value &#x27;ÖÐ¹ú±ê×¼Ê±¼ä&#x27; is unrecognized or represents more than one time zone. You must configure either the server or JDBC driver (via the serverTimezone configuration property) to use a more specifc time zone value if you want to utilize time zone support.</span><br></pre></td></tr></table></figure>

<h3 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h3><p>手动指定时区，如果服务器也是东八区（GMT+8），那么在 URL 后面加上参数 <code>serverTimezone=GMT%2B8</code> 即可：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">url=jdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8</span></span><br></pre></td></tr></table></figure>

<h2 id="●-MySQL-8-0-15-getTables-默认返回所有库的表"><a href="#●-MySQL-8-0-15-getTables-默认返回所有库的表" class="headerlink" title="● MySQL 8.0.15 getTables 默认返回所有库的表"></a>● MySQL 8.0.15 getTables 默认返回所有库的表</h2><h3 id="问题描述-3"><a href="#问题描述-3" class="headerlink" title="问题描述"></a>问题描述</h3><p>8.0 及以上版本的驱动默认将 <code>nullCatalogMeansCurrent</code> 的默认值由 true 改为了 false，如果使用 <code>DatabaseMetaData</code> 类的对象调用 getTables 方法，就会返回所有库的表，而非在 url 参数中指定的数据库（本例中数据库名为 test）</p>
<h3 id="解决方案-3"><a href="#解决方案-3" class="headerlink" title="解决方案"></a>解决方案</h3><p>手动在参数中指定 <code>nullCatalogMeansCurrent</code> 值为 true</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">url=jdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8&amp;useSSL=false&amp;useSSL=false&amp;allowPublicKeyRetrieval=true&amp;nullCatalogMeansCurrent=true</span></span><br></pre></td></tr></table></figure>

<h2 id="●-SpringBoot-连接-MySql-8-x-时出现-CLIENT-PLUGIN-AUTH-is-required-异常"><a href="#●-SpringBoot-连接-MySql-8-x-时出现-CLIENT-PLUGIN-AUTH-is-required-异常" class="headerlink" title="● SpringBoot 连接 MySql 8.x 时出现 CLIENT_PLUGIN_AUTH is required 异常"></a>● SpringBoot 连接 MySql 8.x 时出现 CLIENT_PLUGIN_AUTH is required 异常</h2><h3 id="问题描述-4"><a href="#问题描述-4" class="headerlink" title="问题描述"></a>问题描述</h3><p>SpringBoot 连接 MySql 8.x 时出现 <code>CLIENT_PLUGIN_AUTH is required</code> 异常</p>
<h3 id="解决方案-4"><a href="#解决方案-4" class="headerlink" title="解决方案"></a>解决方案</h3><p>修改 mysql-connector-java 依赖版本为低版本，如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// https://mvnrepository.com/artifact/mysql/mysql-connector-java</span><br><span class="line">compile group: &#x27;mysql&#x27;, name: &#x27;mysql-connector-java&#x27;, version: &#x27;5.1.47&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="●-MySQL-8-0-15-SSL"><a href="#●-MySQL-8-0-15-SSL" class="headerlink" title="● MySQL 8.0.15 SSL"></a>● MySQL 8.0.15 SSL</h2><h3 id="问题描述-5"><a href="#问题描述-5" class="headerlink" title="问题描述"></a>问题描述</h3><p>关闭连接对象时会产生的一个无关紧要的报错，不解决也可以正常使用，会占据控制台的大量篇幅，导致使用体验极差：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">javax.net.ssl.SSLException</span><br><span class="line">MESSAGE: closing inbound before receiving peer&#x27;s close_notify</span><br></pre></td></tr></table></figure>

<h3 id="解决方案-5"><a href="#解决方案-5" class="headerlink" title="解决方案"></a>解决方案</h3><p>MySQL 8.0 开始，数据库 URL 需要设置是否使用 SSL 安全连接，在 URL 后面加上参数 useSSL&#x3D;false 即可，多个参数键值对中间用 &amp; 隔开：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">url=jdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8&amp;useSSL=false</span></span><br></pre></td></tr></table></figure>

<h2 id="●-MySQL-8-0-15-Public-Key-Retrieval-报错"><a href="#●-MySQL-8-0-15-Public-Key-Retrieval-报错" class="headerlink" title="● MySQL 8.0.15 Public Key Retrieval 报错"></a>● MySQL 8.0.15 Public Key Retrieval 报错</h2><h3 id="问题描述-6"><a href="#问题描述-6" class="headerlink" title="问题描述"></a>问题描述</h3><p>重启服务器后出现 Public Key Retrieval 报错：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java.sql.SQLNonTransientConnectionException: Public Key Retrieval is not allowed</span><br></pre></td></tr></table></figure>

<h3 id="解决方案-6"><a href="#解决方案-6" class="headerlink" title="解决方案"></a>解决方案</h3><p>在 URL 后加上 <code>allowPublicKeyRetrieval=true</code> 即可</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">url=jdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8&amp;useSSL=false&amp;allowPublicKeyRetrieval=true</span></span><br></pre></td></tr></table></figure>

<h2 id="●-使用可视化客户端连接-MySQL-时出现-2058-错误"><a href="#●-使用可视化客户端连接-MySQL-时出现-2058-错误" class="headerlink" title="● 使用可视化客户端连接 MySQL 时出现 2058 错误"></a>● 使用可视化客户端连接 MySQL 时出现 2058 错误</h2><h3 id="解决方案-7"><a href="#解决方案-7" class="headerlink" title="解决方案"></a>解决方案</h3><p>MySQL 8.0 采用了 caching_sha2_password 加密，是 sha256 的改进版加密方式，多数第三方客户端都不支持这种加密方式，自带的命令行可支持。具体可参看 <a href="https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password">官方文档</a> 有关该内容说明。要解决该问题，需要修改加密方式。以 root 用户为例，如果要配置其他用户或授权 IP，对应修改名称和地址即可。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">&#x27;password&#x27;</span>;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL 使用存储过程批量建表</title>
    <url>/ef131c21-4937-11ee-861d-b3cf05b530a5/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>


<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>建立 data_0 开始，到 data_9 共 10 张表，各表的字段结构、数据引擎、编码方式等均相同。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>使用如下存储过程：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> create_table()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> `<span class="variable">@i</span>` <span class="type">INT</span>(<span class="number">11</span>);</span><br><span class="line"><span class="keyword">DECLARE</span> `<span class="variable">@sqlstr</span>` <span class="type">VARCHAR</span>(<span class="number">2560</span>);</span><br><span class="line"><span class="keyword">SET</span> `<span class="variable">@i</span>`<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">WHILE `<span class="variable">@i</span>` <span class="operator">&lt;</span> <span class="number">10</span> DO</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@sqlstr</span> <span class="operator">=</span> CONCAT(</span><br><span class="line">&quot;CREATE TABLE data_&quot;,</span><br><span class="line"></span><br><span class="line">`<span class="variable">@i</span>`,</span><br><span class="line"></span><br><span class="line">&quot;(</span><br><span class="line">`ID` BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `field1` VARCHAR(6) NOT NULL,</span><br><span class="line">  `field2` VARCHAR(10) NOT NULL,</span><br><span class="line">  `field3` VARCHAR(10) NOT NULL,</span><br><span class="line">  `field4` VARCHAR(10) NOT NULL,</span><br><span class="line">  `field5` VARCHAR(10) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`ID`)</span><br><span class="line">) ENGINE=INNODB DEFAULT CHARSET=utf8 &quot;</span><br><span class="line">);</span><br><span class="line"><span class="keyword">PREPARE</span> stmt <span class="keyword">FROM</span> <span class="variable">@sqlstr</span>;</span><br><span class="line"><span class="keyword">EXECUTE</span> stmt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> `<span class="variable">@i</span>` <span class="operator">=</span> `<span class="variable">@i</span>` <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<p>执行存储过程，执行后删除存储过程并恢复默认命令结束符：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CALL</span> create_table();</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> create_table;</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>创建存储过程时，若采用命令行的方式，要先修改默认命令结束符，这样将 CREATE 到 END 之间的代码当是一条语句来执行。例如上述代码中的 <code>DELIMITER //</code>，将命令结束符修改为 <code>//</code>，执行结束后再修改回 <code>;</code>。</p>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>mariadb 报错 The total number of locks exceeds the lock table size 的解决</title>
    <url>/d0d9c500-5563-11ee-b900-f9a67c785a37/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、问题描述"><a href="#1、问题描述" class="headerlink" title="1、问题描述"></a>1、问题描述</h2><p>修改表某字段 <code>decimal(10,2)</code> 类型为 <code>decimal(10,3)</code>，该表数据量约 2 亿行。执行时报如题错误。</p>
<h2 id="2、解决方案"><a href="#2、解决方案" class="headerlink" title="2、解决方案"></a>2、解决方案</h2><p>1）执行 <code>show variables like &quot;%_buffer%&quot;;</code> 查看当前 <code>innodb_buffer_pool_size</code> 参数，默认为 134217728（128M）</p>
<p>2）执行 <code>SET GLOBAL innodb_buffer_pool_size= 1073741824</code>，临时设置参数值为 1G</p>
<h2 id="3、参考文献"><a href="#3、参考文献" class="headerlink" title="3、参考文献"></a>3、参考文献</h2><ul>
<li><a href="https://www.cnblogs.com/innocenter/p/14948857.html">https://www.cnblogs.com/innocenter/p/14948857.html</a></li>
</ul>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>mariadb</tag>
      </tags>
  </entry>
  <entry>
    <title>oracle 12c 使用 WM_CONCAT 函数提示标识符无效</title>
    <url>/ef12f514-4937-11ee-861d-b3cf05b530a5/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>


<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>查询语句使用 WM_CONCAT 函数时报错：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Error querying database.  Cause: java.sql.SQLSyntaxErrorException: ORA-00904: &quot;WM_CONCAT&quot;: 标识符无效</span><br></pre></td></tr></table></figure>

<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>11gR2 和 12c 上已经摒弃了该函数，在程序中若使用该函数，将导致程序出现错误</p>
<blockquote>
<p>在我们需要将某字段多行内容拼接起来的时候，wm_concat 提供了简洁的方法，这使得这个未公开的函数得到了广泛的宣传与运用。但是，不公开就意味着随时可能发生变更。在 10.2.0.5 上，其返回类型从 varchar2 变为了 clob，而在 12c 当中，干脆就取消了此函数。同样未公开的，还有 reverse 函数。</p>
</blockquote>
<p>用 <code>listagg</code> 函数替代，效果相同。</p>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>oracle</tag>
      </tags>
  </entry>
  <entry>
    <title>oracle、postgresql、mysql行转列的内置函数</title>
    <url>/8a9db7f2-e38d-11ee-8d05-110f62540784/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>

<h2 id="1、需求描述"><a href="#1、需求描述" class="headerlink" title="1、需求描述"></a>1、需求描述</h2><p>查询人员的年龄</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> t.age,t.name <span class="keyword">from</span> table_name t <span class="keyword">where</span> t.age <span class="operator">=</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">age</th>
<th align="center">name</th>
</tr>
</thead>
<tbody><tr>
<td align="center">16</td>
<td align="center">Jack</td>
</tr>
<tr>
<td align="center">16</td>
<td align="center">Jones</td>
</tr>
<tr>
<td align="center">16</td>
<td align="center">Mark</td>
</tr>
<tr>
<td align="center">16</td>
<td align="center">Lucy</td>
</tr>
<tr>
<td align="center">16</td>
<td align="center">Adams</td>
</tr>
</tbody></table>
<p>要达到的效果：</p>
<table>
<thead>
<tr>
<th align="center">age</th>
<th align="center">names</th>
</tr>
</thead>
<tbody><tr>
<td align="center">16</td>
<td align="center">Jack,Jones,Mark,Lucy,Adams</td>
</tr>
</tbody></table>
<h2 id="2、解决方案"><a href="#2、解决方案" class="headerlink" title="2、解决方案"></a>2、解决方案</h2><p>1）oracle：listagg() within group()</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> t.age, <span class="built_in">listagg</span>(t.name, <span class="string">&#x27;,&#x27;</span>) <span class="keyword">within</span> <span class="keyword">group</span> (<span class="keyword">order</span> <span class="keyword">by</span> t.name) names</span><br><span class="line"><span class="keyword">from</span> table_name t</span><br><span class="line"><span class="keyword">where</span> t.age <span class="operator">=</span> <span class="number">20</span> <span class="keyword">group</span> <span class="keyword">by</span> t.age</span><br></pre></td></tr></table></figure>

<p>2） postgresql：string_agg()</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> t.age, string_agg(t.name, <span class="string">&#x27;,&#x27;</span>) <span class="keyword">as</span> names</span><br><span class="line"><span class="keyword">from</span> table_name t</span><br><span class="line"><span class="keyword">where</span> t.age <span class="operator">=</span> <span class="number">20</span> <span class="keyword">group</span> <span class="keyword">by</span> t.age</span><br></pre></td></tr></table></figure>

<p>3） mysql：group_concat()</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> t.age, group_concat(t.name <span class="keyword">order</span> <span class="keyword">by</span> t.name separator <span class="string">&#x27;,&#x27;</span>) <span class="keyword">as</span> names</span><br><span class="line"><span class="keyword">from</span> table_name t</span><br><span class="line"><span class="keyword">where</span> t.age <span class="operator">=</span> <span class="number">20</span> <span class="keyword">group</span> <span class="keyword">by</span> t.age</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>postgresql</tag>
        <tag>oracle</tag>
      </tags>
  </entry>
  <entry>
    <title>触发器案例（MySQL）</title>
    <url>/ef131c20-4937-11ee-861d-b3cf05b530a5/</url>
    <content><![CDATA[<blockquote>
</blockquote>
<span id="more"></span>


<p>MySQL 包含对触发器的支持。触发器是一种与表操作有关的数据库对象，当触发器所在表上出现指定事件时，将调用该对象，即表的操作事件触发表上的触发器的执行。</p>
<h2 id="创建触发器"><a href="#创建触发器" class="headerlink" title="创建触发器"></a>创建触发器</h2><p>在 MySQL 中，创建触发器语法如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger_name</span><br><span class="line">trigger_time</span><br><span class="line">trigger_event <span class="keyword">ON</span> tbl_name</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line">trigger_stmt</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li>trigger_name：标识触发器名称，用户自行指定；</li>
<li>trigger_time：标识触发时机，取值为 BEFORE 或 AFTER；</li>
<li>trigger_event：标识触发事件，取值为 INSERT、UPDATE 或 DELETE；</li>
<li>tbl_name：标识建立触发器的表名，即在哪张表上建立触发器；</li>
<li>trigger_stmt：触发器程序体，可以是一句 SQL 语句，或者用 BEGIN 和 END 包含的多条语句。</li>
</ul>
<p>由此可见，可以建立 6 种触发器，即：BEFORE INSERT、BEFORE UPDATE、BEFORE DELETE、AFTER INSERT、AFTER UPDATE、AFTER DELETE。</p>
<p>另外有一个限制是不能同时在一个表上建立 2 个相同类型的触发器，因此在一个表上最多建立 6 个触发器。</p>
<h2 id="trigger-event"><a href="#trigger-event" class="headerlink" title="trigger_event"></a>trigger_event</h2><p>MySQL 除了对 INSERT、UPDATE、DELETE 基本操作进行定义外，还定义了 LOAD DATA 和 REPLACE 语句，这两种语句也能引起上述 6 中类型的触发器的触发。</p>
<p>LOAD DATA 语句用于将一个文件装入到一个数据表中，相当与一系列的 INSERT 操作。</p>
<p>REPLACE 语句一般来说和 INSERT 语句很像，只是在表中有 primary key 或 unique 索引时，如果插入的数据和原来 primary key 或 unique 索引一致时，会先删除原来的数据，然后增加一条新数据，也就是说，一条 REPLACE 语句有时候等价于一条。</p>
<p>INSERT 语句，有时候等价于一条 DELETE 语句加上一条 INSERT 语句。</p>
<ul>
<li>INSERT 型触发器：插入某一行时激活触发器，可能通过 INSERT、LOAD DATA、REPLACE 语句触发；</li>
<li>UPDATE 型触发器：更改某一行时激活触发器，可能通过 UPDATE 语句触发；</li>
<li>DELETE 型触发器：删除某一行时激活触发器，可能通过 DELETE、REPLACE 语句触发。</li>
</ul>
<h2 id="BEGIN-…-END"><a href="#BEGIN-…-END" class="headerlink" title="BEGIN … END"></a>BEGIN … END</h2><p>在 MySQL 中，BEGIN … END 语句的语法为：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">[statement_list]</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<p>其中，statement_list 代表一个或多个语句的列表，列表内的每条语句都必须用分号（;）来结尾。而在 MySQL 中，分号是语句结束的标识符，遇到分号表示该段语句已经结束，MySQL 可以开始执行了。因此，解释器遇到 statement_list 中的分号后就开始执行，然后会报出错误，因为没有找到和 BEGIN 匹配的 END。</p>
<p>这时就会用到 DELIMITER 命令（DELIMITER 是定界符，分隔符的意思），它是一条命令，不需要语句结束标识，语法为：<code>DELIMITER new_delemiter</code>。new_delemiter 可以设为 1 个或多个长度的符号，默认的是分号（;），我们可以把它修改为其他符号，如$：<br><code>DELIMITER $</code>，在这之后的语句，以分号结束，解释器不会有什么反应，只有遇到了$，才认为是语句结束。注意，使用完之后，我们还应该记得把它给修改回来。</p>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><p>假设系统中有两个表：</p>
<ul>
<li>班级表 class(班级号 classID, 班内学生数 stuCount)</li>
<li>学生表 student(学号 stuID, 所属班级号 classID)</li>
</ul>
<p>要创建触发器来使班级表中的班内学生数随着学生的添加自动更新，代码如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> tri_stuInsert after <span class="keyword">insert</span></span><br><span class="line"><span class="keyword">on</span> student <span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> c <span class="type">int</span>;</span><br><span class="line"><span class="keyword">set</span> c <span class="operator">=</span> (<span class="keyword">select</span> stuCount <span class="keyword">from</span> class <span class="keyword">where</span> classID<span class="operator">=</span>new.classID);</span><br><span class="line"><span class="keyword">update</span> class <span class="keyword">set</span> stuCount <span class="operator">=</span> c <span class="operator">+</span> <span class="number">1</span> <span class="keyword">where</span> classID <span class="operator">=</span> new.classID;</span><br><span class="line"><span class="keyword">end</span>$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>MySQL 中使用 DECLARE 来定义一局部变量，该变量只能在 BEGIN … END 复合语句中使用，并且应该定义在复合语句的开头，即其它语句之前，语法如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> var_name[,...] type [<span class="keyword">DEFAULT</span> <span class="keyword">value</span>]</span><br></pre></td></tr></table></figure>

<p>其中，<code>var_name</code> 为变量名称，同 SQL 语句一样，变量名不区分大小写；type 为 MySQL 支持的任何数据类型；可以同时定义多个同类型的变量，用逗号隔开；变量初始值为 NULL，如果需要，可以使用 DEFAULT 子句提供默认值，值可以被指定为一个表达式。</p>
<p>对变量赋值采用 SET 语句，语法为：<code>SET var_name = expr [,var_name = expr] ...</code></p>
<h2 id="NEW-与-OLD-详解"><a href="#NEW-与-OLD-详解" class="headerlink" title="NEW 与 OLD 详解"></a>NEW 与 OLD 详解</h2><p>上述示例中使用了 NEW 关键字，和 MS SQL Server 中的 INSERTED 和 DELETED 类似，MySQL 中定义了 NEW 和 OLD，用来表示触发器的所在表中，触发了触发器的那一行数据。具体地：</p>
<ul>
<li>在 INSERT 型触发器中，NEW 用来表示将要（BEFORE）或已经（AFTER）插入的新数据；</li>
<li>在 UPDATE 型触发器中，OLD 用来表示将要或已经被修改的原数据，NEW 用来表示将要或已经修改为的新数据；</li>
<li>在 DELETE 型触发器中，OLD 用来表示将要或已经被删除的原数据；</li>
</ul>
<p>使用方法： NEW.columnName （columnName 为相应数据表某一列名）。另外，OLD 是只读的，而 NEW 则可以在触发器中使用 SET 赋值，这样不会再次触发触发器，造成循环调用（如每插入一个学生前，都在其学号前加“2013”）。</p>
<h2 id="查看触发器"><a href="#查看触发器" class="headerlink" title="查看触发器"></a>查看触发器</h2><p>和查看数据库（show databases;）查看表格（show tables;）一样，查看触发器的语法如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> TRIGGERS [<span class="keyword">FROM</span> schema_name];</span><br></pre></td></tr></table></figure>

<p>其中，schema_name 即 Schema 的名称，在 MySQL 中 Schema 和 Database 是一样的，也就是说，可以指定数据库名，这样就</p>
<p>不必先“USE database_name;”了。</p>
<h2 id="删除触发器"><a href="#删除触发器" class="headerlink" title="删除触发器"></a>删除触发器</h2><p>和删除数据库、删除表格一样，删除触发器的语法如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> [IF <span class="keyword">EXISTS</span>][schema_name.]trigger_name</span><br></pre></td></tr></table></figure>

<h2 id="触发器的执行顺序"><a href="#触发器的执行顺序" class="headerlink" title="触发器的执行顺序"></a>触发器的执行顺序</h2><p>我们建立的数据库一般都是 InnoDB 数据库，其上建立的表是事务性表，也就是事务安全的。这时，若 SQL 语句或触发器执行失败，MySQL 会回滚事务，有：</p>
<ul>
<li>如果 BEFORE 触发器执行失败，SQL 无法正确执行。</li>
<li>SQL 执行失败时，AFTER 型触发器不会触发。</li>
<li>AFTER 类型的触发器执行失败，SQL 会回滚。</li>
</ul>
]]></content>
      <categories>
        <category>后端技术</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
</search>
